   0: <span style='color:#696969; '># Copyright (C) 2000 Mark Stosberg </span><span style='color:#0000e6; '>&lt;</span><span style='color:#7144c4; '>mark@stosberg.com</span><span style='color:#0000e6; '>></span>
   1: <span style='color:#696969; '># Licensed under the the GNU GPL, available here: </span><span style='color:#5555dd; '>http://www.gnu.org/copyleft/gpl.html</span>
   2: 
   3: <span style='color:#696969; '># Originally by Mark Stosberg </span><span style='color:#7144c4; '>mark@summersault.com</span><span style='color:#696969; '> for the skatepark.org website</span>
   4: <span style='color:#696969; '># inspired by sumsearch by Chris Hardie </span><span style='color:#0000e6; '>&lt;</span><span style='color:#7144c4; '>chris@summersault.com</span><span style='color:#0000e6; '>></span>
   5: 
   6: <span style='color:#808030; '>=pod</span><span style='color:#3f5fbf; '></span>
   7: <span style='color:#3f5fbf; '></span>
   8: <span style='color:#808030; '>=head1</span><span style='color:#3f5fbf; '> NAME</span><span style='color:#3f5fbf; '></span>
   9: <span style='color:#3f5fbf; '></span>
  10: <span style='color:#3f5fbf; '>Cascade - Content Management System for a database driven web based dir</span>
  11: <span style='color:#3f5fbf; '></span>
  12: <span style='color:#808030; '>=head1</span><span style='color:#3f5fbf; '> SYNOPSIS</span><span style='color:#3f5fbf; '></span>
  13: <span style='color:#3f5fbf; '></span>
  14: <span style='color:#3f5fbf; '>Cascade is expected to be used by an instance script, </span>
  15: <span style='color:#3f5fbf; '>which provides loads a configuration file and runs</span>
  16: <span style='color:#3f5fbf; '>the web application. See </span><span style='color:#e34adc; '>C&lt;html_path/cgi-bin/cascade.cgi></span><span style='color:#3f5fbf; '></span>
  17: <span style='color:#3f5fbf; '>included in the distribution for a working example. You</span>
  18: <span style='color:#3f5fbf; '>may be able use this directly, only changing </span>
  19: <span style='color:#3f5fbf; '>the configuration file to make it work for you. An</span>
  20: <span style='color:#3f5fbf; '>example configuration file is provided in the distribution</span>
  21: <span style='color:#3f5fbf; '>at </span><span style='color:#e34adc; '>C&lt;config/config.pl></span><span style='color:#3f5fbf; '>.</span>
  22: <span style='color:#3f5fbf; '></span>
  23: <span style='color:#808030; '>=head1</span><span style='color:#3f5fbf; '> DESCRIPTION </span><span style='color:#3f5fbf; '></span>
  24: <span style='color:#3f5fbf; '></span>
  25: <span style='color:#3f5fbf; '>Cascade is a content management application for a database-driven</span>
  26: <span style='color:#3f5fbf; '>web-based directory. Since it's primarily intended to be used as an</span>
  27: <span style='color:#3f5fbf; '>application rather than directly as Perl modules, most of the</span>
  28: <span style='color:#3f5fbf; '>documention here of how the module works won't be interesting to most</span>
  29: <span style='color:#3f5fbf; '>users. Instead, read the INSTALL file in the distribution to get your</span>
  30: <span style='color:#3f5fbf; '>site up and running. The remaining documentation in the Cascade</span>
  31: <span style='color:#3f5fbf; '>modules for is provided for hackers who might want to tinker with the</span>
  32: <span style='color:#3f5fbf; '>code, and for myself, so I can remember why I did the things I did. </span>
  33: <span style='color:#3f5fbf; '></span>
  34: <span style='color:#3f5fbf; '>For a detailed description of Cascade, see:</span>
  35: <span style='color:#5555dd; '>http://summersault.com/software/cascade</span><span style='color:#3f5fbf; '> </span>
  36: <span style='color:#3f5fbf; '></span>
  37: <span style='color:#808030; '>=head1</span><span style='color:#3f5fbf; '> AUTHOR</span><span style='color:#3f5fbf; '></span>
  38: <span style='color:#3f5fbf; '></span>
  39: <span style='color:#3f5fbf; '>Copyright (C) 2000-2001 Mark Stosberg </span><span style='color:#0000e6; '>&lt;</span><span style='color:#7144c4; '>mark@stosberg.com</span><span style='color:#0000e6; '>></span><span style='color:#3f5fbf; '></span>
  40: <span style='color:#3f5fbf; '></span>
  41: <span style='color:#3f5fbf; '>This library is free software; you can redistribute it and/or modify</span>
  42: <span style='color:#3f5fbf; '></span>
  43: <span style='color:#ffffff; background:#dd0000; font-weight:bold; font-style:italic; '> </span><span style='color:#3f5fbf; '></span>
  44: <span style='color:#3f5fbf; '>Address bug reports and comments to: </span><span style='color:#7144c4; '>mark@stosberg.com.</span><span style='color:#3f5fbf; '>  When sending</span>
  45: <span style='color:#3f5fbf; '>bug reports, please provide the version of Cascade, the version of</span>
  46: <span style='color:#3f5fbf; '>Perl, the name and version of your Web server, the name and version of</span>
  47: <span style='color:#3f5fbf; '>the operating system you are using, and the name and version of the</span>
  48: <span style='color:#3f5fbf; '>database you are using.  If the problem is even remotely browser</span>
  49: <span style='color:#3f5fbf; '>dependent, please provide information about the affected browers as</span>
  50: <span style='color:#3f5fbf; '>well.</span>
  51: <span style='color:#3f5fbf; '></span>
  52: <span style='color:#808030; '>=head1</span><span style='color:#3f5fbf; '> SEE ALSO</span><span style='color:#3f5fbf; '></span>
  53: <span style='color:#3f5fbf; '></span>
  54: <span style='color:#3f5fbf; '>perl(1).</span>
  55: <span style='color:#3f5fbf; '></span>
  56: <span style='color:#808030; '>=head2</span><span style='color:#3f5fbf; '> Steps for adding a new run mode</span><span style='color:#3f5fbf; '></span>
  57: <span style='color:#3f5fbf; '></span>
  58: <span style='color:#808030; '>=over </span><span style='color:#008c00; '>4</span><span style='color:#3f5fbf; '></span>
  59: <span style='color:#3f5fbf; '></span>
  60: <span style='color:#808030; '>=item</span><span style='color:#3f5fbf; '> * Add entry in run_modes() hash in &amp;Cascade::setup</span>
  61: <span style='color:#3f5fbf; '></span>
  62: <span style='color:#808030; '>=item</span><span style='color:#3f5fbf; '> * If run mode is non-public, create an appropriate entry in the</span>
  63: <span style='color:#0000e6; '>        RM_AUTH hash in config/config.pl</span><span style='color:#3f5fbf; '></span>
  64: <span style='color:#3f5fbf; '></span>
  65: <span style='color:#808030; '>=item</span><span style='color:#3f5fbf; '> * Add run mode to appropriate module. Right now this</span>
  66: <span style='color:#0000e6; '>     Cascade::Admin for editor and admin run modes, and Cascade.pm</span><span style='color:#3f5fbf; '></span>
  67: <span style='color:#0000e6; '>     for most everything else. </span><span style='color:#3f5fbf; '></span>
  68: <span style='color:#3f5fbf; '></span>
  69: <span style='color:#808030; '>=back</span><span style='color:#3f5fbf; '></span>
  70: <span style='color:#3f5fbf; '></span>
  71: <span style='color:#3f5fbf; '>See the documentation for CGI::Application for further information on</span>
  72: <span style='color:#3f5fbf; '>run modes.</span>
  73: <span style='color:#3f5fbf; '></span>
  74: <span style='color:#808030; '>=cut</span>
  75: 
  76: <span style='color:#800000; font-weight:bold; '>package </span>Cascade<span style='color:#800080; '>;</span>
  77: <span style='color:#696969; '># CGI::Application will "use CGI" for us, but it doesn't check the version, </span>
  78: <span style='color:#696969; '># so we do that here. In earlier versions, "Vars" may not work as we'd like or expect. -mls</span>
  79: <span style='color:#800000; font-weight:bold; '>use</span> CGI <span style='color:#008c00; '>2.</span><span style='color:#008c00; '>75</span><span style='color:#800080; '>;</span>
  80: <span style='color:#800000; font-weight:bold; '>use</span> base <span style='color:#0000e6; '>'CGI::Application'</span><span style='color:#800080; '>;</span>
  81: 
  82: <span style='color:#800000; font-weight:bold; '>use</span> DBI <span style='color:#008c00; '>1.</span><span style='color:#008c00; '>20</span><span style='color:#800080; '>;</span> <span style='color:#696969; '># we depened on some features added in this version </span>
  83: <span style='color:#800000; font-weight:bold; '>use</span> <span style='color:#bb7977; font-weight:bold; '>CGI</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Carp</span><span style='color:#800080; '>;</span>
  84: 
  85: <span style='color:#696969; '># Global variables</span>
  86: <span style='color:#696969; '># %TMPL is a global hash to for template handle recycling</span>
  87: <span style='color:#696969; '>#   the keys are filenames and the values are handles for those files</span>
  88: <span style='color:#800000; font-weight:bold; '>use</span> <span style='color:#800000; font-weight:bold; '>vars</span> <span style='color:#800000; font-weight:bold; '>qw </span><span style='color:#800000; '>(</span><span style='color:#0000e6; '></span>
  89: <span style='color:#0000e6; '>    $DBH</span>
  90: <span style='color:#0000e6; '>    $DEBUG</span>
  91: <span style='color:#0000e6; '>    $VERSION  </span>
  92: <span style='color:#0000e6; '>    %CFG</span>
  93: <span style='color:#0000e6; '>    %FORM</span>
  94: <span style='color:#0000e6; '>    %SES</span>
  95: <span style='color:#0000e6; '>    %TMPL  </span>
  96: <span style='color:#0000e6; '>    $q</span>
  97: <span style='color:#800000; '>)</span><span style='color:#800080; '>;</span>
  98: 
  99: <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Exporter</span><span style='color:#800080; '>;</span>
 100: <span style='color:#400000; '>push</span> @ISA<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>qw</span><span style='color:#800000; '>(</span><span style='color:#0000e6; '>Exporter</span><span style='color:#800000; '>)</span><span style='color:#800080; '>;</span>
 101: 
 102: @EXPORT_OK <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>qw</span><span style='color:#800000; '>(</span><span style='color:#0000e6; '></span>
 103: <span style='color:#0000e6; '>  $DBH</span>
 104: <span style='color:#0000e6; '>  $VERSION</span>
 105: <span style='color:#0000e6; '>  %CFG</span>
 106: <span style='color:#0000e6; '>  %FORM</span>
 107: <span style='color:#0000e6; '>  %SES</span>
 108: <span style='color:#0000e6; '>  %TMPL</span>
 109: <span style='color:#0000e6; '>  &amp;_html_error</span>
 110: <span style='color:#0000e6; '>  &amp;cat_already_exists</span>
 111: <span style='color:#0000e6; '>  &amp;check_cat_url</span>
 112: <span style='color:#0000e6; '>  &amp;conflicts_with_existing_cat</span>
 113: <span style='color:#0000e6; '>  &amp;err</span>
 114: <span style='color:#0000e6; '>  &amp;footer_html_tmpl</span>
 115: <span style='color:#0000e6; '>  &amp;front_page</span>
 116: <span style='color:#0000e6; '>  &amp;gettext</span>
 117: <span style='color:#0000e6; '>  &amp;html_item_new</span>
 118: <span style='color:#0000e6; '>  &amp;illegal_chars</span>
 119: <span style='color:#0000e6; '>  &amp;is_role</span>
 120: <span style='color:#0000e6; '>  &amp;validate_image</span>
 121: <span style='color:#0000e6; '>  $q</span>
 122: <span style='color:#0000e6; '>  &amp;htmlicize</span>
 123: <span style='color:#0000e6; '>  &amp;insert_hash</span>
 124: <span style='color:#800000; '>)</span><span style='color:#800080; '>;</span>
 125: 
 126: @EXPORT <span style='color:#808030; '>=</span> @EXPORT_OK<span style='color:#800080; '>;</span>
 127: <span style='color:#800000; font-weight:bold; '>use</span> <span style='color:#800000; font-weight:bold; '>strict</span><span style='color:#800080; '>;</span>
 128: 
 129: <span style='color:#800000; font-weight:bold; '>use</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Auth</span><span style='color:#800080; '>;</span>
 130: <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#800080; '>;</span>
 131: <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#800080; '>;</span>
 132: 
 133: <span style='color:#696969; '># XXX How can I avoid loading the admin module for every page? </span>
 134: <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Admin</span><span style='color:#800080; '>;</span>
 135: $VERSION <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'2.1.2'</span><span style='color:#800080; '>;</span> 
 136: 
 137: <span style='color:#696969; '># Internationalization stuff</span>
 138: <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span> $CFG<span style='color:#808030; '>{</span>LAN<span style='color:#808030; '>}</span> <span style='color:#808030; '>ne</span> <span style='color:#0000e6; '>''</span> <span style='color:#808030; '>and</span> $CFG<span style='color:#808030; '>{</span>LAN<span style='color:#808030; '>}</span> <span style='color:#808030; '>ne</span> <span style='color:#0000e6; '>'en'</span> <span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> 
 139:     <span style='color:#696969; '># XXX very broken for now, because gettext is sparsely used. -mls</span>
 140:     <span style='color:#696969; '># We require rather than 'use' POSIX here so it only get's loaded inside of this "if" block</span>
 141:     <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>POSIX</span><span style='color:#800080; '>;</span>
 142:     import <span style='color:#bb7977; font-weight:bold; '>POSIX</span><span style='color:#800080; '>;</span>
 143:     <span style='color:#800000; font-weight:bold; '>eval</span> <span style='color:#0000e6; '>"use Locale::gettext"</span><span style='color:#800080; '>;</span>
 144:     $ENV<span style='color:#808030; '>{</span>LC_MESSAGES<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> $CFG<span style='color:#808030; '>{</span>LAN<span style='color:#808030; '>}</span> <span style='color:#800080; '>;</span>
 145:     bindtextdomain<span style='color:#808030; '>(</span>$CFG<span style='color:#808030; '>{</span>DATABASE<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>$CFG<span style='color:#808030; '>{</span>CATDIR<span style='color:#808030; '>}</span> <span style='color:#808030; '>)</span> <span style='color:#800080; '>;</span>
 146:     textdomain<span style='color:#808030; '>(</span>$CFG<span style='color:#808030; '>{</span>DATABASE<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> 
 147:     <span style='color:#bb7977; font-weight:bold; '>POSIX</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span>setlocale<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span><span style='color:#bb7977; font-weight:bold; '>POSIX</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span>LC_MESSAGES<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>''</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 148: <span style='color:#800080; '>}</span>
 149: <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
 150:   <span style='color:#696969; '># In case that we dont want to use gettext, this is  the shortcut</span>
 151:   *gettext<span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>sub</span> <span style='color:#800080; '>{</span> <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#400000; '>shift</span> <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 152: <span style='color:#800080; '>}</span>
 153: 
 154: <span style='color:#800000; font-weight:bold; '>sub </span>setup <span style='color:#800080; '>{</span>
 155:     <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 156:     $DBH <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span><span style='color:#808030; '>=</span> connect_db<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>die</span> <span style='color:#0000e6; '>"Could not connect to database. Check connection parameters"</span><span style='color:#800080; '>;</span>
 157: 
 158:     <span style='color:#696969; '># Put param variables into a global hash</span>
 159:     $q <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>query<span style='color:#800080; '>;</span> 
 160:     %FORM <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>%FORM<span style='color:#808030; '>,</span> $q<span style='color:#808030; '>-></span>Vars<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 161: 
 162: <span style='color:#696969; '># set $FORM{rm} (run mode)</span>
 163:     $FORM<span style='color:#808030; '>{</span>rm<span style='color:#808030; '>}</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span><span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'front_page'</span><span style='color:#800080; '>;</span>
 164:     $self<span style='color:#808030; '>-></span>get_mode_param<span style='color:#800080; '>;</span>
 165: 
 166:     %SES <span style='color:#808030; '>=</span> validate_session<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 167: <span style='color:#696969; '>#  It would be nice to distinquish failures that occur when people are</span>
 168: <span style='color:#696969; '>#  logged in, just not at a high enough level (ie, they are logged in</span>
 169: <span style='color:#696969; '>#  as editor, but the run mode requires them to be an admin). This isn't the way to</span>
 170: <span style='color:#696969; '>#  do it.</span>
 171: <span style='color:#696969; '>#  $SES{valid_idle} or print</span>
 172: <span style='color:#696969; '>#  CGI::header().err(title=>'Insufficient Authorization', msg=>'The</span>
 173: <span style='color:#696969; '>#  user you logged in as does not have permission to view this page.')</span>
 174: <span style='color:#696969; '>#  and exit;</span>
 175:     <span style='color:#800000; font-weight:bold; '>my</span> $start_mode <span style='color:#808030; '>=</span> $SES<span style='color:#808030; '>{</span>valid_idle<span style='color:#808030; '>}</span> <span style='color:#808030; '>?</span> $FORM<span style='color:#808030; '>{</span>rm<span style='color:#808030; '>}</span> <span style='color:#808030; '>:</span> <span style='color:#0000e6; '>'login'</span><span style='color:#800080; '>;</span> 
 176:     $self<span style='color:#808030; '>-></span>start_mode<span style='color:#808030; '>(</span>$start_mode<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 177: 
 178:     $self<span style='color:#808030; '>-></span>run_modes<span style='color:#808030; '>(</span>
 179:             <span style='color:#0000e6; '>'front_page'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'front_page'</span><span style='color:#808030; '>,</span>
 180: <span style='color:#696969; '># "cat" is just a short alias for "category_page"</span>
 181:             <span style='color:#0000e6; '>'cat'</span>          <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'category_page'</span><span style='color:#808030; '>,</span>
 182:             <span style='color:#0000e6; '>'category_page'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'category_page'</span><span style='color:#808030; '>,</span>
 183:             <span style='color:#0000e6; '>'item_add_form'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_add_form'</span><span style='color:#808030; '>,</span>
 184:             <span style='color:#0000e6; '>'item_suggest_add'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_suggest_add'</span><span style='color:#808030; '>,</span> 
 185:             <span style='color:#0000e6; '>'item_approve_add'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_approve_add'</span><span style='color:#808030; '>,</span>
 186:             item_approve_insert <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'item_approve_insert'</span><span style='color:#808030; '>,</span>
 187:             item_approve_update <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'item_approve_update'</span><span style='color:#808030; '>,</span>
 188:             <span style='color:#0000e6; '>'item_edit_form'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_edit_form'</span><span style='color:#808030; '>,</span>
 189:             <span style='color:#0000e6; '>'item_delete_checklist'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_delete_checklist'</span><span style='color:#808030; '>,</span>
 190:             <span style='color:#0000e6; '>'item_list_delete_urls'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_list_delete_urls'</span><span style='color:#808030; '>,</span>
 191: <span style='color:#696969; '># we make this alias so we can force editors to login when they visit urls via email to edit suggestions -mls</span>
 192:             item_edit_suggestion_form <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'item_edit_form'</span><span style='color:#808030; '>,</span>
 193:             <span style='color:#0000e6; '>'item_new'</span>    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'html_item_new'</span><span style='color:#808030; '>,</span>
 194:             <span style='color:#0000e6; '>'write_static_pages'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'write_static_pages'</span><span style='color:#808030; '>,</span>
 195:             <span style='color:#0000e6; '>'item_suggest_update'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_suggest_update'</span><span style='color:#808030; '>,</span>
 196:             <span style='color:#0000e6; '>'cat_add_form'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'cat_add_form'</span><span style='color:#808030; '>,</span>
 197:             <span style='color:#0000e6; '>'cat_add_process'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'cat_add_process'</span><span style='color:#808030; '>,</span>
 198:             <span style='color:#0000e6; '>'link_form'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'link_form'</span><span style='color:#808030; '>,</span>
 199:             <span style='color:#0000e6; '>'link_add'</span>  <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'link_add'</span><span style='color:#808030; '>,</span>
 200:             <span style='color:#0000e6; '>'link_edit'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'link_edit'</span><span style='color:#808030; '>,</span>
 201:             <span style='color:#0000e6; '>'link_delete'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'link_delete'</span><span style='color:#808030; '>,</span>
 202:             <span style='color:#0000e6; '>'cat_relate_form'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'cat_relate_form'</span><span style='color:#808030; '>,</span>
 203:             <span style='color:#0000e6; '>'cat_relate_update'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'cat_relate_update'</span><span style='color:#808030; '>,</span>
 204:             <span style='color:#0000e6; '>'cat_edit_form'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'cat_edit_form'</span><span style='color:#808030; '>,</span>
 205:             <span style='color:#0000e6; '>'cat_update'</span>    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'cat_update'</span><span style='color:#808030; '>,</span>
 206:             <span style='color:#0000e6; '>'cat_delete'</span>    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'cat_delete'</span><span style='color:#808030; '>,</span>
 207:             <span style='color:#0000e6; '>'item_delete'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_delete'</span><span style='color:#808030; '>,</span>
 208:             <span style='color:#0000e6; '>'needs_approval_summary'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'needs_approval_summary'</span><span style='color:#808030; '>,</span>
 209:             <span style='color:#0000e6; '>'unverified_urls_report'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'unverified_urls_report'</span><span style='color:#808030; '>,</span>
 210:             search_zip    <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'search_zip'</span><span style='color:#808030; '>,</span>
 211:             item_edit <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'item_edit'</span><span style='color:#808030; '>,</span>
 212:             item_suggest_update_form <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'item_suggest_update_form'</span><span style='color:#808030; '>,</span>
 213:             item_suggest_update_thanks <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'item_suggest_update_thanks'</span><span style='color:#808030; '>,</span>
 214:             login    <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'login_form'</span><span style='color:#808030; '>,</span>
 215:             login_process <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'login_process'</span><span style='color:#808030; '>,</span>
 216:             logout    <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'logout'</span><span style='color:#808030; '>,</span>
 217:             register_form <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'register_form'</span><span style='color:#808030; '>,</span>
 218:             register_process <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'register_process'</span><span style='color:#808030; '>,</span>
 219:             password_forgot_form <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'password_forgot_form'</span><span style='color:#808030; '>,</span>
 220:             password_mail_forgotten <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'password_mail_forgotten'</span><span style='color:#808030; '>,</span>
 221:             password_mail_success <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'password_mail_success'</span><span style='color:#808030; '>,</span>
 222:             item_view_comments <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'item_view_comments'</span><span style='color:#808030; '>,</span>
 223:             item_comment_post  <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'item_comment_post'</span><span style='color:#808030; '>,</span>
 224:             item_comments_delete <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'item_comments_delete'</span><span style='color:#808030; '>,</span>
 225:             item_include_comments <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'item_include_comments'</span><span style='color:#808030; '>,</span>
 226:             pvt_basic_info_update_form <span style='color:#808030; '>=></span> <span style='color:#800000; font-weight:bold; '>sub</span> <span style='color:#800080; '>{</span> <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>User</span><span style='color:#800080; '>;</span> <span style='color:#808030; '>&amp;</span>pvt_basic_info_update_form <span style='color:#800080; '>}</span><span style='color:#808030; '>,</span> 
 227:             pvt_home <span style='color:#808030; '>=></span> <span style='color:#800000; font-weight:bold; '>sub</span> <span style='color:#800080; '>{</span> <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>User</span><span style='color:#800080; '>;</span> <span style='color:#808030; '>&amp;</span>pvt_home <span style='color:#800080; '>}</span><span style='color:#808030; '>,</span> 
 228:             shared_home <span style='color:#808030; '>=></span> <span style='color:#800000; font-weight:bold; '>sub</span> <span style='color:#800080; '>{</span> <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>User</span><span style='color:#800080; '>;</span> <span style='color:#808030; '>&amp;</span>shared_home <span style='color:#800080; '>}</span><span style='color:#808030; '>,</span> 
 229:             pvt_basic_info_process <span style='color:#808030; '>=></span> <span style='color:#800000; font-weight:bold; '>sub</span> <span style='color:#800080; '>{</span> <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>User</span><span style='color:#800080; '>;</span> <span style='color:#808030; '>&amp;</span>pvt_basic_info_process <span style='color:#800080; '>}</span><span style='color:#808030; '>,</span> 
 230:             current_contributors <span style='color:#808030; '>=></span> <span style='color:#800000; font-weight:bold; '>sub</span> <span style='color:#800080; '>{</span> <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>User</span><span style='color:#800080; '>;</span> <span style='color:#808030; '>&amp;</span>current_contributors <span style='color:#800080; '>}</span><span style='color:#808030; '>,</span> 
 231:             historical_month_index <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'historical_month_index'</span><span style='color:#808030; '>,</span> 
 232:             historical_all_index <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'historical_all_index'</span><span style='color:#808030; '>,</span> 
 233:             AUTOLOAD           <span style='color:#808030; '>=></span> 
 234:                 <span style='color:#800000; font-weight:bold; '>sub</span> <span style='color:#800080; '>{</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Page not found'</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>"(the run mode tried was: $FORM</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>rm</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>)"</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>}</span>
 235:             <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 236: 
 237: <span style='color:#696969; '># This happens here so that we can declare $VERSION in Cascade.pm to make CPAN happy</span>
 238: <span style='color:#696969; '># but also have a copy in %CFG to make template management easier. -mls</span>
 239:             $CFG<span style='color:#808030; '>{</span>VERSION<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> $VERSION<span style='color:#800080; '>;</span>
 240: <span style='color:#800080; '>}</span>
 241: 
 242: <span style='color:#696969; '># use the first piece of PATH_INFO, or just look in $FORM{rm};</span>
 243: <span style='color:#800000; font-weight:bold; '>sub </span>get_mode_param <span style='color:#800080; '>{</span>
 244:    <span style='color:#696969; '># The run mode is the first chunk, the rest goes back into PATH_INFO</span>
 245:    <span style='color:#696969; '># We ignore any leading slashes</span>
 246:    <span style='color:#800000; font-weight:bold; '>my</span> $pi<span style='color:#800080; '>;</span>
 247:    <span style='color:#808030; '>(</span>$pi<span style='color:#808030; '>,</span> $ENV<span style='color:#808030; '>{</span>PATH_INFO<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $ENV<span style='color:#808030; '>{</span>PATH_INFO<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>m</span><span style='color:#800000; '>@</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>/</span><span style='color:#808030; '>*</span><span style='color:#808030; '>(</span><span style='color:#808030; '>[</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>/</span><span style='color:#808030; '>]</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#0000e6; '>/</span><span style='color:#808030; '>*</span><span style='color:#808030; '>(</span><span style='color:#808030; '>.</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>$</span><span style='color:#800000; '>@</span><span style='color:#800080; '>;</span>
 248: 
 249:   $FORM<span style='color:#808030; '>{</span>rm<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#400000; '>length</span> $pi<span style='color:#808030; '>)</span> <span style='color:#808030; '>?</span> $pi <span style='color:#808030; '>:</span> $FORM<span style='color:#808030; '>{</span>rm<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span> 
 250: <span style='color:#800080; '>}</span>
 251: 
 252: <span style='color:#808030; '>=pod</span><span style='color:#3f5fbf; '> </span>
 253: <span style='color:#3f5fbf; '></span>
 254: <span style='color:#808030; '>=head2</span><span style='color:#3f5fbf; '> A note about template namespaces</span><span style='color:#3f5fbf; '></span>
 255: <span style='color:#3f5fbf; '></span>
 256: <span style='color:#3f5fbf; '>A few prefixes in the template namespace are reserved for use by Cascade. These include:</span>
 257: <span style='color:#3f5fbf; '></span>
 258: <span style='color:#808030; '>=over </span><span style='color:#008c00; '>4</span><span style='color:#3f5fbf; '></span>
 259: <span style='color:#3f5fbf; '></span>
 260: <span style='color:#808030; '>=item</span><span style='color:#3f5fbf; '> * cfg_ -- variables from the CFG hash</span>
 261: <span style='color:#3f5fbf; '></span>
 262: <span style='color:#808030; '>=item</span><span style='color:#3f5fbf; '> * ses_ -- session variables</span>
 263: <span style='color:#3f5fbf; '></span>
 264: <span style='color:#808030; '>=item</span><span style='color:#3f5fbf; '> * err_ -- error variables</span>
 265: <span style='color:#3f5fbf; '></span>
 266: <span style='color:#808030; '>=item</span><span style='color:#3f5fbf; '> * role_ -- role variables </span>
 267: <span style='color:#3f5fbf; '></span>
 268: <span style='color:#808030; '>=back</span><span style='color:#3f5fbf; '></span>
 269: <span style='color:#3f5fbf; '></span>
 270: <span style='color:#808030; '>=cut</span>
 271: 
 272: <span style='color:#800000; font-weight:bold; '>sub </span>load_tmpl <span style='color:#800080; '>{</span>
 273:         <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 274:         <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$tmpl_file<span style='color:#808030; '>,</span> @extra_params<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @_<span style='color:#800080; '>;</span>
 275:  
 276:         <span style='color:#800000; font-weight:bold; '>my</span> $fq_tmpl_file <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>tmpl_path<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>.</span> $tmpl_file<span style='color:#800080; '>;</span>
 277:  
 278:         <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>HTML</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Template</span><span style='color:#800080; '>;</span>
 279:     <span style='color:#696969; '># set up the templates with some defaults</span>
 280:         <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>HTML</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Template</span><span style='color:#808030; '>-></span>new_file<span style='color:#808030; '>(</span>$fq_tmpl_file<span style='color:#808030; '>,</span> @extra_params<span style='color:#808030; '>,</span> %{ $CFG<span style='color:#808030; '>{</span>HTML_TMPL_DEFAULTS<span style='color:#808030; '>}</span> }<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 281: 
 282:     $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 283:         <span style='color:#696969; '># supply global config variables to the templates. Rather than pollute the name space</span>
 284:         <span style='color:#696969; '># let's prefix them with cfg_, dawg. </span>
 285:        <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>map</span> <span style='color:#800080; '>{</span>
 286:           <span style='color:#800000; font-weight:bold; '>my</span> $k <span style='color:#808030; '>=</span> $_<span style='color:#800080; '>;</span>
 287:           <span style='color:#0000e6; '>'CFG_'</span><span style='color:#808030; '>.</span>$k <span style='color:#808030; '>=</span><span style='color:#808030; '>></span>  $CFG<span style='color:#808030; '>{</span>$k<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
 288:        <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>keys</span> %CFG<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 289:        <span style='color:#696969; '># supply global session variables to the template</span>
 290:        <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>map</span> <span style='color:#800080; '>{</span>
 291:           <span style='color:#800000; font-weight:bold; '>my</span> $k <span style='color:#808030; '>=</span> $_<span style='color:#800080; '>;</span>
 292:           <span style='color:#0000e6; '>'SES_'</span><span style='color:#808030; '>.</span>$k <span style='color:#808030; '>=</span><span style='color:#808030; '>></span>  $SES<span style='color:#808030; '>{</span>$k<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
 293:        <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>keys</span> %SES<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 294:       <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 295:         <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#800080; '>;</span>
 296: <span style='color:#800080; '>}</span>
 297: 
 298: 
 299: <span style='color:#800000; font-weight:bold; '>sub </span>connect_db <span style='color:#800080; '>{</span>
 300: 
 301:     <span style='color:#800000; font-weight:bold; '>my</span> $dsn<span style='color:#800080; '>;</span>
 302:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$CFG<span style='color:#808030; '>{</span>DRIVER<span style='color:#808030; '>}</span> <span style='color:#808030; '>eq</span> <span style='color:#0000e6; '>'mysql'</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 303:         $dsn <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"DBI:$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>DRIVER</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>:database=$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>DATABASE</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>;host=$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>DBSERVER</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>;port=$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>DBPORT</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>"</span><span style='color:#800080; '>;</span>
 304:     <span style='color:#696969; '># Default to Postgres' style dsn for now</span>
 305:     <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
 306:         $dsn <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"dbi:$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>DRIVER</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>:dbname=$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>DATABASE</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>;"</span><span style='color:#808030; '>.</span>
 307:             <span style='color:#808030; '>(</span>$CFG<span style='color:#808030; '>{</span>DBSERVER<span style='color:#808030; '>}</span> <span style='color:#808030; '>and</span> <span style='color:#0000e6; '>"host=$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>DBSERVER</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>;"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>
 308:             <span style='color:#808030; '>(</span>$CFG<span style='color:#808030; '>{</span>DBOPTIONS<span style='color:#808030; '>}</span> <span style='color:#808030; '>and</span> <span style='color:#0000e6; '>"options=$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>DBOPTIONS</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>;"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>
 309:             <span style='color:#808030; '>(</span>$CFG<span style='color:#808030; '>{</span>DBPORT<span style='color:#808030; '>}</span> <span style='color:#808030; '>and</span> <span style='color:#0000e6; '>"port=$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>DBPORT</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>;"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 310:     <span style='color:#800080; '>}</span>        
 311:     
 312:     <span style='color:#800000; font-weight:bold; '>my</span> $rv <span style='color:#808030; '>=</span> $DBH <span style='color:#808030; '>=</span>  DBI<span style='color:#808030; '>-></span><span style='color:#400000; '>connect</span><span style='color:#808030; '>(</span>$dsn<span style='color:#808030; '>,</span>
 313:                $CFG<span style='color:#808030; '>{</span>DBUSER<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>$CFG<span style='color:#808030; '>{</span>DBPASS<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>
 314:                <span style='color:#800080; '>{</span>
 315:                    PrintError <span style='color:#808030; '>=></span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>
 316:                    RaiseError <span style='color:#808030; '>=></span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
 317:                <span style='color:#800080; '>}</span> <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 318:     <span style='color:#800000; font-weight:bold; '>return</span> $rv<span style='color:#800080; '>;</span>                
 319: <span style='color:#800080; '>}</span>
 320: 
 321: 
 322: 
 323: 
 324: 
 325: <span style='color:#696969; '># Establish some defaults and provide a template to call CGI::Err with.</span>
 326: <span style='color:#800000; font-weight:bold; '>sub </span>err <span style='color:#800080; '>{</span>
 327: 
 328:     <span style='color:#800000; font-weight:bold; '>my</span> %args <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>
 329:         debug    <span style='color:#808030; '>=></span> $DEBUG<span style='color:#808030; '>,</span>
 330:         @_
 331:     <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 332:     
 333:     <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>HTML</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Template</span><span style='color:#800080; '>;</span>
 334: 
 335:     <span style='color:#696969; '># We treat the header and footer differently since they rely on other values in the incoming hash. </span>
 336:     <span style='color:#800000; font-weight:bold; '>my</span> $tmpl <span style='color:#808030; '>=</span> new <span style='color:#bb7977; font-weight:bold; '>HTML</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Template</span><span style='color:#808030; '>(</span>
 337:         die_on_bad_params<span style='color:#808030; '>=></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
 338:         path<span style='color:#808030; '>=></span>$CFG<span style='color:#808030; '>{</span>HTML_TEMPLATE_ROOT<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>
 339:         filename<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'error.tmpl'</span>
 340:     <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 341:     
 342:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$args<span style='color:#808030; '>{</span>debug<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 343:         <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$package<span style='color:#808030; '>,</span> $file<span style='color:#808030; '>,</span> $line<span style='color:#808030; '>,</span> $sub<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>caller</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
 344:         <span style='color:#800000; font-weight:bold; '>my</span> $q <span style='color:#808030; '>=</span> new CGI<span style='color:#800080; '>;</span>
 345:         $args<span style='color:#808030; '>{</span>debugging_text<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"Package: $package&lt;BR> File: $file &lt;BR>Line: $line &lt;BR> Subroutine: $sub&lt;P>"</span> <span style='color:#808030; '>.</span>$q<span style='color:#808030; '>-></span>Dump<span style='color:#800080; '>;</span>
 346:     <span style='color:#800080; '>}</span>
 347: 
 348:     $args<span style='color:#808030; '>{</span>page_title<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> $args<span style='color:#808030; '>{</span>title<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
 349:     $tmpl<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>%args<span style='color:#808030; '>,</span>contact_email<span style='color:#808030; '>=></span>$CFG<span style='color:#808030; '>{</span>CONTACT_EMAIL<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 350: 
 351:     <span style='color:#800000; font-weight:bold; '>return</span> $tmpl<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
 352:   
 353: <span style='color:#800080; '>}</span>
 354: 
 355: 
 356: <span style='color:#696969; '># Currently not used</span>
 357: <span style='color:#696969; '># sub get_user_item_rating {</span>
 358: <span style='color:#696969; '>#   </span>
 359: <span style='color:#696969; '>#   my ($user_id, $item_id, $category_id) = @_;</span>
 360: <span style='color:#696969; '>#   </span>
 361: <span style='color:#696969; '>#   my $rating = $DBH->selectrow_array("select rating from rating </span>
 362: <span style='color:#696969; '>#       where (user_id = $user_id</span>
 363: <span style='color:#696969; '>#       and item_id = $item_id</span>
 364: <span style='color:#696969; '>#       and category_id = $category_id)");</span>
 365: <span style='color:#696969; '>#   </span>
 366: <span style='color:#696969; '>#   return $rating;</span>
 367: <span style='color:#696969; '># </span>
 368: <span style='color:#696969; '># }</span>
 369: 
 370: 
 371: 
 372: 
 373: <span style='color:#696969; '># Used to to check to see whether the Input URL is a valid category, returns the category_id if true,</span>
 374: <span style='color:#696969; '># or undef if false</span>
 375: <span style='color:#800000; font-weight:bold; '>sub </span>check_cat_url <span style='color:#800080; '>{</span>
 376:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 377:    <span style='color:#800000; font-weight:bold; '>my</span> $url <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 378:    <span style='color:#800000; font-weight:bold; '>my</span> @cat_ids<span style='color:#800080; '>;</span>
 379:     
 380:    <span style='color:#696969; '># Be forgiving about leading and trailing whitespace (delete it)</span>
 381:    $url <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>s</span><span style='color:#800000; '>/</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>\s</span><span style='color:#808030; '>+</span><span style='color:#800080; '>|</span><span style='color:#0000e6; '>\s</span><span style='color:#808030; '>+</span><span style='color:#808030; '>$</span><span style='color:#800000; '>/</span><span style='color:#800000; '>/</span><span style='color:#800000; font-weight:bold; '>g</span><span style='color:#800080; '>;</span>
 382: 
 383:    <span style='color:#696969; '># If it's a static page, we want to get rid of HTML_ROOT_URL first</span>
 384:    $url <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>s</span><span style='color:#800000; '>/</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>HTML_ROOT_URL</span><span style='color:#808030; '>}</span><span style='color:#800000; '>/</span><span style='color:#800000; '>/</span><span style='color:#800080; '>;</span>
 385:    
 386:    <span style='color:#696969; '># Undo encoding</span>
 387: 
 388:    <span style='color:#696969; '># underscores back to spaces</span>
 389:    $url <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>s</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>_</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '> </span><span style='color:#800000; '>/</span><span style='color:#800000; font-weight:bold; '>g</span><span style='color:#800080; '>;</span>
 390: 
 391:    <span style='color:#696969; '># x's, which represent characters that don't make good urls, get turned into %</span>
 392:    <span style='color:#696969; '># for SQL LIKE pattern matching. -mls</span>
 393:    $url <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>s</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>x</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>%</span><span style='color:#800000; '>/</span><span style='color:#800000; font-weight:bold; '>g</span><span style='color:#800080; '>;</span>
 394:     
 395:    <span style='color:#696969; '># Split into directory names</span>
 396:    <span style='color:#800000; font-weight:bold; '>my</span> @cats <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>split</span> <span style='color:#0000e6; '>"/"</span><span style='color:#808030; '>,</span> $url<span style='color:#800080; '>;</span>
 397: 
 398:    <span style='color:#696969; '># The first element of the array is probably a null troublemaker. -mls</span>
 399:    <span style='color:#800000; font-weight:bold; '>my</span> $discard <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span> @cats <span style='color:#800000; font-weight:bold; '>unless</span> $cats<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
 400:     
 401:    @cats <span style='color:#808030; '>=</span> <span style='color:#400000; '>reverse</span> @cats<span style='color:#800080; '>;</span>
 402:     
 403:    <span style='color:#696969; '># Create a SQL statement to see if this directory really exists. </span>
 404:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>@from_bits<span style='color:#808030; '>,</span> @where_bits<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 405:    <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> $i <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> $i <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span> $#cats<span style='color:#800080; '>;</span> $i<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 406:       <span style='color:#800000; font-weight:bold; '>my</span> $i1 <span style='color:#808030; '>=</span> $i<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
 407:       <span style='color:#400000; '>push</span> @from_bits<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"cas_category c$i"</span><span style='color:#800080; '>;</span>
 408:       <span style='color:#400000; '>push</span> @where_bits<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"c$i1.category_id = c$i.parent_id"</span> <span style='color:#800000; font-weight:bold; '>unless</span> $i <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> $#cats<span style='color:#800080; '>;</span>
 409:       <span style='color:#400000; '>push</span> @where_bits<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"c$i.name LIKE "</span><span style='color:#808030; '>.</span>$DBH<span style='color:#808030; '>-></span>quote<span style='color:#808030; '>(</span>$cats<span style='color:#808030; '>[</span>$i<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> 
 410:    <span style='color:#800080; '>}</span>
 411:     
 412:    <span style='color:#800000; font-weight:bold; '>my</span> $sql <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"SELECT c0.category_id FROM "</span><span style='color:#808030; '>.</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>join</span> <span style='color:#0000e6; '>', '</span><span style='color:#808030; '>,</span> @from_bits<span style='color:#808030; '>)</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>" WHERE "</span><span style='color:#808030; '>.</span><span style='color:#800000; font-weight:bold; '>join</span> <span style='color:#0000e6; '>"</span><span style='color:#0f69ff; '>\n</span><span style='color:#0000e6; '>and "</span><span style='color:#808030; '>,</span> @where_bits<span style='color:#800080; '>;</span>
 413:    $sql <span style='color:#808030; '>.</span><span style='color:#808030; '>=</span> <span style='color:#0000e6; '>" AND c$#cats.parent_id = </span><span style='color:#008c00; '>0</span><span style='color:#0000e6; '>"</span><span style='color:#800080; '>;</span>
 414:     
 415:    <span style='color:#800000; font-weight:bold; '>my</span> $cat_id <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span>$sql<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 416: 
 417:    <span style='color:#696969; '>#If we made it this far, all's good. Return the $target_id</span>
 418:    <span style='color:#800000; font-weight:bold; '>return</span> $cat_id<span style='color:#800080; '>;</span>
 419: <span style='color:#800080; '>}</span>
 420: 
 421: <span style='color:#696969; '># Before we compare a submitted URL to one in the database, let's reduce the chance that 2 equivalent URLS will appear different.</span>
 422: <span style='color:#696969; '># We can lowercase the URL, and chop off standard directory prefixes. </span>
 423: <span style='color:#800000; font-weight:bold; '>sub </span>base_url <span style='color:#800080; '>{</span>
 424:     <span style='color:#800000; font-weight:bold; '>my</span> $url <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 425:     $url <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>s</span><span style='color:#800000; '>%</span><span style='color:#808030; '>(</span><span style='color:#808030; '>.</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#0000e6; '>default</span><span style='color:#800080; '>|</span><span style='color:#0000e6; '>welcome</span><span style='color:#800080; '>|</span><span style='color:#0000e6; '>index</span><span style='color:#808030; '>)</span><span style='color:#0f69ff; '>\.</span><span style='color:#808030; '>(</span><span style='color:#0000e6; '>cgi</span><span style='color:#800080; '>|</span><span style='color:#0000e6; '>s</span><span style='color:#808030; '>?</span><span style='color:#0000e6; '>html</span><span style='color:#808030; '>?</span><span style='color:#800080; '>|</span><span style='color:#0000e6; '>tcl</span><span style='color:#800080; '>|</span><span style='color:#0000e6; '>adp</span><span style='color:#800080; '>|</span><span style='color:#0000e6; '>asp</span><span style='color:#800080; '>|</span><span style='color:#0000e6; '>pl</span><span style='color:#808030; '>)</span><span style='color:#808030; '>$</span><span style='color:#800000; '>%</span><span style='color:#0000e6; '>$1</span><span style='color:#800000; '>%</span><span style='color:#800000; font-weight:bold; '>i</span><span style='color:#800080; '>;</span>
 426:     <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#808030; '>(</span><span style='color:#400000; '>lc</span> $url<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 427: <span style='color:#800080; '>}</span>
 428: 
 429: <span style='color:#696969; '># returns the html page for "what's new" page</span>
 430: <span style='color:#696969; '># deprecated. May go away in favor of historical_* run modes</span>
 431: <span style='color:#800000; font-weight:bold; '>sub </span>html_item_new <span style='color:#800080; '>{</span>
 432:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 433:    <span style='color:#800000; font-weight:bold; '>my</span> $tbl <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span>most_recent<span style='color:#808030; '>(</span>$CFG<span style='color:#808030; '>{</span>BUILD_NEW_CUTOFF<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> 
 434:    <span style='color:#800000; font-weight:bold; '>my</span> %cats<span style='color:#800080; '>;</span>
 435:    <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> $row <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span> @$tbl<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 436:       <span style='color:#400000; '>push</span> @{ $cats<span style='color:#808030; '>{</span> $row<span style='color:#808030; '>-></span><span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>}</span> }<span style='color:#808030; '>,</span> $row<span style='color:#808030; '>-></span><span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span>
 437:    <span style='color:#800080; '>}</span>
 438: 
 439:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>@tmpl_cats<span style='color:#808030; '>,</span>$cut_off<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 440:    <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $cat_id <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>keys</span> %cats<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 441:       <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span>$cat_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 442:       <span style='color:#800000; font-weight:bold; '>my</span> %cat <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>multi_link<span style='color:#808030; '>=></span> $cat<span style='color:#808030; '>-></span>name<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'multi_link'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 443:       <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $item_id <span style='color:#808030; '>(</span>@{ $cats<span style='color:#808030; '>{</span>$cat_id<span style='color:#808030; '>}</span> }<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 444:      $cut_off<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#800080; '>;</span>
 445:      <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span>$item_id<span style='color:#808030; '>,</span>category_id<span style='color:#808030; '>=></span>$cat_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 446:      $cat<span style='color:#808030; '>{</span>items<span style='color:#808030; '>}</span> <span style='color:#808030; '>.</span><span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"&lt;LI>"</span><span style='color:#808030; '>.</span>$item<span style='color:#808030; '>-></span>output_html<span style='color:#808030; '>(</span>date_added<span style='color:#808030; '>=></span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>    
 447:       <span style='color:#800080; '>}</span>    
 448:       <span style='color:#400000; '>push</span> @tmpl_cats<span style='color:#808030; '>,</span> <span style='color:#808030; '>\</span>%cat<span style='color:#800080; '>;</span>
 449:    <span style='color:#800080; '>}</span>
 450:     
 451:    <span style='color:#800000; font-weight:bold; '>my</span> $tmpl <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'whats-new.tmpl'</span> <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 452:   
 453:    $tmpl<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 454:         whats_new            <span style='color:#808030; '>=></span> <span style='color:#808030; '>\</span>@tmpl_cats<span style='color:#808030; '>,</span>
 455:         cutoff                <span style='color:#808030; '>=></span> $cut_off<span style='color:#808030; '>,</span>
 456:         page_title            <span style='color:#808030; '>=></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'What</span><span style='color:#0f69ff; '>\'</span><span style='color:#0000e6; '>s New'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 457:         <span style='color:#808030; '>&amp;</span>footer_html_tmpl
 458:            <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 459:   
 460:    <span style='color:#800000; font-weight:bold; '>return</span> $tmpl<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
 461: <span style='color:#800080; '>}</span>
 462: 
 463: <span style='color:#800000; font-weight:bold; '>sub </span>historical_month_index <span style='color:#800080; '>{</span>
 464:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 465:    <span style='color:#696969; '># default to the current month </span>
 466:    <span style='color:#800000; font-weight:bold; '>my</span> $month <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> $FORM<span style='color:#808030; '>{</span>historical_month<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span> 
 467:    <span style='color:#696969; '># If nothing was passed in directly or in the form, this is the default view. </span>
 468:    <span style='color:#800000; font-weight:bold; '>my</span> $default<span style='color:#800080; '>;</span>
 469:    <span style='color:#800000; font-weight:bold; '>unless</span> <span style='color:#808030; '>(</span>$month<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 470:       $default <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
 471:       $month <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"SELECT date_trunc('month',CURRENT_DATE)"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 472:    <span style='color:#800080; '>}</span>
 473:    $month <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>quote<span style='color:#808030; '>(</span>$month<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 474: 
 475:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'historical-month-index.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 476: 
 477:    <span style='color:#696969; '># get all the item_ids for a month</span>
 478:    <span style='color:#800000; font-weight:bold; '>my</span> $items <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectcol_arrayref<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"select </span>
 479: <span style='color:#0000e6; '>    item_id </span>
 480: <span style='color:#0000e6; '>    from cas_item_approved</span>
 481: <span style='color:#0000e6; '>        WHERE date_trunc('month',COALESCE(historical_date,approved_date,insert_date)) =</span>
 482: <span style='color:#0000e6; '>            date_trunc('month',CAST($month AS DATE))</span>
 483: <span style='color:#0000e6; '>        ORDER BY COALESCE(historical_date,approved_date,insert_date) DESC "</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 484: 
 485:    <span style='color:#800000; font-weight:bold; '>my</span> $prev_month <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 486: <span style='color:#0000e6; '>        SELECT  date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date</span>
 487: <span style='color:#0000e6; '>    as previous_month</span>
 488: <span style='color:#0000e6; '>    FROM cas_item_approved</span>
 489: <span style='color:#0000e6; '>    WHERE date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date </span>
 490: <span style='color:#0000e6; '>        &lt; date_trunc('month',CAST($month AS DATE))</span>
 491: <span style='color:#0000e6; '>    ORDER BY date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date DESC</span>
 492: <span style='color:#0000e6; '>    LIMIT </span><span style='color:#008c00; '>1</span><span style='color:#0000e6; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 493: 
 494:    <span style='color:#696969; '># If there are no items in the default month,</span>
 495:    <span style='color:#696969; '># and there are in the previous month, return that instead. </span>
 496:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>not</span> <span style='color:#400000; '>scalar</span> @$items<span style='color:#808030; '>)</span> <span style='color:#808030; '>and</span> $prev_month <span style='color:#808030; '>and</span> $default<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 497:       <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>historical_month_index<span style='color:#808030; '>(</span>$prev_month<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 498:    <span style='color:#800080; '>}</span>
 499: 
 500:    <span style='color:#800000; font-weight:bold; '>my</span> @entries<span style='color:#800080; '>;</span>
 501:    <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span>@$items<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 502:       <span style='color:#696969; '># We use static mode here because currently the edit link won't work because</span>
 503:       <span style='color:#696969; '># we are requiring a category_id at the moment. -mls</span>
 504:        <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span>$_<span style='color:#808030; '>,</span>mode<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'static'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 505:     <span style='color:#400000; '>push</span> @entries<span style='color:#808030; '>,</span> <span style='color:#800080; '>{</span> <span style='color:#0000e6; '>'item_html'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $item<span style='color:#808030; '>-></span>output_html<span style='color:#808030; '>(</span>date_added<span style='color:#808030; '>=></span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 506:    <span style='color:#800080; '>}</span>
 507:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span> prev_month   <span style='color:#808030; '>=></span> $prev_month<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 508:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 509:       next_month   <span style='color:#808030; '>=></span>$DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 510: <span style='color:#0000e6; '>        SELECT  date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date</span>
 511: <span style='color:#0000e6; '>    as next_month</span>
 512: <span style='color:#0000e6; '>    FROM cas_item_approved</span>
 513: <span style='color:#0000e6; '>    WHERE date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date </span>
 514: <span style='color:#0000e6; '>        > date_trunc('month',CAST($month AS DATE))</span>
 515: <span style='color:#0000e6; '>    ORDER BY date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date ASC</span>
 516: <span style='color:#0000e6; '>    LIMIT </span><span style='color:#008c00; '>1</span><span style='color:#0000e6; '> "</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 517:      
 518:       <span style='color:#800000; font-weight:bold; '>my</span> $mode <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'static'</span> <span style='color:#800000; font-weight:bold; '>unless</span> $CFG<span style='color:#808030; '>{</span>DYNAMIC_ONLY_P<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
 519:      $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 520:       month_as_text<span style='color:#808030; '>=></span>$DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 521: <span style='color:#0000e6; '>        SELECT to_char(CAST($month AS DATE), 'FMMonth, YYYY') "</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 522:        entries<span style='color:#808030; '>=></span><span style='color:#808030; '>\</span>@entries<span style='color:#808030; '>,</span>
 523:       footer_html_tmpl<span style='color:#808030; '>(</span>$mode<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 524:      <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>    
 525:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
 526: <span style='color:#800080; '>}</span>
 527: 
 528: <span style='color:#696969; '># display historical index of all data. Pass in a year</span>
 529: <span style='color:#696969; '># directly or through the FORM to view just one year. -mls </span>
 530: <span style='color:#800000; font-weight:bold; '>sub </span>historical_all_index <span style='color:#800080; '>{</span>
 531:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 532:    <span style='color:#800000; font-weight:bold; '>my</span> %in <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>
 533:       year <span style='color:#808030; '>=></span> $FORM<span style='color:#808030; '>{</span>year<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>
 534:       @_<span style='color:#808030; '>,</span>
 535:      <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 536:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'historical-all-index.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 537: 
 538:    <span style='color:#800000; font-weight:bold; '>my</span> $LoH <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectall_arrayref<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"select </span>
 539: <span style='color:#0000e6; '>    extract(year from COALESCE(historical_date,approved_date,insert_date)::date) as year,</span>
 540: <span style='color:#0000e6; '>    to_char( COALESCE(historical_date,approved_date,insert_date)::date, 'FMMonth, YYYY') as month_as_text,</span>
 541: <span style='color:#0000e6; '>     date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date as month_as_date,</span>
 542: <span style='color:#0000e6; '>    count(item_id) as items_in_month</span>
 543: <span style='color:#0000e6; '>    from cas_item_approved "</span><span style='color:#808030; '>.</span>
 544:         <span style='color:#808030; '>(</span>$in<span style='color:#808030; '>{</span>year<span style='color:#808030; '>}</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> 
 545:        <span style='color:#0000e6; '>"WHERE extract(year from COALESCE(historical_date,approved_date,insert_date)::date) = "</span><span style='color:#808030; '>.</span>$DBH<span style='color:#808030; '>-></span>quote<span style='color:#808030; '>(</span>$in<span style='color:#808030; '>{</span>year<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>"</span>
 546: <span style='color:#0000e6; '>      GROUP BY year,month_as_text, month_as_date</span>
 547: <span style='color:#0000e6; '>      ORDER BY  month_as_date ASC"</span><span style='color:#808030; '>,</span> <span style='color:#800080; '>{</span> Slice <span style='color:#808030; '>=></span> <span style='color:#800080; '>{</span><span style='color:#800080; '>}</span> <span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 548: 
 549:    <span style='color:#800000; font-weight:bold; '>my</span> %years<span style='color:#800080; '>;</span>
 550:    <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span>@$LoH<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 551:       <span style='color:#800000; font-weight:bold; '>my</span> $y <span style='color:#808030; '>=</span> $_<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>year<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
 552:       $years<span style='color:#808030; '>{</span>$y<span style='color:#808030; '>}</span><span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>year<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> $y<span style='color:#800080; '>;</span>
 553:       $_<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>one_entry<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$_<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>items_in_month<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 554:       <span style='color:#696969; '># add the global we need inside this loop</span>
 555:       $_<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>cfg_cascade_cgi<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> $CFG<span style='color:#808030; '>{</span>CASCADE_CGI<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
 556:       <span style='color:#400000; '>push</span> @{ $years<span style='color:#808030; '>{</span>$y<span style='color:#808030; '>}</span><span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>months<span style='color:#808030; '>}</span> }<span style='color:#808030; '>,</span> $_<span style='color:#800080; '>;</span>
 557:    <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 558: 
 559:    <span style='color:#696969; '># If we are not in "dynamic only" mode, we want to show static links in the footer here.</span>
 560:    <span style='color:#800000; font-weight:bold; '>my</span> $mode <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'static'</span> <span style='color:#800000; font-weight:bold; '>unless</span> $CFG<span style='color:#808030; '>{</span>DYNAMIC_ONLY_P<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
 561:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 562:       page_title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>"Historical View of $CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>SYSTEM_NAME</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>"</span><span style='color:#808030; '>,</span>
 563:       footer_html_tmpl<span style='color:#808030; '>(</span>$mode<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 564:     <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 565:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>years<span style='color:#808030; '>=></span><span style='color:#808030; '>[</span><span style='color:#400000; '>sort</span> <span style='color:#800080; '>{</span> $b<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>year<span style='color:#808030; '>}</span> <span style='color:#40015a; '>&lt;=></span> $a<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>year<span style='color:#808030; '>}</span> <span style='color:#800080; '>}</span> <span style='color:#400000; '>values</span> %years <span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 566:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
 567: <span style='color:#800080; '>}</span>
 568: 
 569: <span style='color:#800000; font-weight:bold; '>sub </span>search_zip <span style='color:#800080; '>{</span>
 570:   <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 571: 
 572:   <span style='color:#696969; '># default to 50 miles. -mls</span>
 573:   <span style='color:#696969; '># XXX another candidate for moving to the config file</span>
 574:   <span style='color:#800000; font-weight:bold; '>my</span> $radius <span style='color:#808030; '>=</span> $FORM<span style='color:#808030; '>{</span><span style='color:#0000e6; '>'distance'</span><span style='color:#808030; '>}</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> <span style='color:#008c00; '>50</span><span style='color:#800080; '>;</span> 
 575: 
 576:   <span style='color:#696969; '># Convert kilometers to miles if needed</span>
 577:   <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>units<span style='color:#808030; '>}</span> <span style='color:#808030; '>eq</span> <span style='color:#0000e6; '>'kilometers'</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 578:     $radius <span style='color:#808030; '>*</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>.62140</span><span style='color:#800080; '>;</span>
 579:   <span style='color:#800080; '>}</span>
 580: 
 581:   <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span><span style='color:#0000e6; '>'zipcode'</span><span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>m</span><span style='color:#800000; '>/</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>\d</span><span style='color:#0000e6; '>\d</span><span style='color:#0000e6; '>\d</span><span style='color:#0000e6; '>\d</span><span style='color:#0000e6; '>\d</span><span style='color:#808030; '>$</span><span style='color:#800000; '>/</span> <span style='color:#808030; '>)</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span>
 582:     <span style='color:#808030; '>(</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span><span style='color:#0000e6; '>'city'</span><span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span><span style='color:#0000e6; '> </span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>\w</span><span style='color:#800000; '>/</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span><span style='color:#0000e6; '>'st'</span><span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span><span style='color:#0000e6; '> </span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>\w</span><span style='color:#800000; '>/</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>)</span> <span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 583:      <span style='color:#696969; '># We trim off the first 28 characters of the city because</span>
 584:      <span style='color:#696969; '># that's all that's in my zipcode database -mls</span>
 585:      <span style='color:#696969; '># Find all the zipcodes that have a close enough latitude or</span>
 586:      <span style='color:#696969; '># longitude</span>
 587:      <span style='color:#696969; '># it's important to join on the item table-- this speeds thing up</span>
 588:      <span style='color:#696969; '># A LOT In a less sophicated database (like MySQL), you could</span>
 589:      <span style='color:#696969; '># accomplish the same thing with 3 seperate selects</span>
 590:      <span style='color:#696969; '># If you are here to think about making this work for another</span>
 591:      <span style='color:#696969; '># database, note that I'm doing a number of functions in the</span>
 592:      <span style='color:#696969; '># database (substr,trim,upper), which are probably better done in</span>
 593:      <span style='color:#696969; '># Perl to be more portable.</span>
 594:     $DBH<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>RaiseError<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
 595:    <span style='color:#800000; font-weight:bold; '>my</span> $items<span style='color:#800080; '>;</span>
 596:     <span style='color:#800000; font-weight:bold; '>eval</span> <span style='color:#800080; '>{</span>
 597:        <span style='color:#800000; font-weight:bold; '>my</span> $matching_point <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 598: <span style='color:#0000e6; '>        SELECT lon_lat </span>
 599: <span style='color:#0000e6; '>      FROM cas_zipcodes zipcodes</span>
 600: <span style='color:#0000e6; '>          WHERE zipcode = trim("</span><span style='color:#808030; '>.</span>$DBH<span style='color:#808030; '>-></span>quote<span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>zipcode<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>")</span>
 601: <span style='color:#0000e6; '>        OR (city = substring(upper(trim("</span><span style='color:#808030; '>.</span>$DBH<span style='color:#808030; '>-></span>quote<span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>city<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>")) from </span><span style='color:#008c00; '>1</span><span style='color:#0000e6; '> for </span><span style='color:#008c00; '>28</span><span style='color:#0000e6; '>) </span>
 602: <span style='color:#0000e6; '>            AND state_code = upper("</span><span style='color:#808030; '>.</span>$DBH<span style='color:#808030; '>-></span>quote<span style='color:#808030; '>(</span> $FORM<span style='color:#808030; '>{</span>st<span style='color:#808030; '>}</span> <span style='color:#808030; '>)</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>"))"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 603:        $matching_point <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#400000; '>undef</span><span style='color:#800080; '>;</span>
 604:     $items <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectall_arrayref<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 605: <span style='color:#0000e6; '>SELECT item.*,category_id </span>
 606: <span style='color:#0000e6; '> FROM cas_item item, cas_category_item_map category_item_map</span>
 607: <span style='color:#0000e6; '> WHERE item.item_id = category_item_map.item_id </span>
 608: <span style='color:#0000e6; '>   AND postal_code IN (</span>
 609: <span style='color:#0000e6; '> SELECT distinct zipcode FROM cas_zipcodes zipcodes</span>
 610: <span style='color:#0000e6; '>   WHERE item.postal_code = zipcodes.zipcode</span>
 611: <span style='color:#0000e6; '>     AND (?::point &lt;@> lon_lat ) &lt; ? ) "</span><span style='color:#808030; '>,</span>
 612:     <span style='color:#800080; '>{</span>  Slice<span style='color:#808030; '>=></span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span> <span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
 613:         $matching_point<span style='color:#808030; '>,</span> $radius
 614:        <span style='color:#808030; '>)</span>
 615:       <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'No Results'</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Your search returned no results'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 616:     <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 617:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$@<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 618:        err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Database Error'</span><span style='color:#808030; '>,</span>
 619:        msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'There was a database error when searching. This error has been logged.'</span><span style='color:#808030; '>)</span>
 620:     <span style='color:#800080; '>}</span>
 621:     <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
 622:        <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>search_results<span style='color:#808030; '>(</span><span style='color:#400000; '>undef</span><span style='color:#808030; '>,</span>$items<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 623:     <span style='color:#800080; '>}</span>
 624:   <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
 625:     <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>TITLE <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'Missing Fields'</span><span style='color:#808030; '>,</span> MSG <span style='color:#808030; '>=></span> <span style='color:#800000; font-weight:bold; '>q</span><span style='color:#800000; '>{</span><span style='color:#0000e6; '>You Must specify a city and state or a zipcode to search. That's the breaks. </span><span style='color:#800000; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 626:   <span style='color:#800080; '>}</span>
 627: <span style='color:#800080; '>}</span>
 628: 
 629: 
 630: <span style='color:#800000; font-weight:bold; '>sub </span>search_results  <span style='color:#800080; '>{</span>
 631:   <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 632:   <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$cat_ref<span style='color:#808030; '>,</span> $item_ref<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @_<span style='color:#800080; '>;</span>
 633: 
 634:  <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'No matches found'</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'No results were found matching your query'</span><span style='color:#808030; '>)</span> 
 635:    <span style='color:#800000; font-weight:bold; '>unless</span> <span style='color:#808030; '>(</span>$item_ref <span style='color:#808030; '>or</span> $cat_ref<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 636:     
 637:   <span style='color:#800000; font-weight:bold; '>my</span> @cats<span style='color:#800080; '>;</span>
 638:   <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $row <span style='color:#808030; '>(</span>@$cat_ref<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 639:     <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$id<span style='color:#808030; '>,</span> $name<span style='color:#808030; '>,</span> $desc<span style='color:#808030; '>,</span> $items_below<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @$row<span style='color:#800080; '>;</span>
 640:     <span style='color:#800000; font-weight:bold; '>my</span>  $cat <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span>$id<span style='color:#808030; '>,</span>populate<span style='color:#808030; '>=></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 641:     <span style='color:#400000; '>push</span> @cats<span style='color:#808030; '>,</span> <span style='color:#800080; '>{</span> 
 642:       name         <span style='color:#808030; '>=></span> $cat<span style='color:#808030; '>-></span>relative<span style='color:#808030; '>(</span>$name<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 643:       items_below <span style='color:#808030; '>=></span> $items_below<span style='color:#808030; '>,</span>
 644:       description    <span style='color:#808030; '>=></span> $desc
 645:      <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>    
 646:   <span style='color:#800080; '>}</span>                 
 647:                       
 648:   <span style='color:#800000; font-weight:bold; '>my</span> @items<span style='color:#800080; '>;</span>
 649:   <span style='color:#696969; '># Note: I changed how this worked around 1.3.8</span>
 650:   <span style='color:#696969; '># instead of passing in an array of item ids, we are now passing in</span>
 651:   <span style='color:#696969; '># an array of hash references with item data</span>
 652:   <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $item_ref <span style='color:#808030; '>(</span>@$item_ref<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 653:     <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span>$item_ref<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>id<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>data<span style='color:#808030; '>=></span>$item_ref<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 654:     <span style='color:#400000; '>push</span> @items<span style='color:#808030; '>,</span> $item<span style='color:#808030; '>-></span>output_html<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 655:   <span style='color:#800080; '>}</span>
 656:     
 657:     <span style='color:#800000; font-weight:bold; '>my</span> $tmpl <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'search-results.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 658:           
 659:     $tmpl<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 660:       cats                <span style='color:#808030; '>=></span> <span style='color:#808030; '>\</span>@cats<span style='color:#808030; '>,</span>
 661:       items                <span style='color:#808030; '>=></span> <span style='color:#bb7977; font-weight:bold; '>CGI</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>li</span><span style='color:#808030; '>(</span><span style='color:#808030; '>[</span>@items<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 662:       <span style='color:#808030; '>&amp;</span>footer_html_tmpl
 663:      <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 664: 
 665:     <span style='color:#800000; font-weight:bold; '>return</span> $tmpl<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
 666: <span style='color:#800080; '>}</span>    
 667: 
 668: <span style='color:#800000; font-weight:bold; '>sub </span>illegal_chars <span style='color:#800080; '>{</span>
 669:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span><span style='color:#0000e6; '>'name'</span><span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>m</span><span style='color:#800000; '>/</span><span style='color:#808030; '>(</span><span style='color:#808030; '>[</span><span style='color:#0000e6; '>_</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800000; '>/</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 670:     <span style='color:#800000; font-weight:bold; '>my</span> $msg <span style='color:#808030; '>=</span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Your Name contained the illegal character"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>
 671:         <span style='color:#0000e6; '>" &lt;B></span><span style='color:#0000e6; '>$1</span><span style='color:#0000e6; '>&lt;/B>. "</span><span style='color:#808030; '>.</span>gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Go back and try again."</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 672:     <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title <span style='color:#808030; '>=></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Illegal Character"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> msg <span style='color:#808030; '>=></span> $msg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 673:      <span style='color:#800080; '>}</span>
 674: 
 675: <span style='color:#800080; '>}</span>
 676: 
 677: <span style='color:#696969; '># check to  see if a category already exists</span>
 678: <span style='color:#800000; font-weight:bold; '>sub </span>cat_already_exists <span style='color:#800080; '>{</span>
 679:     <span style='color:#696969; '># If they pass in a $cat_id, we assume this check is for an edit,</span>
 680:     <span style='color:#696969; '># otherwise we assume it's for an addition. If we have it's</span>
 681:     <span style='color:#696969; '># $cat_id, we can make sure it doesn't show up falsely as a</span>
 682:     <span style='color:#696969; '># duplicate of itself. -mls</span>
 683:     <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$name<span style='color:#808030; '>,</span>$parent_id<span style='color:#808030; '>,</span>$cat_id<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @_<span style='color:#800080; '>;</span>
 684:     <span style='color:#808030; '>(</span><span style='color:#400000; '>length</span> $name <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#400000; '>length</span> $parent_id<span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>die</span> <span style='color:#0000e6; '>"no category name and parent_id found"</span><span style='color:#800080; '>;</span> 
 685: 
 686:     <span style='color:#800000; font-weight:bold; '>my</span> @bind <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#400000; '>lc</span> $name<span style='color:#808030; '>,</span> $parent_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 687:     <span style='color:#800000; font-weight:bold; '>my</span> $sql <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"select category_id from cas_category</span>
 688: <span style='color:#0000e6; '>      where lower(name) =  ?</span>
 689: <span style='color:#0000e6; '>      and   parent_id = ? "</span><span style='color:#800080; '>;</span>
 690:       <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#400000; '>length</span> $cat_id<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 691:         <span style='color:#400000; '>push</span> @bind<span style='color:#808030; '>,</span> $cat_id<span style='color:#800080; '>;</span>
 692:         $sql <span style='color:#808030; '>.</span><span style='color:#808030; '>=</span> <span style='color:#0000e6; '>" category_id &lt;> ? "</span><span style='color:#800080; '>;</span>
 693:     <span style='color:#800080; '>}</span>
 694: 
 695:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>defined</span> $cat_id<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 696:          <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span>$cat_id<span style='color:#808030; '>,</span> mode<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'dynamic'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 697:          <span style='color:#800000; font-weight:bold; '>my</span> $msg <span style='color:#808030; '>=</span>  gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"The Category you have submitted "</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>
 698:              gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"is already in our database"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span> <span style='color:#0000e6; '>':&lt;P>'</span><span style='color:#808030; '>.</span>$cat<span style='color:#808030; '>-></span>name<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'plain'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>'&lt;P>'</span><span style='color:#808030; '>.</span>
 699:                  gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Try another!"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>    
 700:          <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title <span style='color:#808030; '>=></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Category Exists"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> msg <span style='color:#808030; '>=></span> $msg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 701:     <span style='color:#800080; '>}</span>                              
 702: <span style='color:#800080; '>}</span>
 703: 
 704: <span style='color:#696969; '># This tests for the case in which the category maps to directory name which is the same as an existing category</span>
 705: <span style='color:#800000; font-weight:bold; '>sub </span>conflicts_with_existing_cat <span style='color:#800080; '>{</span>
 706:     <span style='color:#800000; font-weight:bold; '>my</span> $name <span style='color:#808030; '>=</span> $FORM<span style='color:#808030; '>{</span>name<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
 707: 
 708:     <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#800080; '>;</span>
 709:     <span style='color:#800000; font-weight:bold; '>my</span> $enc_name <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span>encode_name<span style='color:#808030; '>(</span>$name<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 710: 
 711:     <span style='color:#400000; '>length</span> $FORM<span style='color:#808030; '>{</span>category_id<span style='color:#808030; '>}</span> <span style='color:#808030; '>and</span> <span style='color:#400000; '>length</span> $FORM<span style='color:#808030; '>{</span>parent_id<span style='color:#808030; '>}</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#400000; '>undef</span><span style='color:#800080; '>;</span>
 712:     <span style='color:#800000; font-weight:bold; '>my</span> $tbl <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectall_arrayref<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 713: <span style='color:#0000e6; '>        SELECT category_id, name</span>
 714: <span style='color:#0000e6; '>            FROM cas_category</span>
 715: <span style='color:#0000e6; '>            WHERE parent_id = ?</span>
 716: <span style='color:#0000e6; '>                AND category_id != ?</span>
 717: <span style='color:#0000e6; '>    "</span><span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$FORM<span style='color:#808030; '>{</span>parent_id<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>$FORM<span style='color:#808030; '>{</span>category_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 718:     
 719:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$tbl<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 720:         <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $row <span style='color:#808030; '>(</span>@$tbl<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 721:             <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$cat_id<span style='color:#808030; '>,</span> $name<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @$row<span style='color:#800080; '>;</span>
 722:             $name <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span>encode_name<span style='color:#808030; '>(</span>$name<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 723:             <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#400000; '>lc</span> $name<span style='color:#808030; '>)</span> <span style='color:#808030; '>eq</span> <span style='color:#808030; '>(</span><span style='color:#400000; '>lc</span> $enc_name<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 724:                 <span style='color:#800000; font-weight:bold; '>my</span> $msg <span style='color:#808030; '>=</span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"The Category you have submitted "</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>
 725:                     gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"conflicts with a pre-existing one named &lt;B>$name&lt;/B>"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>
 726:                     <span style='color:#0000e6; '>'&lt;P>'</span><span style='color:#808030; '>.</span>gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Try another!"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 727:                 <span style='color:#800000; font-weight:bold; '>return</span>     err<span style='color:#808030; '>(</span>title <span style='color:#808030; '>=></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Category Conflict"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> msg <span style='color:#808030; '>=></span> $msg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>    
 728:             <span style='color:#800080; '>}</span> 
 729:         <span style='color:#800080; '>}</span>
 730:     <span style='color:#800080; '>}</span>
 731: <span style='color:#800080; '>}</span>
 732: 
 733: <span style='color:#696969; '># is the user logged in as one of the passed in roles?</span>
 734: <span style='color:#696969; '># takes array of roles as input</span>
 735: <span style='color:#800000; font-weight:bold; '>sub </span>is_role <span style='color:#800080; '>{</span>
 736:    <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> @roles <span style='color:#808030; '>=</span> @_<span style='color:#808030; '>)</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#400000; '>undef</span><span style='color:#800080; '>;</span>
 737:     
 738:    <span style='color:#800000; font-weight:bold; '>my</span> $user_id <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 739: <span style='color:#0000e6; '>        SELECT user_id </span>
 740: <span style='color:#0000e6; '>        FROM cas_users</span>
 741: <span style='color:#0000e6; '>        WHERE role in  ("</span><span style='color:#808030; '>.</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>join</span> <span style='color:#0000e6; '>','</span><span style='color:#808030; '>,</span><span style='color:#800000; font-weight:bold; '>map</span> <span style='color:#800080; '>{</span> $DBH<span style='color:#808030; '>-></span>quote<span style='color:#808030; '>(</span>$_<span style='color:#808030; '>)</span> <span style='color:#800080; '>}</span> @roles<span style='color:#808030; '>)</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>")</span>
 742: <span style='color:#0000e6; '>            AND user_id = ?</span>
 743: <span style='color:#0000e6; '>    "</span><span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$SES<span style='color:#808030; '>{</span>user_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>    
 744:    <span style='color:#800000; font-weight:bold; '>return</span> $user_id<span style='color:#800080; '>;</span>
 745: <span style='color:#800080; '>}</span>
 746: 
 747: <span style='color:#800000; font-weight:bold; '>sub </span>item_id_from_title <span style='color:#800080; '>{</span>
 748:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$title<span style='color:#808030; '>,</span>$cat_id<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @_<span style='color:#800080; '>;</span>
 749:    $title <span style='color:#808030; '>and</span> $cat_id <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#400000; '>undef</span><span style='color:#800080; '>;</span>
 750:    <span style='color:#696969; '># strip leading and trailing new lines and spaces to make the form more copy/paste friendly</span>
 751:    $title <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>s</span><span style='color:#800000; '>/</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>\s</span><span style='color:#808030; '>+</span><span style='color:#800080; '>|</span><span style='color:#808030; '>[</span><span style='color:#0f69ff; '>\n</span><span style='color:#0f69ff; '>\r</span><span style='color:#0000e6; '>\s</span><span style='color:#808030; '>]</span><span style='color:#808030; '>+</span><span style='color:#808030; '>$</span><span style='color:#800000; '>/</span><span style='color:#800000; '>/</span><span style='color:#800080; '>;</span>
 752: 
 753:    <span style='color:#800000; font-weight:bold; '>return</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 754: <span style='color:#0000e6; '>        SELECT item.item_id </span>
 755: <span style='color:#0000e6; '>            FROM cas_item item, cas_category_item_map category_item_map</span>
 756: <span style='color:#0000e6; '>            WHERE lower(title) = ?</span>
 757: <span style='color:#0000e6; '>                AND item.item_id = category_item_map.item_id</span>
 758: <span style='color:#0000e6; '>                AND category_item_map.category_id = ? "</span><span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
 759:             <span style='color:#400000; '>lc</span> $title<span style='color:#808030; '>,</span> $cat_id
 760:         <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>     
 761: <span style='color:#800080; '>}</span>
 762: 
 763: 
 764: 
 765: <span style='color:#696969; '># prepare the content used in the html footer</span>
 766: <span style='color:#800000; font-weight:bold; '>sub </span>footer_html_tmpl <span style='color:#800080; '>{</span>
 767:    <span style='color:#800000; font-weight:bold; '>my</span> $mode <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 768:      <span style='color:#800000; font-weight:bold; '>my</span> %footer <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>
 769:          footer_cats                 <span style='color:#808030; '>=></span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>-></span>footer_cats<span style='color:#808030; '>(</span>$mode<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 770:         version                <span style='color:#808030; '>=></span> $CFG<span style='color:#808030; '>{</span>VERSION<span style='color:#808030; '>}</span>
 771:      <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 772:      <span style='color:#800000; font-weight:bold; '>return</span> %footer<span style='color:#800080; '>;</span>
 773: <span style='color:#800080; '>}</span>
 774: 
 775: <span style='color:#800000; font-weight:bold; '>sub </span>front_page <span style='color:#800080; '>{</span>
 776:   <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 777:   <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 778: 
 779:   <span style='color:#696969; '># If we are in static mode, we just redirect and we're done</span>
 780:   <span style='color:#800000; font-weight:bold; '>my</span> $user_id<span style='color:#800080; '>;</span>
 781:   <span style='color:#696969; '># I don't remember why I set max_includes to be 5. -mls </span>
 782:   <span style='color:#800000; font-weight:bold; '>my</span> $tmpl <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'front-page.tmpl'</span><span style='color:#808030; '>,</span> max_includes<span style='color:#808030; '>=></span><span style='color:#008c00; '>5</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 783: 
 784: 
 785:   <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$total_states<span style='color:#808030; '>,</span> $total_countries<span style='color:#808030; '>,</span> $total_resources<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 786:     <span style='color:#808030; '>(</span>$total_states<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 787: <span style='color:#0000e6; '>        SELECT count(distinct state) FROM cas_item WHERE state is not null and approval_state = 'approved' "</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 788: 
 789:     <span style='color:#808030; '>(</span>$total_countries<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 790: <span style='color:#0000e6; '>        SELECT count(distinct country) FROM cas_item WHERE country is not null and approval_state = 'approved' "</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 791: 
 792:     <span style='color:#808030; '>(</span>$total_resources<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 793: <span style='color:#0000e6; '>        SELECT count(*) FROM cas_item where approval_state = 'approved' "</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 794: 
 795:  <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$suggested_inserts<span style='color:#808030; '>,</span>$suggested_updates<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 796:   <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$SES<span style='color:#808030; '>{</span>role_admin<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 797:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$CFG<span style='color:#808030; '>{</span>DISPLAY_SUGGESTION_LINKS_P<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 798:       <span style='color:#808030; '>(</span>$suggested_inserts<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 799: <span style='color:#0000e6; '>         SELECT count(item.item_id)</span>
 800: <span style='color:#0000e6; '>            FROM cas_item item, cas_category_item_map category_item_map</span>
 801: <span style='color:#0000e6; '>            WHERE item.item_id = category_item_map.item_id AND item.approval_state = 'needs_approval'"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 802:       <span style='color:#808030; '>(</span>$suggested_updates<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 803: <span style='color:#0000e6; '>         SELECT count(item_update_id) FROM cas_item_suggested_updates"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 804:     <span style='color:#800080; '>}</span>
 805:     $tmpl<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span> any_links_verified <span style='color:#808030; '>=></span> 
 806:         $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 807: <span style='color:#0000e6; '>                SELECT item_id FROM cas_item WHERE url_verified_date is not null LIMIT </span><span style='color:#008c00; '>1</span><span style='color:#0000e6; '>"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 808:     $tmpl<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span> num_links_appear_stale <span style='color:#808030; '>=></span> 
 809:         $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 810: <span style='color:#0000e6; '>        SELECT count(item_id) FROM cas_item</span>
 811: <span style='color:#0000e6; '>            WHERE url like 'http%' </span>
 812: <span style='color:#0000e6; '>            AND</span>
 813: <span style='color:#0000e6; '>             ( url_verified_date is null )</span>
 814: <span style='color:#0000e6; '>               OR</span>
 815: <span style='color:#0000e6; '>             ( url_verified_date &lt; (CURRENT_DATE - '</span><span style='color:#008c00; '>30</span><span style='color:#0000e6; '> days'::interval)::date</span>
 816: <span style='color:#0000e6; '>                   AND url_verified_date is not null )"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 817:    <span style='color:#800080; '>}</span>
 818:     <span style='color:#696969; '># XXX editors will need their own select statement here</span>
 819:   
 820:   <span style='color:#800000; font-weight:bold; '>my</span> $subcats <span style='color:#808030; '>=</span> $cat<span style='color:#808030; '>-></span>sub_cats<span style='color:#800080; '>;</span> 
 821:   <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> $i <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> $i <span style='color:#808030; '>&lt;</span> @$subcats<span style='color:#800080; '>;</span> $i<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 822:      <span style='color:#696969; '># create a new category object</span>
 823:      <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> new <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span> <span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span> $subcats<span style='color:#808030; '>-></span><span style='color:#808030; '>[</span>$i<span style='color:#808030; '>]</span><span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>cat_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>        
 824:      <span style='color:#696969; '># get the subsubcats for this subcat, if any</span>
 825:      $subcats<span style='color:#808030; '>-></span><span style='color:#808030; '>[</span>$i<span style='color:#808030; '>]</span><span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>subcats<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> $cat<span style='color:#808030; '>-></span>sub_cats<span style='color:#808030; '>(</span>include_items_below<span style='color:#808030; '>=></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 826:   <span style='color:#800080; '>}</span>
 827:  
 828:   <span style='color:#696969; '># handle the "new items"</span>
 829:   <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$new_cutoff<span style='color:#808030; '>,</span>@new_items<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 830:   <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> $tbl <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span>most_recent<span style='color:#808030; '>(</span>$CFG<span style='color:#808030; '>{</span>FRONT_PAGE_NEW_CUTOFF<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 831:   <span style='color:#696969; '># You may wonder why we bother computing the cutoff here when we have it already in a config variable</span>
 832:   <span style='color:#696969; '># If the config variable says 10, and there are are only 9 items, this will correctly display "9"</span>
 833:   <span style='color:#696969; '># Instead of announcing there are 10 items when there aren't. -mls</span>
 834:      $new_cutoff <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>@$tbl <span style='color:#808030; '>&lt;</span> $CFG<span style='color:#808030; '>{</span>FRONT_PAGE_NEW_CUTOFF<span style='color:#808030; '>}</span> <span style='color:#808030; '>)</span> 
 835:        <span style='color:#808030; '>?</span> <span style='color:#400000; '>scalar</span> @$tbl
 836:      <span style='color:#808030; '>:</span> $CFG<span style='color:#808030; '>{</span>FRONT_PAGE_NEW_CUTOFF<span style='color:#808030; '>}</span> <span style='color:#800080; '>;</span>
 837:      <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $row <span style='color:#808030; '>(</span>@$tbl<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 838:     <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$item_id<span style='color:#808030; '>,</span>$cat_id<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @$row<span style='color:#800080; '>;</span>
 839:     <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span>$item_id<span style='color:#808030; '>,</span>category_id<span style='color:#808030; '>=></span>$cat_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 840:     <span style='color:#400000; '>push</span> @new_items<span style='color:#808030; '>,</span> <span style='color:#800080; '>{</span> item_html <span style='color:#808030; '>=></span> $item<span style='color:#808030; '>-></span>output_html<span style='color:#808030; '>(</span>style<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'short'</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 841:      <span style='color:#800080; '>}</span>    
 842:   <span style='color:#800080; '>}</span>
 843:      $tmpl<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 844:        new_items        <span style='color:#808030; '>=></span> <span style='color:#808030; '>\</span>@new_items<span style='color:#808030; '>,</span>
 845:        new_cutoff        <span style='color:#808030; '>=></span> $new_cutoff<span style='color:#808030; '>,</span>
 846:        suggested_inserts    <span style='color:#808030; '>=></span> $suggested_inserts<span style='color:#808030; '>,</span>
 847:        suggested_updates    <span style='color:#808030; '>=></span> $suggested_updates<span style='color:#808030; '>,</span>
 848:        any_suggestions        <span style='color:#808030; '>=></span> $suggested_updates<span style='color:#808030; '>+</span>$suggested_inserts<span style='color:#808030; '>,</span>
 849:        sub_cats            <span style='color:#808030; '>=></span> $subcats<span style='color:#808030; '>,</span>
 850:        role_admin         <span style='color:#808030; '>=></span> $SES<span style='color:#808030; '>{</span>role_admin<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>
 851:          total_resources        <span style='color:#808030; '>=></span> $total_resources<span style='color:#808030; '>,</span>
 852:          total_states        <span style='color:#808030; '>=></span> $total_states<span style='color:#808030; '>,</span>
 853:          total_countries        <span style='color:#808030; '>=></span> $total_countries<span style='color:#808030; '>,</span>
 854:          page_title                <span style='color:#808030; '>=></span> $CFG<span style='color:#808030; '>{</span>SYSTEM_NAME<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>
 855:          states_plural        <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'state'</span><span style='color:#808030; '>.</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>$total_states <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#0000e6; '>'s'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 856:          countries_plural    <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'countr'</span><span style='color:#808030; '>.</span><span style='color:#808030; '>(</span>$total_countries <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span> <span style='color:#808030; '>?</span> <span style='color:#0000e6; '>'y'</span> <span style='color:#808030; '>:</span> <span style='color:#0000e6; '>'ies'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 857:          items                <span style='color:#808030; '>=></span> $cat<span style='color:#808030; '>-></span>get_item_html<span style='color:#808030; '>,</span>
 858:         whats_new_link        <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>"$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>CASCADE_CGI</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>/historical_month_index"</span><span style='color:#808030; '>,</span>
 859:     <span style='color:#696969; '>#  ($FORM{mode} eq 'static') ? $CFG{WHATS_NEW_URL} : "$CFG{CASCADE_CGI}/historical_month_index",</span>
 860:         <span style='color:#808030; '>&amp;</span>footer_html_tmpl    
 861:      <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 862:   $tmpl<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'display_admin_links'</span><span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>mode<span style='color:#808030; '>}</span> <span style='color:#808030; '>eq</span> <span style='color:#0000e6; '>'dynamic'</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>and</span> $SES<span style='color:#808030; '>{</span>role_admin<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>        
 863:   $self<span style='color:#808030; '>-></span>header_props<span style='color:#808030; '>(</span><span style='color:#808030; '>-</span>expires<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'-3m'</span><span style='color:#808030; '>,</span><span style='color:#808030; '>-</span>type<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'text/html'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 864:   <span style='color:#800000; font-weight:bold; '>return</span> $tmpl<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
 865: <span style='color:#800080; '>}</span>
 866: 
 867: <span style='color:#800000; font-weight:bold; '>sub </span>category_page <span style='color:#800080; '>{</span>
 868:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 869:    <span style='color:#800000; font-weight:bold; '>my</span> $cat_id <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 870:    $cat_id <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#400000; '>length</span> $cat_id<span style='color:#808030; '>)</span> 
 871:      <span style='color:#808030; '>?</span> $cat_id  
 872:        <span style='color:#808030; '>:</span> <span style='color:#808030; '>(</span><span style='color:#400000; '>length</span> $FORM<span style='color:#808030; '>{</span>category_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> 
 873:      <span style='color:#808030; '>?</span> $FORM<span style='color:#808030; '>{</span>category_id<span style='color:#808030; '>}</span> 
 874:        <span style='color:#808030; '>:</span> $self<span style='color:#808030; '>-></span>check_cat_url<span style='color:#808030; '>(</span>$ENV<span style='color:#808030; '>{</span>PATH_INFO<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 875: 
 876:    <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span>$cat_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 877: 
 878:    <span style='color:#696969; '># If the category didn't work out, it could be because it was for category that</span>
 879:    <span style='color:#696969; '># has a static page, but doesn't have an entry in the database. </span>
 880:    <span style='color:#696969; '># For that rare case, we return people to the front page by using category_id zero instead. -mls</span>
 881:    <span style='color:#800000; font-weight:bold; '>unless</span> <span style='color:#808030; '>(</span>$cat<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 882:       <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>mode<span style='color:#808030; '>}</span> <span style='color:#808030; '>eq</span> <span style='color:#0000e6; '>'static'</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 883:      $self<span style='color:#808030; '>-></span>header_type<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'redirect'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 884:      $self<span style='color:#808030; '>-></span>header_props<span style='color:#808030; '>(</span><span style='color:#808030; '>-</span>url<span style='color:#808030; '>=></span>$CFG<span style='color:#808030; '>{</span>HTML_ROOT_URL<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> 
 885:      <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#800080; '>;</span>
 886:       <span style='color:#800080; '>}</span>
 887:       <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
 888:      <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>front_page<span style='color:#800080; '>;</span> 
 889:        <span style='color:#800080; '>}</span>
 890:    <span style='color:#800080; '>}</span>
 891: 
 892:    <span style='color:#696969; '>#if they want a static category, we redirect them</span>
 893:    <span style='color:#696969; '># redirecting the dynamic page would create a loop. -mls</span>
 894:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>mode<span style='color:#808030; '>}</span> <span style='color:#808030; '>eq</span> <span style='color:#0000e6; '>'static'</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 895:        $self<span style='color:#808030; '>-></span>header_type<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'redirect'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 896:        $self<span style='color:#808030; '>-></span>header_props<span style='color:#808030; '>(</span><span style='color:#808030; '>-</span>url<span style='color:#808030; '>=></span>$cat<span style='color:#808030; '>-></span>name<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'full_url'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> 
 897:    <span style='color:#800080; '>}</span>
 898:    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
 899:        <span style='color:#696969; '># make an exception for the top category</span>
 900:        <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>front_page <span style='color:#800000; font-weight:bold; '>if</span> $cat_id <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
 901: 
 902:        <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'category.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 903:        $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>$cat<span style='color:#808030; '>-></span>html_page<span style='color:#808030; '>(</span>user_id<span style='color:#808030; '>=></span>$SES<span style='color:#808030; '>{</span>user_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 904:        <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
 905:    <span style='color:#800080; '>}</span>
 906: <span style='color:#800080; '>}</span>
 907: 
 908: <span style='color:#800000; font-weight:bold; '>sub </span>item_add_form <span style='color:#800080; '>{</span>
 909:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 910:    <span style='color:#800000; font-weight:bold; '>my</span> $errs <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 911: 
 912:    <span style='color:#696969; '># If we aren't passed a type_id, we use the default for this category. </span>
 913:    <span style='color:#800000; font-weight:bold; '>my</span> $type_id <span style='color:#808030; '>=</span> $FORM<span style='color:#808030; '>{</span>type_id<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
 914:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>not</span> <span style='color:#400000; '>length</span> $type_id<span style='color:#808030; '>)</span> <span style='color:#808030; '>and</span> <span style='color:#808030; '>(</span><span style='color:#400000; '>length</span> $FORM<span style='color:#808030; '>{</span>category_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 915:       <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span>$FORM<span style='color:#808030; '>{</span>category_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 916:       $type_id <span style='color:#808030; '>=</span> $cat<span style='color:#808030; '>-></span>default_type_id<span style='color:#800080; '>;</span>  
 917:    <span style='color:#800080; '>}</span>
 918:    <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>category_id<span style='color:#808030; '>=></span>$FORM<span style='color:#808030; '>{</span>category_id<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>type_id<span style='color:#808030; '>=></span>$type_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 919:    $self<span style='color:#808030; '>-></span>header_props<span style='color:#808030; '>(</span><span style='color:#808030; '>-</span>expires<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'-3m'</span><span style='color:#808030; '>,</span><span style='color:#808030; '>-</span>type<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'text/html'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 920: 
 921:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'items/'</span><span style='color:#808030; '>.</span>$item<span style='color:#808030; '>-></span>type_tech_name<span style='color:#808030; '>.</span><span style='color:#0000e6; '>'-form.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 922:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 923:       $item<span style='color:#808030; '>-></span>html_form<span style='color:#808030; '>,</span>
 924:       %$errs
 925:      <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 926: 
 927:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span> 
 928: <span style='color:#800080; '>}</span>
 929: 
 930: <span style='color:#800000; font-weight:bold; '>sub </span>item_edit_form <span style='color:#800080; '>{</span>
 931:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 932:    <span style='color:#800000; font-weight:bold; '>my</span> $errs <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
 933:    <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>defined</span> $FORM<span style='color:#808030; '>{</span><span style='color:#0000e6; '>'item_id'</span><span style='color:#808030; '>}</span> <span style='color:#808030; '>or</span> $FORM<span style='color:#808030; '>{</span>title<span style='color:#808030; '>}</span> <span style='color:#808030; '>or</span> $FORM<span style='color:#808030; '>{</span>item_update_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span> 
 934:     <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title <span style='color:#808030; '>=></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Insufficient Information"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> 
 935:            msg <span style='color:#808030; '>=></span>
 936:              gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"There must be an item_id or title or item_update_id "</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>
 937:                gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"present to edit the item"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 938:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$ItemId<span style='color:#808030; '>,</span>$Table<span style='color:#808030; '>,</span>$orig_item_html<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 939:    <span style='color:#800000; font-weight:bold; '>my</span> $change_cat <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
 940:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>item_update_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 941:      $ItemId <span style='color:#808030; '>=</span> $FORM<span style='color:#808030; '>{</span>item_update_id<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
 942:      $Table <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'cas_item_suggested_updates'</span><span style='color:#800080; '>;</span>
 943:      
 944:    <span style='color:#800080; '>}</span>
 945: 
 946:    <span style='color:#696969; '># XXX For now we assume that if people are using a title to update the item</span>
 947:    <span style='color:#696969; '># They are a user</span>
 948:    <span style='color:#800000; font-weight:bold; '>elsif</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>not</span> $FORM<span style='color:#808030; '>{</span>item_id<span style='color:#808030; '>}</span> <span style='color:#808030; '>and</span> $FORM<span style='color:#808030; '>{</span>title<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 949:      $ItemId <span style='color:#808030; '>=</span> item_id_from_title<span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>title<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>$FORM<span style='color:#808030; '>{</span>category_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span>
 950:        <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'No Matches Found'</span><span style='color:#808030; '>,</span>
 951:        msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'There were no items found with that title in this category.                 Try returning to the category and copying and pasting the item title precisely.</span>
 952: <span style='color:#0000e6; '>                It</span><span style='color:#0f69ff; '>\'</span><span style='color:#0000e6; '>s also possible that the item no longer exists in the database, although </span>
 953: <span style='color:#0000e6; '>                it still appears on the website.         </span>
 954: <span style='color:#0000e6; '>                '</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 955:      $Table <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'cas_item'</span><span style='color:#800080; '>;</span>
 956:      $change_cat <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
 957:    <span style='color:#800080; '>}</span>
 958:    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>     
 959:      $ItemId <span style='color:#808030; '>=</span> $FORM<span style='color:#808030; '>{</span>item_id<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
 960:      $Table <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'cas_item'</span><span style='color:#800080; '>;</span>
 961:    <span style='color:#800080; '>}</span>    
 962:    <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>
 963:      category_id<span style='color:#808030; '>=></span>$FORM<span style='color:#808030; '>{</span>category_id<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>
 964:     id<span style='color:#808030; '>=></span>$ItemId<span style='color:#808030; '>,</span>
 965:     table<span style='color:#808030; '>=></span>$Table<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>  
 966:    $item <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'No Item Found'</span><span style='color:#808030; '>,</span> msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'No Item found with that item_id'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 967:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'items/'</span><span style='color:#808030; '>.</span>$item<span style='color:#808030; '>-></span>type_tech_name<span style='color:#808030; '>.</span><span style='color:#0000e6; '>'-form.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 968: 
 969:     <span style='color:#696969; '># Get the HTML for the original item to display as a comparison (if that applies)</span>
 970:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$Table <span style='color:#808030; '>eq</span> <span style='color:#0000e6; '>'cas_item_suggested_updates'</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 971:       <span style='color:#800000; font-weight:bold; '>my</span> $orig_item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span>$item<span style='color:#808030; '>-></span>field<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'item_id'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 972:       $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>orig_item_html<span style='color:#808030; '>=></span>$orig_item<span style='color:#808030; '>-></span>output_html<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 973:    <span style='color:#800080; '>}</span>
 974:       
 975:    $self<span style='color:#808030; '>-></span>header_props<span style='color:#808030; '>(</span><span style='color:#808030; '>-</span>expires<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'-3m'</span><span style='color:#808030; '>,</span><span style='color:#808030; '>-</span>type<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'text/html'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 976:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 977:       $item<span style='color:#808030; '>-></span>html_form<span style='color:#808030; '>(</span>change_category<span style='color:#808030; '>=></span>$change_cat<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 978:       %$errs<span style='color:#808030; '>,</span>
 979:  <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 980:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span> 
 981: <span style='color:#800080; '>}</span>
 982: 
 983: <span style='color:#800000; font-weight:bold; '>sub </span>item_suggest_add <span style='color:#800080; '>{</span>
 984:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span> 
 985:    
 986:    <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>category_id<span style='color:#808030; '>=></span>$FORM<span style='color:#808030; '>{</span>category_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 987:    
 988:    $item<span style='color:#808030; '>-></span>validate_form<span style='color:#800080; '>;</span>
 989: 
 990:    <span style='color:#696969; '># if there are errors, return the errors</span>
 991:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$item<span style='color:#808030; '>-></span>missing <span style='color:#808030; '>or</span> $item<span style='color:#808030; '>-></span>invalid<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 992:       <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>HTML</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>FillInForm</span><span style='color:#800080; '>;</span>
 993:       <span style='color:#800000; font-weight:bold; '>my</span> $fif <span style='color:#808030; '>=</span> new <span style='color:#bb7977; font-weight:bold; '>HTML</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>FillInForm</span><span style='color:#800080; '>;</span>
 994:       <span style='color:#800000; font-weight:bold; '>return</span> $fif<span style='color:#808030; '>-></span>fill<span style='color:#808030; '>(</span>
 995:      scalarref <span style='color:#808030; '>=></span> <span style='color:#808030; '>\</span>$self<span style='color:#808030; '>-></span>item_add_form<span style='color:#808030; '>(</span>
 996:         error_marks<span style='color:#808030; '>(</span> <span style='color:#808030; '>[</span> $item<span style='color:#808030; '>-></span>missing <span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span> $item<span style='color:#808030; '>-></span>invalid <span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> $item<span style='color:#808030; '>-></span>validation_msgs <span style='color:#808030; '>)</span>    
 997:        <span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 998:      fobject <span style='color:#808030; '>=></span> $self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 999:    <span style='color:#800080; '>}</span>
1000: 
1001:    <span style='color:#800000; font-weight:bold; '>my</span> %params <span style='color:#808030; '>=</span> $item<span style='color:#808030; '>-></span>already_exists<span style='color:#800080; '>;</span>
1002:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$params<span style='color:#808030; '>{</span>self_html<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1003:       <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'item-duplicate.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1004:       $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>%params<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1005:       <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1006:    <span style='color:#800080; '>}</span>
1007: 
1008:    <span style='color:#696969; '># are we suggesting an update are actually making one? </span>
1009:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$send_alerts_p<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1010:    <span style='color:#800000; font-weight:bold; '>unless</span> <span style='color:#808030; '>(</span>$SES<span style='color:#808030; '>{</span>role_admin<span style='color:#808030; '>}</span> <span style='color:#808030; '>or</span> $SES<span style='color:#808030; '>{</span>role_editor<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1011:       $send_alerts_p <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
1012:    <span style='color:#800080; '>}</span>
1013:    
1014:    <span style='color:#696969; '># add the item to the database</span>
1015:    <span style='color:#800000; font-weight:bold; '>my</span> $item_id<span style='color:#800080; '>;</span>
1016:    <span style='color:#800000; font-weight:bold; '>eval</span> <span style='color:#800080; '>{</span> $item_id <span style='color:#808030; '>=</span> $item<span style='color:#808030; '>-></span>insert <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1017:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$@<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1018:       <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Insert Failed'</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>"The item could not be inserted due to the following error:&lt;BR></span><span style='color:#0000e6; '>$@</span><span style='color:#0000e6; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1019:    <span style='color:#800080; '>}</span>    
1020: 
1021:    <span style='color:#696969; '># send email alerts </span>
1022:    $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span>$item_id<span style='color:#808030; '>,</span>category_id<span style='color:#808030; '>=></span>$FORM<span style='color:#808030; '>{</span>category_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1023:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> $msg <span style='color:#808030; '>=</span> $item<span style='color:#808030; '>-></span>send_alerts<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1024:      <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'emails/item-alert-new.txt'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1025:      $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span> $msg <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1026:      <span style='color:#400000; '>open</span><span style='color:#808030; '>(</span>MAIL<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"|$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>MAILPROG</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>    -t"</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> 
1027:        err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Error Opening Mail Program'</span><span style='color:#808030; '>,</span> msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'There was an error opening the mail program'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1028:      <span style='color:#800000; font-weight:bold; '>print</span> MAIL $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1029:      <span style='color:#400000; '>close</span><span style='color:#808030; '>(</span>MAIL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1030:    <span style='color:#800080; '>}</span>
1031: 
1032: 
1033:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$SES<span style='color:#808030; '>{</span>role_editor<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1034:       <span style='color:#696969; '># Return to the category_id we came from. </span>
1035:       <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>category_page<span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>orig_category_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1036:    <span style='color:#800080; '>}</span>
1037:    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1038:       <span style='color:#696969; '># XXX We should probably eventually great a page to thank people specifically for suggesting</span>
1039:       <span style='color:#696969; '># an addition, but the current message is generic enough for now. -mls </span>
1040:       <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>item_suggest_update_thanks<span style='color:#800080; '>;</span>
1041:    <span style='color:#800080; '>}</span>
1042: <span style='color:#800080; '>}</span>
1043: 
1044: <span style='color:#800000; font-weight:bold; '>sub </span>item_suggest_update_form <span style='color:#800080; '>{</span>
1045:   <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1046:   <span style='color:#800000; font-weight:bold; '>defined</span> $FORM<span style='color:#808030; '>{</span>category_id<span style='color:#808030; '>}</span> <span style='color:#808030; '>or</span> 
1047:     <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title <span style='color:#808030; '>=></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"No Category ID specified"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> 
1048:      msg <span style='color:#808030; '>=></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"There must be a category_id "</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"present for this script to work"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1049:      
1050:   <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span>$FORM<span style='color:#808030; '>{</span>category_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1051: 
1052:   <span style='color:#800000; font-weight:bold; '>my</span> $tmpl <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'item-suggest-update.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1053:   $tmpl<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
1054:     plain      <span style='color:#808030; '>=></span> $cat<span style='color:#808030; '>-></span>name<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'plain'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
1055:     category_id <span style='color:#808030; '>=></span> $FORM<span style='color:#808030; '>{</span>category_id<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>
1056:     mode    <span style='color:#808030; '>=></span> $FORM<span style='color:#808030; '>{</span>mode<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>
1057:     <span style='color:#808030; '>&amp;</span>footer_html_tmpl
1058:    <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1059:   <span style='color:#800000; font-weight:bold; '>return</span> $tmpl<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1060: <span style='color:#800080; '>}</span>
1061: 
1062: <span style='color:#800000; font-weight:bold; '>sub </span>item_edit <span style='color:#800080; '>{</span>
1063:   <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1064: 
1065:    <span style='color:#808030; '>(</span><span style='color:#400000; '>length</span> $FORM<span style='color:#808030; '>{</span><span style='color:#0000e6; '>'item_id'</span><span style='color:#808030; '>}</span> <span style='color:#808030; '>or</span> $FORM<span style='color:#808030; '>{</span>item_update_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span> 
1066:     <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title <span style='color:#808030; '>=></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Insufficient Information"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> 
1067:            msg <span style='color:#808030; '>=></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"There must be an item_id or item_update_id "</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>
1068:                gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"present to edit the item"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1069:   <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$ItemId<span style='color:#808030; '>,</span>$Table<span style='color:#808030; '>,</span>$return_mode<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1070:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>item_update_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1071:      $ItemId <span style='color:#808030; '>=</span> $FORM<span style='color:#808030; '>{</span>item_update_id<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
1072:      $Table <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'cas_item_suggested_updates'</span><span style='color:#800080; '>;</span>
1073:      $return_mode <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'needs_approval_summary'</span>
1074:    <span style='color:#800080; '>}</span>
1075:    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>     
1076:      $ItemId <span style='color:#808030; '>=</span> $FORM<span style='color:#808030; '>{</span>item_id<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
1077:      $Table <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'cas_item'</span><span style='color:#800080; '>;</span>
1078:    <span style='color:#800080; '>}</span>
1079: 
1080:   <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>
1081:     <span style='color:#696969; '>#category_id=>$FORM{category_id},</span>
1082:     id<span style='color:#808030; '>=></span>$ItemId<span style='color:#808030; '>,</span>
1083:     table<span style='color:#808030; '>=></span>$Table <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1084:   $return_mode <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span><span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>$item<span style='color:#808030; '>-></span>field<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'approval_state'</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>eq</span> <span style='color:#0000e6; '>'needs_approval'</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>?</span> <span style='color:#0000e6; '>'needs_approval_summary'</span> <span style='color:#808030; '>:</span> <span style='color:#0000e6; '>'category_page'</span><span style='color:#800080; '>;</span>
1085:   
1086: 
1087:   $item<span style='color:#808030; '>-></span>validate_form<span style='color:#800080; '>;</span>
1088: 
1089:    <span style='color:#696969; '># if there are errors, return the errors</span>
1090:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$item<span style='color:#808030; '>-></span>missing <span style='color:#808030; '>or</span> $item<span style='color:#808030; '>-></span>invalid<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1091:       <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>HTML</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>FillInForm</span><span style='color:#800080; '>;</span>
1092:       <span style='color:#800000; font-weight:bold; '>my</span> $fif <span style='color:#808030; '>=</span> new <span style='color:#bb7977; font-weight:bold; '>HTML</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>FillInForm</span><span style='color:#800080; '>;</span>
1093:       <span style='color:#800000; font-weight:bold; '>return</span> $fif<span style='color:#808030; '>-></span>fill<span style='color:#808030; '>(</span>
1094:      scalarref <span style='color:#808030; '>=></span> <span style='color:#808030; '>\</span>$self<span style='color:#808030; '>-></span>item_edit_form<span style='color:#808030; '>(</span> 
1095:         error_marks<span style='color:#808030; '>(</span> <span style='color:#808030; '>[</span> $item<span style='color:#808030; '>-></span>missing <span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span> $item<span style='color:#808030; '>-></span>invalid <span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> $item<span style='color:#808030; '>-></span>validation_msgs<span style='color:#808030; '>)</span>
1096:        <span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
1097:      fobject <span style='color:#808030; '>=></span> $self<span style='color:#808030; '>-></span>query
1098:     <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1099:    <span style='color:#800080; '>}</span>
1100: 
1101:    <span style='color:#800000; font-weight:bold; '>my</span> %params <span style='color:#808030; '>=</span> $item<span style='color:#808030; '>-></span>already_exists<span style='color:#800080; '>;</span>
1102:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$params<span style='color:#808030; '>{</span>self_html<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1103:       <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'item-duplicate.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1104:       $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>%params<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1105:       <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1106:    <span style='color:#800080; '>}</span>
1107: 
1108:     <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $field <span style='color:#808030; '>(</span><span style='color:#0000e6; '>'state'</span><span style='color:#808030; '>,</span><span style='color:#0000e6; '>'country'</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1109:         $self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>-></span>Delete<span style='color:#808030; '>(</span>$field<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#400000; '>length</span>  $self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>$field<span style='color:#808030; '>)</span> <span style='color:#808030; '>)</span> <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1110:     <span style='color:#800080; '>}</span>
1111: 
1112:   <span style='color:#696969; '># Users just suggest edits, editors and admins actually make them</span>
1113:   <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$SES<span style='color:#808030; '>{</span>role_admin<span style='color:#808030; '>}</span> <span style='color:#808030; '>or</span> $SES<span style='color:#808030; '>{</span>role_editor<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1114:     <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Admin</span><span style='color:#800080; '>;</span>
1115:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$item<span style='color:#808030; '>-></span>update<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1116:        <span style='color:#696969; '># update this form variable to return the category we came from. </span>
1117:        $FORM<span style='color:#808030; '>{</span>category_id<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> $FORM<span style='color:#808030; '>{</span>orig_category_id<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
1118:        <span style='color:#696969; '># XXX It's only safe for admins to use this internal redirection</span>
1119:        <span style='color:#696969; '># because it by-passes the auth checking for run modes in setup(). -mls</span>
1120:        <span style='color:#696969; '># If $FORM{return_rm} is present, it supercedes the default return_mode. </span>
1121:        $return_mode <span style='color:#808030; '>=</span> $FORM<span style='color:#808030; '>{</span>return_rm<span style='color:#808030; '>}</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> $return_mode<span style='color:#800080; '>;</span>
1122:        <span style='color:#800000; font-weight:bold; '>my</span> $out <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>eval</span><span style='color:#808030; '>(</span><span style='color:#0000e6; '>'$self->'</span><span style='color:#808030; '>.</span>$return_mode<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> 
1123:        $@ <span style='color:#808030; '>?</span> <span style='color:#800000; font-weight:bold; '>die</span> <span style='color:#0000e6; '>"error run mode $return_mode was </span><span style='color:#0000e6; '>$@</span><span style='color:#0000e6; '>"</span><span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>return</span> $out<span style='color:#800080; '>;</span>
1124:     <span style='color:#800080; '>}</span>
1125:     <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1126:        err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Item Not Updated'</span><span style='color:#808030; '>,</span>
1127:         msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'The item was not updated. The database returned the error: '</span><span style='color:#808030; '>.</span>$DBI::errstr<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1128:     <span style='color:#800080; '>}</span>
1129:   <span style='color:#800080; '>}</span>
1130:   <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1131:      <span style='color:#800000; font-weight:bold; '>my</span> $update_id<span style='color:#800080; '>;</span>
1132:       <span style='color:#800000; font-weight:bold; '>eval</span> <span style='color:#800080; '>{</span>$update_id <span style='color:#808030; '>=</span> $item<span style='color:#808030; '>-></span>suggest_update<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1133:       $@ <span style='color:#808030; '>and</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Insert Failed'</span><span style='color:#808030; '>,</span>
1134:     msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>"Inserting that suggested update failed with an unexpected error.</span>
1135: <span style='color:#0000e6; '>                   The error was: </span><span style='color:#0000e6; '>$@</span><span style='color:#0000e6; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1136:       <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> $msg <span style='color:#808030; '>=</span> $item<span style='color:#808030; '>-></span>send_alerts<span style='color:#808030; '>(</span>$update_id<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1137:      <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'emails/item-alert-update.txt'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1138:      $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>$msg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1139:      <span style='color:#400000; '>open</span><span style='color:#808030; '>(</span>MAIL<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"|$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>MAILPROG</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '> -t"</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> 
1140:        err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Error Opening Mail Program'</span><span style='color:#808030; '>,</span> msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'There was an error opening the mail program'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1141:      <span style='color:#800000; font-weight:bold; '>print</span> MAIL $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1142:      <span style='color:#400000; '>close</span><span style='color:#808030; '>(</span>MAIL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1143:        <span style='color:#800080; '>}</span>
1144:      <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>item_suggest_update_thanks
1145:   <span style='color:#800080; '>}</span>
1146: <span style='color:#800080; '>}</span>
1147: 
1148: <span style='color:#800000; font-weight:bold; '>sub </span>item_suggest_update_thanks <span style='color:#800080; '>{</span>
1149:   <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1150:   <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'item_suggest_update_thanks.html'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1151:   $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>footer_html_tmpl<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1152:   <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1153: <span style='color:#800080; '>}</span>
1154: 
1155: <span style='color:#800000; font-weight:bold; '>sub </span>login_form <span style='color:#800080; '>{</span>
1156:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1157: 
1158:    <span style='color:#800000; font-weight:bold; '>my</span> $return_rm<span style='color:#800080; '>;</span>
1159:    <span style='color:#696969; '># If we have been passed an explicit return_rm, we use that first. </span>
1160:    <span style='color:#800080; '>{</span>
1161:       <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#400000; '>length</span> $FORM<span style='color:#808030; '>{</span>return_rm<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> $return_rm <span style='color:#808030; '>=</span> $FORM<span style='color:#808030; '>{</span>return_rm<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span> <span style='color:#800000; font-weight:bold; '>last</span> <span style='color:#800080; '>}</span>
1162:       
1163:       <span style='color:#696969; '># If we are being call from another run mode, we return there.</span>
1164:       <span style='color:#696969; '># Otherwise, we return to their homepage </span>
1165:       $return_rm <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>rm<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>m</span><span style='color:#800000; '>/</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>login</span><span style='color:#800000; '>/</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>?</span> <span style='color:#0000e6; '>'pvt_home'</span> <span style='color:#808030; '>:</span> $FORM<span style='color:#808030; '>{</span>rm<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
1166:    <span style='color:#800080; '>}</span>
1167: 
1168:    <span style='color:#696969; '># If we are not in "dynamic only" mode, we want to show static links in the footer here.</span>
1169:    $FORM<span style='color:#808030; '>{</span>mode<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'static'</span> <span style='color:#800000; font-weight:bold; '>unless</span> $CFG<span style='color:#808030; '>{</span>DYNAMIC_ONLY_P<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
1170: 
1171:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'register-index.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1172: 
1173:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span> 
1174:       referred    <span style='color:#808030; '>=></span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>rm<span style='color:#808030; '>}</span> <span style='color:#808030; '>ne</span> <span style='color:#0000e6; '>'login'</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>and</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
1175:       return_rm   <span style='color:#808030; '>=></span> $return_rm<span style='color:#808030; '>,</span>
1176:       query_string <span style='color:#808030; '>=></span> $self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>-></span>escapeHTML<span style='color:#808030; '>(</span>$self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>-></span>query_string<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
1177:      footer_html_tmpl<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1178: 
1179:    <span style='color:#696969; '># Expire the existing cookie, just for good measure. </span>
1180:    $self<span style='color:#808030; '>-></span>header_props<span style='color:#808030; '>(</span><span style='color:#808030; '>-</span>cookie<span style='color:#808030; '>=></span>create_cookie<span style='color:#808030; '>(</span>$SES<span style='color:#808030; '>{</span>session_id<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span><span style='color:#0000e6; '>'-3M'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1181:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1182: <span style='color:#800080; '>}</span>
1183: 
1184: <span style='color:#800000; font-weight:bold; '>sub </span>login_process <span style='color:#800080; '>{</span>
1185:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1186:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$user_id<span style='color:#808030; '>,</span> $user_state<span style='color:#808030; '>,</span>$role<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
1187: <span style='color:#0000e6; '>     SELECT user_id,user_state,role</span>
1188: <span style='color:#0000e6; '>      FROM cas_users</span>
1189: <span style='color:#0000e6; '>      WHERE lower(email) = ?"</span><span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span><span style='color:#400000; '>lc</span> $FORM<span style='color:#808030; '>{</span>email<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1190:    <span style='color:#696969; '># If we recognize your email address</span>
1191:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$user_id<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1192:       <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$user_state <span style='color:#808030; '>eq</span> <span style='color:#0000e6; '>'authorized'</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1193:      <span style='color:#800000; font-weight:bold; '>my</span> $recognize_both <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
1194: <span style='color:#0000e6; '>            SELECT user_id </span>
1195: <span style='color:#0000e6; '>                FROM cas_users users</span>
1196: <span style='color:#0000e6; '>                WHERE users.user_id = $user_id </span>
1197: <span style='color:#0000e6; '>                    AND password = ?"</span><span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$FORM<span style='color:#808030; '>{</span>password<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1198: 
1199:      <span style='color:#696969; '># If we recognize your password, authorize and redirect you</span>
1200:      <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$recognize_both<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1201:         <span style='color:#696969; '>#my %session = validate_session();</span>
1202:         add_userid_to_session<span style='color:#808030; '>(</span><span style='color:#808030; '>\</span>%SES<span style='color:#808030; '>,</span>$user_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1203: 
1204:         <span style='color:#696969; '># if return_rm starts with 'http' we assume it's a </span>
1205:         <span style='color:#696969; '># full URL and use that. Otherwise, return_rm should be a run mode</span>
1206:         <span style='color:#800000; font-weight:bold; '>my</span> $url<span style='color:#800080; '>;</span>
1207:         <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>return_rm<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>m</span><span style='color:#800000; '>/</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>http</span><span style='color:#800000; '>/</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1208:             $url <span style='color:#808030; '>=</span> $FORM<span style='color:#808030; '>{</span>return_rm<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
1209:         <span style='color:#800080; '>}</span>
1210:         <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1211:             $url <span style='color:#808030; '>=</span><span style='color:#0000e6; '>"$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>CASCADE_CGI</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>/$FORM</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>return_rm</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>?$FORM</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>query_string</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>"</span><span style='color:#800080; '>;</span> 
1212:         <span style='color:#800080; '>}</span>
1213: 
1214:         $self<span style='color:#808030; '>-></span>header_props<span style='color:#808030; '>(</span>
1215:            <span style='color:#808030; '>-</span>cookie<span style='color:#808030; '>=></span>create_cookie<span style='color:#808030; '>(</span>$SES<span style='color:#808030; '>{</span>session_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
1216:            <span style='color:#808030; '>-</span>url<span style='color:#808030; '>=></span>$url<span style='color:#808030; '>,</span>
1217:          <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1218: 
1219:         $self<span style='color:#808030; '>-></span>header_type<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'redirect'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1220:         <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#800080; '>;</span>
1221:      <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1222:         <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Bad Password'</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>=></span><span style='color:#800000; font-weight:bold; '>qq</span><span style='color:#800000; '>!</span><span style='color:#0000e6; '>The password is not correct.</span>
1223: <span style='color:#0000e6; '>                   If you've forgotten it, </span>
1224: <span style='color:#0000e6; '>              &lt;a href="$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>CASCADE_CGI</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>/password_mail_forgotten?user_id=$user_id">we can mail it to you.&lt;/A></span><span style='color:#800000; '>!</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1225:      <span style='color:#800080; '>}</span>
1226:       <span style='color:#800080; '>}</span> 
1227:       <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1228:      <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Inactive account'</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Your account is no longer active'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1229:       <span style='color:#800080; '>}</span>
1230:    <span style='color:#800080; '>}</span>
1231:    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1232:       <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'User not found'</span><span style='color:#808030; '>,</span>
1233:          msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'No user was not with that email address'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1234:    <span style='color:#800080; '>}</span>
1235: <span style='color:#800080; '>}</span>
1236: 
1237: <span style='color:#696969; '># XXX maybe this run mode should really be Auth.pm. -mls</span>
1238: <span style='color:#800000; font-weight:bold; '>sub </span>logout <span style='color:#800080; '>{</span>
1239:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1240:    <span style='color:#696969; '># We don't want to validate the session, since that would redirect them to register</span>
1241:    <span style='color:#696969; '># if they are already logged out. Instead, we just grab the cookie directly. </span>
1242:    <span style='color:#800000; font-weight:bold; '>my</span> %session <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span> session_id <span style='color:#808030; '>=></span> $self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>-></span>cookie<span style='color:#808030; '>(</span>$CFG<span style='color:#808030; '>{</span>SESSION_COOKIE_NAME<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1243:    <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Auth</span><span style='color:#800080; '>;</span>
1244:    remove_userid_from_session<span style='color:#808030; '>(</span><span style='color:#808030; '>\</span>%session<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1245:    $self<span style='color:#808030; '>-></span>header_props<span style='color:#808030; '>(</span> <span style='color:#808030; '>-</span>cookie<span style='color:#808030; '>=></span>create_cookie<span style='color:#808030; '>(</span>$session<span style='color:#808030; '>{</span>session_id<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span><span style='color:#0000e6; '>'-3M'</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1246:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'register-logout.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1247:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
1248:       top_url    <span style='color:#808030; '>=></span> <span style='color:#808030; '>!</span>$CFG<span style='color:#808030; '>{</span>DYNAMIC_ONLY_P<span style='color:#808030; '>}</span> <span style='color:#808030; '>?</span> $CFG<span style='color:#808030; '>{</span>HTML_ROOT_URL<span style='color:#808030; '>}</span> <span style='color:#808030; '>:</span> $CFG<span style='color:#808030; '>{</span>CASCADE_CGI<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>
1249:       return_rm <span style='color:#808030; '>=></span> <span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>return_rm<span style='color:#808030; '>}</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> $ENV<span style='color:#808030; '>{</span>HTTP_REFERER<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1250:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1251: <span style='color:#800080; '>}</span>
1252:      
1253: <span style='color:#800000; font-weight:bold; '>sub </span>register_form <span style='color:#800080; '>{</span>
1254:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1255:    <span style='color:#800000; font-weight:bold; '>my</span> $errs <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1256: 
1257:    <span style='color:#696969; '># We don't want to pass through the run mode and confuse the</span>
1258:    <span style='color:#696969; '># system. -mls</span>
1259:    <span style='color:#400000; '>delete</span> $FORM<span style='color:#808030; '>{</span>rm<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
1260:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'register-form.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1261:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>  
1262:       return_rm<span style='color:#808030; '>=></span>$FORM<span style='color:#808030; '>{</span>return_rm<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>
1263:       query_string <span style='color:#808030; '>=></span> $self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>-></span>escapeHTML<span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>query_string<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> 
1264:       %$errs<span style='color:#808030; '>,</span>
1265:      <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1266:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1267: <span style='color:#800080; '>}</span>
1268: 
1269: <span style='color:#800000; font-weight:bold; '>sub </span>register_process <span style='color:#800080; '>{</span>
1270:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1271:    <span style='color:#696969; '># validate form</span>
1272:    <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Data</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>FormValidator</span><span style='color:#800080; '>;</span>
1273:    <span style='color:#800000; font-weight:bold; '>my</span> %email_validation <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>email <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'email'</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>if</span> $CFG<span style='color:#808030; '>{</span>VERIFY_EMAILS_P<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
1274:    <span style='color:#800000; font-weight:bold; '>my</span> $validator <span style='color:#808030; '>=</span> new <span style='color:#bb7977; font-weight:bold; '>Data</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>FormValidator</span><span style='color:#808030; '>(</span><span style='color:#800080; '>{</span>
1275:       form <span style='color:#808030; '>=></span> <span style='color:#800080; '>{</span>
1276:     required <span style='color:#808030; '>=></span> <span style='color:#808030; '>[</span><span style='color:#800000; font-weight:bold; '>qw</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>first_names last_name email password password_confirmation</span><span style='color:#800000; '>/</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>
1277:     filters <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'trim'</span><span style='color:#808030; '>,</span>
1278:     constraints <span style='color:#808030; '>=></span> <span style='color:#800080; '>{</span>
1279:        %email_validation<span style='color:#808030; '>,</span>
1280:        <span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
1281:     <span style='color:#800080; '>}</span>
1282:      <span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1283:      <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span> $valid<span style='color:#808030; '>,</span> $missing<span style='color:#808030; '>,</span> $invalid <span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $validator<span style='color:#808030; '>-></span>validate<span style='color:#808030; '>(</span>  <span style='color:#808030; '>\</span>%FORM<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"form"</span> <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1284: 
1285:    <span style='color:#800000; font-weight:bold; '>my</span> $msgs<span style='color:#800080; '>;</span>
1286:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>password<span style='color:#808030; '>}</span> <span style='color:#808030; '>ne</span> $FORM<span style='color:#808030; '>{</span>password_confirmation<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1287:       $msgs<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>password<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'Password and Confirmation do not match.'</span><span style='color:#800080; '>;</span>
1288:       <span style='color:#400000; '>push</span> @$invalid<span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#0000e6; '>'password'</span><span style='color:#808030; '>,</span> <span style='color:#0000e6; '>'password_confirmation'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1289:    <span style='color:#800080; '>}</span>
1290: 
1291:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>grep</span><span style='color:#0000e6; '> </span><span style='color:#800000; '>/</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>email</span><span style='color:#808030; '>$</span><span style='color:#800000; '>/</span><span style='color:#808030; '>,</span> @$invalid<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1292:       $msgs<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>email<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'Invalid Email format'</span><span style='color:#800080; '>;</span>
1293:    <span style='color:#800080; '>}</span>
1294: 
1295:    <span style='color:#696969; '># Are they already registered with this email address?</span>
1296:    <span style='color:#696969; '># If the user_id return is greater than zero, they are. </span>
1297:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span> <span style='color:#800000; font-weight:bold; '>my</span> $uid <span style='color:#808030; '>=</span> 
1298:            $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"SELECT user_id FROM cas_users WHERE lower(email) = ?"</span><span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span><span style='color:#400000; '>lc</span> $FORM<span style='color:#808030; '>{</span>email<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>></span> <span style='color:#008c00; '>0</span> <span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1299:       <span style='color:#400000; '>push</span> @$invalid<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>'email'</span><span style='color:#800080; '>;</span>
1300:       $msgs<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>email<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>qq</span><span style='color:#800000; '>!</span><span style='color:#0000e6; '>Already in system. </span>
1301: <span style='color:#0000e6; '>       ( &lt;a href="$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>CASCADE_CGI</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>/password_mail_forgotten?user_id=$uid">Send password to this address&lt;/a>&amp;nbsp;)</span><span style='color:#800000; '>!</span><span style='color:#800080; '>;</span>
1302:    <span style='color:#800080; '>}</span>
1303: 
1304:    <span style='color:#696969; '># if there are errors, return the errors</span>
1305:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>@$missing <span style='color:#808030; '>or</span> @$invalid<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1306:       <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>HTML</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>FillInForm</span><span style='color:#800080; '>;</span>
1307:       <span style='color:#800000; font-weight:bold; '>my</span> $fif <span style='color:#808030; '>=</span> new <span style='color:#bb7977; font-weight:bold; '>HTML</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>FillInForm</span><span style='color:#800080; '>;</span>
1308:       <span style='color:#800000; font-weight:bold; '>return</span> $fif<span style='color:#808030; '>-></span>fill<span style='color:#808030; '>(</span>
1309:      scalarref <span style='color:#808030; '>=></span> <span style='color:#808030; '>\</span>$self<span style='color:#808030; '>-></span>register_form<span style='color:#808030; '>(</span>
1310:         error_marks<span style='color:#808030; '>(</span> $missing<span style='color:#808030; '>,</span> $invalid<span style='color:#808030; '>,</span>$msgs<span style='color:#808030; '>)</span>
1311:        <span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
1312:      fobject <span style='color:#808030; '>=></span> $self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
1313:    <span style='color:#800080; '>}</span>
1314:    <span style='color:#696969; '># otherwise, return login_process with the info we've got</span>
1315:    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1316:       <span style='color:#696969; '># check for duplicate email address</span>
1317:       <span style='color:#696969; '># insert into the database</span>
1318:       <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>DBIx</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Abstract</span><span style='color:#800080; '>;</span>
1319:       <span style='color:#800000; font-weight:bold; '>my</span> $db <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>DBIx</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Abstract</span><span style='color:#808030; '>-></span><span style='color:#400000; '>connect</span><span style='color:#808030; '>(</span>$DBH<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1320:       <span style='color:#400000; '>delete</span> $valid<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>password_confirmation<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
1321:       <span style='color:#696969; '># XXX There's a good chance we should be verifying email addresses when people sign up. -mls</span>
1322:       $valid<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>user_state<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'authorized'</span><span style='color:#800080; '>;</span>
1323:       $valid<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>registration_ip<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> $ENV<span style='color:#808030; '>{</span>REMOTE_ADDR<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
1324:       $db<span style='color:#808030; '>-></span>insert<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'cas_users'</span><span style='color:#808030; '>,</span>$valid<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1325:       <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>login_process<span style='color:#800080; '>;</span>
1326:    <span style='color:#800080; '>}</span>
1327:    
1328: <span style='color:#800080; '>}</span>
1329: <span style='color:#696969; '># create a hash from Data::FormValidator data for HTML::Template Input</span>
1330: <span style='color:#696969; '># is a reference to a list of fields with errors and a hash of field</span>
1331: <span style='color:#696969; '># names and custom error message messages</span>
1332: <span style='color:#696969; '># output is hash reference for HTML::Template;</span>
1333: <span style='color:#800000; font-weight:bold; '>sub </span>error_marks <span style='color:#800080; '>{</span>
1334:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$missing<span style='color:#808030; '>,</span> $invalid<span style='color:#808030; '>,</span> $msgs<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @_<span style='color:#800080; '>;</span>
1335:    
1336:    <span style='color:#696969; '># set one field just to say "we have some errors"</span>
1337:    <span style='color:#800000; font-weight:bold; '>my</span> $err_h <span style='color:#808030; '>=</span> <span style='color:#800080; '>{</span> <span style='color:#0000e6; '>'err__'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#008c00; '>1</span> <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1338: 
1339:    <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $err <span style='color:#808030; '>(</span>@$missing<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1340:       $msgs<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>$err<span style='color:#808030; '>}</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span><span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'Missing'</span><span style='color:#800080; '>;</span>
1341:       $err_h<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>'err_'</span><span style='color:#808030; '>.</span>$err<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span>
1342:     $CFG<span style='color:#808030; '>{</span>ERROR_MARK<span style='color:#808030; '>}</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>'&lt;B>&lt;font size="-1">'</span><span style='color:#808030; '>.</span>$msgs<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>$err<span style='color:#808030; '>}</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>'&lt;/font>&lt;/B>'</span><span style='color:#800080; '>;</span>
1343:    <span style='color:#800080; '>}</span>
1344:    <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $err <span style='color:#808030; '>(</span>@$invalid<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1345:       $msgs<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>$err<span style='color:#808030; '>}</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span><span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'Invalid'</span><span style='color:#800080; '>;</span>
1346:       $err_h<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>'err_'</span><span style='color:#808030; '>.</span>$err<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span>
1347:     $CFG<span style='color:#808030; '>{</span>ERROR_MARK<span style='color:#808030; '>}</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>'&lt;B>&lt;font size="-1">'</span><span style='color:#808030; '>.</span>$msgs<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>$err<span style='color:#808030; '>}</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>'&lt;/font>&lt;/B>'</span><span style='color:#800080; '>;</span>
1348:    <span style='color:#800080; '>}</span>
1349:    <span style='color:#800000; font-weight:bold; '>return</span> $err_h<span style='color:#800080; '>;</span>
1350: <span style='color:#800080; '>}</span>
1351: 
1352: <span style='color:#696969; '># a general purpose image validation routine</span>
1353: <span style='color:#696969; '># input</span>
1354: <span style='color:#696969; '>#    1. form field name</span>
1355: <span style='color:#696969; '>#    2. hashref of maxes (width, height, bytes)         </span>
1356: <span style='color:#696969; '># output: </span>
1357: <span style='color:#696969; '>#   1. attribute hash (width, height, mime_type, extension)</span>
1358: <span style='color:#696969; '>#   2. error msg (if any)</span>
1359: <span style='color:#800000; font-weight:bold; '>sub </span>validate_image <span style='color:#800080; '>{</span>
1360:    <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Image</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Size</span><span style='color:#800080; '>;</span>
1361:    import <span style='color:#bb7977; font-weight:bold; '>Image</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Size</span> <span style='color:#800000; font-weight:bold; '>qw</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>imgsize</span><span style='color:#800000; '>/</span><span style='color:#800080; '>;</span>
1362:    <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>HTTP</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Headers</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span>UserAgent<span style='color:#800080; '>;</span>
1363:    import <span style='color:#bb7977; font-weight:bold; '>HTTP</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Headers</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span>UserAgent<span style='color:#800080; '>;</span>
1364:    <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>File</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Basename</span><span style='color:#800080; '>;</span>
1365:    import <span style='color:#bb7977; font-weight:bold; '>File</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Basename</span><span style='color:#800080; '>;</span>  
1366: 
1367:    <span style='color:#800000; font-weight:bold; '>my</span> %os_convert <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>
1368:       Win95           <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'MSWin32'</span><span style='color:#808030; '>,</span>
1369:       Win98           <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'MSWin32'</span><span style='color:#808030; '>,</span>
1370:       WinNT           <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'MSWin32'</span><span style='color:#808030; '>,</span>
1371:       Mac             <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'MacOS'</span><span style='color:#808030; '>,</span>
1372:       Linux           <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#696969; '># the default for File::Basename</span>
1373:       UNIX            <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>''</span>
1374:    <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1375: 
1376:    <span style='color:#800000; font-weight:bold; '>my</span> %valid_mime_types <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>
1377:       <span style='color:#0000e6; '>'image/jpeg'</span>    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>
1378:       <span style='color:#0000e6; '>'image/gif'</span>     <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>
1379:       <span style='color:#0000e6; '>'image/png'</span>     <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>
1380:      <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1381: 
1382:    <span style='color:#800000; font-weight:bold; '>my</span> $field <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1383:    <span style='color:#800000; font-weight:bold; '>my</span> $maxs <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1384:    <span style='color:#800000; font-weight:bold; '>my</span> $img <span style='color:#808030; '>=</span> $q<span style='color:#808030; '>-></span>upload<span style='color:#808030; '>(</span>$field<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1385:    carp $q<span style='color:#808030; '>-></span>cgi_error <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>$img <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> $q<span style='color:#808030; '>-></span>cgi_error<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1386: 
1387:    <span style='color:#800000; font-weight:bold; '>my</span> $tmp_file <span style='color:#808030; '>=</span> $q<span style='color:#808030; '>-></span>tmpFileName<span style='color:#808030; '>(</span>$q<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>$field<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1388:    <span style='color:#800000; font-weight:bold; '>my</span> $file_size <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#400000; '>stat</span> <span style='color:#808030; '>(</span>$img<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>[</span><span style='color:#008c00; '>7</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
1389:    <span style='color:#800000; font-weight:bold; '>my</span> $mime_type <span style='color:#808030; '>=</span> $q<span style='color:#808030; '>-></span>uploadInfo<span style='color:#808030; '>(</span>$img<span style='color:#808030; '>)</span><span style='color:#808030; '>-></span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>'Content-Type'</span><span style='color:#808030; '>}</span> <span style='color:#800000; font-weight:bold; '>if</span> $img<span style='color:#800080; '>;</span>
1390: 
1391:    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>$file_size <span style='color:#808030; '>></span> $maxs<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>bytes<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1392:       <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#808030; '>(</span><span style='color:#400000; '>undef</span><span style='color:#808030; '>,</span><span style='color:#0000e6; '>"File size exceeds maximum allowed"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1393:    <span style='color:#800080; '>}</span>
1394:    
1395:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span> $valid_mime_types<span style='color:#808030; '>{</span>$mime_type<span style='color:#808030; '>}</span> <span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1396:       <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#808030; '>(</span><span style='color:#400000; '>undef</span><span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"Does not appear to be an allowed image format. (GIF, JPG, or PNG)"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1397:    <span style='color:#800080; '>}</span> 
1398: 
1399:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$width<span style='color:#808030; '>,</span>$height<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> imgsize<span style='color:#808030; '>(</span>$tmp_file<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1400:    <span style='color:#800000; font-weight:bold; '>my</span> $err<span style='color:#800080; '>;</span>
1401:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>$width <span style='color:#808030; '>></span> $maxs<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>width<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span>
1402:     <span style='color:#808030; '>(</span>$height <span style='color:#808030; '>></span> $maxs<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>height<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1403:      $err <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"Image dimensions ($width x $height) exceeds maximum allowed</span>
1404: <span style='color:#0000e6; '>           ($maxs-></span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>width</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '> x $maxs-></span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>height</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>)"</span><span style='color:#800080; '>;</span>
1405:    <span style='color:#800080; '>}</span>
1406: 
1407:    <span style='color:#800000; font-weight:bold; '>my</span> $Platform <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>HTTP</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Headers</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span><span style='color:#bb7977; font-weight:bold; '>UserAgent</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>GetPlatform</span> <span style='color:#808030; '>(</span>$ENV<span style='color:#808030; '>{</span>HTTP_USER_AGENT<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1408:    fileparse_set_fstype<span style='color:#808030; '>(</span>$os_convert<span style='color:#808030; '>{</span>$Platform<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1409:    <span style='color:#800000; font-weight:bold; '>my</span> $orig_file_name <span style='color:#808030; '>=</span> basename<span style='color:#808030; '>(</span>$img<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1410:    <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> $ext<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $orig_file_name <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>m</span><span style='color:#800000; '>/</span><span style='color:#808030; '>(</span><span style='color:#0f69ff; '>\.</span><span style='color:#0000e6; '>\w</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>?</span><span style='color:#808030; '>$</span><span style='color:#800000; '>/</span><span style='color:#800080; '>;</span>
1411: 
1412:    <span style='color:#800000; font-weight:bold; '>my</span> %attr <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>
1413:      width  <span style='color:#808030; '>=></span> $width<span style='color:#808030; '>,</span>
1414:      height <span style='color:#808030; '>=></span> $height<span style='color:#808030; '>,</span>
1415:      extension <span style='color:#808030; '>=></span> $ext<span style='color:#808030; '>,</span> 
1416:      mime_type <span style='color:#808030; '>=></span> $mime_type<span style='color:#808030; '>,</span>
1417:     <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1418:    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>\</span>%attr<span style='color:#808030; '>,</span>$err<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1419: <span style='color:#800080; '>}</span>
1420: 
1421: 
1422: <span style='color:#696969; '># XXX maybe I should rename this item_comments_view to be more consistent. -mls</span>
1423: <span style='color:#800000; font-weight:bold; '>sub </span>item_view_comments <span style='color:#800080; '>{</span>
1424:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1425:    <span style='color:#400000; '>length</span> $FORM<span style='color:#808030; '>{</span>item_id<span style='color:#808030; '>}</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>"No item_id"</span><span style='color:#808030; '>,</span>
1426:                        msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Insufficient information was found to build this page'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1427: 
1428:    <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span>$FORM<span style='color:#808030; '>{</span>item_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> 
1429:     <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>"No item"</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Failed to create an Item'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span><span style='color:#800080; '>;</span>
1430:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'item-view-comments.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1431:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>$item<span style='color:#808030; '>-></span>comments_html<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1432:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1433: <span style='color:#800080; '>}</span>
1434: 
1435: <span style='color:#800000; font-weight:bold; '>sub </span>item_include_comments <span style='color:#800080; '>{</span>
1436:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span> 
1437:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$item_id<span style='color:#808030; '>,</span> $where<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> 
1438:    
1439:    <span style='color:#800000; font-weight:bold; '>my</span> @bind<span style='color:#800080; '>;</span>
1440:    <span style='color:#696969; '># first we try an explicit item_id</span>
1441:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>item_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1442:       $where <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>' item_id = ? '</span><span style='color:#800080; '>;</span>
1443:       <span style='color:#400000; '>push</span> @bind<span style='color:#808030; '>,</span> $FORM<span style='color:#808030; '>{</span>item_id<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
1444:    <span style='color:#800080; '>}</span>
1445:    <span style='color:#696969; '># next we try matching the documents URI</span>
1446:    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1447:       $where <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'url = ?'</span><span style='color:#800080; '>;</span>
1448:       <span style='color:#400000; '>push</span> @bind<span style='color:#808030; '>,</span> $ENV<span style='color:#808030; '>{</span>DOCUMENT_URI<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
1449:    <span style='color:#800080; '>}</span>
1450: 
1451:    $item_id <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span>
1452:        <span style='color:#0000e6; '>"SELECT item_id FROM cas_item_approved WHERE $where"</span><span style='color:#808030; '>,</span>
1453:            <span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
1454:         @bind<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1455:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$item_id <span style='color:#808030; '>></span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1456:       <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span>$item_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1457:       <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'includes/item-include-comments.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1458:       $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>$item<span style='color:#808030; '>-></span>comments_html<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1459:       <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1460:    <span style='color:#800080; '>}</span>
1461: 
1462: <span style='color:#800080; '>}</span>
1463: 
1464: 
1465: <span style='color:#800000; font-weight:bold; '>sub </span>item_comment_post <span style='color:#800080; '>{</span>
1466:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1467:    <span style='color:#696969; '># validate the form;</span>
1468:    <span style='color:#400000; '>length</span> $FORM<span style='color:#808030; '>{</span>item_id<span style='color:#808030; '>}</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Technical Failure'</span><span style='color:#808030; '>,</span>
1469:                        msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'No item_id was found. This is probably not your fault'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1470: 
1471:    <span style='color:#400000; '>length</span> $SES<span style='color:#808030; '>{</span>user_id<span style='color:#808030; '>}</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Not logged in'</span><span style='color:#808030; '>,</span>
1472:                       msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'You need to logged in for this function to work. </span>
1473: <span style='color:#0000e6; '>         Try going back and reloading the page'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1474: 
1475:    <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Data</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>FormValidator</span><span style='color:#800080; '>;</span>
1476:    <span style='color:#800000; font-weight:bold; '>my</span> $validator <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Data</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>FormValidator</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span><span style='color:#800080; '>{</span>
1477:       form <span style='color:#808030; '>=></span> <span style='color:#800080; '>{</span>
1478:        optional <span style='color:#808030; '>=></span> <span style='color:#808030; '>[</span><span style='color:#800000; font-weight:bold; '>qw</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>rating comment</span><span style='color:#800000; '>/</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>
1479:        filters <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>'trim'</span><span style='color:#808030; '>,</span>
1480:     <span style='color:#800080; '>}</span>
1481:      <span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1482:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$valid<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $validator<span style='color:#808030; '>-></span>validate<span style='color:#808030; '>(</span><span style='color:#808030; '>\</span>%FORM<span style='color:#808030; '>,</span><span style='color:#0000e6; '>'form'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1483: 
1484:    <span style='color:#696969; '># throw an error if they don't give a rating or a comment</span>
1485:    <span style='color:#808030; '>(</span>$valid<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>rating<span style='color:#808030; '>}</span> <span style='color:#808030; '>or</span> $valid<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>comment<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span>
1486:      <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Insufficient Information'</span><span style='color:#808030; '>,</span>
1487:         msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'You must supply a rating and/or a comment.'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1488: 
1489:    $valid<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>item_id<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> $FORM<span style='color:#808030; '>{</span>item_id<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
1490:    $valid<span style='color:#808030; '>-></span><span style='color:#808030; '>{</span>user_id<span style='color:#808030; '>}</span> <span style='color:#808030; '>=</span> $SES<span style='color:#808030; '>{</span>user_id<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
1491: 
1492:    <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>DBIx</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Abstract</span><span style='color:#800080; '>;</span>
1493:    <span style='color:#800000; font-weight:bold; '>my</span> $db <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>DBIx</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Abstract</span><span style='color:#808030; '>-></span><span style='color:#400000; '>connect</span><span style='color:#808030; '>(</span>$DBH<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1494:    <span style='color:#696969; '># If they've already posted</span>
1495:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
1496: <span style='color:#0000e6; '>          SELECT </span><span style='color:#008c00; '>1</span><span style='color:#0000e6; '> FROM cas_user_item_map</span>
1497: <span style='color:#0000e6; '>              WHERE user_id = ? AND item_id = ?"</span>
1498:               <span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$SES<span style='color:#808030; '>{</span>user_id<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>$FORM<span style='color:#808030; '>{</span>item_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1499: 
1500:       $db<span style='color:#808030; '>-></span>update<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'cas_user_item_map'</span><span style='color:#808030; '>,</span>$valid<span style='color:#808030; '>,</span>
1501:           <span style='color:#800080; '>{</span> user_id <span style='color:#808030; '>=></span> $SES<span style='color:#808030; '>{</span>user_id<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span> item_id <span style='color:#808030; '>=></span> $FORM<span style='color:#808030; '>{</span>item_id<span style='color:#808030; '>}</span> <span style='color:#800080; '>}</span><span style='color:#808030; '>)</span>
1502:    <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1503:       $db<span style='color:#808030; '>-></span>insert<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'cas_user_item_map'</span><span style='color:#808030; '>,</span>$valid<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1504:    <span style='color:#800080; '>}</span>
1505:   
1506:    DBI<span style='color:#808030; '>-></span>trace<span style='color:#808030; '>(</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1507:    <span style='color:#696969; '># write affected static pages if we need to. </span>
1508:    <span style='color:#800000; font-weight:bold; '>unless</span> <span style='color:#808030; '>(</span>$CFG<span style='color:#808030; '>{</span>DYNAMIC_ONLY_P<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1509:        <span style='color:#696969; '># write static pages for all affected categories</span>
1510:        <span style='color:#800000; font-weight:bold; '>my</span> $cat_ids <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectcol_arrayref<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
1511: <span style='color:#0000e6; '>       SELECT category_id </span>
1512: <span style='color:#0000e6; '>       FROM cas_category cat</span>
1513: <span style='color:#0000e6; '>       LEFT JOIN cas_category_item_map map USING (category_id)</span>
1514: <span style='color:#0000e6; '>       WHERE map.item_id = ?"</span><span style='color:#808030; '>,</span>
1515:        <span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$FORM<span style='color:#808030; '>{</span>item_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1516: 
1517:        <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $id <span style='color:#808030; '>(</span>@$cat_ids<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1518:            <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> new <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span>$id<span style='color:#808030; '>,</span>mode<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'static'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1519:            <span style='color:#800000; font-weight:bold; '>my</span> $rv <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>write_static_cat<span style='color:#808030; '>(</span>$cat<span style='color:#808030; '>,</span>verbose<span style='color:#808030; '>=></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1520:        <span style='color:#800080; '>}</span>
1521:    <span style='color:#800080; '>}</span>
1522:    DBI<span style='color:#808030; '>-></span>trace<span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1523: 
1524:    <span style='color:#696969; '># Send comments to those who care </span>
1525:    <span style='color:#696969; '># XXX For now, just admins. Later, maybe editors, too </span>
1526:    <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> new <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>(</span>id<span style='color:#808030; '>=></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1527:       <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> $to_emails <span style='color:#808030; '>=</span> $cat<span style='color:#808030; '>-></span>get_admin_and_cat_emails<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1528:      <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'emails/item-alert-comment.txt'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1529:      $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
1530:         to_emails   <span style='color:#808030; '>=></span> $to_emails<span style='color:#808030; '>,</span>
1531:         from_email     <span style='color:#808030; '>=></span>$SES<span style='color:#808030; '>{</span>email<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>
1532:         title     <span style='color:#808030; '>=></span> $FORM<span style='color:#808030; '>{</span>title<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>
1533:         rating    <span style='color:#808030; '>=></span> $FORM<span style='color:#808030; '>{</span>rating<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>
1534:         comment     <span style='color:#808030; '>=></span> $FORM<span style='color:#808030; '>{</span>comment<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>
1535:         comment_url <span style='color:#808030; '>=></span> <span style='color:#0000e6; '>"$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>CASCADE_CGI</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>/item_view_comments?item_id=$FORM</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>item_id</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>"</span><span style='color:#808030; '>,</span>
1536:         delete_url  <span style='color:#808030; '>=></span>
1537:           <span style='color:#0000e6; '>"$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>CASCADE_CGI</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>/item_comments_delete?item_id=$FORM</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>item_id</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>&amp;comment_delete=$SES</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>user_id</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>"</span><span style='color:#808030; '>,</span>
1538:           
1539:        <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1540:      <span style='color:#400000; '>open</span><span style='color:#808030; '>(</span>MAIL<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"|$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>MAILPROG</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '> -t"</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> 
1541:        err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Error Opening Mail Program'</span><span style='color:#808030; '>,</span> msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'There was an error opening the mail program'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1542:      <span style='color:#800000; font-weight:bold; '>eval</span> <span style='color:#800080; '>{</span><span style='color:#800000; font-weight:bold; '>print</span> MAIL $t<span style='color:#808030; '>-></span>output <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1543:      $@ <span style='color:#808030; '>and</span> carp $@<span style='color:#800080; '>;</span> 
1544:      <span style='color:#400000; '>close</span><span style='color:#808030; '>(</span>MAIL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1545:        <span style='color:#800080; '>}</span>
1546: 
1547:    <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>item_view_comments<span style='color:#800080; '>;</span>
1548: 
1549: <span style='color:#800080; '>}</span>
1550: 
1551: <span style='color:#800000; font-weight:bold; '>sub </span>item_comments_delete <span style='color:#800080; '>{</span>
1552:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1553:    <span style='color:#400000; '>length</span> $FORM<span style='color:#808030; '>{</span>item_id<span style='color:#808030; '>}</span> <span style='color:#808030; '>or</span> error<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>"Insufficient Information"</span><span style='color:#808030; '>,</span>
1554:                   msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>"No item_id was found"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1555: 
1556:    <span style='color:#696969; '># delete the marked comments</span>
1557:    <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $c <span style='color:#808030; '>(</span>$self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'comment_delete'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1558:       $DBH<span style='color:#808030; '>-></span><span style='color:#800000; font-weight:bold; '>do</span><span style='color:#808030; '>(</span><span style='color:#0000e6; '>"DELETE FROM cas_user_item_map</span>
1559: <span style='color:#0000e6; '>         WHERE item_id = ?</span>
1560: <span style='color:#0000e6; '>           AND user_id = ? "</span><span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$FORM<span style='color:#808030; '>{</span>item_id<span style='color:#808030; '>}</span><span style='color:#808030; '>,</span>$c<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1561:    <span style='color:#800080; '>}</span>
1562: 
1563:    <span style='color:#696969; '># return to the page</span>
1564:    <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>item_view_comments<span style='color:#800080; '>;</span>
1565: <span style='color:#800080; '>}</span>
1566: 
1567: <span style='color:#800000; font-weight:bold; '>sub </span>password_forgot_form <span style='color:#800080; '>{</span>
1568:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1569:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'register-forgot-password.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1570:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1571: <span style='color:#800080; '>}</span>
1572: 
1573: <span style='color:#800000; font-weight:bold; '>sub </span>password_mail_success <span style='color:#800080; '>{</span>
1574:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1575:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'register-password-emailed.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1576:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1577: <span style='color:#800080; '>}</span>
1578: 
1579: <span style='color:#800000; font-weight:bold; '>sub </span>password_mail_forgotten <span style='color:#800080; '>{</span>
1580:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1581: 
1582:    <span style='color:#800000; font-weight:bold; '>unless</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>user_id<span style='color:#808030; '>}</span> <span style='color:#808030; '>or</span> $FORM<span style='color:#808030; '>{</span>email<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1583:     <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Insufficient Information'</span><span style='color:#808030; '>,</span>
1584:         msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'There was an error processing your request-- Insufficient Information was received'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1585:      <span style='color:#800080; '>}</span>
1586: 
1587:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>@bind<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1588:    <span style='color:#800000; font-weight:bold; '>my</span> $sql <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"SELECT password,email FROM cas_users WHERE "</span><span style='color:#800080; '>;</span>
1589:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#808030; '>{</span>user_id<span style='color:#808030; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1590:         $sql <span style='color:#808030; '>.</span><span style='color:#808030; '>=</span> <span style='color:#0000e6; '>" user_id = ? "</span><span style='color:#800080; '>;</span>
1591:         <span style='color:#400000; '>push</span> @bind<span style='color:#808030; '>,</span> $FORM<span style='color:#808030; '>{</span>user_id<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
1592:    <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1593:        $sql <span style='color:#808030; '>.</span><span style='color:#808030; '>=</span> <span style='color:#0000e6; '>" lower(email) = ? "</span><span style='color:#800080; '>;</span>
1594:        <span style='color:#400000; '>push</span> @bind<span style='color:#808030; '>,</span> <span style='color:#400000; '>lc</span> $FORM<span style='color:#808030; '>{</span>email<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
1595:    <span style='color:#800080; '>}</span>
1596:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$password<span style='color:#808030; '>,</span>$email<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span>$sql<span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>@bind<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1597: 
1598:    <span style='color:#800000; font-weight:bold; '>unless</span> <span style='color:#808030; '>(</span>$password <span style='color:#808030; '>and</span> $email<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1599:           <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Information not found'</span><span style='color:#808030; '>,</span>
1600:         msg<span style='color:#808030; '>=></span><span style='color:#800000; font-weight:bold; '>qq</span><span style='color:#800000; '>!</span><span style='color:#0000e6; '>We could not find sufficient information on your account.</span>
1601: <span style='color:#0000e6; '>            &lt;P></span>
1602: <span style='color:#0000e6; '>            Return to our &lt;A HREF="$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>CASCADE_CGI</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '>/login">login page&lt;/A> to try logging in again</span><span style='color:#800000; '>!</span> <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1603:    <span style='color:#800080; '>}</span>
1604: 
1605:    <span style='color:#400000; '>open</span><span style='color:#808030; '>(</span>MAIL<span style='color:#808030; '>,</span><span style='color:#0000e6; '>"|$CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>MAILPROG</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '> -t "</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=></span><span style='color:#0000e6; '>'Error sending email'</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>=></span><span style='color:#0000e6; '>"There was an error sending the message,</span>
1606: <span style='color:#0000e6; '>            please contact $CFG</span><span style='color:#808030; '>{</span><span style='color:#0000e6; '>CONTACT_EMAIL</span><span style='color:#808030; '>}</span><span style='color:#0000e6; '> for assistance."</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1607:    <span style='color:#800000; font-weight:bold; '>my</span> $msg <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'emails/password-forgot.txt'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1608:    $msg<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span> email<span style='color:#808030; '>=></span>$email<span style='color:#808030; '>,</span> password<span style='color:#808030; '>=></span>$password <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1609:    <span style='color:#800000; font-weight:bold; '>print</span> MAIL $msg<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1610:    <span style='color:#400000; '>close</span><span style='color:#808030; '>(</span>MAIL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1611: 
1612:    <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>password_mail_success<span style='color:#800080; '>;</span>
1613: <span style='color:#800080; '>}</span>
1614: 
1615: <span style='color:#696969; '># make text a little more readable as HTML</span>
1616: <span style='color:#800000; font-weight:bold; '>sub </span>htmlicize <span style='color:#800080; '>{</span>
1617:    <span style='color:#800000; font-weight:bold; '>my</span> $txt <span style='color:#808030; '>=</span> <span style='color:#400000; '>shift</span><span style='color:#800080; '>;</span>
1618:    <span style='color:#696969; '># convert 2 or more blank lines to a paragraph break</span>
1619:    $txt <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>s</span><span style='color:#800000; '>/</span><span style='color:#808030; '>(</span><span style='color:#0000e6; '>\s</span><span style='color:#808030; '>*</span><span style='color:#0f69ff; '>\n</span><span style='color:#808030; '>)</span><span style='color:#808030; '>{</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>}</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>&lt;P></span><span style='color:#800000; '>/</span><span style='color:#800000; font-weight:bold; '>gsi</span><span style='color:#800080; '>;</span>
1620: 
1621:    <span style='color:#696969; '># convert remaining newlines to html line breaks</span>
1622:    $txt <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>s</span><span style='color:#800000; '>/</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>&lt;BR></span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>/</span><span style='color:#800000; font-weight:bold; '>gsi</span><span style='color:#800080; '>;</span>
1623: 
1624:    <span style='color:#800000; font-weight:bold; '>return</span> $txt<span style='color:#800080; '>;</span>
1625: <span style='color:#800080; '>}</span>
1626: 
1627: <span style='color:#696969; '># We use this sometimes to avoid the overhead of DBIx::Abstract</span>
1628: <span style='color:#696969; '># and take advantage of prepare_cached for mass inserting</span>
1629: <span style='color:#696969; '># (which only happened for a bookmark import script when I added this. -mls )</span>
1630: <span style='color:#696969; '># credit: This is basically straight from the DBI documentation. </span>
1631: <span style='color:#800000; font-weight:bold; '>sub </span>insert_hash <span style='color:#800080; '>{</span>
1632:     <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$table<span style='color:#808030; '>,</span> $field_values<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @_<span style='color:#800080; '>;</span>
1633:     <span style='color:#800000; font-weight:bold; '>my</span> @fields <span style='color:#808030; '>=</span> <span style='color:#400000; '>sort</span> <span style='color:#800000; font-weight:bold; '>keys</span> %$field_values<span style='color:#800080; '>;</span> <span style='color:#696969; '># sort required</span>
1634:     <span style='color:#800000; font-weight:bold; '>my</span> @values <span style='color:#808030; '>=</span> @{$field_values}<span style='color:#808030; '>{</span>@fields<span style='color:#808030; '>}</span><span style='color:#800080; '>;</span>
1635:     <span style='color:#800000; font-weight:bold; '>my</span> $sql <span style='color:#808030; '>=</span> <span style='color:#400000; '>sprintf</span> <span style='color:#0000e6; '>"insert into </span><span style='color:#007997; '>%s</span><span style='color:#0000e6; '> (</span><span style='color:#007997; '>%s</span><span style='color:#0000e6; '>) values (</span><span style='color:#007997; '>%s</span><span style='color:#0000e6; '>)"</span><span style='color:#808030; '>,</span>
1636:         $table<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>join</span><span style='color:#808030; '>(</span><span style='color:#0000e6; '>","</span><span style='color:#808030; '>,</span> @fields<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>join</span><span style='color:#808030; '>(</span><span style='color:#0000e6; '>","</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#0000e6; '>"?"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>x</span>@fields<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1637:     <span style='color:#800000; font-weight:bold; '>my</span> $sth <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>prepare_cached<span style='color:#808030; '>(</span>$sql<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1638:     <span style='color:#800000; font-weight:bold; '>return</span> $sth<span style='color:#808030; '>-></span>execute<span style='color:#808030; '>(</span>@values<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1639: <span style='color:#800080; '>}</span>
1640: 
1641: <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
1642: 
1643: 
1644: 
