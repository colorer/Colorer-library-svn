  0: <span style='color:#696969; '>#!</span><span style='color:#007997; '>./perl</span>
  1: 
  2: <span style='color:#800000; font-weight:bold; '>BEGIN</span> <span style='color:#800080; '>{</span>
  3:     <span style='color:#400000; '>chdir</span> <span style='color:#0000e6; '>'t'</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#800000; font-weight:bold; '>-d</span> <span style='color:#0000e6; '>'t'</span><span style='color:#800080; '>;</span>
  4:     <span style='color:#400000; '>unshift</span> @INC<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"../lib"</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#800000; font-weight:bold; '>-d</span> <span style='color:#0000e6; '>"../lib"</span><span style='color:#800080; '>;</span>
  5:     <span style='color:#800000; font-weight:bold; '>eval</span> <span style='color:#800080; '>{</span><span style='color:#800000; font-weight:bold; '>my</span> @n <span style='color:#808030; '>=</span> <span style='color:#400000; '>getpwuid</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
  6:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#797997; '>$@</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#797997; '>$@</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span><span style='color:#0000e6; '> </span><span style='color:#800000; '>/</span><span style='color:#808030; '>(</span><span style='color:#0000e6; '>The </span><span style='color:#797997; '>\w</span><span style='color:#808030; '>+</span><span style='color:#0000e6; '> function is unimplemented</span><span style='color:#808030; '>)</span><span style='color:#800000; '>/</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
  7:     <span style='color:#800000; font-weight:bold; '>print</span> <span style='color:#0000e6; '>"</span><span style='color:#008c00; '>1</span><span style='color:#0000e6; '>.</span><span style='color:#008000; '>.0</span><span style='color:#0000e6; '> # Skip: </span><span style='color:#797997; '>$1</span><span style='color:#0f69ff; '>\n</span><span style='color:#0000e6; '>"</span><span style='color:#800080; '>;</span>
  8:     <span style='color:#800000; font-weight:bold; '>exit</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
  9:     <span style='color:#800080; '>}</span>
 10:     <span style='color:#800000; font-weight:bold; '>eval</span> <span style='color:#800080; '>{</span> <span style='color:#800000; font-weight:bold; '>require</span> Config<span style='color:#800080; '>;</span> import Config<span style='color:#800080; '>;</span> <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 11:     <span style='color:#800000; font-weight:bold; '>my</span> $reason<span style='color:#800080; '>;</span>
 12:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$Config<span style='color:#808030; '>{</span><span style='color:#0000e6; '>'i_pwd'</span><span style='color:#808030; '>}</span> <span style='color:#808030; '>ne</span> <span style='color:#0000e6; '>'define'</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 13:     $reason <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'$Config{i_pwd} undefined'</span><span style='color:#800080; '>;</span>
 14:     <span style='color:#800080; '>}</span>
 15:     <span style='color:#800000; font-weight:bold; '>elsif</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>not</span> <span style='color:#800000; font-weight:bold; '>-f</span> <span style='color:#0000e6; '>"/etc/passwd"</span> <span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> <span style='color:#696969; '># Play safe.</span>
 16:     $reason <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'no /etc/passwd file'</span><span style='color:#800080; '>;</span>
 17:     <span style='color:#800080; '>}</span>
 18: 
 19:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>not</span> <span style='color:#800000; font-weight:bold; '>defined</span> $where<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>    <span style='color:#696969; '># Try NIS.</span>
 20:     <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $ypcat <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>qw</span><span style='color:#800000; '>(</span><span style='color:#0000e6; '>/usr/bin/ypcat /bin/ypcat /etc/ypcat</span><span style='color:#800000; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 21:         <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>-x</span> $ypcat <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span>
 22:         <span style='color:#400000; '>open</span><span style='color:#808030; '>(</span>PW<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"$ypcat passwd </span><span style='color:#008c00; '>2</span><span style='color:#0000e6; '>>/dev/null |"</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span>
 23:         <span style='color:#800000; font-weight:bold; '>defined</span><span style='color:#808030; '>(</span><span style='color:#40015a; '>&lt;PW></span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 24:         $where <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"NIS passwd"</span><span style='color:#800080; '>;</span>
 25:         <span style='color:#400000; '>undef</span> $reason<span style='color:#800080; '>;</span>
 26:         <span style='color:#800000; font-weight:bold; '>last</span><span style='color:#800080; '>;</span>
 27:         <span style='color:#800080; '>}</span>
 28:     <span style='color:#800080; '>}</span>
 29:     <span style='color:#800080; '>}</span>
 30: 
 31:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>not</span> <span style='color:#800000; font-weight:bold; '>defined</span> $where<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>    <span style='color:#696969; '># Try NetInfo.</span>
 32:     <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $nidump <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>qw</span><span style='color:#800000; '>(</span><span style='color:#0000e6; '>/usr/bin/nidump</span><span style='color:#800000; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 33:         <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>-x</span> $nidump <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span>
 34:         <span style='color:#400000; '>open</span><span style='color:#808030; '>(</span>PW<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"$nidump passwd . </span><span style='color:#008c00; '>2</span><span style='color:#0000e6; '>>/dev/null |"</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span>
 35:         <span style='color:#800000; font-weight:bold; '>defined</span><span style='color:#808030; '>(</span><span style='color:#40015a; '>&lt;PW></span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 36:         $where <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"NetInfo passwd"</span><span style='color:#800080; '>;</span>
 37:         <span style='color:#400000; '>undef</span> $reason<span style='color:#800080; '>;</span>
 38:         <span style='color:#800000; font-weight:bold; '>last</span><span style='color:#800080; '>;</span>
 39:         <span style='color:#800080; '>}</span>
 40:     <span style='color:#800080; '>}</span>
 41:     <span style='color:#800080; '>}</span>
 42: 
 43:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>not</span> <span style='color:#800000; font-weight:bold; '>defined</span> $where<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>    <span style='color:#696969; '># Try local.</span>
 44:     <span style='color:#800000; font-weight:bold; '>my</span> $PW <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"/etc/passwd"</span><span style='color:#800080; '>;</span>
 45:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>-f</span> $PW <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#400000; '>open</span><span style='color:#808030; '>(</span>PW<span style='color:#808030; '>,</span> $PW<span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#800000; font-weight:bold; '>defined</span><span style='color:#808030; '>(</span><span style='color:#40015a; '>&lt;PW></span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 46:         $where <span style='color:#808030; '>=</span> $PW<span style='color:#800080; '>;</span>
 47:         <span style='color:#400000; '>undef</span> $reason<span style='color:#800080; '>;</span>
 48:     <span style='color:#800080; '>}</span>
 49:     <span style='color:#800080; '>}</span>
 50: 
 51:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$reason<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>    <span style='color:#696969; '># Give up.</span>
 52:     <span style='color:#800000; font-weight:bold; '>print</span> <span style='color:#0000e6; '>"</span><span style='color:#008c00; '>1</span><span style='color:#0000e6; '>.</span><span style='color:#008000; '>.0</span><span style='color:#0000e6; '> # Skip: $reason</span><span style='color:#0f69ff; '>\n</span><span style='color:#0000e6; '>"</span><span style='color:#800080; '>;</span>
 53:     <span style='color:#800000; font-weight:bold; '>exit</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
 54:     <span style='color:#800080; '>}</span>
 55: <span style='color:#800080; '>}</span>
 56: 
 57: <span style='color:#696969; '># By now PW filehandle should be open and full of juicy password entries.</span>
 58: 
 59: <span style='color:#800000; font-weight:bold; '>print</span> <span style='color:#0000e6; '>"</span><span style='color:#008c00; '>1</span><span style='color:#0000e6; '>.</span><span style='color:#008000; '>.1</span><span style='color:#0f69ff; '>\n</span><span style='color:#0000e6; '>"</span><span style='color:#800080; '>;</span>
 60: 
 61: <span style='color:#696969; '># Go through at most this many users.</span>
 62: <span style='color:#696969; '># (note that the first entry has been read away by now)</span>
 63: <span style='color:#800000; font-weight:bold; '>my</span> $max <span style='color:#808030; '>=</span> <span style='color:#008c00; '>25</span><span style='color:#800080; '>;</span>
 64: 
 65: <span style='color:#800000; font-weight:bold; '>my</span> $n <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
 66: <span style='color:#800000; font-weight:bold; '>my</span> $tst <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
 67: <span style='color:#800000; font-weight:bold; '>my</span> %perfect<span style='color:#800080; '>;</span>
 68: <span style='color:#800000; font-weight:bold; '>my</span> %seen<span style='color:#800080; '>;</span>
 69: 
 70: <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#40015a; '>&lt;PW></span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 71:     <span style='color:#400000; '>chomp</span><span style='color:#800080; '>;</span>
 72:     <span style='color:#800000; font-weight:bold; '>my</span> @s <span style='color:#808030; '>=</span> <span style='color:#808030; '>split</span><span style='color:#0000e6; '> </span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>:</span><span style='color:#800000; '>/</span><span style='color:#800080; '>;</span>
 73:     <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$name_s<span style='color:#808030; '>,</span> $passwd_s<span style='color:#808030; '>,</span> $uid_s<span style='color:#808030; '>,</span> $gid_s<span style='color:#808030; '>,</span> $gcos_s<span style='color:#808030; '>,</span> $home_s<span style='color:#808030; '>,</span> $shell_s<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @s<span style='color:#800080; '>;</span>
 74:     <span style='color:#800000; font-weight:bold; '>next</span> <span style='color:#808030; '>if</span><span style='color:#0000e6; '> </span><span style='color:#800000; '>/</span><span style='color:#808030; '>^</span><span style='color:#0f69ff; '>\+</span><span style='color:#800000; '>/</span><span style='color:#800080; '>;</span> <span style='color:#696969; '># ignore NIS includes</span>
 75:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>@s<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 76:     <span style='color:#400000; '>push</span> @<span style='color:#797997; '>{</span> $seen<span style='color:#808030; '>{</span>$name_s<span style='color:#808030; '>}</span> <span style='color:#797997; '>}</span><span style='color:#808030; '>,</span> <span style='color:#797997; '>$.</span><span style='color:#800080; '>;</span>
 77:     <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
 78:     <span style='color:#400000; '>warn</span> <span style='color:#0000e6; '>"# Your $where line </span><span style='color:#797997; '>$.</span><span style='color:#0000e6; '> is empty.</span><span style='color:#0f69ff; '>\n</span><span style='color:#0000e6; '>"</span><span style='color:#800080; '>;</span>
 79:     <span style='color:#800000; font-weight:bold; '>next</span><span style='color:#800080; '>;</span>
 80:     <span style='color:#800080; '>}</span>
 81:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$n <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> $max<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 82:     <span style='color:#800000; font-weight:bold; '>local</span> <span style='color:#797997; '>$/</span><span style='color:#800080; '>;</span>
 83:     <span style='color:#800000; font-weight:bold; '>my</span> $junk <span style='color:#808030; '>=</span> <span style='color:#40015a; '>&lt;PW></span><span style='color:#800080; '>;</span>
 84:     <span style='color:#800000; font-weight:bold; '>last</span><span style='color:#800080; '>;</span>
 85:     <span style='color:#800080; '>}</span>
 86:     <span style='color:#696969; '># In principle we could whine if @s != 7 but do we know enough</span>
 87:     <span style='color:#696969; '># of passwd file formats everywhere?</span>
 88:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>@s <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>7</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 89:     @n <span style='color:#808030; '>=</span> <span style='color:#400000; '>getpwuid</span><span style='color:#808030; '>(</span>$uid_s<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 90:     <span style='color:#696969; '># 'nobody' et al.</span>
 91:     <span style='color:#800000; font-weight:bold; '>next</span> <span style='color:#800000; font-weight:bold; '>unless</span> @n<span style='color:#800080; '>;</span>
 92:     <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$name<span style='color:#808030; '>,</span>$passwd<span style='color:#808030; '>,</span>$uid<span style='color:#808030; '>,</span>$gid<span style='color:#808030; '>,</span>$quota<span style='color:#808030; '>,</span>$comment<span style='color:#808030; '>,</span>$gcos<span style='color:#808030; '>,</span>$home<span style='color:#808030; '>,</span>$shell<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @n<span style='color:#800080; '>;</span>
 93:     <span style='color:#696969; '># Protect against one-to-many and many-to-one mappings.</span>
 94:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$name_s <span style='color:#808030; '>ne</span> $name<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 95:         @n <span style='color:#808030; '>=</span> <span style='color:#400000; '>getpwnam</span><span style='color:#808030; '>(</span>$name_s<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 96:         <span style='color:#808030; '>(</span>$name<span style='color:#808030; '>,</span>$passwd<span style='color:#808030; '>,</span>$uid<span style='color:#808030; '>,</span>$gid<span style='color:#808030; '>,</span>$quota<span style='color:#808030; '>,</span>$comment<span style='color:#808030; '>,</span>$gcos<span style='color:#808030; '>,</span>$home<span style='color:#808030; '>,</span>$shell<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @n<span style='color:#800080; '>;</span>
 97:         <span style='color:#800000; font-weight:bold; '>next</span> <span style='color:#800000; font-weight:bold; '>if</span> $name_s <span style='color:#808030; '>ne</span> $name<span style='color:#800080; '>;</span>
 98:     <span style='color:#800080; '>}</span>
 99:     $perfect<span style='color:#808030; '>{</span>$name_s<span style='color:#808030; '>}</span><span style='color:#808030; '>+</span><span style='color:#808030; '>+</span>
100:         <span style='color:#800000; font-weight:bold; '>if</span> $name    <span style='color:#808030; '>eq</span> $name_s    <span style='color:#808030; '>and</span>
101:                $uid     <span style='color:#808030; '>eq</span> $uid_s     <span style='color:#808030; '>and</span>
102: <span style='color:#696969; '># Do not compare passwords: think shadow passwords.</span>
103:                $gid     <span style='color:#808030; '>eq</span> $gid_s     <span style='color:#808030; '>and</span>
104:                $gcos    <span style='color:#808030; '>eq</span> $gcos_s    <span style='color:#808030; '>and</span>
105:                $home    <span style='color:#808030; '>eq</span> $home_s    <span style='color:#808030; '>and</span>
106:                $shell   <span style='color:#808030; '>eq</span> $shell_s<span style='color:#800080; '>;</span>
107:     <span style='color:#800080; '>}</span>
108:     $n<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#800080; '>;</span>
109: <span style='color:#800080; '>}</span>
110: 
111: <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>keys</span> %perfect <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
112:     $max<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#800080; '>;</span>
113: <span style='color:#000000; background:#ffffff; '>    </span><span style='color:#800000; background:#ffffff; font-weight:bold; '>print</span><span style='color:#000000; background:#ffffff; '> </span><span style='color:#800000; background:#ffffff; '>&lt;&lt;</span><span style='color:#e34adc; background:#ffffff; '>EOEX</span><span style='color:#800080; background:#ffffff; '>;</span><span style='color:#0000e6; '></span>
114: <span style='color:#0000e6; '>#</span>
115: <span style='color:#0000e6; '># The failure of op/pwent test is not necessarily serious.</span>
116: <span style='color:#0000e6; '># It may fail due to local password administration conventions.</span>
117: <span style='color:#0000e6; '># If you are for example using both NIS and local passwords,</span>
118: <span style='color:#0000e6; '># test failure is possible.  Any distributed password scheme</span>
119: <span style='color:#0000e6; '># can cause such failures.</span>
120: <span style='color:#0000e6; '>#</span>
121: <span style='color:#0000e6; '># What the pwent test is doing is that it compares the $max first</span>
122: <span style='color:#0000e6; '># entries of $where</span>
123: <span style='color:#0000e6; '># with the results of getpwuid() and getpwnam() call.  If it finds no</span>
124: <span style='color:#0000e6; '># matches at all, it suspects something is wrong.</span>
125: <span style='color:#0000e6; '># </span>
126: <span style='color:#e34adc; '>EOEX</span>
127:     <span style='color:#800000; font-weight:bold; '>print</span> <span style='color:#0000e6; '>"not "</span><span style='color:#800080; '>;</span>
128:     $not <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
129: <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
130:     $not <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
131: <span style='color:#800080; '>}</span>
132: <span style='color:#800000; font-weight:bold; '>print</span> <span style='color:#0000e6; '>"ok "</span><span style='color:#808030; '>,</span> $tst<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#800080; '>;</span>
133: <span style='color:#800000; font-weight:bold; '>print</span> <span style='color:#0000e6; '>"</span><span style='color:#0f69ff; '>\t</span><span style='color:#0000e6; '># (not necessarily serious: run t/op/pwent.t by itself)"</span> <span style='color:#800000; font-weight:bold; '>if</span> $not<span style='color:#800080; '>;</span>
134: <span style='color:#800000; font-weight:bold; '>print</span> <span style='color:#0000e6; '>"</span><span style='color:#0f69ff; '>\n</span><span style='color:#0000e6; '>"</span><span style='color:#800080; '>;</span>
135: 
136: <span style='color:#400000; '>close</span><span style='color:#808030; '>(</span>PW<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
137: 
