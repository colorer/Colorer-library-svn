   0: <span style='color:#696969; '>(* Copyright (C) 1987 Jensen &amp; Partners International *)</span>
   1: <span style='color:#696969; '>(*$V-,R-,S-,I-,A-,O-*)</span>
   2: <span style='color:#800000; font-weight:bold; '>IMPLEMENTATION</span> <span style='color:#800000; font-weight:bold; '>MODULE</span> Window<span style='color:#808030; '>;</span>
   3: 
   4: <span style='color:#800000; font-weight:bold; '>FROM</span> <span style='color:#800000; font-weight:bold; '>SYSTEM</span>  <span style='color:#800000; font-weight:bold; '>IMPORT</span> Registers<span style='color:#808030; '>,</span>CurrentProcess<span style='color:#808030; '>,</span>Seg<span style='color:#808030; '>,</span>Ofs<span style='color:#808030; '>;</span>
   5: <span style='color:#800000; font-weight:bold; '>FROM</span> Storage <span style='color:#800000; font-weight:bold; '>IMPORT</span> ALLOCATE<span style='color:#808030; '>,</span>DEALLOCATE<span style='color:#808030; '>;</span>
   6: <span style='color:#800000; font-weight:bold; '>FROM</span> Str     <span style='color:#800000; font-weight:bold; '>IMPORT</span> Length<span style='color:#808030; '>,</span>CHARSET<span style='color:#808030; '>,</span>Copy<span style='color:#808030; '>;</span>
   7: <span style='color:#800000; font-weight:bold; '>FROM</span> Lib     <span style='color:#800000; font-weight:bold; '>IMPORT</span> Move<span style='color:#808030; '>,</span>WordMove<span style='color:#808030; '>,</span>Fill<span style='color:#808030; '>,</span>WordFill<span style='color:#808030; '>,</span>ScanR<span style='color:#808030; '>,</span>FatalError<span style='color:#808030; '>;</span>
   8: <span style='color:#800000; font-weight:bold; '>FROM</span> AsmLib  <span style='color:#800000; font-weight:bold; '>IMPORT</span> BufferToScreen<span style='color:#808030; '>,</span>BufferWrite<span style='color:#808030; '>,</span>ActivePage<span style='color:#808030; '>,</span>PalXlat<span style='color:#808030; '>,</span>
   9:                     ScreenToBuffer<span style='color:#808030; '>,</span>InitScreenType<span style='color:#808030; '>;</span>
  10: 
  11: <span style='color:#800000; font-weight:bold; '>IMPORT</span> Lib<span style='color:#808030; '>,</span>IO<span style='color:#808030; '>;</span>
  12: 
  13: <span style='color:#800000; font-weight:bold; '>TYPE</span>
  14:   UseListPtr  <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>POINTER</span> <span style='color:#800000; font-weight:bold; '>TO</span> UseListLink<span style='color:#808030; '>;</span>
  15:   UseListLink <span style='color:#808030; '>=</span> <span style='color:#808030; '>RECORD</span>
  16:                   Next <span style='color:#808030; '>:</span> UseListPtr<span style='color:#808030; '>;</span>
  17:                   Proc <span style='color:#808030; '>:</span> ADDRESS<span style='color:#808030; '>;</span>
  18:                   Wind <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
  19:                 <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
  20: <span style='color:#800000; font-weight:bold; '>VAR</span>
  21:   UseList      <span style='color:#808030; '>:</span> UseListPtr<span style='color:#808030; '>;</span>
  22:   WindowStack  <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
  23:   CursorStack  <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
  24:   MultiP       <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>BOOLEAN</span><span style='color:#808030; '>;</span>
  25:   Lock<span style='color:#808030; '>,</span>Unlock  <span style='color:#808030; '>:</span> PROC<span style='color:#808030; '>;</span>
  26:   CursorLines  <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span> <span style='color:#808030; '>;</span>
  27: 
  28: 
  29: <span style='color:#800000; font-weight:bold; '>CONST</span>
  30:   GuardConst <span style='color:#808030; '>=</span> <span style='color:#008c00; '>4A4EH</span><span style='color:#808030; '>;</span>
  31: 
  32: 
  33: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> CheckWindow <span style='color:#696969; '>(*$N*)</span> <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
  34: <span style='color:#808030; '>BEGIN</span>
  35:   <span style='color:#808030; '>IF</span> W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Guard<span style='color:#808030; '>-</span>Seg<span style='color:#808030; '>(</span>W<span style='color:#808030; '>^</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>></span> GuardConst <span style='color:#800000; font-weight:bold; '>THEN</span>
  36:     FatalError<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'Window, Fatal error : Invalid window'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
  37:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
  38: <span style='color:#808030; '>END</span> CheckWindow<span style='color:#808030; '>;</span>
  39: 
  40: 
  41: 
  42: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> ClipFrame <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
  43: <span style='color:#800000; font-weight:bold; '>VAR</span>
  44:   i <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
  45: <span style='color:#808030; '>BEGIN</span>
  46:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
  47:     <span style='color:#808030; '>IF</span> WDef<span style='color:#008c00; '>.</span>FrameOn <span style='color:#800000; font-weight:bold; '>THEN</span> i <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>ELSE</span> i <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
  48:     <span style='color:#808030; '>IF</span> XA <span style='color:#808030; '>&lt;</span> WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>+</span>i <span style='color:#800000; font-weight:bold; '>THEN</span>
  49:       XA <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>+</span>i
  50:     <span style='color:#800000; font-weight:bold; '>ELSIF</span> XA <span style='color:#808030; '>></span> WDef<span style='color:#008c00; '>.</span>X2<span style='color:#808030; '>-</span>i <span style='color:#800000; font-weight:bold; '>THEN</span>
  51:       XA <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>X2<span style='color:#808030; '>-</span>i
  52:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
  53:     <span style='color:#808030; '>IF</span> XB <span style='color:#808030; '>></span> WDef<span style='color:#008c00; '>.</span>X2<span style='color:#808030; '>-</span>i <span style='color:#800000; font-weight:bold; '>THEN</span>
  54:       XB <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>X2<span style='color:#808030; '>-</span>i
  55:     <span style='color:#800000; font-weight:bold; '>ELSIF</span> XB <span style='color:#808030; '>&lt;</span> WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>+</span>i <span style='color:#800000; font-weight:bold; '>THEN</span>
  56:       XB <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>+</span>i
  57:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
  58:     <span style='color:#808030; '>IF</span> YA <span style='color:#808030; '>&lt;</span> WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>+</span>i <span style='color:#800000; font-weight:bold; '>THEN</span>
  59:       YA <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>+</span>i
  60:     <span style='color:#800000; font-weight:bold; '>ELSIF</span> YA <span style='color:#808030; '>></span> WDef<span style='color:#008c00; '>.</span>Y2<span style='color:#808030; '>-</span>i <span style='color:#800000; font-weight:bold; '>THEN</span>
  61:       YA <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>Y2<span style='color:#808030; '>-</span>i
  62:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
  63:     <span style='color:#808030; '>IF</span> YB <span style='color:#808030; '>></span> WDef<span style='color:#008c00; '>.</span>Y2<span style='color:#808030; '>-</span>i <span style='color:#800000; font-weight:bold; '>THEN</span>
  64:       YB <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>Y2<span style='color:#808030; '>-</span>i
  65:     <span style='color:#800000; font-weight:bold; '>ELSIF</span> YB <span style='color:#808030; '>&lt;</span> WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>+</span>i <span style='color:#800000; font-weight:bold; '>THEN</span>
  66:       YB <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>+</span>i
  67:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
  68:     Width <span style='color:#808030; '>:=</span> XB<span style='color:#808030; '>-</span>XA<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span> Depth <span style='color:#808030; '>:=</span> YB<span style='color:#808030; '>-</span>YA<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span>
  69:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
  70: <span style='color:#808030; '>END</span> ClipFrame<span style='color:#808030; '>;</span>
  71: 
  72: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> ClipXY <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span> <span style='color:#800000; font-weight:bold; '>VAR</span> X<span style='color:#808030; '>,</span>Y <span style='color:#808030; '>:</span> RelCoord <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
  73: <span style='color:#800000; font-weight:bold; '>VAR</span>
  74:   mw<span style='color:#808030; '>,</span>md <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
  75: <span style='color:#808030; '>BEGIN</span>
  76:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
  77:     mw <span style='color:#808030; '>:=</span> Width<span style='color:#808030; '>;</span> md <span style='color:#808030; '>:=</span> Depth<span style='color:#808030; '>;</span>
  78:     <span style='color:#808030; '>IF</span> WDef<span style='color:#008c00; '>.</span>FrameOn <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#800000; font-weight:bold; '>NOT</span> WDef<span style='color:#008c00; '>.</span>WrapOn <span style='color:#800000; font-weight:bold; '>THEN</span>
  79:       INC<span style='color:#808030; '>(</span>md<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> INC<span style='color:#808030; '>(</span>mw<span style='color:#808030; '>)</span>
  80:     <span style='color:#800000; font-weight:bold; '>ELSE</span>
  81:       <span style='color:#808030; '>IF</span> X<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>THEN</span> X <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>1</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
  82:       <span style='color:#808030; '>IF</span> Y<span style='color:#808030; '>=</span><span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>THEN</span> Y <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>1</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
  83:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
  84:     <span style='color:#808030; '>IF</span> X<span style='color:#808030; '>></span>mw <span style='color:#800000; font-weight:bold; '>THEN</span> X <span style='color:#808030; '>:=</span> mw <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
  85:     <span style='color:#808030; '>IF</span> Y<span style='color:#808030; '>></span>md <span style='color:#800000; font-weight:bold; '>THEN</span> Y <span style='color:#808030; '>:=</span> md <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
  86:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
  87: <span style='color:#808030; '>END</span> ClipXY<span style='color:#808030; '>;</span>
  88: 
  89: 
  90: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> BufferSpaceFill <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span> pos <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span> len <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span> <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
  91: <span style='color:#808030; '>BEGIN</span>
  92:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
  93:     <span style='color:#808030; '>IF</span> IsPalette <span style='color:#800000; font-weight:bold; '>THEN</span>
  94:       WordFill<span style='color:#808030; '>(</span>ADR<span style='color:#808030; '>(</span>Buffer<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span>pos<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>len<span style='color:#808030; '>,</span><span style='color:#008c00; '>32</span>
  95:                <span style='color:#808030; '>+</span>VAL<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>,</span>CurPalColor<span style='color:#808030; '>)</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>256</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
  96:     <span style='color:#800000; font-weight:bold; '>ELSE</span>
  97:       WordFill<span style='color:#808030; '>(</span>ADR<span style='color:#808030; '>(</span>Buffer<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span>pos<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>len<span style='color:#808030; '>,</span><span style='color:#008c00; '>32</span><span style='color:#808030; '>+</span>
  98:                ORD<span style='color:#808030; '>(</span>WDef<span style='color:#008c00; '>.</span>Foreground<span style='color:#808030; '>)</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>256</span><span style='color:#808030; '>+</span>ORD<span style='color:#808030; '>(</span>WDef<span style='color:#008c00; '>.</span>Background<span style='color:#808030; '>)</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>4096</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
  99:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 100:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 101: <span style='color:#808030; '>END</span> BufferSpaceFill<span style='color:#808030; '>;</span>
 102: 
 103: 
 104: 
 105: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> CurWin <span style='color:#808030; '>(</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 106: <span style='color:#696969; '>(*</span>
 107: <span style='color:#696969; '>    Returns The current window being used for output for this process</span>
 108: <span style='color:#696969; '>    If no window assigned by Use then returns Top</span>
 109: <span style='color:#696969; '>    NB Locks window system and leaves locked if MultiP set</span>
 110: <span style='color:#696969; '>*)</span>
 111: <span style='color:#800000; font-weight:bold; '>VAR</span>
 112:   u <span style='color:#808030; '>:</span> UseListPtr<span style='color:#808030; '>;</span>
 113:   p <span style='color:#808030; '>:</span> ADDRESS<span style='color:#808030; '>;</span>
 114: <span style='color:#808030; '>BEGIN</span>
 115:   <span style='color:#808030; '>IF</span> MultiP <span style='color:#800000; font-weight:bold; '>THEN</span>
 116:     Lock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 117:     p <span style='color:#808030; '>:=</span> CurrentProcess<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 118:     u <span style='color:#808030; '>:=</span> UseList<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next<span style='color:#808030; '>;</span>
 119:     <span style='color:#808030; '>LOOP</span>
 120:       <span style='color:#808030; '>IF</span> u<span style='color:#808030; '>=</span><span style='color:#800000; font-weight:bold; '>NIL</span> <span style='color:#800000; font-weight:bold; '>THEN</span>
 121:         <span style='color:#800000; font-weight:bold; '>RETURN</span> WindowStack <span style='color:#696969; '>(* Top() *)</span>
 122:       <span style='color:#800000; font-weight:bold; '>ELSIF</span> p<span style='color:#808030; '>=</span>u<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Proc <span style='color:#800000; font-weight:bold; '>THEN</span>
 123:         <span style='color:#800000; font-weight:bold; '>RETURN</span> u<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Wind<span style='color:#808030; '>;</span>
 124:       <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 125:       u <span style='color:#808030; '>:=</span> u<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next<span style='color:#808030; '>;</span>
 126:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 127:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 128:   u <span style='color:#808030; '>:=</span> UseList<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next<span style='color:#808030; '>;</span>
 129:   <span style='color:#808030; '>IF</span> u <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>NIL</span> <span style='color:#800000; font-weight:bold; '>THEN</span> <span style='color:#800000; font-weight:bold; '>RETURN</span> WindowStack <span style='color:#696969; '>(* Top() *)</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 130:   <span style='color:#800000; font-weight:bold; '>RETURN</span> u<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Wind<span style='color:#808030; '>;</span>
 131: <span style='color:#808030; '>END</span> CurWin<span style='color:#808030; '>;</span>
 132: 
 133: 
 134: 
 135: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> ResetCursor<span style='color:#808030; '>;</span>
 136: <span style='color:#800000; font-weight:bold; '>VAR</span>
 137:   R    <span style='color:#808030; '>:</span> Registers<span style='color:#808030; '>;</span>
 138:   mode <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
 139: <span style='color:#808030; '>BEGIN</span>
 140:   <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>CursorStack <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>NIL</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>OR</span>
 141:      ObscuredAt<span style='color:#808030; '>(</span>CursorStack<span style='color:#808030; '>,</span>CursorStack<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CurrentX<span style='color:#808030; '>,</span>CursorStack<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CurrentY<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span>
 142:     mode <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>2000H</span><span style='color:#808030; '>;</span>
 143:   <span style='color:#800000; font-weight:bold; '>ELSE</span>
 144:     <span style='color:#808030; '>WITH</span> CursorStack<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 145:       <span style='color:#808030; '>WITH</span> R <span style='color:#800000; font-weight:bold; '>DO</span>
 146:         AH <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>2</span><span style='color:#808030; '>;</span>
 147:         BH <span style='color:#808030; '>:=</span> ActivePage<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 148:         DL <span style='color:#808030; '>:=</span> SHORTCARD<span style='color:#808030; '>(</span>XA<span style='color:#808030; '>+</span>CurrentX<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 149:         DH <span style='color:#808030; '>:=</span> SHORTCARD<span style='color:#808030; '>(</span>YA<span style='color:#808030; '>+</span>CurrentY<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 150:       <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 151:       Lib<span style='color:#008c00; '>.</span>Intr<span style='color:#808030; '>(</span>R<span style='color:#808030; '>,</span><span style='color:#008c00; '>10H</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 152:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 153:     mode <span style='color:#808030; '>:=</span> CursorLines<span style='color:#808030; '>;</span>
 154:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 155:   R<span style='color:#008c00; '>.</span>AH <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span>
 156:   R<span style='color:#008c00; '>.</span>CX <span style='color:#808030; '>:=</span> mode<span style='color:#808030; '>;</span>
 157:   Lib<span style='color:#008c00; '>.</span>Intr<span style='color:#808030; '>(</span>R<span style='color:#808030; '>,</span><span style='color:#008c00; '>10H</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 158: <span style='color:#808030; '>END</span> ResetCursor<span style='color:#808030; '>;</span>
 159: 
 160: 
 161: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> UnlinkCursor <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 162: <span style='color:#800000; font-weight:bold; '>VAR</span>
 163:   w <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 164: <span style='color:#808030; '>BEGIN</span>
 165:   w <span style='color:#808030; '>:=</span> CursorStack<span style='color:#808030; '>;</span>
 166:   <span style='color:#808030; '>IF</span> w <span style='color:#808030; '>=</span> W <span style='color:#800000; font-weight:bold; '>THEN</span> CursorStack <span style='color:#808030; '>:=</span> w<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CursorChain <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 167:   <span style='color:#808030; '>LOOP</span>
 168:     <span style='color:#808030; '>IF</span> w <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>NIL</span> <span style='color:#800000; font-weight:bold; '>THEN</span> <span style='color:#800000; font-weight:bold; '>RETURN</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 169:     <span style='color:#808030; '>IF</span> w<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CursorChain <span style='color:#808030; '>=</span> W <span style='color:#800000; font-weight:bold; '>THEN</span>
 170:       w<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CursorChain <span style='color:#808030; '>:=</span> W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CursorChain<span style='color:#808030; '>;</span>
 171:       <span style='color:#800000; font-weight:bold; '>RETURN</span><span style='color:#808030; '>;</span>
 172:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 173:     w <span style='color:#808030; '>:=</span> w<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CursorChain<span style='color:#808030; '>;</span>
 174:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 175: <span style='color:#808030; '>END</span> UnlinkCursor<span style='color:#808030; '>;</span>
 176: 
 177: <span style='color:#696969; '>(* ------------------------- *)</span>
 178: <span style='color:#696969; '>(* Cursor Control            *)</span>
 179: <span style='color:#696969; '>(* ------------------------- *)</span>
 180: 
 181: 
 182: 
 183: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> CursorOn<span style='color:#808030; '>;</span>
 184: <span style='color:#800000; font-weight:bold; '>VAR</span>
 185:   w<span style='color:#808030; '>,</span>cw <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 186: <span style='color:#808030; '>BEGIN</span>
 187:   cw <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 188:   UnlinkCursor<span style='color:#808030; '>(</span>cw<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 189:   cw<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>CursorOn <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>TRUE</span><span style='color:#808030; '>;</span>
 190:   <span style='color:#808030; '>IF</span> <span style='color:#800000; font-weight:bold; '>NOT</span> cw<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>Hidden <span style='color:#800000; font-weight:bold; '>THEN</span>
 191:     cw<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CursorChain <span style='color:#808030; '>:=</span> CursorStack<span style='color:#808030; '>;</span>
 192:     CursorStack <span style='color:#808030; '>:=</span> cw<span style='color:#808030; '>;</span>
 193:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 194:   ResetCursor<span style='color:#808030; '>;</span>
 195:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 196: <span style='color:#808030; '>END</span> CursorOn<span style='color:#808030; '>;</span>
 197: 
 198: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> CursorOff<span style='color:#808030; '>;</span>
 199: <span style='color:#800000; font-weight:bold; '>VAR</span>
 200:   w<span style='color:#808030; '>,</span>cw <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 201: <span style='color:#808030; '>BEGIN</span>
 202:   cw <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 203:   UnlinkCursor<span style='color:#808030; '>(</span>cw<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 204:   cw<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>CursorOn <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>FALSE</span><span style='color:#808030; '>;</span>
 205:   ResetCursor<span style='color:#808030; '>;</span>
 206:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 207: <span style='color:#808030; '>END</span> CursorOff<span style='color:#808030; '>;</span>
 208: 
 209: <span style='color:#696969; '>(* ------------------------- *)</span>
 210: <span style='color:#696969; '>(* Window creation           *)</span>
 211: <span style='color:#696969; '>(* ------------------------- *)</span>
 212: 
 213: 
 214: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> MakeWindow <span style='color:#808030; '>(</span> <span style='color:#800000; font-weight:bold; '>VAR</span> WD <span style='color:#808030; '>:</span> WinDef <span style='color:#808030; '>)</span> <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 215: 
 216: <span style='color:#696969; '>(*</span>
 217: <span style='color:#696969; '>  Creates a new Window descriptor</span>
 218: <span style='color:#696969; '>  The size is Inclusive of frame if needed</span>
 219: <span style='color:#696969; '>  does not allocate buffer</span>
 220: <span style='color:#696969; '>*)</span>
 221: <span style='color:#800000; font-weight:bold; '>VAR</span> W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span> min <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span> <span style='color:#808030; '>;</span>
 222: <span style='color:#808030; '>BEGIN</span>
 223:   NEW<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 224:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 225:     <span style='color:#808030; '>WITH</span> WD <span style='color:#800000; font-weight:bold; '>DO</span>
 226:       <span style='color:#808030; '>IF</span> X2 <span style='color:#808030; '>>=</span> ScreenWidth <span style='color:#800000; font-weight:bold; '>THEN</span> X2<span style='color:#808030; '>:=</span>ScreenWidth<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 227:       <span style='color:#808030; '>IF</span> Y2 <span style='color:#808030; '>>=</span> ScreenDepth <span style='color:#800000; font-weight:bold; '>THEN</span> Y2<span style='color:#808030; '>:=</span>ScreenDepth<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 228:       <span style='color:#808030; '>IF</span> WD<span style='color:#008c00; '>.</span>FrameOn <span style='color:#800000; font-weight:bold; '>THEN</span> min <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>2</span> <span style='color:#800000; font-weight:bold; '>ELSE</span> min <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0</span> <span style='color:#808030; '>END</span> <span style='color:#808030; '>;</span>
 229:       <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>X1<span style='color:#808030; '>+</span>min<span style='color:#808030; '>></span>X2<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span> X2 <span style='color:#808030; '>:=</span> X1<span style='color:#808030; '>+</span>min <span style='color:#808030; '>END</span> <span style='color:#808030; '>;</span>
 230:       <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>Y1<span style='color:#808030; '>+</span>min<span style='color:#808030; '>></span>Y2<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span> Y2 <span style='color:#808030; '>:=</span> Y1<span style='color:#808030; '>+</span>min <span style='color:#808030; '>END</span> <span style='color:#808030; '>;</span>
 231:       XA  <span style='color:#808030; '>:=</span> X1<span style='color:#808030; '>;</span> YA  <span style='color:#808030; '>:=</span> Y1<span style='color:#808030; '>;</span> XB <span style='color:#808030; '>:=</span> X2<span style='color:#808030; '>;</span> YB <span style='color:#808030; '>:=</span> Y2<span style='color:#808030; '>;</span>
 232:       Width <span style='color:#808030; '>:=</span> X2<span style='color:#808030; '>-</span>X1<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span>    <span style='color:#808030; '>;</span> Depth <span style='color:#808030; '>:=</span> Y2<span style='color:#808030; '>-</span>Y1<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span>
 233:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 234:     WDef <span style='color:#808030; '>:=</span> WD<span style='color:#808030; '>;</span>
 235:     OWidth <span style='color:#808030; '>:=</span> Width     <span style='color:#808030; '>;</span> ODepth <span style='color:#808030; '>:=</span> Depth<span style='color:#808030; '>;</span>
 236:     CurrentX   <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span>
 237:     CurrentY   <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span>
 238:     Next       <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>NIL</span><span style='color:#808030; '>;</span>
 239:     Buffer     <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>NIL</span><span style='color:#808030; '>;</span>
 240:     UserRecord <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>NIL</span><span style='color:#808030; '>;</span>
 241:     IsPalette  <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>FALSE</span><span style='color:#808030; '>;</span>
 242:     CurPalColor<span style='color:#808030; '>:=</span> NormalPaletteColor<span style='color:#808030; '>;</span>
 243:     TMode      <span style='color:#808030; '>:=</span> NoTitle<span style='color:#808030; '>;</span>
 244:     Guard      <span style='color:#808030; '>:=</span> GuardConst<span style='color:#808030; '>+</span>Seg<span style='color:#808030; '>(</span>W<span style='color:#808030; '>^</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 245:     Title      <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>NIL</span><span style='color:#808030; '>;</span>
 246:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 247:   ClipFrame<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 248:   <span style='color:#800000; font-weight:bold; '>RETURN</span> W<span style='color:#808030; '>;</span>
 249: <span style='color:#808030; '>END</span> MakeWindow<span style='color:#808030; '>;</span>
 250: 
 251: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> Open <span style='color:#808030; '>(</span> WD <span style='color:#808030; '>:</span> WinDef <span style='color:#808030; '>)</span> <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 252: <span style='color:#696969; '>(*</span>
 253: <span style='color:#696969; '>  Opens a window on the screen ready for use</span>
 254: <span style='color:#696969; '>*)</span>
 255: <span style='color:#800000; font-weight:bold; '>VAR</span>
 256:   W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 257: <span style='color:#808030; '>BEGIN</span>
 258:   Lock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 259:   W <span style='color:#808030; '>:=</span> MakeWindow <span style='color:#808030; '>(</span>WD<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 260:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 261:     ALLOCATE <span style='color:#808030; '>(</span> Buffer<span style='color:#808030; '>,</span>OWidth<span style='color:#808030; '>*</span>ODepth<span style='color:#808030; '>*</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 262:     BufferSpaceFill<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>OWidth<span style='color:#808030; '>*</span>ODepth<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 263:     <span style='color:#808030; '>IF</span> WD<span style='color:#008c00; '>.</span>FrameOn <span style='color:#800000; font-weight:bold; '>THEN</span>
 264:       SetFrame<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>WDef<span style='color:#008c00; '>.</span>FrameDef<span style='color:#808030; '>,</span>WDef<span style='color:#008c00; '>.</span>FrameFore<span style='color:#808030; '>,</span>WDef<span style='color:#008c00; '>.</span>FrameBack<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 265:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 266:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 267:   <span style='color:#808030; '>IF</span> WD<span style='color:#008c00; '>.</span>Hidden <span style='color:#800000; font-weight:bold; '>THEN</span>
 268:     Use <span style='color:#808030; '>(</span> W <span style='color:#808030; '>)</span>
 269:   <span style='color:#800000; font-weight:bold; '>ELSE</span>
 270:     PutOnTop <span style='color:#808030; '>(</span> W <span style='color:#808030; '>)</span>
 271:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 272:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 273:   <span style='color:#800000; font-weight:bold; '>RETURN</span> W<span style='color:#808030; '>;</span>
 274: <span style='color:#808030; '>END</span> Open<span style='color:#808030; '>;</span>
 275: 
 276: 
 277: <span style='color:#696969; '>(* ------------------------- *)</span>
 278: <span style='color:#696969; '>(* Window stack manipulation *)</span>
 279: <span style='color:#696969; '>(* and screen redraw         *)</span>
 280: <span style='color:#696969; '>(* ------------------------- *)</span>
 281: 
 282: 
 283: 
 284: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> Use <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 285: <span style='color:#696969; '>(*</span>
 286: <span style='color:#696969; '>   Causes all subsequent output (by the current process)</span>
 287: <span style='color:#696969; '>   to appear in the specified Window</span>
 288: <span style='color:#696969; '>   NB does not have to be Top Window (or in fact on the screen at all)</span>
 289: <span style='color:#696969; '>   UseList is the MRU window</span>
 290: <span style='color:#696969; '>*)</span>
 291: <span style='color:#800000; font-weight:bold; '>VAR</span>
 292:   p  <span style='color:#808030; '>:</span> ADDRESS<span style='color:#808030; '>;</span>
 293:   u  <span style='color:#808030; '>:</span> UseListPtr<span style='color:#808030; '>;</span>
 294:   up <span style='color:#808030; '>:</span> UseListPtr<span style='color:#808030; '>;</span>
 295: <span style='color:#808030; '>BEGIN</span>
 296:   Lock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 297:   CheckWindow<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 298:   p  <span style='color:#808030; '>:=</span> CurrentProcess<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 299:   up <span style='color:#808030; '>:=</span> UseList<span style='color:#808030; '>;</span>
 300:   u  <span style='color:#808030; '>:=</span> up<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next<span style='color:#808030; '>;</span>
 301:   <span style='color:#808030; '>LOOP</span>
 302:     <span style='color:#808030; '>IF</span> u <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>NIL</span> <span style='color:#800000; font-weight:bold; '>THEN</span> NEW<span style='color:#808030; '>(</span>u<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> u<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Proc <span style='color:#808030; '>:=</span> p<span style='color:#808030; '>;</span> <span style='color:#800000; font-weight:bold; '>EXIT</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 303:     <span style='color:#808030; '>IF</span> p <span style='color:#808030; '>=</span> u<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Proc <span style='color:#800000; font-weight:bold; '>THEN</span> up<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next <span style='color:#808030; '>:=</span> u<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next<span style='color:#808030; '>;</span> <span style='color:#800000; font-weight:bold; '>EXIT</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 304:     up <span style='color:#808030; '>:=</span> u<span style='color:#808030; '>;</span> u <span style='color:#808030; '>:=</span> u<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next<span style='color:#808030; '>;</span>
 305:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 306:   u<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next <span style='color:#808030; '>:=</span> UseList<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next<span style='color:#808030; '>;</span>
 307:   UseList<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next <span style='color:#808030; '>:=</span> u<span style='color:#808030; '>;</span>
 308:   u<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Wind <span style='color:#808030; '>:=</span> W<span style='color:#808030; '>;</span>
 309:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 310: <span style='color:#808030; '>END</span> Use<span style='color:#808030; '>;</span>
 311: 
 312: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> TakeOffStack <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> <span style='color:#696969; '>(* Private *)</span>
 313: <span style='color:#800000; font-weight:bold; '>VAR</span> pw <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 314: <span style='color:#808030; '>BEGIN</span>
 315:   <span style='color:#808030; '>IF</span> W <span style='color:#808030; '>=</span> WindowStack <span style='color:#800000; font-weight:bold; '>THEN</span>
 316:     WindowStack <span style='color:#808030; '>:=</span> W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next<span style='color:#808030; '>;</span>
 317:   <span style='color:#800000; font-weight:bold; '>ELSE</span>
 318:     pw <span style='color:#808030; '>:=</span> WindowStack<span style='color:#808030; '>;</span>
 319:     <span style='color:#808030; '>IF</span> W <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>></span> pw <span style='color:#800000; font-weight:bold; '>THEN</span>
 320:       <span style='color:#808030; '>LOOP</span>
 321:         <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>pw <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>NIL</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span> <span style='color:#800000; font-weight:bold; '>EXIT</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 322:         <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>pw<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next <span style='color:#808030; '>=</span> W<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span> pw<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next <span style='color:#808030; '>:=</span> W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next<span style='color:#808030; '>;</span> <span style='color:#800000; font-weight:bold; '>EXIT</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 323:         pw <span style='color:#808030; '>:=</span> pw<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next<span style='color:#808030; '>;</span>
 324:       <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 325:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 326:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 327:   W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>NIL</span><span style='color:#808030; '>;</span>
 328: <span style='color:#808030; '>END</span> TakeOffStack<span style='color:#808030; '>;</span>
 329: 
 330: 
 331: 
 332: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> UpdateScreen <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span> X<span style='color:#808030; '>,</span>Y <span style='color:#808030; '>:</span> AbsCoord<span style='color:#808030; '>;</span> Len <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span> <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 333: <span style='color:#696969; '>(* Updates the screen from the window buffer *)</span>
 334: <span style='color:#800000; font-weight:bold; '>VAR</span>
 335:   NextLen<span style='color:#808030; '>,</span>
 336:   NextX <span style='color:#808030; '>:</span> AbsCoord<span style='color:#808030; '>;</span>
 337:   w     <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 338:   oxa<span style='color:#808030; '>,</span>oxb<span style='color:#808030; '>,</span>ax<span style='color:#808030; '>,</span>bx <span style='color:#808030; '>:</span> AbsCoord<span style='color:#808030; '>;</span>
 339:   buff  <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>ARRAY</span><span style='color:#808030; '>[</span><span style='color:#008c00; '>0..</span>ScreenWidth<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#800000; font-weight:bold; '>OF</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
 340:   a     <span style='color:#808030; '>:</span> ADDRESS<span style='color:#808030; '>;</span>
 341: <span style='color:#808030; '>BEGIN</span>
 342:   <span style='color:#808030; '>IF</span> W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>Hidden <span style='color:#800000; font-weight:bold; '>THEN</span> <span style='color:#800000; font-weight:bold; '>RETURN</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 343:   <span style='color:#808030; '>WHILE</span> Len<span style='color:#808030; '>&lt;</span><span style='color:#808030; '>></span><span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 344:     <span style='color:#696969; '>(* adjust co ordinates for crossing windows *)</span>
 345:     NextLen <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>;</span>
 346:     w <span style='color:#808030; '>:=</span> WindowStack<span style='color:#808030; '>;</span>
 347:     ax <span style='color:#808030; '>:=</span> X<span style='color:#808030; '>;</span> bx <span style='color:#808030; '>:=</span> X<span style='color:#808030; '>+</span>Len<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span>
 348:     <span style='color:#808030; '>LOOP</span>
 349:       <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>w <span style='color:#808030; '>=</span> W<span style='color:#808030; '>)</span><span style='color:#800000; font-weight:bold; '>OR</span><span style='color:#808030; '>(</span>w<span style='color:#808030; '>=</span><span style='color:#800000; font-weight:bold; '>NIL</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span> <span style='color:#800000; font-weight:bold; '>EXIT</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 350:       <span style='color:#808030; '>WITH</span> w<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 351:         <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>Y<span style='color:#808030; '>>=</span>WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#808030; '>(</span>Y<span style='color:#808030; '>&lt;=</span>WDef<span style='color:#008c00; '>.</span>Y2<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span>
 352:           oxa <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>;</span> oxb <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>X2<span style='color:#808030; '>;</span>
 353:           <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>ax<span style='color:#808030; '>>=</span>oxa<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#808030; '>(</span>bx<span style='color:#808030; '>&lt;=</span>oxb<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span>    <span style='color:#696969; '>(* wiped out *)</span>
 354:             ax <span style='color:#808030; '>:=</span> bx<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span> <span style='color:#800000; font-weight:bold; '>EXIT</span><span style='color:#808030; '>;</span>
 355:           <span style='color:#800000; font-weight:bold; '>ELSIF</span> <span style='color:#808030; '>(</span>ax<span style='color:#808030; '>&lt;=</span>oxb<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#808030; '>(</span>bx<span style='color:#808030; '>>=</span>oxa<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span> <span style='color:#696969; '>(* some interaction *)</span>
 356:             <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>ax<span style='color:#808030; '>&lt;</span>oxa<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#808030; '>(</span>bx<span style='color:#808030; '>></span>oxb<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span>    <span style='color:#696969; '>(* cut into two *)</span>
 357:               bx <span style='color:#808030; '>:=</span> oxa<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span>
 358:               NextX <span style='color:#808030; '>:=</span> oxb<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span>
 359:               NextLen <span style='color:#808030; '>:=</span> X<span style='color:#808030; '>+</span>Len<span style='color:#808030; '>-</span>NextX<span style='color:#808030; '>;</span>
 360:             <span style='color:#800000; font-weight:bold; '>ELSIF</span> <span style='color:#808030; '>(</span>bx<span style='color:#808030; '>></span>oxb<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span> <span style='color:#696969; '>(* left edge cut off *)</span>
 361:               ax <span style='color:#808030; '>:=</span> oxb<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span>
 362:             <span style='color:#800000; font-weight:bold; '>ELSIF</span> <span style='color:#808030; '>(</span>ax<span style='color:#808030; '>&lt;</span>oxa<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span> <span style='color:#696969; '>(* right edge cut off *)</span>
 363:               bx <span style='color:#808030; '>:=</span> oxa<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span>
 364:             <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 365:           <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 366:         <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 367:         w <span style='color:#808030; '>:=</span> Next<span style='color:#808030; '>;</span>
 368:       <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 369:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 370:     Len <span style='color:#808030; '>:=</span> bx<span style='color:#808030; '>-</span>ax<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span>
 371:     <span style='color:#808030; '>IF</span> Len <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>></span> <span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>THEN</span>
 372:       <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 373:         a <span style='color:#808030; '>:=</span> ADR<span style='color:#808030; '>(</span>Buffer<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span><span style='color:#808030; '>(</span>ax<span style='color:#808030; '>-</span>WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>Y<span style='color:#808030; '>-</span>WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>)</span><span style='color:#808030; '>*</span>OWidth<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 374:         <span style='color:#808030; '>IF</span> IsPalette <span style='color:#800000; font-weight:bold; '>THEN</span>
 375:           PalXlat<span style='color:#808030; '>(</span>ADR<span style='color:#808030; '>(</span>buff<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>a<span style='color:#808030; '>,</span>Len<span style='color:#808030; '>,</span>ADR<span style='color:#808030; '>(</span>PalAttr<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 376:           a <span style='color:#808030; '>:=</span> ADR<span style='color:#808030; '>(</span>buff<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 377:         <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 378:         BufferToScreen <span style='color:#808030; '>(</span> ax<span style='color:#808030; '>,</span>Y<span style='color:#808030; '>,</span>a<span style='color:#808030; '>,</span>Len<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 379:       <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 380:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 381:     X   <span style='color:#808030; '>:=</span> NextX<span style='color:#808030; '>;</span>
 382:     Len <span style='color:#808030; '>:=</span> NextLen<span style='color:#808030; '>;</span>
 383:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 384: <span style='color:#808030; '>END</span> UpdateScreen<span style='color:#808030; '>;</span>
 385: 
 386: 
 387: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> RedrawSection <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 388:                                  X1<span style='color:#808030; '>,</span>Y1<span style='color:#808030; '>,</span>X2<span style='color:#808030; '>,</span>Y2 <span style='color:#808030; '>:</span> AbsCoord <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> <span style='color:#696969; '>(* Private *)</span>
 389: <span style='color:#696969; '>(* redraws rectangular portion of the window from the buffer *)</span>
 390: <span style='color:#800000; font-weight:bold; '>VAR</span>
 391:   Y <span style='color:#808030; '>:</span> AbsCoord<span style='color:#808030; '>;</span>
 392: <span style='color:#808030; '>BEGIN</span>
 393:   <span style='color:#808030; '>FOR</span> Y <span style='color:#808030; '>:=</span> Y1 <span style='color:#800000; font-weight:bold; '>TO</span> Y2 <span style='color:#800000; font-weight:bold; '>DO</span>
 394:     UpdateScreen<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>X1<span style='color:#808030; '>,</span>Y<span style='color:#808030; '>,</span>X2<span style='color:#808030; '>-</span>X1<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 395:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 396: <span style='color:#808030; '>END</span> RedrawSection<span style='color:#808030; '>;</span>
 397: 
 398: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> RedrawWindow <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> <span style='color:#696969; '>(* Private *)</span>
 399: <span style='color:#808030; '>BEGIN</span>
 400:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 401:     RedrawSection <span style='color:#808030; '>(</span> W<span style='color:#808030; '>,</span>WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>,</span>WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>,</span>WDef<span style='color:#008c00; '>.</span>X2<span style='color:#808030; '>,</span>WDef<span style='color:#008c00; '>.</span>Y2 <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 402:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 403: <span style='color:#808030; '>END</span> RedrawWindow<span style='color:#808030; '>;</span>
 404: 
 405: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> RedrawWindowPane <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> <span style='color:#696969; '>(* Private *)</span>
 406: <span style='color:#808030; '>BEGIN</span>
 407:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 408:     RedrawSection <span style='color:#808030; '>(</span> W<span style='color:#808030; '>,</span>XA<span style='color:#808030; '>,</span>YA<span style='color:#808030; '>,</span>XB<span style='color:#808030; '>,</span>YB <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 409:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 410: <span style='color:#808030; '>END</span> RedrawWindowPane<span style='color:#808030; '>;</span>
 411: 
 412: 
 413: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> DisplayBeneath <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span> NW <span style='color:#808030; '>:</span> WinType <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> <span style='color:#696969; '>(* Private *)</span>
 414: <span style='color:#696969; '>(* Re-displays windows Obscured by W from NW *)</span>
 415: <span style='color:#800000; font-weight:bold; '>VAR</span>
 416:   x1<span style='color:#808030; '>,</span>x2<span style='color:#808030; '>,</span>y1<span style='color:#808030; '>,</span>y2 <span style='color:#808030; '>:</span> AbsCoord<span style='color:#808030; '>;</span>
 417: <span style='color:#808030; '>BEGIN</span>
 418:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 419:     <span style='color:#808030; '>WHILE</span> NW<span style='color:#808030; '>&lt;</span><span style='color:#808030; '>></span><span style='color:#800000; font-weight:bold; '>NIL</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 420:       <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>WDef<span style='color:#008c00; '>.</span>X2<span style='color:#808030; '>>=</span>NW<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>)</span><span style='color:#800000; font-weight:bold; '>AND</span><span style='color:#808030; '>(</span>NW<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>X2<span style='color:#808030; '>>=</span>WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>AND</span>
 421:           <span style='color:#808030; '>(</span>WDef<span style='color:#008c00; '>.</span>Y2<span style='color:#808030; '>>=</span>NW<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>)</span><span style='color:#800000; font-weight:bold; '>AND</span><span style='color:#808030; '>(</span>NW<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>Y2<span style='color:#808030; '>>=</span>WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span> <span style='color:#696969; '>(* windows cross *)</span>
 422:          <span style='color:#696969; '>(* calculate Intersection *)</span>
 423:          <span style='color:#808030; '>IF</span> WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>></span>NW<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>X1 <span style='color:#800000; font-weight:bold; '>THEN</span>
 424:            x1 <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>X1
 425:          <span style='color:#800000; font-weight:bold; '>ELSE</span>
 426:            x1 <span style='color:#808030; '>:=</span> NW<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>X1
 427:          <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 428:          <span style='color:#808030; '>IF</span> WDef<span style='color:#008c00; '>.</span>X2<span style='color:#808030; '>&lt;</span>NW<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>X2 <span style='color:#800000; font-weight:bold; '>THEN</span>
 429:            x2 <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>X2
 430:          <span style='color:#800000; font-weight:bold; '>ELSE</span>
 431:            x2 <span style='color:#808030; '>:=</span> NW<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>X2
 432:          <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 433:          <span style='color:#808030; '>IF</span> WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>></span>NW<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>Y1 <span style='color:#800000; font-weight:bold; '>THEN</span>
 434:            y1 <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>Y1
 435:          <span style='color:#800000; font-weight:bold; '>ELSE</span>
 436:            y1 <span style='color:#808030; '>:=</span> NW<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>Y1
 437:          <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 438:          <span style='color:#808030; '>IF</span> WDef<span style='color:#008c00; '>.</span>Y2<span style='color:#808030; '>&lt;</span>NW<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>Y2 <span style='color:#800000; font-weight:bold; '>THEN</span>
 439:            y2 <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>Y2
 440:          <span style='color:#800000; font-weight:bold; '>ELSE</span>
 441:            y2 <span style='color:#808030; '>:=</span> NW<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>Y2
 442:          <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 443:          RedrawSection <span style='color:#808030; '>(</span>NW<span style='color:#808030; '>,</span> x1<span style='color:#808030; '>,</span>y1<span style='color:#808030; '>,</span>x2<span style='color:#808030; '>,</span>y2 <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 444:       <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 445:       NW <span style='color:#808030; '>:=</span> NW<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next<span style='color:#808030; '>;</span>
 446:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 447:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 448: <span style='color:#808030; '>END</span> DisplayBeneath<span style='color:#808030; '>;</span>
 449: 
 450: 
 451: 
 452: 
 453: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> PutOnTop <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 454: <span style='color:#696969; '>(*</span>
 455: <span style='color:#696969; '>   Puts the specified window on the top of the window stack</span>
 456: <span style='color:#696969; '>   Ensuring that it is fully visible.</span>
 457: <span style='color:#696969; '>   If this results in other windows becoming obscured then a buffer</span>
 458: <span style='color:#696969; '>   is allocated for each of these windows.</span>
 459: <span style='color:#696969; '>   All otherwise undirected output (ie with no Use) will appear</span>
 460: <span style='color:#696969; '>   within this window.</span>
 461: <span style='color:#696969; '>*)</span>
 462: 
 463: <span style='color:#808030; '>BEGIN</span>
 464:   Lock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 465:   CheckWindow<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 466:   <span style='color:#808030; '>IF</span> W <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>></span> WindowStack <span style='color:#800000; font-weight:bold; '>THEN</span>
 467:     TakeOffStack<span style='color:#808030; '>(</span> W <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 468:     W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next     <span style='color:#808030; '>:=</span> WindowStack<span style='color:#808030; '>;</span>
 469:     WindowStack <span style='color:#808030; '>:=</span> W<span style='color:#808030; '>;</span>
 470:     <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 471:       WDef<span style='color:#008c00; '>.</span>Hidden <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>FALSE</span><span style='color:#808030; '>;</span>
 472:       RedrawWindow <span style='color:#808030; '>(</span> W <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 473:       <span style='color:#808030; '>IF</span> WDef<span style='color:#008c00; '>.</span>CursorOn <span style='color:#800000; font-weight:bold; '>THEN</span>
 474:         Use <span style='color:#808030; '>(</span> W <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 475:         CursorOn<span style='color:#808030; '>;</span>
 476:       <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 477:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 478:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 479:   Use <span style='color:#808030; '>(</span> W <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 480:   ResetCursor<span style='color:#808030; '>;</span>
 481:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 482: <span style='color:#808030; '>END</span> PutOnTop<span style='color:#808030; '>;</span>
 483: 
 484: 
 485: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> Hide <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 486: <span style='color:#696969; '>(*</span>
 487: <span style='color:#696969; '>    Removes window from the Window stack and also the screen</span>
 488: <span style='color:#696969; '>    Placing the windows contents in a buffer for possible re-display later</span>
 489: <span style='color:#696969; '>    Uncovers obscured windows</span>
 490: <span style='color:#696969; '>*)</span>
 491: <span style='color:#800000; font-weight:bold; '>VAR</span>
 492:   p <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 493:   w <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 494: <span style='color:#808030; '>BEGIN</span>
 495:   Lock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 496:   CheckWindow<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 497:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 498:     <span style='color:#808030; '>IF</span> <span style='color:#800000; font-weight:bold; '>NOT</span> WDef<span style='color:#008c00; '>.</span>Hidden <span style='color:#800000; font-weight:bold; '>THEN</span>
 499:       w <span style='color:#808030; '>:=</span> W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next<span style='color:#808030; '>;</span>
 500:       TakeOffStack <span style='color:#808030; '>(</span> W <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 501:       DisplayBeneath <span style='color:#808030; '>(</span> W<span style='color:#808030; '>,</span> w <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 502:       <span style='color:#808030; '>IF</span> WDef<span style='color:#008c00; '>.</span>CursorOn <span style='color:#800000; font-weight:bold; '>THEN</span> CursorOff<span style='color:#808030; '>;</span> WDef<span style='color:#008c00; '>.</span>CursorOn <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>TRUE</span><span style='color:#808030; '>;</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 503:       WDef<span style='color:#008c00; '>.</span>Hidden <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>TRUE</span><span style='color:#808030; '>;</span>
 504:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 505:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 506:   ResetCursor<span style='color:#808030; '>;</span>
 507:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 508: <span style='color:#808030; '>END</span> Hide<span style='color:#808030; '>;</span>
 509: 
 510: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> PutBeneath <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span> WA <span style='color:#808030; '>:</span> WinType <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 511: <span style='color:#696969; '>(*</span>
 512: <span style='color:#696969; '>    Puts window W beneath window WA</span>
 513: <span style='color:#696969; '>*)</span>
 514: <span style='color:#800000; font-weight:bold; '>VAR</span>
 515:   p <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 516:   w <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 517: <span style='color:#808030; '>BEGIN</span>
 518:   Hide<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 519:   Lock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 520:   CheckWindow<span style='color:#808030; '>(</span>WA<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 521:   <span style='color:#808030; '>WITH</span> WA<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 522:     <span style='color:#808030; '>IF</span> <span style='color:#800000; font-weight:bold; '>NOT</span> WDef<span style='color:#008c00; '>.</span>Hidden <span style='color:#800000; font-weight:bold; '>THEN</span>
 523:       w <span style='color:#808030; '>:=</span> Next<span style='color:#808030; '>;</span>
 524:       Next <span style='color:#808030; '>:=</span> W<span style='color:#808030; '>;</span>
 525:       W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next <span style='color:#808030; '>:=</span> w<span style='color:#808030; '>;</span>
 526:       W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>Hidden <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>FALSE</span><span style='color:#808030; '>;</span>
 527:       RedrawWindow <span style='color:#808030; '>(</span> W <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 528:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 529:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 530:   ResetCursor<span style='color:#808030; '>;</span>
 531:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 532: <span style='color:#808030; '>END</span> PutBeneath<span style='color:#808030; '>;</span>
 533: 
 534: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> SnapShot<span style='color:#808030; '>;</span>
 535: <span style='color:#696969; '>(* Updates the Window buffer from the screen *)</span>
 536: <span style='color:#696969; '>(* only works with non palette windows       *)</span>
 537: <span style='color:#800000; font-weight:bold; '>VAR</span>
 538:   W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 539:   y <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
 540:   p <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
 541: <span style='color:#808030; '>BEGIN</span>
 542:   W <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 543:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 544:     <span style='color:#808030; '>WITH</span> WDef <span style='color:#800000; font-weight:bold; '>DO</span>
 545:       <span style='color:#808030; '>IF</span> <span style='color:#800000; font-weight:bold; '>NOT</span> IsPalette <span style='color:#800000; font-weight:bold; '>THEN</span>
 546:         p <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>;</span>
 547:         <span style='color:#808030; '>FOR</span> y <span style='color:#808030; '>:=</span> Y1 <span style='color:#800000; font-weight:bold; '>TO</span> Y2 <span style='color:#800000; font-weight:bold; '>DO</span>
 548:           ScreenToBuffer<span style='color:#808030; '>(</span>X1<span style='color:#808030; '>,</span>y<span style='color:#808030; '>,</span>ADR<span style='color:#808030; '>(</span>Buffer<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span>p<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>OWidth<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 549:           INC<span style='color:#808030; '>(</span>p<span style='color:#808030; '>,</span>OWidth<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 550:         <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 551:       <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 552:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 553:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 554:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 555: <span style='color:#808030; '>END</span> SnapShot<span style='color:#808030; '>;</span>
 556: 
 557: 
 558: <span style='color:#696969; '>(* ------------------------- *)</span>
 559: <span style='color:#696969; '>(* Window disposal           *)</span>
 560: <span style='color:#696969; '>(* ------------------------- *)</span>
 561: 
 562: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> DisposeTitle <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 563: <span style='color:#808030; '>BEGIN</span>
 564:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 565:     <span style='color:#808030; '>IF</span> TMode <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>></span> NoTitle <span style='color:#800000; font-weight:bold; '>THEN</span>
 566:       DEALLOCATE<span style='color:#808030; '>(</span>Title<span style='color:#808030; '>,</span>Length<span style='color:#808030; '>(</span>Title<span style='color:#808030; '>^</span><span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 567:       TMode <span style='color:#808030; '>:=</span> NoTitle<span style='color:#808030; '>;</span>
 568:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 569:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 570: <span style='color:#808030; '>END</span> DisposeTitle<span style='color:#808030; '>;</span>
 571: 
 572: 
 573: 
 574: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> Close <span style='color:#808030; '>(</span> <span style='color:#800000; font-weight:bold; '>VAR</span> W <span style='color:#808030; '>:</span> WinType <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 575: <span style='color:#696969; '>(*</span>
 576: <span style='color:#696969; '>     removes the specified window from the screen</span>
 577: <span style='color:#696969; '>     deletes window descriptor and</span>
 578: <span style='color:#696969; '>     de-allocates any buffers previously allocated.</span>
 579: <span style='color:#696969; '>*)</span>
 580: <span style='color:#800000; font-weight:bold; '>VAR</span>
 581:   w       <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 582:   u<span style='color:#808030; '>,</span>up<span style='color:#808030; '>,</span>un <span style='color:#808030; '>:</span> UseListPtr<span style='color:#808030; '>;</span>
 583: <span style='color:#808030; '>BEGIN</span>
 584:   Lock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 585:   Hide <span style='color:#808030; '>(</span> W <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 586:   TakeOffStack <span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 587:   UnlinkCursor<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 588:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 589:     <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>Buffer <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>></span> <span style='color:#800000; font-weight:bold; '>NIL</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span> DEALLOCATE<span style='color:#808030; '>(</span>Buffer<span style='color:#808030; '>,</span>OWidth <span style='color:#808030; '>*</span> ODepth <span style='color:#808030; '>*</span> <span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 590:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 591:   up <span style='color:#808030; '>:=</span> UseList<span style='color:#808030; '>;</span>
 592:   u <span style='color:#808030; '>:=</span> up<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next<span style='color:#808030; '>;</span>
 593:   <span style='color:#808030; '>WHILE</span> <span style='color:#808030; '>(</span>u<span style='color:#808030; '>&lt;</span><span style='color:#808030; '>></span><span style='color:#800000; font-weight:bold; '>NIL</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 594:     un <span style='color:#808030; '>:=</span> u<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next<span style='color:#808030; '>;</span>
 595:     <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>u<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Wind <span style='color:#808030; '>=</span> W<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span>
 596:       up<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next <span style='color:#808030; '>:=</span> un<span style='color:#808030; '>;</span>
 597:       DISPOSE<span style='color:#808030; '>(</span>u<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 598:     <span style='color:#800000; font-weight:bold; '>ELSE</span>
 599:       up <span style='color:#808030; '>:=</span> u<span style='color:#808030; '>;</span>
 600:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 601:     u <span style='color:#808030; '>:=</span> un<span style='color:#808030; '>;</span>
 602:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 603:   DisposeTitle<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 604:   W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Guard <span style='color:#808030; '>:=</span> GuardConst<span style='color:#808030; '>;</span> <span style='color:#696969; '>(* Invalidate guard *)</span>
 605:   DISPOSE<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 606:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 607: <span style='color:#808030; '>END</span> Close<span style='color:#808030; '>;</span>
 608: 
 609: 
 610: 
 611: 
 612: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> Used <span style='color:#808030; '>(</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 613: <span style='color:#696969; '>(*</span>
 614: <span style='color:#696969; '>    Returns The current window being used for output for this process</span>
 615: <span style='color:#696969; '>    If no window assigned by Use then returns Top</span>
 616: <span style='color:#696969; '>*)</span>
 617: <span style='color:#800000; font-weight:bold; '>VAR</span>
 618:   w <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 619: <span style='color:#808030; '>BEGIN</span>
 620:   w <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 621:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 622:   <span style='color:#800000; font-weight:bold; '>RETURN</span> w<span style='color:#808030; '>;</span>
 623: <span style='color:#808030; '>END</span> Used<span style='color:#808030; '>;</span>
 624: 
 625: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> Top <span style='color:#808030; '>(</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 626: <span style='color:#696969; '>(*</span>
 627: <span style='color:#696969; '>    Returns The current top Window</span>
 628: <span style='color:#696969; '>*)</span>
 629: <span style='color:#800000; font-weight:bold; '>VAR</span> w <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 630: <span style='color:#808030; '>BEGIN</span>
 631:   Lock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 632:   w <span style='color:#808030; '>:=</span> WindowStack<span style='color:#808030; '>;</span>
 633:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 634:   <span style='color:#800000; font-weight:bold; '>RETURN</span> w<span style='color:#808030; '>;</span>
 635: <span style='color:#808030; '>END</span> Top<span style='color:#808030; '>;</span>
 636: 
 637: 
 638: 
 639: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> At <span style='color:#808030; '>(</span>X<span style='color:#808030; '>,</span>Y <span style='color:#808030; '>:</span> AbsCoord<span style='color:#808030; '>)</span> <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 640: <span style='color:#696969; '>(*</span>
 641: <span style='color:#696969; '>    Returns the window displayed at the absolute position X,Y</span>
 642: <span style='color:#696969; '>*)</span>
 643: <span style='color:#800000; font-weight:bold; '>VAR</span>
 644:   W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 645: <span style='color:#808030; '>BEGIN</span>
 646:   Lock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 647:   W <span style='color:#808030; '>:=</span> WindowStack<span style='color:#808030; '>;</span>
 648:   <span style='color:#808030; '>LOOP</span>
 649:     <span style='color:#808030; '>IF</span> W <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>NIL</span> <span style='color:#800000; font-weight:bold; '>THEN</span> <span style='color:#800000; font-weight:bold; '>EXIT</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 650:     <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 651:       <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>Y <span style='color:#808030; '>>=</span> WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#808030; '>(</span>Y <span style='color:#808030; '>&lt;=</span> WDef<span style='color:#008c00; '>.</span>Y2<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>AND</span>
 652:          <span style='color:#808030; '>(</span>X <span style='color:#808030; '>>=</span> WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#808030; '>(</span>X <span style='color:#808030; '>&lt;=</span> WDef<span style='color:#008c00; '>.</span>X2<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span>
 653:         <span style='color:#800000; font-weight:bold; '>EXIT</span>
 654:       <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 655:       W <span style='color:#808030; '>:=</span> Next<span style='color:#808030; '>;</span>
 656:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 657:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 658:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 659:   <span style='color:#800000; font-weight:bold; '>RETURN</span> W<span style='color:#808030; '>;</span>
 660: <span style='color:#808030; '>END</span> At<span style='color:#808030; '>;</span>
 661: 
 662: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> ObscuredAt <span style='color:#808030; '>(</span>W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span> X<span style='color:#808030; '>,</span>Y <span style='color:#808030; '>:</span> RelCoord <span style='color:#808030; '>)</span> <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>BOOLEAN</span><span style='color:#808030; '>;</span>
 663: <span style='color:#696969; '>(*</span>
 664: <span style='color:#696969; '>    Returns if the specified window is obscured at the specified position</span>
 665: <span style='color:#696969; '>*)</span>
 666: <span style='color:#800000; font-weight:bold; '>VAR</span>
 667:   b <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>BOOLEAN</span><span style='color:#808030; '>;</span>
 668:   w <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 669: <span style='color:#808030; '>BEGIN</span>
 670:   Lock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 671:   CheckWindow<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 672:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 673:     <span style='color:#808030; '>IF</span> WDef<span style='color:#008c00; '>.</span>Hidden <span style='color:#800000; font-weight:bold; '>THEN</span>
 674:       b<span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>TRUE</span><span style='color:#808030; '>;</span>
 675:     <span style='color:#800000; font-weight:bold; '>ELSE</span>
 676:       INC<span style='color:#808030; '>(</span>X<span style='color:#808030; '>,</span>XA<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> INC<span style='color:#808030; '>(</span>Y<span style='color:#808030; '>,</span>YA<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 677:       w <span style='color:#808030; '>:=</span> WindowStack<span style='color:#808030; '>;</span>
 678:       <span style='color:#808030; '>LOOP</span>
 679:         <span style='color:#808030; '>IF</span> w <span style='color:#808030; '>=</span> W <span style='color:#800000; font-weight:bold; '>THEN</span> b <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>FALSE</span><span style='color:#808030; '>;</span> <span style='color:#800000; font-weight:bold; '>EXIT</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 680:         <span style='color:#808030; '>WITH</span> w<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 681:           <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>Y<span style='color:#808030; '>>=</span>WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#808030; '>(</span>Y<span style='color:#808030; '>&lt;=</span>WDef<span style='color:#008c00; '>.</span>Y2<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>AND</span>
 682:              <span style='color:#808030; '>(</span>X<span style='color:#808030; '>>=</span>WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>AND</span> <span style='color:#808030; '>(</span>X<span style='color:#808030; '>&lt;=</span>WDef<span style='color:#008c00; '>.</span>X2<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span>
 683:             b <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>TRUE</span><span style='color:#808030; '>;</span>
 684:             <span style='color:#800000; font-weight:bold; '>EXIT</span>
 685:           <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 686:           w <span style='color:#808030; '>:=</span> Next<span style='color:#808030; '>;</span>
 687:         <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 688:       <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 689:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 690:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 691:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 692:   <span style='color:#800000; font-weight:bold; '>RETURN</span> b<span style='color:#808030; '>;</span>
 693: <span style='color:#808030; '>END</span> ObscuredAt<span style='color:#808030; '>;</span>
 694: 
 695: 
 696: 
 697: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> WindowWrite <span style='color:#808030; '>(</span> W     <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 698:                                x<span style='color:#808030; '>,</span>y   <span style='color:#808030; '>:</span> RelCoord<span style='color:#808030; '>;</span>
 699:                                Len   <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
 700:                                str   <span style='color:#808030; '>:</span> ADDRESS<span style='color:#808030; '>;</span>
 701:                                frame <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>BOOLEAN</span> <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> <span style='color:#696969; '>(* Private *)</span>
 702: <span style='color:#800000; font-weight:bold; '>VAR</span>
 703:   Attr <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
 704:   X<span style='color:#808030; '>,</span>Y  <span style='color:#808030; '>:</span> AbsCoord<span style='color:#808030; '>;</span>
 705: <span style='color:#808030; '>BEGIN</span>
 706:   <span style='color:#808030; '>IF</span> Len<span style='color:#808030; '>></span><span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>THEN</span>
 707:     <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 708:       <span style='color:#808030; '>IF</span> IsPalette <span style='color:#800000; font-weight:bold; '>THEN</span>
 709:         <span style='color:#808030; '>IF</span> frame <span style='color:#800000; font-weight:bold; '>THEN</span>
 710:           Attr <span style='color:#808030; '>:=</span> VAL<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>,</span>FramePaletteColor<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 711:         <span style='color:#800000; font-weight:bold; '>ELSE</span>
 712:           Attr <span style='color:#808030; '>:=</span> VAL<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>,</span>CurPalColor<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 713:         <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 714:       <span style='color:#800000; font-weight:bold; '>ELSIF</span> frame <span style='color:#800000; font-weight:bold; '>THEN</span>
 715:         Attr <span style='color:#808030; '>:=</span> ORD<span style='color:#808030; '>(</span>WDef<span style='color:#008c00; '>.</span>FrameFore<span style='color:#808030; '>)</span><span style='color:#808030; '>+</span>ORD<span style='color:#808030; '>(</span>WDef<span style='color:#008c00; '>.</span>FrameBack<span style='color:#808030; '>)</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>;</span>
 716:       <span style='color:#800000; font-weight:bold; '>ELSE</span>
 717:         Attr <span style='color:#808030; '>:=</span> ORD<span style='color:#808030; '>(</span>WDef<span style='color:#008c00; '>.</span>Foreground<span style='color:#808030; '>)</span><span style='color:#808030; '>+</span>ORD<span style='color:#808030; '>(</span>WDef<span style='color:#008c00; '>.</span>Background<span style='color:#808030; '>)</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>;</span>
 718:       <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 719:       X <span style='color:#808030; '>:=</span> x<span style='color:#808030; '>+</span>XA<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span> Y <span style='color:#808030; '>:=</span> y<span style='color:#808030; '>+</span>YA<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span>
 720:       <span style='color:#808030; '>IF</span> Len<span style='color:#808030; '>+</span>X<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span> <span style='color:#808030; '>></span> WDef<span style='color:#008c00; '>.</span>X2 <span style='color:#800000; font-weight:bold; '>THEN</span> Len <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>X2<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>-</span>X <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 721:       BufferWrite <span style='color:#808030; '>(</span>ADR<span style='color:#808030; '>(</span>Buffer<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span>X<span style='color:#808030; '>-</span>WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>Y<span style='color:#808030; '>-</span>WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>)</span><span style='color:#808030; '>*</span>OWidth<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>str<span style='color:#808030; '>,</span>Len<span style='color:#808030; '>,</span>Attr<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 722:       UpdateScreen<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>X<span style='color:#808030; '>,</span>Y<span style='color:#808030; '>,</span>Len<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 723:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 724:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 725: <span style='color:#808030; '>END</span> WindowWrite<span style='color:#808030; '>;</span>
 726: 
 727: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> DrawFrame <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 728: <span style='color:#800000; font-weight:bold; '>VAR</span>
 729:   s      <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>ARRAY</span><span style='color:#808030; '>[</span><span style='color:#008c00; '>0..81</span><span style='color:#808030; '>]</span> <span style='color:#800000; font-weight:bold; '>OF</span> <span style='color:#800000; font-weight:bold; '>CHAR</span><span style='color:#808030; '>;</span>
 730:   w<span style='color:#808030; '>,</span>l<span style='color:#808030; '>,</span>tl <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
 731:   i      <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
 732: 
 733:   <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> PutTitle <span style='color:#808030; '>(</span> mode <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span> row <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span> <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 734:   <span style='color:#800000; font-weight:bold; '>VAR</span>
 735:     i<span style='color:#808030; '>,</span>j <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
 736:   <span style='color:#808030; '>BEGIN</span>
 737:     <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 738:       <span style='color:#808030; '>CASE</span> mode <span style='color:#800000; font-weight:bold; '>OF</span>
 739:         <span style='color:#008c00; '>0</span> <span style='color:#808030; '>:</span> i <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>1</span>                     <span style='color:#808030; '>|</span>
 740:         <span style='color:#008c00; '>1</span> <span style='color:#808030; '>:</span> i <span style='color:#808030; '>:=</span> <span style='color:#808030; '>(</span>Width<span style='color:#808030; '>-</span>tl<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>DIV</span> <span style='color:#008c00; '>2</span> <span style='color:#808030; '>+</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span> <span style='color:#808030; '>|</span>
 741:         <span style='color:#008c00; '>2</span> <span style='color:#808030; '>:</span> i <span style='color:#808030; '>:=</span> Width<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>-</span>tl            <span style='color:#808030; '>|</span>
 742:       <span style='color:#800000; font-weight:bold; '>ELSE</span>
 743:         i <span style='color:#808030; '>:=</span> MAX<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 744:       <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 745:       j <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>;</span>
 746:       <span style='color:#808030; '>WHILE</span> <span style='color:#808030; '>(</span>i<span style='color:#808030; '>&lt;=</span>Width<span style='color:#808030; '>)</span><span style='color:#800000; font-weight:bold; '>AND</span><span style='color:#808030; '>(</span>j<span style='color:#808030; '>&lt;</span>tl<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 747:         s<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span> <span style='color:#808030; '>:=</span> Title<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span>j<span style='color:#808030; '>]</span><span style='color:#808030; '>;</span> INC<span style='color:#808030; '>(</span>i<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> INC<span style='color:#808030; '>(</span>j<span style='color:#808030; '>)</span>
 748:       <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 749:       WindowWrite <span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>row<span style='color:#808030; '>,</span>OWidth<span style='color:#808030; '>,</span>ADR<span style='color:#808030; '>(</span>s<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#800000; font-weight:bold; '>TRUE</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 750:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 751:   <span style='color:#808030; '>END</span> PutTitle<span style='color:#808030; '>;</span>
 752: 
 753: 
 754: <span style='color:#808030; '>BEGIN</span>
 755:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 756:     <span style='color:#808030; '>IF</span> <span style='color:#800000; font-weight:bold; '>NOT</span> WDef<span style='color:#008c00; '>.</span>FrameOn <span style='color:#800000; font-weight:bold; '>THEN</span>
 757:       <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>OWidth<span style='color:#808030; '>&lt;</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>)</span><span style='color:#800000; font-weight:bold; '>OR</span><span style='color:#808030; '>(</span>ODepth<span style='color:#808030; '>&lt;</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span> <span style='color:#800000; font-weight:bold; '>RETURN</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span> <span style='color:#696969; '>(* No Room *)</span>
 758:       WDef<span style='color:#008c00; '>.</span>FrameOn <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>TRUE</span><span style='color:#808030; '>;</span>
 759:       ClipFrame<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 760:       ResetCursor<span style='color:#808030; '>;</span>
 761:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 762:     s<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>FrameDef<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#808030; '>;</span>
 763:     Fill<span style='color:#808030; '>(</span>ADR<span style='color:#808030; '>(</span>s<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>Width<span style='color:#808030; '>,</span>WDef<span style='color:#008c00; '>.</span>FrameDef<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 764:     s<span style='color:#808030; '>[</span>Width<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>FrameDef<span style='color:#808030; '>[</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>]</span><span style='color:#808030; '>;</span>
 765:     <span style='color:#808030; '>IF</span> TMode <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>></span> NoTitle <span style='color:#800000; font-weight:bold; '>THEN</span>
 766:       tl <span style='color:#808030; '>:=</span> Length<span style='color:#808030; '>(</span>Title<span style='color:#808030; '>^</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 767:       <span style='color:#808030; '>IF</span> tl<span style='color:#808030; '>></span>Width <span style='color:#800000; font-weight:bold; '>THEN</span> tl <span style='color:#808030; '>:=</span> Width <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 768:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 769:     PutTitle<span style='color:#808030; '>(</span>ORD<span style='color:#808030; '>(</span>TMode<span style='color:#808030; '>-</span>LeftUpperTitle<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 770:     <span style='color:#696969; '>(* Sides *)</span>
 771:     <span style='color:#808030; '>FOR</span> i <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>TO</span> Depth <span style='color:#800000; font-weight:bold; '>DO</span>
 772:       WindowWrite<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>i<span style='color:#808030; '>,</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>ADR<span style='color:#808030; '>(</span>WDef<span style='color:#008c00; '>.</span>FrameDef<span style='color:#808030; '>[</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#800000; font-weight:bold; '>TRUE</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 773:       WindowWrite<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>Width<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>i<span style='color:#808030; '>,</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>ADR<span style='color:#808030; '>(</span>WDef<span style='color:#008c00; '>.</span>FrameDef<span style='color:#808030; '>[</span><span style='color:#008c00; '>4</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#800000; font-weight:bold; '>TRUE</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 774:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 775:     s<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>FrameDef<span style='color:#808030; '>[</span><span style='color:#008c00; '>5</span><span style='color:#808030; '>]</span><span style='color:#808030; '>;</span>
 776:     Fill<span style='color:#808030; '>(</span>ADR<span style='color:#808030; '>(</span>s<span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>Width<span style='color:#808030; '>,</span>WDef<span style='color:#008c00; '>.</span>FrameDef<span style='color:#808030; '>[</span><span style='color:#008c00; '>6</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 777:     s<span style='color:#808030; '>[</span>Width<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#808030; '>:=</span> WDef<span style='color:#008c00; '>.</span>FrameDef<span style='color:#808030; '>[</span><span style='color:#008c00; '>7</span><span style='color:#808030; '>]</span><span style='color:#808030; '>;</span>
 778:     PutTitle<span style='color:#808030; '>(</span>ORD<span style='color:#808030; '>(</span>TMode<span style='color:#808030; '>-</span>LeftLowerTitle<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>Depth<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 779:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 780: <span style='color:#808030; '>END</span> DrawFrame<span style='color:#808030; '>;</span>
 781: 
 782: 
 783: 
 784: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span>  <span style='color:#696969; '>(*$F*)</span> SetFrame <span style='color:#808030; '>(</span> W     <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 785:                              Frame <span style='color:#808030; '>:</span> FrameStr<span style='color:#808030; '>;</span>
 786:                              Fore<span style='color:#808030; '>,</span> Back  <span style='color:#808030; '>:</span> Color <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 787: <span style='color:#696969; '>(*</span>
 788: <span style='color:#696969; '>   Put a frame around the specified window</span>
 789: <span style='color:#696969; '>   With Title String and border definition (see above)</span>
 790: <span style='color:#696969; '>   having specified fore/background colours for the border</span>
 791: <span style='color:#696969; '>*)</span>
 792: <span style='color:#808030; '>BEGIN</span>
 793:   Lock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 794:   CheckWindow<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 795:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 796:     WDef<span style='color:#008c00; '>.</span>FrameDef <span style='color:#808030; '>:=</span> Frame<span style='color:#808030; '>;</span>
 797:     WDef<span style='color:#008c00; '>.</span>FrameFore <span style='color:#808030; '>:=</span> Fore<span style='color:#808030; '>;</span>
 798:     WDef<span style='color:#008c00; '>.</span>FrameBack <span style='color:#808030; '>:=</span> Back<span style='color:#808030; '>;</span>
 799:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 800:   DrawFrame<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 801:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 802: <span style='color:#808030; '>END</span> SetFrame<span style='color:#808030; '>;</span>
 803: 
 804: 
 805: 
 806: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> MergeWindows <span style='color:#808030; '>(</span> s<span style='color:#808030; '>,</span>d <span style='color:#808030; '>:</span> WinType <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 807: <span style='color:#696969; '>(* slightly complicated procedure to merge two windows</span>
 808: <span style='color:#696969; '>   s is new (hidden) window</span>
 809: <span style='color:#696969; '>   d is old window to be merged into</span>
 810: <span style='color:#696969; '>*)</span>
 811: <span style='color:#800000; font-weight:bold; '>VAR</span>
 812:   w <span style='color:#808030; '>:</span> WinDescriptor<span style='color:#808030; '>;</span>
 813:   r<span style='color:#808030; '>,</span>wd        <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
 814:   sw<span style='color:#808030; '>,</span>sd<span style='color:#808030; '>,</span>so<span style='color:#808030; '>,</span>sp <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
 815:   dw<span style='color:#808030; '>,</span>dd<span style='color:#808030; '>,</span>do<span style='color:#808030; '>,</span>dp <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
 816: <span style='color:#808030; '>BEGIN</span>
 817:   s<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CurrentX    <span style='color:#808030; '>:=</span> d<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CurrentX<span style='color:#808030; '>;</span>
 818:   s<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CurrentY    <span style='color:#808030; '>:=</span> d<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CurrentY<span style='color:#808030; '>;</span>
 819:   s<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CursorChain <span style='color:#808030; '>:=</span> d<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CursorChain<span style='color:#808030; '>;</span>
 820:   s<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>UserRecord  <span style='color:#808030; '>:=</span> d<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>UserRecord<span style='color:#808030; '>;</span>
 821:   s<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CurPalColor <span style='color:#808030; '>:=</span> d<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CurPalColor<span style='color:#808030; '>;</span>
 822:   s<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Title       <span style='color:#808030; '>:=</span> d<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Title<span style='color:#808030; '>;</span>
 823:   s<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>TMode       <span style='color:#808030; '>:=</span> d<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>TMode<span style='color:#808030; '>;</span>
 824:   d<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>TMode       <span style='color:#808030; '>:=</span> NoTitle<span style='color:#808030; '>;</span>
 825:   d<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>CursorOn  <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>FALSE</span><span style='color:#808030; '>;</span>
 826:   w <span style='color:#808030; '>:=</span> d<span style='color:#808030; '>^</span><span style='color:#808030; '>;</span> d<span style='color:#808030; '>^</span> <span style='color:#808030; '>:=</span> s<span style='color:#808030; '>^</span><span style='color:#808030; '>;</span> s<span style='color:#808030; '>^</span> <span style='color:#808030; '>:=</span> w<span style='color:#808030; '>;</span>
 827:   <span style='color:#808030; '>WITH</span> s<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 828:     sw <span style='color:#808030; '>:=</span> OWidth<span style='color:#808030; '>;</span> sd <span style='color:#808030; '>:=</span> ODepth<span style='color:#808030; '>;</span>
 829:     <span style='color:#808030; '>IF</span> WDef<span style='color:#008c00; '>.</span>FrameOn <span style='color:#800000; font-weight:bold; '>THEN</span>
 830:       DEC<span style='color:#808030; '>(</span>sw<span style='color:#808030; '>,</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> DEC<span style='color:#808030; '>(</span>sd<span style='color:#808030; '>,</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 831:       sp <span style='color:#808030; '>:=</span> <span style='color:#808030; '>(</span>OWidth<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 832:     <span style='color:#800000; font-weight:bold; '>ELSE</span>
 833:       sp <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>;</span>
 834:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 835:     Guard <span style='color:#808030; '>:=</span> GuardConst<span style='color:#808030; '>+</span>Seg<span style='color:#808030; '>(</span>s<span style='color:#808030; '>^</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 836:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 837:   <span style='color:#808030; '>WITH</span> d<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 838:     dw <span style='color:#808030; '>:=</span> OWidth<span style='color:#808030; '>;</span> dd <span style='color:#808030; '>:=</span> ODepth<span style='color:#808030; '>;</span>
 839:     <span style='color:#808030; '>IF</span> WDef<span style='color:#008c00; '>.</span>FrameOn <span style='color:#800000; font-weight:bold; '>THEN</span>
 840:       DEC<span style='color:#808030; '>(</span>dw<span style='color:#808030; '>,</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> DEC<span style='color:#808030; '>(</span>dd<span style='color:#808030; '>,</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 841:       dp <span style='color:#808030; '>:=</span> OWidth<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span>
 842:     <span style='color:#800000; font-weight:bold; '>ELSE</span>
 843:       dp <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>;</span>
 844:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 845:     Guard <span style='color:#808030; '>:=</span> GuardConst<span style='color:#808030; '>+</span>Seg<span style='color:#808030; '>(</span>d<span style='color:#808030; '>^</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 846:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 847:   <span style='color:#808030; '>IF</span> sd <span style='color:#808030; '>&lt;</span> dd <span style='color:#800000; font-weight:bold; '>THEN</span> wd <span style='color:#808030; '>:=</span> sd <span style='color:#800000; font-weight:bold; '>ELSE</span> wd <span style='color:#808030; '>:=</span> dd <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 848:   <span style='color:#808030; '>FOR</span> r <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>TO</span> wd<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 849:     <span style='color:#808030; '>IF</span> sw<span style='color:#808030; '>>=</span>dw <span style='color:#800000; font-weight:bold; '>THEN</span>
 850:       WordMove<span style='color:#808030; '>(</span>ADR<span style='color:#808030; '>(</span>s<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Buffer<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span>sp<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>ADR<span style='color:#808030; '>(</span>d<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Buffer<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span>dp<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>dw<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 851:     <span style='color:#800000; font-weight:bold; '>ELSE</span>
 852:       WordMove<span style='color:#808030; '>(</span>ADR<span style='color:#808030; '>(</span>s<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Buffer<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span>sp<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>ADR<span style='color:#808030; '>(</span>d<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Buffer<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span>dp<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>sw<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 853:       BufferSpaceFill<span style='color:#808030; '>(</span>d<span style='color:#808030; '>,</span>dp<span style='color:#808030; '>+</span>sw<span style='color:#808030; '>,</span>dw<span style='color:#808030; '>-</span>sw<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 854:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 855:     INC<span style='color:#808030; '>(</span>sp<span style='color:#808030; '>,</span>s<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>OWidth<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> INC<span style='color:#808030; '>(</span>dp<span style='color:#808030; '>,</span>d<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>OWidth<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 856:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 857:   <span style='color:#696969; '>(* now fill rest *)</span>
 858:   <span style='color:#808030; '>IF</span> wd<span style='color:#808030; '>&lt;</span>dd <span style='color:#800000; font-weight:bold; '>THEN</span>
 859:     <span style='color:#808030; '>FOR</span> r <span style='color:#808030; '>:=</span> wd <span style='color:#800000; font-weight:bold; '>TO</span> dd<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 860:       BufferSpaceFill<span style='color:#808030; '>(</span>d<span style='color:#808030; '>,</span>dp<span style='color:#808030; '>,</span>dw<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 861:       INC<span style='color:#808030; '>(</span>dp<span style='color:#808030; '>,</span>d<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>OWidth<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 862:     <span style='color:#808030; '>END</span>
 863:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 864:   <span style='color:#808030; '>IF</span> d<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>FrameOn <span style='color:#800000; font-weight:bold; '>THEN</span> DrawFrame<span style='color:#808030; '>(</span>d<span style='color:#808030; '>)</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 865:   <span style='color:#808030; '>IF</span> <span style='color:#800000; font-weight:bold; '>NOT</span> s<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>Hidden <span style='color:#800000; font-weight:bold; '>THEN</span>
 866:     d<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next <span style='color:#808030; '>:=</span> s<span style='color:#808030; '>;</span>
 867:     d<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>Hidden <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>FALSE</span><span style='color:#808030; '>;</span>
 868:     RedrawWindow<span style='color:#808030; '>(</span>d<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 869:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 870:   Close<span style='color:#808030; '>(</span>s<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 871: <span style='color:#808030; '>END</span> MergeWindows<span style='color:#808030; '>;</span>
 872: 
 873: 
 874: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> IGotoXY <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span> X<span style='color:#808030; '>,</span>Y <span style='color:#808030; '>:</span> RelCoord <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 875: <span style='color:#696969; '>(*</span>
 876: <span style='color:#696969; '>    Sets the current X Y position of the pane currently being used</span>
 877: <span style='color:#696969; '>*)</span>
 878: <span style='color:#808030; '>BEGIN</span>
 879:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span> CurrentX <span style='color:#808030; '>:=</span> X<span style='color:#808030; '>;</span> CurrentY <span style='color:#808030; '>:=</span> Y <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 880:   <span style='color:#808030; '>IF</span> CursorStack <span style='color:#808030; '>=</span> W <span style='color:#800000; font-weight:bold; '>THEN</span> ResetCursor <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 881: <span style='color:#808030; '>END</span> IGotoXY<span style='color:#808030; '>;</span>
 882: 
 883: 
 884: 
 885: 
 886: <span style='color:#696969; '>(* ------------------------- *)</span>
 887: <span style='color:#696969; '>(* Palette procedures        *)</span>
 888: <span style='color:#696969; '>(* ------------------------- *)</span>
 889: 
 890: 
 891: 
 892: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> GetPal <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span> <span style='color:#800000; font-weight:bold; '>VAR</span> Pal <span style='color:#808030; '>:</span> PaletteDef <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 893: <span style='color:#800000; font-weight:bold; '>VAR</span>
 894:   i <span style='color:#808030; '>:</span> PaletteRange<span style='color:#808030; '>;</span>
 895: <span style='color:#808030; '>BEGIN</span>
 896:   CheckWindow<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 897:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 898:     <span style='color:#808030; '>FOR</span> i <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>TO</span> PaletteMax <span style='color:#800000; font-weight:bold; '>DO</span>
 899:       Pal<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>.</span>Fore <span style='color:#808030; '>:=</span> Color<span style='color:#808030; '>(</span>PalAttr<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span> <span style='color:#800000; font-weight:bold; '>MOD</span> <span style='color:#008c00; '>16</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 900:       Pal<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>.</span>Back <span style='color:#808030; '>:=</span> Color<span style='color:#808030; '>(</span>PalAttr<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span> <span style='color:#800000; font-weight:bold; '>DIV</span> <span style='color:#008c00; '>16</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 901:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 902:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 903: <span style='color:#808030; '>END</span> GetPal<span style='color:#808030; '>;</span>
 904: 
 905: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> SetPal <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span> <span style='color:#800000; font-weight:bold; '>VAR</span> Pal <span style='color:#808030; '>:</span> PaletteDef <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 906: <span style='color:#800000; font-weight:bold; '>VAR</span>
 907:   i <span style='color:#808030; '>:</span> PaletteRange<span style='color:#808030; '>;</span>
 908: <span style='color:#808030; '>BEGIN</span>
 909:   CheckWindow<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 910:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 911:     <span style='color:#808030; '>FOR</span> i <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>TO</span> PaletteMax <span style='color:#800000; font-weight:bold; '>DO</span>
 912:       PalAttr<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span> <span style='color:#808030; '>:=</span> VAL<span style='color:#808030; '>(</span>SHORTCARD<span style='color:#808030; '>,</span>ORD<span style='color:#808030; '>(</span>Pal<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>.</span>Fore<span style='color:#808030; '>)</span><span style='color:#808030; '>+</span>ORD<span style='color:#808030; '>(</span>Pal<span style='color:#808030; '>[</span>i<span style='color:#808030; '>]</span><span style='color:#808030; '>.</span>Back<span style='color:#808030; '>)</span><span style='color:#808030; '>*</span><span style='color:#008c00; '>16</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 913:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 914:     IsPalette <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>TRUE</span><span style='color:#808030; '>;</span>
 915:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 916: <span style='color:#808030; '>END</span> SetPal<span style='color:#808030; '>;</span>
 917: 
 918: 
 919: 
 920: 
 921: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> PaletteOpen<span style='color:#808030; '>(</span>WD<span style='color:#808030; '>:</span> WinDef<span style='color:#808030; '>;</span> Pal<span style='color:#808030; '>:</span> PaletteDef<span style='color:#808030; '>)</span> <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 922: <span style='color:#696969; '>(*</span>
 923: <span style='color:#696969; '>  Opens a window on the screen ready for use</span>
 924: <span style='color:#696969; '>*)</span>
 925: <span style='color:#800000; font-weight:bold; '>VAR</span>
 926:   W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 927: <span style='color:#808030; '>BEGIN</span>
 928:   Lock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 929:   W <span style='color:#808030; '>:=</span> MakeWindow <span style='color:#808030; '>(</span>WD<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 930:   SetPal<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>Pal<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 931:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 932:     ALLOCATE <span style='color:#808030; '>(</span> Buffer<span style='color:#808030; '>,</span>OWidth<span style='color:#808030; '>*</span>ODepth<span style='color:#808030; '>*</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 933:     BufferSpaceFill<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>OWidth<span style='color:#808030; '>*</span>ODepth<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 934:     <span style='color:#808030; '>IF</span> WD<span style='color:#008c00; '>.</span>FrameOn <span style='color:#800000; font-weight:bold; '>THEN</span>
 935:       SetFrame<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>WDef<span style='color:#008c00; '>.</span>FrameDef<span style='color:#808030; '>,</span>WDef<span style='color:#008c00; '>.</span>FrameFore<span style='color:#808030; '>,</span>WDef<span style='color:#008c00; '>.</span>FrameBack<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 936:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 937:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 938:   <span style='color:#808030; '>IF</span> WD<span style='color:#008c00; '>.</span>Hidden <span style='color:#800000; font-weight:bold; '>THEN</span>
 939:     Use <span style='color:#808030; '>(</span> W <span style='color:#808030; '>)</span>
 940:   <span style='color:#800000; font-weight:bold; '>ELSE</span>
 941:     PutOnTop <span style='color:#808030; '>(</span> W <span style='color:#808030; '>)</span>
 942:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 943:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 944:   <span style='color:#800000; font-weight:bold; '>RETURN</span> W<span style='color:#808030; '>;</span>
 945: <span style='color:#808030; '>END</span> PaletteOpen<span style='color:#808030; '>;</span>
 946: 
 947: 
 948: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> SetPaletteColor <span style='color:#808030; '>(</span> c <span style='color:#808030; '>:</span> PaletteRange <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 949: <span style='color:#800000; font-weight:bold; '>VAR</span>
 950:   W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 951: <span style='color:#808030; '>BEGIN</span>
 952:   W <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 953:   W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CurPalColor <span style='color:#808030; '>:=</span> c<span style='color:#808030; '>;</span>
 954:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 955: <span style='color:#808030; '>END</span> SetPaletteColor<span style='color:#808030; '>;</span>
 956: 
 957: 
 958: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> PaletteColor<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>:</span> PaletteRange<span style='color:#808030; '>;</span>
 959: <span style='color:#800000; font-weight:bold; '>VAR</span>
 960:   W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
 961: <span style='color:#808030; '>BEGIN</span>
 962:   W <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 963:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 964:   <span style='color:#800000; font-weight:bold; '>RETURN</span> W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CurPalColor<span style='color:#808030; '>;</span>
 965: <span style='color:#808030; '>END</span> PaletteColor<span style='color:#808030; '>;</span>
 966: 
 967: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> SetPalette<span style='color:#808030; '>(</span>W<span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span> Pal<span style='color:#808030; '>:</span> PaletteDef<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 968: <span style='color:#696969; '>(*</span>
 969: <span style='color:#696969; '>   Changes the Palette of the specified window,</span>
 970: <span style='color:#696969; '>   redisplaying the changed colors</span>
 971: <span style='color:#696969; '>*)</span>
 972: <span style='color:#808030; '>BEGIN</span>
 973:   Lock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 974:   SetPal<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>Pal<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 975:   RedrawWindow<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 976:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 977: <span style='color:#808030; '>END</span> SetPalette<span style='color:#808030; '>;</span>
 978: 
 979: 
 980: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> PaletteColorUsed<span style='color:#808030; '>(</span>W<span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span> pc<span style='color:#808030; '>:</span> PaletteRange<span style='color:#808030; '>)</span> <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>BOOLEAN</span><span style='color:#808030; '>;</span>
 981: <span style='color:#696969; '>(*</span>
 982: <span style='color:#696969; '>   Returns if color in use anywhere in the window</span>
 983: <span style='color:#696969; '>*)</span>
 984: <span style='color:#800000; font-weight:bold; '>VAR</span>
 985:   p  <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
 986:   l  <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
 987:   m  <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
 988:   ba <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>POINTER</span> <span style='color:#800000; font-weight:bold; '>TO</span> <span style='color:#800000; font-weight:bold; '>ARRAY</span><span style='color:#808030; '>[</span><span style='color:#008c00; '>0..</span>MAX<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>)</span><span style='color:#808030; '>]</span> <span style='color:#800000; font-weight:bold; '>OF</span> SHORTCARD<span style='color:#808030; '>;</span>
 989: <span style='color:#808030; '>BEGIN</span>
 990:   CheckWindow<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 991:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
 992:     ba <span style='color:#808030; '>:=</span> ADR<span style='color:#808030; '>(</span>Buffer<span style='color:#808030; '>^</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 993:     p  <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>;</span>
 994:     m  <span style='color:#808030; '>:=</span> OWidth<span style='color:#808030; '>*</span>ODepth<span style='color:#808030; '>*</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>;</span>
 995:     <span style='color:#808030; '>LOOP</span>
 996:       l <span style='color:#808030; '>:=</span> m<span style='color:#808030; '>-</span>p<span style='color:#808030; '>;</span>
 997:       p <span style='color:#808030; '>:=</span> p<span style='color:#808030; '>+</span>ScanR<span style='color:#808030; '>(</span>ADR<span style='color:#808030; '>(</span>ba<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span>p<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>l<span style='color:#808030; '>,</span>pc<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
 998:       <span style='color:#808030; '>IF</span> p <span style='color:#808030; '>>=</span> m <span style='color:#800000; font-weight:bold; '>THEN</span> <span style='color:#800000; font-weight:bold; '>RETURN</span> <span style='color:#800000; font-weight:bold; '>FALSE</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
 999:       <span style='color:#808030; '>IF</span> ODD<span style='color:#808030; '>(</span>p<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span> <span style='color:#800000; font-weight:bold; '>RETURN</span> <span style='color:#800000; font-weight:bold; '>TRUE</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1000:       INC<span style='color:#808030; '>(</span>p<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1001:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1002:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1003: <span style='color:#808030; '>END</span> PaletteColorUsed<span style='color:#808030; '>;</span>
1004: 
1005: 
1006: 
1007: <span style='color:#696969; '>(* ------------------------- *)</span>
1008: <span style='color:#696969; '>(* Move resize procedure     *)</span>
1009: <span style='color:#696969; '>(* ------------------------- *)</span>
1010: 
1011: 
1012: 
1013: 
1014: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> Change <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span> X1<span style='color:#808030; '>,</span>Y1<span style='color:#808030; '>,</span>X2<span style='color:#808030; '>,</span>Y2 <span style='color:#808030; '>:</span> AbsCoord <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1015: <span style='color:#696969; '>(*</span>
1016: <span style='color:#696969; '>   Changes the size and/or position of the specified window</span>
1017: <span style='color:#696969; '>   The contents of the window will be moved with it</span>
1018: <span style='color:#696969; '>*)</span>
1019: <span style='color:#800000; font-weight:bold; '>VAR</span>
1020:   nw   <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
1021:   wd   <span style='color:#808030; '>:</span> WinDef<span style='color:#808030; '>;</span>
1022:   pal  <span style='color:#808030; '>:</span> PaletteDef<span style='color:#808030; '>;</span>
1023:   save <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
1024:   min  <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span> <span style='color:#808030; '>;</span>
1025: <span style='color:#808030; '>BEGIN</span>
1026:   CheckWindow<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1027:   save <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1028:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
1029:     <span style='color:#808030; '>IF</span> X2<span style='color:#808030; '>>=</span>ScreenWidth <span style='color:#800000; font-weight:bold; '>THEN</span> X2<span style='color:#808030; '>:=</span>ScreenWidth<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1030:     <span style='color:#808030; '>IF</span> Y2<span style='color:#808030; '>>=</span>ScreenDepth <span style='color:#800000; font-weight:bold; '>THEN</span> Y2<span style='color:#808030; '>:=</span>ScreenDepth<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1031:     wd <span style='color:#808030; '>:=</span> WDef<span style='color:#808030; '>;</span>
1032:     <span style='color:#808030; '>IF</span> wd<span style='color:#008c00; '>.</span>FrameOn <span style='color:#800000; font-weight:bold; '>THEN</span> min <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>2</span> <span style='color:#800000; font-weight:bold; '>ELSE</span> min <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0</span> <span style='color:#808030; '>END</span> <span style='color:#808030; '>;</span>
1033:     <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>X1<span style='color:#808030; '>+</span>min<span style='color:#808030; '>></span>X2<span style='color:#808030; '>)</span><span style='color:#800000; font-weight:bold; '>OR</span><span style='color:#808030; '>(</span>Y1<span style='color:#808030; '>+</span>min<span style='color:#808030; '>></span>Y2<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span> <span style='color:#800000; font-weight:bold; '>RETURN</span> <span style='color:#808030; '>END</span> <span style='color:#808030; '>;</span>
1034:     wd<span style='color:#008c00; '>.</span>X1 <span style='color:#808030; '>:=</span> X1<span style='color:#808030; '>;</span> wd<span style='color:#008c00; '>.</span>Y1 <span style='color:#808030; '>:=</span> Y1<span style='color:#808030; '>;</span>
1035:     wd<span style='color:#008c00; '>.</span>X2 <span style='color:#808030; '>:=</span> X2<span style='color:#808030; '>;</span> wd<span style='color:#008c00; '>.</span>Y2 <span style='color:#808030; '>:=</span> Y2<span style='color:#808030; '>;</span>
1036:     wd<span style='color:#008c00; '>.</span>Hidden <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>TRUE</span><span style='color:#808030; '>;</span>
1037:     <span style='color:#808030; '>IF</span> IsPalette <span style='color:#800000; font-weight:bold; '>THEN</span>
1038:       GetPal<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>pal<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1039:       nw <span style='color:#808030; '>:=</span> PaletteOpen<span style='color:#808030; '>(</span>wd<span style='color:#808030; '>,</span>pal<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1040:     <span style='color:#800000; font-weight:bold; '>ELSE</span>
1041:       nw <span style='color:#808030; '>:=</span> Open<span style='color:#808030; '>(</span> wd <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1042:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1043:     MergeWindows<span style='color:#808030; '>(</span>nw<span style='color:#808030; '>,</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1044:     ClipFrame <span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1045:     <span style='color:#808030; '>IF</span> CurrentX<span style='color:#808030; '>></span>Width <span style='color:#800000; font-weight:bold; '>THEN</span> CurrentX <span style='color:#808030; '>:=</span> Width <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1046:     <span style='color:#808030; '>IF</span> CurrentY<span style='color:#808030; '>></span>Depth <span style='color:#800000; font-weight:bold; '>THEN</span> CurrentY <span style='color:#808030; '>:=</span> Depth <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1047:     ResetCursor<span style='color:#808030; '>;</span>
1048:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1049:   Use<span style='color:#808030; '>(</span>save<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> <span style='color:#696969; '>(* restore used window *)</span>
1050:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1051: <span style='color:#808030; '>END</span> Change<span style='color:#808030; '>;</span>
1052: 
1053: <span style='color:#696969; '>(* ------------------------- *)</span>
1054: <span style='color:#696969; '>(* Multi process support     *)</span>
1055: <span style='color:#696969; '>(* ------------------------- *)</span>
1056: 
1057: 
1058: 
1059: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> NullProc<span style='color:#808030; '>;</span>
1060: <span style='color:#808030; '>BEGIN</span>
1061: <span style='color:#808030; '>END</span> NullProc<span style='color:#808030; '>;</span>
1062: 
1063: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> SetProcessLocks <span style='color:#808030; '>(</span> LockProc<span style='color:#808030; '>,</span>UnlockProc <span style='color:#808030; '>:</span> PROC <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1064: <span style='color:#808030; '>BEGIN</span>
1065:   Lock   <span style='color:#808030; '>:=</span> LockProc<span style='color:#808030; '>;</span>
1066:   Unlock <span style='color:#808030; '>:=</span> UnlockProc<span style='color:#808030; '>;</span>
1067:   MultiP <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>TRUE</span><span style='color:#808030; '>;</span>
1068: <span style='color:#808030; '>END</span> SetProcessLocks<span style='color:#808030; '>;</span>
1069: 
1070: <span style='color:#696969; '>(* ------------------------- *)</span>
1071: <span style='color:#696969; '>(* Window output             *)</span>
1072: <span style='color:#696969; '>(* ------------------------- *)</span>
1073: 
1074: 
1075: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> DeleteLine <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span> Y <span style='color:#808030; '>:</span> RelCoord <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1076: <span style='color:#800000; font-weight:bold; '>VAR</span>
1077:   r<span style='color:#808030; '>,</span>p <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
1078: <span style='color:#808030; '>BEGIN</span>
1079:   CheckWindow<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1080:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
1081:     p <span style='color:#808030; '>:=</span> XA<span style='color:#808030; '>-</span>WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>YA<span style='color:#808030; '>-</span>WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>+</span>Y<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>*</span>OWidth<span style='color:#808030; '>;</span>
1082:     <span style='color:#808030; '>FOR</span> r <span style='color:#808030; '>:=</span> Y <span style='color:#800000; font-weight:bold; '>TO</span> Depth<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>DO</span>
1083:       Move<span style='color:#808030; '>(</span>ADR<span style='color:#808030; '>(</span>Buffer<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span>p<span style='color:#808030; '>+</span>OWidth<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>ADR<span style='color:#808030; '>(</span>Buffer<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span>p<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>Width<span style='color:#808030; '>*</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1084:       INC<span style='color:#808030; '>(</span>p<span style='color:#808030; '>,</span>OWidth<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1085:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1086:     BufferSpaceFill<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>p<span style='color:#808030; '>,</span>Width<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1087:     RedrawSection <span style='color:#808030; '>(</span> W<span style='color:#808030; '>,</span>XA<span style='color:#808030; '>,</span>Y<span style='color:#808030; '>+</span>YA<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>XB<span style='color:#808030; '>,</span>YB <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1088:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1089: <span style='color:#808030; '>END</span> DeleteLine<span style='color:#808030; '>;</span>
1090: 
1091: 
1092: 
1093: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> Clear<span style='color:#808030; '>;</span>
1094: <span style='color:#696969; '>(*</span>
1095: <span style='color:#696969; '>  clears the current window</span>
1096: <span style='color:#696969; '>*)</span>
1097: <span style='color:#800000; font-weight:bold; '>VAR</span>
1098:   r<span style='color:#808030; '>,</span>p <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
1099:   W   <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
1100: <span style='color:#808030; '>BEGIN</span>
1101:   W <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1102:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
1103:     p <span style='color:#808030; '>:=</span> XA<span style='color:#808030; '>-</span>WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>YA<span style='color:#808030; '>-</span>WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>)</span><span style='color:#808030; '>*</span>OWidth<span style='color:#808030; '>;</span>
1104:     <span style='color:#808030; '>FOR</span> r <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>TO</span> Depth <span style='color:#800000; font-weight:bold; '>DO</span>
1105:       BufferSpaceFill<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>p<span style='color:#808030; '>,</span>Width<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1106:       INC<span style='color:#808030; '>(</span>p<span style='color:#808030; '>,</span>OWidth<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1107:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1108:     RedrawWindowPane<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1109:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1110:   IGotoXY<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1111:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1112: <span style='color:#808030; '>END</span> Clear<span style='color:#808030; '>;</span>
1113: 
1114: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> ClrEol<span style='color:#808030; '>;</span>
1115: <span style='color:#696969; '>(*</span>
1116: <span style='color:#696969; '>   clears from the cursor to the end of line</span>
1117: <span style='color:#696969; '>*)</span>
1118: <span style='color:#800000; font-weight:bold; '>VAR</span>
1119:   W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
1120: <span style='color:#808030; '>BEGIN</span>
1121:   W <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1122:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
1123:     BufferSpaceFill<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>XA<span style='color:#808030; '>-</span>WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>+</span>CurrentX<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>YA<span style='color:#808030; '>-</span>WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>+</span>CurrentY<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>*</span>OWidth<span style='color:#808030; '>,</span>
1124:           Width<span style='color:#808030; '>-</span>CurrentX<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1125:     RedrawSection <span style='color:#808030; '>(</span> W<span style='color:#808030; '>,</span>XA<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>+</span>CurrentX<span style='color:#808030; '>,</span>YA<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>+</span>CurrentY<span style='color:#808030; '>,</span>XB<span style='color:#808030; '>,</span>YA<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>+</span>CurrentY <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1126:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1127:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1128: <span style='color:#808030; '>END</span> ClrEol<span style='color:#808030; '>;</span>
1129: 
1130: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> Bell<span style='color:#808030; '>;</span>
1131: <span style='color:#800000; font-weight:bold; '>VAR</span>
1132:   R <span style='color:#808030; '>:</span> Registers<span style='color:#808030; '>;</span>
1133: <span style='color:#808030; '>BEGIN</span>
1134:   <span style='color:#808030; '>WITH</span> R <span style='color:#800000; font-weight:bold; '>DO</span>
1135:     AX <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0E07H</span><span style='color:#808030; '>;</span>
1136:     BL <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>;</span>
1137:     Lib<span style='color:#008c00; '>.</span>Intr<span style='color:#808030; '>(</span>R<span style='color:#808030; '>,</span><span style='color:#008c00; '>10H</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1138:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1139: <span style='color:#808030; '>END</span> Bell<span style='color:#808030; '>;</span>
1140: 
1141: 
1142: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$N*)</span> WriteC <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span> C <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CHAR</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1143: <span style='color:#800000; font-weight:bold; '>VAR</span>
1144:   nx <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
1145: <span style='color:#808030; '>BEGIN</span>
1146:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
1147:     <span style='color:#808030; '>CASE</span> C <span style='color:#800000; font-weight:bold; '>OF</span>
1148:        CHR<span style='color:#808030; '>(</span><span style='color:#008c00; '>12</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>:</span> Clear<span style='color:#808030; '>;</span>
1149:                  IGotoXY<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1150:      <span style='color:#808030; '>|</span> CHR<span style='color:#808030; '>(</span><span style='color:#008c00; '>10</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>:</span> <span style='color:#808030; '>IF</span> CurrentY<span style='color:#808030; '>=</span>Depth <span style='color:#800000; font-weight:bold; '>THEN</span>
1151:                    DeleteLine <span style='color:#808030; '>(</span> W<span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span> <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1152:                  <span style='color:#800000; font-weight:bold; '>ELSE</span>
1153:                    IGotoXY<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>CurrentX<span style='color:#808030; '>,</span>CurrentY<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1154:                  <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1155:      <span style='color:#808030; '>|</span> CHR<span style='color:#808030; '>(</span><span style='color:#008c00; '>13</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>:</span> <span style='color:#696969; '>(*ClrEol; change 1/7/88*)</span> IGotoXY<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>CurrentY<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1156:      <span style='color:#808030; '>|</span> CHR<span style='color:#808030; '>(</span><span style='color:#008c00; '>08</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>:</span> <span style='color:#808030; '>IF</span> CurrentX<span style='color:#808030; '>></span><span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>THEN</span>
1157:                    IGotoXY<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>CurrentX<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>CurrentY<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> WriteC<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span><span style='color:#0000e6; '>' '</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1158:                    IGotoXY<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>CurrentX<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>CurrentY<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1159:                  <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1160:      <span style='color:#808030; '>|</span> CHR<span style='color:#808030; '>(</span><span style='color:#008c00; '>7</span><span style='color:#808030; '>)</span>  <span style='color:#808030; '>:</span> Bell<span style='color:#808030; '>;</span>
1161:     <span style='color:#800000; font-weight:bold; '>ELSE</span>
1162:         <span style='color:#808030; '>IF</span> CurrentX <span style='color:#808030; '>></span> Width <span style='color:#800000; font-weight:bold; '>THEN</span> <span style='color:#800000; font-weight:bold; '>RETURN</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1163:         WindowWrite<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>CurrentX<span style='color:#808030; '>,</span>CurrentY<span style='color:#808030; '>,</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>ADR<span style='color:#808030; '>(</span>C<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#800000; font-weight:bold; '>FALSE</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1164:         <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>CurrentX<span style='color:#808030; '>&lt;</span><span style='color:#808030; '>></span>Width<span style='color:#808030; '>)</span><span style='color:#800000; font-weight:bold; '>OR</span> <span style='color:#800000; font-weight:bold; '>NOT</span> WDef<span style='color:#008c00; '>.</span>WrapOn <span style='color:#800000; font-weight:bold; '>THEN</span>
1165:           IGotoXY<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>CurrentX<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>CurrentY<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1166:         <span style='color:#800000; font-weight:bold; '>ELSE</span>
1167:           <span style='color:#808030; '>IF</span> CurrentY<span style='color:#808030; '>=</span>Depth <span style='color:#800000; font-weight:bold; '>THEN</span>
1168:             DeleteLine <span style='color:#808030; '>(</span> W<span style='color:#808030; '>,</span> <span style='color:#008c00; '>1</span> <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1169:             IGotoXY<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>CurrentY<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1170:           <span style='color:#800000; font-weight:bold; '>ELSE</span>
1171:             IGotoXY<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>CurrentY<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1172:           <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1173:         <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1174:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1175:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1176: <span style='color:#808030; '>END</span> WriteC<span style='color:#808030; '>;</span>
1177: 
1178: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> WriteOut <span style='color:#808030; '>(</span>S <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>ARRAY</span> <span style='color:#800000; font-weight:bold; '>OF</span> <span style='color:#800000; font-weight:bold; '>CHAR</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1179: <span style='color:#800000; font-weight:bold; '>VAR</span>
1180:   W     <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
1181:   p<span style='color:#808030; '>,</span>q<span style='color:#808030; '>,</span>m <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
1182:   ss    <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
1183: <span style='color:#808030; '>BEGIN</span>
1184:   W <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1185:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
1186:     ss <span style='color:#808030; '>:=</span> HIGH<span style='color:#808030; '>(</span>S<span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span>
1187:     p <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>;</span>
1188:     q <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>;</span>
1189:     <span style='color:#808030; '>LOOP</span>
1190:       <span style='color:#696969; '>(* first accumulate normal chars on same line *)</span>
1191:       m <span style='color:#808030; '>:=</span> Width<span style='color:#808030; '>+</span>p<span style='color:#808030; '>-</span>CurrentX<span style='color:#808030; '>;</span>
1192:       <span style='color:#808030; '>IF</span> <span style='color:#800000; font-weight:bold; '>NOT</span> W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>WrapOn <span style='color:#800000; font-weight:bold; '>THEN</span> INC<span style='color:#808030; '>(</span>m<span style='color:#808030; '>)</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span> <span style='color:#696969; '>(* can fit another char in *)</span>
1193:       <span style='color:#808030; '>IF</span> m <span style='color:#808030; '>></span> ss <span style='color:#800000; font-weight:bold; '>THEN</span> m <span style='color:#808030; '>:=</span> ss <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1194:       <span style='color:#808030; '>WHILE</span> <span style='color:#808030; '>(</span>q<span style='color:#808030; '>&lt;</span>m<span style='color:#808030; '>)</span><span style='color:#800000; font-weight:bold; '>AND</span><span style='color:#808030; '>(</span>S<span style='color:#808030; '>[</span>q<span style='color:#808030; '>]</span><span style='color:#808030; '>>=</span><span style='color:#0000e6; '>' '</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>DO</span> INC<span style='color:#808030; '>(</span>q<span style='color:#808030; '>)</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1195:       <span style='color:#696969; '>(* now output the line *)</span>
1196:       <span style='color:#808030; '>IF</span> q <span style='color:#808030; '>></span> p <span style='color:#800000; font-weight:bold; '>THEN</span>
1197:         WindowWrite<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>CurrentX<span style='color:#808030; '>,</span>CurrentY<span style='color:#808030; '>,</span>q<span style='color:#808030; '>-</span>p<span style='color:#808030; '>,</span>ADR<span style='color:#808030; '>(</span>S<span style='color:#808030; '>[</span>p<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span><span style='color:#800000; font-weight:bold; '>FALSE</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1198:         IGotoXY<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>CurrentX<span style='color:#808030; '>+</span>q<span style='color:#808030; '>-</span>p<span style='color:#808030; '>,</span>CurrentY<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1199:       <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1200:       <span style='color:#696969; '>(* now output the special char *)</span>
1201:       <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>S<span style='color:#808030; '>[</span>q<span style='color:#808030; '>]</span> <span style='color:#808030; '>=</span> CHR<span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>OR</span> <span style='color:#808030; '>(</span>q <span style='color:#808030; '>></span> HIGH<span style='color:#808030; '>(</span>S<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span> <span style='color:#800000; font-weight:bold; '>EXIT</span> <span style='color:#800000; font-weight:bold; '>ELSE</span> WriteC<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>S<span style='color:#808030; '>[</span>q<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1202:       <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1203:       INC<span style='color:#808030; '>(</span>q<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1204:       p <span style='color:#808030; '>:=</span> q<span style='color:#808030; '>;</span>
1205:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1206:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1207:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1208: <span style='color:#808030; '>END</span> WriteOut<span style='color:#808030; '>;</span>
1209: 
1210: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> DirectWrite <span style='color:#808030; '>(</span> X<span style='color:#808030; '>,</span>Y <span style='color:#808030; '>:</span> RelCoord<span style='color:#808030; '>;</span>      <span style='color:#696969; '>(* start co-ords *)</span>
1211:                                A   <span style='color:#808030; '>:</span> ADDRESS<span style='color:#808030; '>;</span>       <span style='color:#696969; '>(* address of char array *)</span>
1212:                                Len <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span> <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>    <span style='color:#696969; '>(* length to be written *)</span>
1213: <span style='color:#696969; '>(*</span>
1214: <span style='color:#696969; '>   writes directly to current window at the specified X,Y coordinates</span>
1215: <span style='color:#696969; '>   with no check for special (ie control) chars or eol wrap</span>
1216: <span style='color:#696969; '>*)</span>
1217: <span style='color:#800000; font-weight:bold; '>VAR</span>
1218:   W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
1219: <span style='color:#808030; '>BEGIN</span>
1220:   W <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1221:   ClipXY<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>X<span style='color:#808030; '>,</span>Y<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1222:   WindowWrite<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>X<span style='color:#808030; '>,</span>Y<span style='color:#808030; '>,</span>Len<span style='color:#808030; '>,</span>A<span style='color:#808030; '>,</span><span style='color:#800000; font-weight:bold; '>FALSE</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1223:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1224: <span style='color:#808030; '>END</span> DirectWrite<span style='color:#808030; '>;</span>
1225: 
1226: 
1227: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> GotoXY <span style='color:#808030; '>(</span> X<span style='color:#808030; '>,</span>Y <span style='color:#808030; '>:</span> RelCoord <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1228: <span style='color:#800000; font-weight:bold; '>VAR</span>
1229:   W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
1230: <span style='color:#808030; '>BEGIN</span>
1231:   W <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1232:   ClipXY<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>X<span style='color:#808030; '>,</span>Y<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1233:   IGotoXY<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>X<span style='color:#808030; '>,</span>Y<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1234:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1235: <span style='color:#808030; '>END</span> GotoXY<span style='color:#808030; '>;</span>
1236: 
1237: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> WhereX <span style='color:#808030; '>(</span> <span style='color:#808030; '>)</span> <span style='color:#808030; '>:</span> RelCoord<span style='color:#808030; '>;</span>
1238: <span style='color:#800000; font-weight:bold; '>VAR</span>
1239:   W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
1240: <span style='color:#808030; '>BEGIN</span>
1241:   W <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1242:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1243:   <span style='color:#800000; font-weight:bold; '>RETURN</span> W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CurrentX<span style='color:#808030; '>;</span>
1244: <span style='color:#808030; '>END</span> WhereX<span style='color:#808030; '>;</span>
1245: 
1246: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> WhereY <span style='color:#808030; '>(</span> <span style='color:#808030; '>)</span> <span style='color:#808030; '>:</span> RelCoord<span style='color:#808030; '>;</span>
1247: <span style='color:#800000; font-weight:bold; '>VAR</span>
1248:   W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
1249: <span style='color:#808030; '>BEGIN</span>
1250:   W <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1251:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1252:   <span style='color:#800000; font-weight:bold; '>RETURN</span> W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CurrentY<span style='color:#808030; '>;</span>
1253: <span style='color:#808030; '>END</span> WhereY<span style='color:#808030; '>;</span>
1254: 
1255: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> ConvertCoords <span style='color:#808030; '>(</span> W         <span style='color:#808030; '>:</span> WinType  <span style='color:#808030; '>;</span>
1256:                                  X<span style='color:#808030; '>,</span>Y       <span style='color:#808030; '>:</span> RelCoord<span style='color:#808030; '>;</span>
1257:                                  <span style='color:#800000; font-weight:bold; '>VAR</span> XO<span style='color:#808030; '>,</span>YO <span style='color:#808030; '>:</span> AbsCoord <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1258: <span style='color:#808030; '>BEGIN</span>
1259:   CheckWindow<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1260:   XO <span style='color:#808030; '>:=</span> X<span style='color:#808030; '>+</span>W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>XA<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span> YO <span style='color:#808030; '>:=</span> Y<span style='color:#808030; '>+</span>W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>YA<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span>
1261: <span style='color:#808030; '>END</span> ConvertCoords<span style='color:#808030; '>;</span>
1262: 
1263: 
1264: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> InsLine<span style='color:#808030; '>;</span>
1265: <span style='color:#800000; font-weight:bold; '>VAR</span>
1266:   W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
1267:   r<span style='color:#808030; '>,</span>p<span style='color:#808030; '>,</span>p1 <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
1268: <span style='color:#808030; '>BEGIN</span>
1269:   W <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1270:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
1271:     p <span style='color:#808030; '>:=</span> XA<span style='color:#808030; '>-</span>WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>YA<span style='color:#808030; '>-</span>WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>+</span>Depth<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>*</span>OWidth<span style='color:#808030; '>;</span>
1272:     <span style='color:#808030; '>FOR</span> r <span style='color:#808030; '>:=</span> CurrentY <span style='color:#800000; font-weight:bold; '>TO</span> Depth<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>DO</span>
1273:       DEC<span style='color:#808030; '>(</span>p<span style='color:#808030; '>,</span>OWidth<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1274:       Move<span style='color:#808030; '>(</span>ADR<span style='color:#808030; '>(</span>Buffer<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span>p<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>ADR<span style='color:#808030; '>(</span>Buffer<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span>p<span style='color:#808030; '>+</span>OWidth<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>Width<span style='color:#808030; '>*</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1275:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1276:     BufferSpaceFill<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>p<span style='color:#808030; '>,</span>Width<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1277:     RedrawSection <span style='color:#808030; '>(</span> W<span style='color:#808030; '>,</span>XA<span style='color:#808030; '>,</span>CurrentY<span style='color:#808030; '>+</span>YA<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>XB<span style='color:#808030; '>,</span>YB <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1278:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1279:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1280: <span style='color:#808030; '>END</span> InsLine<span style='color:#808030; '>;</span>
1281: 
1282: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> DelLine<span style='color:#808030; '>;</span>
1283: <span style='color:#800000; font-weight:bold; '>VAR</span>
1284:   W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
1285: <span style='color:#808030; '>BEGIN</span>
1286:   W <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1287:   DeleteLine<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>CurrentY<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1288:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1289: <span style='color:#808030; '>END</span> DelLine<span style='color:#808030; '>;</span>
1290: 
1291: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> TextColor <span style='color:#808030; '>(</span> c <span style='color:#808030; '>:</span> Color <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1292: <span style='color:#800000; font-weight:bold; '>VAR</span>
1293:   W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
1294: <span style='color:#808030; '>BEGIN</span>
1295:   W <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1296:   W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>Foreground <span style='color:#808030; '>:=</span> c<span style='color:#808030; '>;</span>
1297:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1298: <span style='color:#808030; '>END</span> TextColor<span style='color:#808030; '>;</span>
1299: 
1300: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> TextBackground <span style='color:#808030; '>(</span> c <span style='color:#808030; '>:</span> Color <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1301: <span style='color:#800000; font-weight:bold; '>VAR</span>
1302:   W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
1303: <span style='color:#808030; '>BEGIN</span>
1304:   W <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1305:   W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>Background <span style='color:#808030; '>:=</span> c<span style='color:#808030; '>;</span>
1306:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1307: <span style='color:#808030; '>END</span> TextBackground<span style='color:#808030; '>;</span>
1308: 
1309: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> SetWrap <span style='color:#808030; '>(</span> on <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>BOOLEAN</span> <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1310: <span style='color:#800000; font-weight:bold; '>VAR</span>
1311:   W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
1312: <span style='color:#808030; '>BEGIN</span>
1313:   W <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1314:   W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>WrapOn <span style='color:#808030; '>:=</span> on<span style='color:#808030; '>;</span>
1315:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1316: <span style='color:#808030; '>END</span> SetWrap<span style='color:#808030; '>;</span>
1317: 
1318: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> Info <span style='color:#696969; '>(*$F*)</span> <span style='color:#808030; '>(</span> W <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span> <span style='color:#800000; font-weight:bold; '>VAR</span> WD <span style='color:#808030; '>:</span> WinDef <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1319: <span style='color:#696969; '>(* gets information for specified window *)</span>
1320: <span style='color:#808030; '>BEGIN</span>
1321:   Lock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1322:   WD <span style='color:#808030; '>:=</span> W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef <span style='color:#808030; '>;</span>
1323:   Unlock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1324: <span style='color:#808030; '>END</span> Info<span style='color:#808030; '>;</span>
1325: 
1326: 
1327: <span style='color:#696969; '>(* ------------------------- *)</span>
1328: <span style='color:#696969; '>(* Title procedure           *)</span>
1329: <span style='color:#696969; '>(* ------------------------- *)</span>
1330: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> SetTitle <span style='color:#808030; '>(</span> W        <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
1331:                      NewTitle <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>ARRAY</span> <span style='color:#800000; font-weight:bold; '>OF</span> <span style='color:#800000; font-weight:bold; '>CHAR</span><span style='color:#808030; '>;</span>
1332:                      Mode     <span style='color:#808030; '>:</span> TitleMode <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1333: <span style='color:#696969; '>(*</span>
1334: <span style='color:#696969; '>  updates the window title within the window frame,</span>
1335: <span style='color:#696969; '>  positioning it in the position defined by the title mode</span>
1336: <span style='color:#696969; '>*)</span>
1337: <span style='color:#800000; font-weight:bold; '>VAR</span>
1338:   l <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
1339: <span style='color:#808030; '>BEGIN</span>
1340:   CheckWindow<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1341:   Lock<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1342:   DisposeTitle<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1343:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
1344:     <span style='color:#808030; '>IF</span> Mode <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>></span> NoTitle <span style='color:#800000; font-weight:bold; '>THEN</span>
1345:       l <span style='color:#808030; '>:=</span> Length<span style='color:#808030; '>(</span>NewTitle<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1346:       ALLOCATE<span style='color:#808030; '>(</span>Title<span style='color:#808030; '>,</span>l<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1347:       Move<span style='color:#808030; '>(</span>ADR<span style='color:#808030; '>(</span>NewTitle<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>ADR<span style='color:#808030; '>(</span>Title<span style='color:#808030; '>^</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>l<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1348:       Title<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span>l<span style='color:#808030; '>]</span> <span style='color:#808030; '>:=</span> CHR<span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1349:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1350:     TMode <span style='color:#808030; '>:=</span> Mode<span style='color:#808030; '>;</span>
1351:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1352:   DrawFrame<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1353:   Unlock<span style='color:#808030; '>;</span>
1354: <span style='color:#808030; '>END</span> SetTitle<span style='color:#808030; '>;</span>
1355: 
1356: 
1357: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> ReadString  <span style='color:#808030; '>(</span> <span style='color:#800000; font-weight:bold; '>VAR</span> string <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>ARRAY</span> <span style='color:#800000; font-weight:bold; '>OF</span> <span style='color:#800000; font-weight:bold; '>CHAR</span> <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1358: <span style='color:#800000; font-weight:bold; '>VAR</span>
1359:   c   <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CHAR</span><span style='color:#808030; '>;</span>
1360:   line<span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>ARRAY</span><span style='color:#808030; '>[</span><span style='color:#008c00; '>0..82</span><span style='color:#808030; '>]</span> <span style='color:#800000; font-weight:bold; '>OF</span> <span style='color:#800000; font-weight:bold; '>CHAR</span><span style='color:#808030; '>;</span>
1361:   p<span style='color:#808030; '>,</span>H <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span><span style='color:#808030; '>;</span>
1362:   W   <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>
1363:   con <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>BOOLEAN</span><span style='color:#808030; '>;</span>
1364: <span style='color:#808030; '>BEGIN</span>
1365:   W <span style='color:#808030; '>:=</span> CurWin<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1366:   PutOnTop<span style='color:#808030; '>(</span>W<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1367:   con <span style='color:#808030; '>:=</span> W<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>WDef<span style='color:#008c00; '>.</span>CursorOn<span style='color:#808030; '>;</span>
1368:   CursorOn<span style='color:#808030; '>;</span>
1369:   H <span style='color:#808030; '>:=</span> HIGH<span style='color:#808030; '>(</span>string<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1370:   <span style='color:#808030; '>IF</span> H<span style='color:#808030; '>></span><span style='color:#008c00; '>79</span> <span style='color:#800000; font-weight:bold; '>THEN</span> H <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>79</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1371:   p <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>;</span>
1372:   <span style='color:#808030; '>LOOP</span>
1373:     c <span style='color:#808030; '>:=</span> IO<span style='color:#008c00; '>.</span>RdKey<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1374:     <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>c<span style='color:#808030; '>=</span>CHR<span style='color:#808030; '>(</span><span style='color:#008c00; '>8</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800000; font-weight:bold; '>OR</span><span style='color:#808030; '>(</span>c<span style='color:#808030; '>=</span>CHR<span style='color:#808030; '>(</span><span style='color:#008c00; '>127</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span>
1375:       <span style='color:#808030; '>IF</span> p<span style='color:#808030; '>></span><span style='color:#008c00; '>0</span> <span style='color:#800000; font-weight:bold; '>THEN</span> DEC<span style='color:#808030; '>(</span>p<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> IO<span style='color:#008c00; '>.</span>WrChar<span style='color:#808030; '>(</span>CHR<span style='color:#808030; '>(</span><span style='color:#008c00; '>8</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1376:     <span style='color:#800000; font-weight:bold; '>ELSIF</span> <span style='color:#808030; '>(</span>c<span style='color:#808030; '>>=</span><span style='color:#0000e6; '>' '</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span>
1377:       <span style='color:#808030; '>IF</span> p<span style='color:#808030; '>&lt;=</span>H <span style='color:#800000; font-weight:bold; '>THEN</span>
1378:         IO<span style='color:#008c00; '>.</span>WrChar<span style='color:#808030; '>(</span>c<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1379:         line<span style='color:#808030; '>[</span>p<span style='color:#808030; '>]</span> <span style='color:#808030; '>:=</span> c<span style='color:#808030; '>;</span>
1380:         INC<span style='color:#808030; '>(</span>p<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1381:       <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1382:     <span style='color:#800000; font-weight:bold; '>ELSIF</span> c<span style='color:#808030; '>=</span>CHR<span style='color:#808030; '>(</span><span style='color:#008c00; '>13</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>THEN</span>
1383:       <span style='color:#800000; font-weight:bold; '>EXIT</span><span style='color:#808030; '>;</span>
1384:     <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1385:   <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1386:   line<span style='color:#808030; '>[</span>p<span style='color:#808030; '>]</span> <span style='color:#808030; '>:=</span> CHR<span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1387:   Copy<span style='color:#808030; '>(</span>string<span style='color:#808030; '>,</span>line<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1388:   <span style='color:#808030; '>IF</span> <span style='color:#800000; font-weight:bold; '>NOT</span> con <span style='color:#800000; font-weight:bold; '>THEN</span> CursorOff <span style='color:#808030; '>END</span><span style='color:#808030; '>;</span>
1389:   Unlock<span style='color:#808030; '>;</span>
1390:   IO<span style='color:#008c00; '>.</span>WrLn<span style='color:#808030; '>;</span>
1391: <span style='color:#808030; '>END</span> ReadString<span style='color:#808030; '>;</span>
1392: 
1393: <span style='color:#696969; '>(* Low level routines to read and write to the window buffer direct *)</span>
1394: 
1395: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> RdBufferLn <span style='color:#808030; '>(</span> W    <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>        <span style='color:#696969; '>(* Source window *)</span>
1396:                               X<span style='color:#808030; '>,</span>Y  <span style='color:#808030; '>:</span> RelCoord<span style='color:#808030; '>;</span>      <span style='color:#696969; '>(* start co-ords *)</span>
1397:                               Dest <span style='color:#808030; '>:</span> ADDRESS<span style='color:#808030; '>;</span>       <span style='color:#696969; '>(* address of buffer *)</span>
1398:                               Len  <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span> <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>    <span style='color:#696969; '>(* length in WORDs *)</span>
1399: <span style='color:#800000; font-weight:bold; '>VAR</span>
1400:   AX<span style='color:#808030; '>,</span>AY  <span style='color:#808030; '>:</span> AbsCoord<span style='color:#808030; '>;</span>
1401: <span style='color:#808030; '>BEGIN</span>
1402:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
1403:       AX <span style='color:#808030; '>:=</span> X<span style='color:#808030; '>+</span>XA<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span> AY <span style='color:#808030; '>:=</span> Y<span style='color:#808030; '>+</span>YA<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span>
1404:       Lib<span style='color:#008c00; '>.</span>WordMove<span style='color:#808030; '>(</span>ADR<span style='color:#808030; '>(</span>Buffer<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span>AX<span style='color:#808030; '>-</span>WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>AY<span style='color:#808030; '>-</span>WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>)</span><span style='color:#808030; '>*</span>OWidth<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>Dest<span style='color:#808030; '>,</span>Len<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1405:   <span style='color:#808030; '>END</span> <span style='color:#808030; '>;</span>
1406: <span style='color:#808030; '>END</span> RdBufferLn <span style='color:#808030; '>;</span>
1407: 
1408: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> <span style='color:#696969; '>(*$F*)</span> WrBufferLn <span style='color:#808030; '>(</span> W    <span style='color:#808030; '>:</span> WinType<span style='color:#808030; '>;</span>       <span style='color:#696969; '>(* Dest window *)</span>
1409:                               X<span style='color:#808030; '>,</span>Y  <span style='color:#808030; '>:</span> RelCoord<span style='color:#808030; '>;</span>      <span style='color:#696969; '>(* start co-ords *)</span>
1410:                               Src  <span style='color:#808030; '>:</span> ADDRESS<span style='color:#808030; '>;</span>       <span style='color:#696969; '>(* address of buffer *)</span>
1411:                               Len  <span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>CARDINAL</span> <span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>    <span style='color:#696969; '>(* length in WORDs *)</span>
1412: <span style='color:#800000; font-weight:bold; '>VAR</span>
1413:   AX<span style='color:#808030; '>,</span>AY  <span style='color:#808030; '>:</span> AbsCoord<span style='color:#808030; '>;</span>
1414: <span style='color:#808030; '>BEGIN</span>
1415:   <span style='color:#808030; '>WITH</span> W<span style='color:#808030; '>^</span> <span style='color:#800000; font-weight:bold; '>DO</span>
1416:       AX <span style='color:#808030; '>:=</span> X<span style='color:#808030; '>+</span>XA<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span> AY <span style='color:#808030; '>:=</span> Y<span style='color:#808030; '>+</span>YA<span style='color:#808030; '>-</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>;</span>
1417:       Lib<span style='color:#008c00; '>.</span>WordMove<span style='color:#808030; '>(</span>Src<span style='color:#808030; '>,</span>ADR<span style='color:#808030; '>(</span>Buffer<span style='color:#808030; '>^</span><span style='color:#808030; '>[</span>AX<span style='color:#808030; '>-</span>WDef<span style='color:#008c00; '>.</span>X1<span style='color:#808030; '>+</span><span style='color:#808030; '>(</span>AY<span style='color:#808030; '>-</span>WDef<span style='color:#008c00; '>.</span>Y1<span style='color:#808030; '>)</span><span style='color:#808030; '>*</span>OWidth<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>Len<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1418:       UpdateScreen<span style='color:#808030; '>(</span>W<span style='color:#808030; '>,</span>AX<span style='color:#808030; '>,</span>AY<span style='color:#808030; '>,</span>Len<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1419:   <span style='color:#808030; '>END</span> <span style='color:#808030; '>;</span>
1420: <span style='color:#808030; '>END</span> WrBufferLn <span style='color:#808030; '>;</span>
1421: 
1422: 
1423: <span style='color:#696969; '>(* ------------------------- *)</span>
1424: <span style='color:#696969; '>(* Main initialization       *)</span>
1425: <span style='color:#696969; '>(* ------------------------- *)</span>
1426: <span style='color:#800000; font-weight:bold; '>PROCEDURE</span> Init <span style='color:#808030; '>;</span>
1427: <span style='color:#800000; font-weight:bold; '>CONST</span>
1428:   ClearOnEntry <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>TRUE</span> <span style='color:#808030; '>;</span>    <span style='color:#696969; '>(* Change to FALSE if automatic clear</span>
1429: <span style='color:#696969; '>                              NOT required *)</span>
1430: <span style='color:#800000; font-weight:bold; '>VAR</span>
1431:   R <span style='color:#808030; '>:</span> Registers <span style='color:#808030; '>;</span>
1432:   WD <span style='color:#808030; '>:</span> WinDef <span style='color:#808030; '>;</span>
1433: <span style='color:#808030; '>BEGIN</span>
1434:   InitScreenType<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>FALSE</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span> <span style='color:#696969; '>(* FALSE = no snow *)</span>
1435:   R<span style='color:#008c00; '>.</span>AH <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>3</span><span style='color:#808030; '>;</span>
1436:   R<span style='color:#008c00; '>.</span>BH <span style='color:#808030; '>:=</span> ActivePage<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1437:   Lib<span style='color:#008c00; '>.</span>Intr<span style='color:#808030; '>(</span>R<span style='color:#808030; '>,</span><span style='color:#008c00; '>10H</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1438:   <span style='color:#808030; '>IF</span> <span style='color:#808030; '>(</span>R<span style='color:#008c00; '>.</span>CH<span style='color:#808030; '>&lt;</span><span style='color:#008c00; '>20H</span><span style='color:#808030; '>)</span><span style='color:#800000; font-weight:bold; '>AND</span><span style='color:#808030; '>(</span>R<span style='color:#008c00; '>.</span>CL<span style='color:#808030; '>></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span>  <span style='color:#800000; font-weight:bold; '>THEN</span>
1439:      CursorLines <span style='color:#808030; '>:=</span> R<span style='color:#008c00; '>.</span>CX <span style='color:#808030; '>;</span>
1440:   <span style='color:#800000; font-weight:bold; '>ELSE</span>
1441:      CursorLines <span style='color:#808030; '>:=</span> <span style='color:#008c00; '>0607H</span> <span style='color:#808030; '>;</span>
1442:   <span style='color:#808030; '>END</span> <span style='color:#808030; '>;</span>
1443:   Lock <span style='color:#808030; '>:=</span> NullProc<span style='color:#808030; '>;</span>
1444:   Unlock <span style='color:#808030; '>:=</span> NullProc<span style='color:#808030; '>;</span>
1445:   MultiP <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>FALSE</span><span style='color:#808030; '>;</span>
1446:   WindowStack <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>NIL</span><span style='color:#808030; '>;</span>
1447:   NEW<span style='color:#808030; '>(</span>UseList<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1448:   UseList<span style='color:#808030; '>^</span><span style='color:#808030; '>.</span>Next <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>NIL</span><span style='color:#808030; '>;</span>        <span style='color:#696969; '>(* dummy *)</span>
1449:   CursorStack <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>NIL</span><span style='color:#808030; '>;</span>
1450:   IO<span style='color:#008c00; '>.</span>WrStrRedirect <span style='color:#808030; '>:=</span> WriteOut<span style='color:#808030; '>;</span>
1451:   IO<span style='color:#008c00; '>.</span>RdStrRedirect <span style='color:#808030; '>:=</span> ReadString<span style='color:#808030; '>;</span>
1452:   <span style='color:#808030; '>IF</span> ClearOnEntry <span style='color:#800000; font-weight:bold; '>THEN</span>
1453:     FullScreen       <span style='color:#808030; '>:=</span> Open<span style='color:#808030; '>(</span>FullScreenDef<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1454:   <span style='color:#800000; font-weight:bold; '>ELSE</span>
1455:     WD <span style='color:#808030; '>:=</span> FullScreenDef <span style='color:#808030; '>;</span>
1456:     WD<span style='color:#008c00; '>.</span>Hidden <span style='color:#808030; '>:=</span> <span style='color:#800000; font-weight:bold; '>TRUE</span> <span style='color:#808030; '>;</span>
1457:     FullScreen       <span style='color:#808030; '>:=</span> Open<span style='color:#808030; '>(</span>WD<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1458:     SnapShot <span style='color:#808030; '>;</span>
1459:     PutOnTop<span style='color:#808030; '>(</span>FullScreen<span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1460:     GotoXY<span style='color:#808030; '>(</span>ORD<span style='color:#808030; '>(</span>R<span style='color:#008c00; '>.</span>DL<span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>ORD<span style='color:#808030; '>(</span>R<span style='color:#008c00; '>.</span>DH<span style='color:#808030; '>)</span><span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>;</span>
1461:   <span style='color:#808030; '>END</span> <span style='color:#808030; '>;</span>
1462: <span style='color:#808030; '>END</span> Init <span style='color:#808030; '>;</span>
1463: 
1464: <span style='color:#808030; '>BEGIN</span>
1465:   Init <span style='color:#808030; '>;</span>
1466: <span style='color:#808030; '>END</span> Window<span style='color:#808030; '>.</span>
1467: 
