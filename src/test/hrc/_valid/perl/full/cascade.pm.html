<html><body style='color:#000000; background:#ffffff; '><pre>
   0: <span style='color:#696969; '># Copyright (C) 2000 Mark Stosberg </span><span style='color:#0000e6; '>&lt;</span><span style='color:#7144c4; '>mark@stosberg.com</span><span style='color:#0000e6; '>></span>
   1: <span style='color:#696969; '># Licensed under the the GNU GPL, available here: </span><span style='color:#5555dd; '>http://www.gnu.org/copyleft/gpl.html</span>
   2: 
   3: <span style='color:#696969; '># Originally by Mark Stosberg </span><span style='color:#7144c4; '>mark@summersault.com</span><span style='color:#696969; '> for the skatepark.org website</span>
   4: <span style='color:#696969; '># inspired by sumsearch by Chris Hardie </span><span style='color:#0000e6; '>&lt;</span><span style='color:#7144c4; '>chris@summersault.com</span><span style='color:#0000e6; '>></span>
   5: 
   6: <span style='color:#696969; '># </span><span style='color:#004a43; '>$Header$</span>
   7: 
   8: <span style='color:#808030; '>=pod</span><span style='color:#3f5fbf; '></span>
   9: <span style='color:#3f5fbf; '></span>
  10: <span style='color:#808030; '>=head1 </span><span style='color:#3f5fbf; '>NAME</span><span style='color:#3f5fbf; '></span>
  11: <span style='color:#3f5fbf; '></span>
  12: <span style='color:#3f5fbf; '>Cascade - Content Management System for a database driven web based dir</span>
  13: <span style='color:#3f5fbf; '></span>
  14: <span style='color:#808030; '>=head1 </span><span style='color:#3f5fbf; '>SYNOPSIS</span><span style='color:#3f5fbf; '></span>
  15: <span style='color:#3f5fbf; '></span>
  16: <span style='color:#3f5fbf; '>Cascade is expected to be used by an instance script, </span>
  17: <span style='color:#3f5fbf; '>which provides loads a configuration file and runs</span>
  18: <span style='color:#3f5fbf; '>the web application. See </span><span style='color:#0000e6; '>C&lt;html_path/cgi-bin/cascade.cgi></span><span style='color:#3f5fbf; '></span>
  19: <span style='color:#3f5fbf; '>included in the distribution for a working example. You</span>
  20: <span style='color:#3f5fbf; '>may be able use this directly, only changing </span>
  21: <span style='color:#3f5fbf; '>the configuration file to make it work for you. An</span>
  22: <span style='color:#3f5fbf; '>example configuration file is provided in the distribution</span>
  23: <span style='color:#3f5fbf; '>at </span><span style='color:#0000e6; '>C&lt;config/config.pl></span><span style='color:#3f5fbf; '>.</span>
  24: <span style='color:#3f5fbf; '></span>
  25: <span style='color:#808030; '>=head1 </span><span style='color:#3f5fbf; '>DESCRIPTION </span><span style='color:#3f5fbf; '></span>
  26: <span style='color:#3f5fbf; '></span>
  27: <span style='color:#3f5fbf; '>Cascade is a content management application for a database-driven</span>
  28: <span style='color:#3f5fbf; '>web-based directory. Since it's primarily intended to be used as an</span>
  29: <span style='color:#3f5fbf; '>application rather than directly as Perl modules, most of the</span>
  30: <span style='color:#3f5fbf; '>documention here of how the module works won't be interesting to most</span>
  31: <span style='color:#3f5fbf; '>users. Instead, read the INSTALL file in the distribution to get your</span>
  32: <span style='color:#3f5fbf; '>site up and running. The remaining documentation in the Cascade</span>
  33: <span style='color:#3f5fbf; '>modules for is provided for hackers who might want to tinker with the</span>
  34: <span style='color:#3f5fbf; '>code, and for myself, so I can remember why I did the things I did. </span>
  35: <span style='color:#3f5fbf; '></span>
  36: <span style='color:#3f5fbf; '>For a detailed description of Cascade, see:</span>
  37: <span style='color:#5555dd; '>http://summersault.com/software/cascade</span><span style='color:#3f5fbf; '> </span>
  38: <span style='color:#3f5fbf; '></span>
  39: <span style='color:#808030; '>=head1 </span><span style='color:#3f5fbf; '>AUTHOR</span><span style='color:#3f5fbf; '></span>
  40: <span style='color:#3f5fbf; '></span>
  41: <span style='color:#3f5fbf; '>Copyright (C) 2000-2001 Mark Stosberg </span><span style='color:#0000e6; '>&lt;</span><span style='color:#7144c4; '>mark@stosberg.com</span><span style='color:#0000e6; '>></span><span style='color:#3f5fbf; '></span>
  42: <span style='color:#3f5fbf; '></span>
  43: <span style='color:#3f5fbf; '>This library is free software; you can redistribute it and/or modify</span>
  44: <span style='color:#3f5fbf; '></span>
  45: <span style='color:#3f5fbf; '> </span>
  46: <span style='color:#3f5fbf; '>Address bug reports and comments to: </span><span style='color:#7144c4; '>mark@stosberg.com.</span><span style='color:#3f5fbf; '>  When sending</span>
  47: <span style='color:#3f5fbf; '>bug reports, please provide the version of Cascade, the version of</span>
  48: <span style='color:#3f5fbf; '>Perl, the name and version of your Web server, the name and version of</span>
  49: <span style='color:#3f5fbf; '>the operating system you are using, and the name and version of the</span>
  50: <span style='color:#3f5fbf; '>database you are using.  If the problem is even remotely browser</span>
  51: <span style='color:#3f5fbf; '>dependent, please provide information about the affected browers as</span>
  52: <span style='color:#3f5fbf; '>well.</span>
  53: <span style='color:#3f5fbf; '></span>
  54: <span style='color:#808030; '>=head1 </span><span style='color:#3f5fbf; '>SEE ALSO</span><span style='color:#3f5fbf; '></span>
  55: <span style='color:#3f5fbf; '></span>
  56: <span style='color:#3f5fbf; '>perl(1).</span>
  57: <span style='color:#3f5fbf; '></span>
  58: <span style='color:#808030; '>=head2 </span><span style='color:#3f5fbf; '>Steps for adding a new run mode</span><span style='color:#3f5fbf; '></span>
  59: <span style='color:#3f5fbf; '></span>
  60: <span style='color:#808030; '>=over </span><span style='color:#008c00; '>4</span><span style='color:#3f5fbf; '></span>
  61: <span style='color:#3f5fbf; '></span>
  62: <span style='color:#808030; '>=item</span><span style='color:#3f5fbf; '> * Add entry in run_modes() hash in &amp;Cascade::setup</span>
  63: <span style='color:#3f5fbf; '></span>
  64: <span style='color:#808030; '>=item</span><span style='color:#3f5fbf; '> * If run mode is non-public, create an appropriate entry in the</span>
  65: <span style='color:#3f5fbf; '>        RM_AUTH hash in config/config.pl</span>
  66: <span style='color:#3f5fbf; '></span>
  67: <span style='color:#808030; '>=item</span><span style='color:#3f5fbf; '> * Add run mode to appropriate module. Right now this</span>
  68: <span style='color:#3f5fbf; '>     Cascade::Admin for editor and admin run modes, and Cascade.pm</span>
  69: <span style='color:#3f5fbf; '>     for most everything else. </span>
  70: <span style='color:#3f5fbf; '></span>
  71: <span style='color:#808030; '>=back</span><span style='color:#3f5fbf; '></span>
  72: <span style='color:#3f5fbf; '></span>
  73: <span style='color:#3f5fbf; '>See the documentation for CGI::Application for further information on</span>
  74: <span style='color:#3f5fbf; '>run modes.</span>
  75: <span style='color:#3f5fbf; '></span>
  76: <span style='color:#808030; '>=cut</span>
  77: 
  78: <span style='color:#800000; font-weight:bold; '>package </span>Cascade<span style='color:#800080; '>;</span>
  79: <span style='color:#696969; '># CGI::Application will "use CGI" for us, but it doesn't check the version, </span>
  80: <span style='color:#696969; '># so we do that here. In earlier versions, "Vars" may not work as we'd like or expect. -mls</span>
  81: <span style='color:#800000; font-weight:bold; '>use</span> CGI <span style='color:#008c00; '>2.</span><span style='color:#008c00; '>75</span><span style='color:#800080; '>;</span>
  82: <span style='color:#800000; font-weight:bold; '>use</span> base <span style='color:#0000e6; '>'CGI::Application'</span><span style='color:#800080; '>;</span>
  83: 
  84: <span style='color:#800000; font-weight:bold; '>use</span> <span style='color:#bb7977; font-weight:bold; '>DBI</span> <span style='color:#008c00; '>1.</span><span style='color:#008c00; '>20</span><span style='color:#800080; '>;</span> <span style='color:#696969; '># we depened on some features added in this version </span>
  85: <span style='color:#800000; font-weight:bold; '>use</span> <span style='color:#bb7977; font-weight:bold; '>CGI::Carp</span><span style='color:#800080; '>;</span>
  86: 
  87: <span style='color:#696969; '># Global variables</span>
  88: <span style='color:#696969; '># %TMPL is a global hash to for template handle recycling</span>
  89: <span style='color:#696969; '>#   the keys are filenames and the values are handles for those files</span>
  90: <span style='color:#800000; font-weight:bold; '>use</span> <span style='color:#bb7977; font-weight:bold; '>vars</span> <span style='color:#800000; font-weight:bold; '>qw </span><span style='color:#800000; '>(</span><span style='color:#0000e6; '></span>
  91: <span style='color:#0000e6; '>    $DBH</span>
  92: <span style='color:#0000e6; '>    $DEBUG</span>
  93: <span style='color:#0000e6; '>    $VERSION  </span>
  94: <span style='color:#0000e6; '>    %CFG</span>
  95: <span style='color:#0000e6; '>    %FORM</span>
  96: <span style='color:#0000e6; '>    %SES</span>
  97: <span style='color:#0000e6; '>    %TMPL  </span>
  98: <span style='color:#0000e6; '>    $q</span>
  99: <span style='color:#800000; '>)</span><span style='color:#800080; '>;</span>
 100: 
 101: <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Exporter</span><span style='color:#800080; '>;</span>
 102: <span style='color:#800000; font-weight:bold; '>push</span> @ISA<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>qw</span><span style='color:#800000; '>(</span><span style='color:#0000e6; '>Exporter</span><span style='color:#800000; '>)</span><span style='color:#800080; '>;</span>
 103: 
 104: @EXPORT_OK <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>qw</span><span style='color:#800000; '>(</span><span style='color:#0000e6; '></span>
 105: <span style='color:#0000e6; '>  $DBH</span>
 106: <span style='color:#0000e6; '>  $VERSION</span>
 107: <span style='color:#0000e6; '>  %CFG</span>
 108: <span style='color:#0000e6; '>  %FORM</span>
 109: <span style='color:#0000e6; '>  %SES</span>
 110: <span style='color:#0000e6; '>  %TMPL</span>
 111: <span style='color:#0000e6; '>  &amp;_html_error</span>
 112: <span style='color:#0000e6; '>  &amp;cat_already_exists</span>
 113: <span style='color:#0000e6; '>  &amp;check_cat_url</span>
 114: <span style='color:#0000e6; '>  &amp;conflicts_with_existing_cat</span>
 115: <span style='color:#0000e6; '>  &amp;err</span>
 116: <span style='color:#0000e6; '>  &amp;footer_html_tmpl</span>
 117: <span style='color:#0000e6; '>  &amp;front_page</span>
 118: <span style='color:#0000e6; '>  &amp;gettext</span>
 119: <span style='color:#0000e6; '>  &amp;html_item_new</span>
 120: <span style='color:#0000e6; '>  &amp;illegal_chars</span>
 121: <span style='color:#0000e6; '>  &amp;is_role</span>
 122: <span style='color:#0000e6; '>  &amp;validate_image</span>
 123: <span style='color:#0000e6; '>  $q</span>
 124: <span style='color:#0000e6; '>  &amp;htmlicize</span>
 125: <span style='color:#0000e6; '>  &amp;insert_hash</span>
 126: <span style='color:#800000; '>)</span><span style='color:#800080; '>;</span>
 127: 
 128: @EXPORT <span style='color:#808030; '>=</span> @EXPORT_OK<span style='color:#800080; '>;</span>
 129: <span style='color:#800000; font-weight:bold; '>use</span> <span style='color:#800000; font-weight:bold; '>strict</span><span style='color:#800080; '>;</span>
 130: 
 131: <span style='color:#800000; font-weight:bold; '>use</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Auth</span><span style='color:#800080; '>;</span>
 132: <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#800080; '>;</span>
 133: <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#800080; '>;</span>
 134: 
 135: <span style='color:#696969; '># XXX How can I avoid loading the admin module for every page? </span>
 136: <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Admin</span><span style='color:#800080; '>;</span>
 137: $VERSION <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'2.1.2'</span><span style='color:#800080; '>;</span> 
 138: 
 139: <span style='color:#696969; '># Internationalization stuff</span>
 140: <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span> $CFG<span style='color:#800080; '>{</span>LAN<span style='color:#800080; '>}</span> <span style='color:#808030; '>ne</span> <span style='color:#0000e6; '>''</span> <span style='color:#808030; '>and</span> $CFG<span style='color:#800080; '>{</span>LAN<span style='color:#800080; '>}</span> <span style='color:#808030; '>ne</span> <span style='color:#0000e6; '>'en'</span> <span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> 
 141:     <span style='color:#696969; '># XXX very broken for now, because gettext is sparsely used. -mls</span>
 142:     <span style='color:#696969; '># We require rather than 'use' POSIX here so it only get's loaded inside of this "if" block</span>
 143:     <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>POSIX</span><span style='color:#800080; '>;</span>
 144:     import <span style='color:#bb7977; font-weight:bold; '>POSIX</span><span style='color:#800080; '>;</span>
 145:     <span style='color:#800000; font-weight:bold; '>eval</span> <span style='color:#0000e6; '>"use Locale::gettext"</span><span style='color:#800080; '>;</span>
 146:     $ENV<span style='color:#800080; '>{</span>LC_MESSAGES<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> $CFG<span style='color:#800080; '>{</span>LAN<span style='color:#800080; '>}</span> <span style='color:#800080; '>;</span>
 147:     bindtextdomain<span style='color:#808030; '>(</span>$CFG<span style='color:#800080; '>{</span>DATABASE<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$CFG<span style='color:#800080; '>{</span>CATDIR<span style='color:#800080; '>}</span> <span style='color:#808030; '>)</span> <span style='color:#800080; '>;</span>
 148:     textdomain<span style='color:#808030; '>(</span>$CFG<span style='color:#800080; '>{</span>DATABASE<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> 
 149:     <span style='color:#bb7977; font-weight:bold; '>POSIX</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span>setlocale<span style='color:#808030; '>(</span><span style='color:#808030; '>&amp;</span><span style='color:#bb7977; font-weight:bold; '>POSIX</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span>LC_MESSAGES<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>''</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 150: <span style='color:#800080; '>}</span>
 151: <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
 152:   <span style='color:#696969; '># In case that we dont want to use gettext, this is  the shortcut</span>
 153:   *gettext<span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>sub</span> <span style='color:#800080; '>{</span> <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#800000; font-weight:bold; '>shift</span> <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 154: <span style='color:#800080; '>}</span>
 155: 
 156: <span style='color:#800000; font-weight:bold; '>sub </span>setup <span style='color:#800080; '>{</span>
 157:     <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 158:     $DBH <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span><span style='color:#808030; '>=</span> connect_db<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>die</span> <span style='color:#0000e6; '>"Could not connect to database. Check connection parameters"</span><span style='color:#800080; '>;</span>
 159: 
 160:     <span style='color:#696969; '># Put param variables into a global hash</span>
 161:     $q <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>query<span style='color:#800080; '>;</span> 
 162:     %FORM <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>%FORM<span style='color:#808030; '>,</span> $q<span style='color:#808030; '>-></span>Vars<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 163: 
 164: <span style='color:#696969; '># set $FORM{rm} (run mode)</span>
 165:     $FORM<span style='color:#800080; '>{</span>rm<span style='color:#800080; '>}</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span><span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'front_page'</span><span style='color:#800080; '>;</span>
 166:     $self<span style='color:#808030; '>-></span>get_mode_param<span style='color:#800080; '>;</span>
 167: 
 168:     %SES <span style='color:#808030; '>=</span> validate_session<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 169: <span style='color:#696969; '>#  It would be nice to distinquish failures that occur when people are</span>
 170: <span style='color:#696969; '>#  logged in, just not at a high enough level (ie, they are logged in</span>
 171: <span style='color:#696969; '>#  as editor, but the run mode requires them to be an admin). This isn't the way to</span>
 172: <span style='color:#696969; '>#  do it.</span>
 173: <span style='color:#696969; '>#  $SES{valid_idle} or print</span>
 174: <span style='color:#696969; '>#  CGI::header().err(title=>'Insufficient Authorization', msg=>'The</span>
 175: <span style='color:#696969; '>#  user you logged in as does not have permission to view this page.')</span>
 176: <span style='color:#696969; '>#  and exit;</span>
 177:     <span style='color:#800000; font-weight:bold; '>my</span> $start_mode <span style='color:#808030; '>=</span> $SES<span style='color:#800080; '>{</span>valid_idle<span style='color:#800080; '>}</span> <span style='color:#808030; '>?</span> $FORM<span style='color:#800080; '>{</span>rm<span style='color:#800080; '>}</span> <span style='color:#808030; '>:</span> <span style='color:#0000e6; '>'login'</span><span style='color:#800080; '>;</span> 
 178:     $self<span style='color:#808030; '>-></span>start_mode<span style='color:#808030; '>(</span>$start_mode<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 179: 
 180:     $self<span style='color:#808030; '>-></span>run_modes<span style='color:#808030; '>(</span>
 181:             <span style='color:#0000e6; '>'front_page'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'front_page'</span><span style='color:#808030; '>,</span>
 182: <span style='color:#696969; '># "cat" is just a short alias for "category_page"</span>
 183:             <span style='color:#0000e6; '>'cat'</span>          <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'category_page'</span><span style='color:#808030; '>,</span>
 184:             <span style='color:#0000e6; '>'category_page'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'category_page'</span><span style='color:#808030; '>,</span>
 185:             <span style='color:#0000e6; '>'item_add_form'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_add_form'</span><span style='color:#808030; '>,</span>
 186:             <span style='color:#0000e6; '>'item_suggest_add'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_suggest_add'</span><span style='color:#808030; '>,</span> 
 187:             <span style='color:#0000e6; '>'item_approve_add'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_approve_add'</span><span style='color:#808030; '>,</span>
 188:             item_approve_insert <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_approve_insert'</span><span style='color:#808030; '>,</span>
 189:             item_approve_update <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_approve_update'</span><span style='color:#808030; '>,</span>
 190:             <span style='color:#0000e6; '>'item_edit_form'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_edit_form'</span><span style='color:#808030; '>,</span>
 191:             <span style='color:#0000e6; '>'item_delete_checklist'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_delete_checklist'</span><span style='color:#808030; '>,</span>
 192:             <span style='color:#0000e6; '>'item_list_delete_urls'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_list_delete_urls'</span><span style='color:#808030; '>,</span>
 193: <span style='color:#696969; '># we make this alias so we can force editors to login when they visit urls via email to edit suggestions -mls</span>
 194:             item_edit_suggestion_form <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_edit_form'</span><span style='color:#808030; '>,</span>
 195:             <span style='color:#0000e6; '>'item_new'</span>    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'html_item_new'</span><span style='color:#808030; '>,</span>
 196:             <span style='color:#0000e6; '>'write_static_pages'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'write_static_pages'</span><span style='color:#808030; '>,</span>
 197:             <span style='color:#0000e6; '>'item_suggest_update'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_suggest_update'</span><span style='color:#808030; '>,</span>
 198:             <span style='color:#0000e6; '>'cat_add_form'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'cat_add_form'</span><span style='color:#808030; '>,</span>
 199:             <span style='color:#0000e6; '>'cat_add_process'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'cat_add_process'</span><span style='color:#808030; '>,</span>
 200:             <span style='color:#0000e6; '>'link_form'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'link_form'</span><span style='color:#808030; '>,</span>
 201:             <span style='color:#0000e6; '>'link_add'</span>  <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'link_add'</span><span style='color:#808030; '>,</span>
 202:             <span style='color:#0000e6; '>'link_edit'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'link_edit'</span><span style='color:#808030; '>,</span>
 203:             <span style='color:#0000e6; '>'link_delete'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'link_delete'</span><span style='color:#808030; '>,</span>
 204:             <span style='color:#0000e6; '>'cat_relate_form'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'cat_relate_form'</span><span style='color:#808030; '>,</span>
 205:             <span style='color:#0000e6; '>'cat_relate_update'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'cat_relate_update'</span><span style='color:#808030; '>,</span>
 206:             <span style='color:#0000e6; '>'cat_edit_form'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'cat_edit_form'</span><span style='color:#808030; '>,</span>
 207:             <span style='color:#0000e6; '>'cat_update'</span>    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'cat_update'</span><span style='color:#808030; '>,</span>
 208:             <span style='color:#0000e6; '>'cat_delete'</span>    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'cat_delete'</span><span style='color:#808030; '>,</span>
 209:             <span style='color:#0000e6; '>'item_delete'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_delete'</span><span style='color:#808030; '>,</span>
 210:             <span style='color:#0000e6; '>'needs_approval_summary'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'needs_approval_summary'</span><span style='color:#808030; '>,</span>
 211:             <span style='color:#0000e6; '>'unverified_urls_report'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'unverified_urls_report'</span><span style='color:#808030; '>,</span>
 212:             search_zip    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'search_zip'</span><span style='color:#808030; '>,</span>
 213:             item_edit <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_edit'</span><span style='color:#808030; '>,</span>
 214:             item_suggest_update_form <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_suggest_update_form'</span><span style='color:#808030; '>,</span>
 215:             item_suggest_update_thanks <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_suggest_update_thanks'</span><span style='color:#808030; '>,</span>
 216:             login    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'login_form'</span><span style='color:#808030; '>,</span>
 217:             login_process <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'login_process'</span><span style='color:#808030; '>,</span>
 218:             logout    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'logout'</span><span style='color:#808030; '>,</span>
 219:             register_form <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'register_form'</span><span style='color:#808030; '>,</span>
 220:             register_process <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'register_process'</span><span style='color:#808030; '>,</span>
 221:             password_forgot_form <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'password_forgot_form'</span><span style='color:#808030; '>,</span>
 222:             password_mail_forgotten <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'password_mail_forgotten'</span><span style='color:#808030; '>,</span>
 223:             password_mail_success <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'password_mail_success'</span><span style='color:#808030; '>,</span>
 224:             item_view_comments <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_view_comments'</span><span style='color:#808030; '>,</span>
 225:             item_comment_post  <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_comment_post'</span><span style='color:#808030; '>,</span>
 226:             item_comments_delete <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_comments_delete'</span><span style='color:#808030; '>,</span>
 227:             item_include_comments <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'item_include_comments'</span><span style='color:#808030; '>,</span>
 228:             pvt_basic_info_update_form <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#800000; font-weight:bold; '>sub</span> <span style='color:#800080; '>{</span> <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>User</span><span style='color:#800080; '>;</span> <span style='color:#808030; '>&amp;</span>pvt_basic_info_update_form <span style='color:#800080; '>}</span><span style='color:#808030; '>,</span> 
 229:             pvt_home <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#800000; font-weight:bold; '>sub</span> <span style='color:#800080; '>{</span> <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>User</span><span style='color:#800080; '>;</span> <span style='color:#808030; '>&amp;</span>pvt_home <span style='color:#800080; '>}</span><span style='color:#808030; '>,</span> 
 230:             shared_home <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#800000; font-weight:bold; '>sub</span> <span style='color:#800080; '>{</span> <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>User</span><span style='color:#800080; '>;</span> <span style='color:#808030; '>&amp;</span>shared_home <span style='color:#800080; '>}</span><span style='color:#808030; '>,</span> 
 231:             pvt_basic_info_process <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#800000; font-weight:bold; '>sub</span> <span style='color:#800080; '>{</span> <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>User</span><span style='color:#800080; '>;</span> <span style='color:#808030; '>&amp;</span>pvt_basic_info_process <span style='color:#800080; '>}</span><span style='color:#808030; '>,</span> 
 232:             current_contributors <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#800000; font-weight:bold; '>sub</span> <span style='color:#800080; '>{</span> <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>User</span><span style='color:#800080; '>;</span> <span style='color:#808030; '>&amp;</span>current_contributors <span style='color:#800080; '>}</span><span style='color:#808030; '>,</span> 
 233:             historical_month_index <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'historical_month_index'</span><span style='color:#808030; '>,</span> 
 234:             historical_all_index <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'historical_all_index'</span><span style='color:#808030; '>,</span> 
 235:             <span style='color:#800000; font-weight:bold; '>AUTOLOAD</span>           <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> 
 236:                 <span style='color:#800000; font-weight:bold; '>sub</span> <span style='color:#800080; '>{</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Page not found'</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>"(the run mode tried was: </span><span style='color:#0000e6; '>$FORM</span><span style='color:#0000e6; '>{rm})"</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>}</span>
 237:             <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 238: 
 239: <span style='color:#696969; '># This happens here so that we can declare $VERSION in Cascade.pm to make CPAN happy</span>
 240: <span style='color:#696969; '># but also have a copy in %CFG to make template management easier. -mls</span>
 241:             $CFG<span style='color:#800080; '>{</span>VERSION<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> $VERSION<span style='color:#800080; '>;</span>
 242: <span style='color:#800080; '>}</span>
 243: 
 244: <span style='color:#696969; '># use the first piece of PATH_INFO, or just look in $FORM{rm};</span>
 245: <span style='color:#800000; font-weight:bold; '>sub </span>get_mode_param <span style='color:#800080; '>{</span>
 246:    <span style='color:#696969; '># The run mode is the first chunk, the rest goes back into PATH_INFO</span>
 247:    <span style='color:#696969; '># We ignore any leading slashes</span>
 248:    <span style='color:#800000; font-weight:bold; '>my</span> $pi<span style='color:#800080; '>;</span>
 249:    <span style='color:#808030; '>(</span>$pi<span style='color:#808030; '>,</span> $ENV<span style='color:#800080; '>{</span>PATH_INFO<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $ENV<span style='color:#800080; '>{</span>PATH_INFO<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>m</span><span style='color:#800000; '>@</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>/</span><span style='color:#808030; '>*</span><span style='color:#808030; '>(</span><span style='color:#808030; '>[</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>/</span><span style='color:#808030; '>]</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#0000e6; '>/</span><span style='color:#808030; '>*</span><span style='color:#808030; '>(</span><span style='color:#808030; '>.</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>$</span><span style='color:#800000; '>@</span><span style='color:#800080; '>;</span>
 250: 
 251:   $FORM<span style='color:#800080; '>{</span>rm<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>length</span> $pi<span style='color:#808030; '>)</span> <span style='color:#808030; '>?</span> $pi <span style='color:#808030; '>:</span> $FORM<span style='color:#800080; '>{</span>rm<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span> 
 252: <span style='color:#800080; '>}</span>
 253: 
 254: <span style='color:#808030; '>=pod</span><span style='color:#3f5fbf; '> </span>
 255: <span style='color:#3f5fbf; '></span>
 256: <span style='color:#808030; '>=head2 </span><span style='color:#3f5fbf; '>A note about template namespaces</span><span style='color:#3f5fbf; '></span>
 257: <span style='color:#3f5fbf; '></span>
 258: <span style='color:#3f5fbf; '>A few prefixes in the template namespace are reserved for use by Cascade. These include:</span>
 259: <span style='color:#3f5fbf; '></span>
 260: <span style='color:#808030; '>=over </span><span style='color:#008c00; '>4</span><span style='color:#3f5fbf; '></span>
 261: <span style='color:#3f5fbf; '></span>
 262: <span style='color:#808030; '>=item</span><span style='color:#3f5fbf; '> * cfg_ -- variables from the CFG hash</span>
 263: <span style='color:#3f5fbf; '></span>
 264: <span style='color:#808030; '>=item</span><span style='color:#3f5fbf; '> * ses_ -- session variables</span>
 265: <span style='color:#3f5fbf; '></span>
 266: <span style='color:#808030; '>=item</span><span style='color:#3f5fbf; '> * err_ -- error variables</span>
 267: <span style='color:#3f5fbf; '></span>
 268: <span style='color:#808030; '>=item</span><span style='color:#3f5fbf; '> * role_ -- role variables </span>
 269: <span style='color:#3f5fbf; '></span>
 270: <span style='color:#808030; '>=back</span><span style='color:#3f5fbf; '></span>
 271: <span style='color:#3f5fbf; '></span>
 272: <span style='color:#808030; '>=cut</span>
 273: 
 274: <span style='color:#800000; font-weight:bold; '>sub </span>load_tmpl <span style='color:#800080; '>{</span>
 275:         <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 276:         <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$tmpl_file<span style='color:#808030; '>,</span> @extra_params<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @_<span style='color:#800080; '>;</span>
 277:  
 278:         <span style='color:#800000; font-weight:bold; '>my</span> $fq_tmpl_file <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>tmpl_path<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>.</span> $tmpl_file<span style='color:#800080; '>;</span>
 279:  
 280:         <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>HTML::Template</span><span style='color:#800080; '>;</span>
 281:     <span style='color:#696969; '># set up the templates with some defaults</span>
 282:         <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>HTML::Template</span><span style='color:#808030; '>-></span>new_file<span style='color:#808030; '>(</span>$fq_tmpl_file<span style='color:#808030; '>,</span> @extra_params<span style='color:#808030; '>,</span> %{ $CFG<span style='color:#800080; '>{</span>HTML_TMPL_DEFAULTS<span style='color:#800080; '>}</span> }<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 283: 
 284:     $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 285:         <span style='color:#696969; '># supply global config variables to the templates. Rather than pollute the name space</span>
 286:         <span style='color:#696969; '># let's prefix them with cfg_, dawg. </span>
 287:        <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>map</span> <span style='color:#800080; '>{</span>
 288:           <span style='color:#800000; font-weight:bold; '>my</span> $k <span style='color:#808030; '>=</span> $_<span style='color:#800080; '>;</span>
 289:           <span style='color:#0000e6; '>'CFG_'</span><span style='color:#808030; '>.</span>$k <span style='color:#808030; '>=</span><span style='color:#808030; '>></span>  $CFG<span style='color:#800080; '>{</span>$k<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 290:        <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>keys</span> %CFG<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 291:        <span style='color:#696969; '># supply global session variables to the template</span>
 292:        <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>map</span> <span style='color:#800080; '>{</span>
 293:           <span style='color:#800000; font-weight:bold; '>my</span> $k <span style='color:#808030; '>=</span> $_<span style='color:#800080; '>;</span>
 294:           <span style='color:#0000e6; '>'SES_'</span><span style='color:#808030; '>.</span>$k <span style='color:#808030; '>=</span><span style='color:#808030; '>></span>  $SES<span style='color:#800080; '>{</span>$k<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 295:        <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>keys</span> %SES<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 296:       <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 297:         <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#800080; '>;</span>
 298: <span style='color:#800080; '>}</span>
 299: 
 300: 
 301: <span style='color:#800000; font-weight:bold; '>sub </span>connect_db <span style='color:#800080; '>{</span>
 302: 
 303:     <span style='color:#800000; font-weight:bold; '>my</span> $dsn<span style='color:#800080; '>;</span>
 304:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$CFG<span style='color:#800080; '>{</span>DRIVER<span style='color:#800080; '>}</span> <span style='color:#808030; '>eq</span> <span style='color:#0000e6; '>'mysql'</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 305:         $dsn <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"DBI:</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{DRIVER}:database=</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{DATABASE};host=</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{DBSERVER};port=</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{DBPORT}"</span><span style='color:#800080; '>;</span>
 306:     <span style='color:#696969; '># Default to Postgres' style dsn for now</span>
 307:     <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
 308:         $dsn <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"dbi:</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{DRIVER}:dbname=</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{DATABASE};"</span><span style='color:#808030; '>.</span>
 309:             <span style='color:#808030; '>(</span>$CFG<span style='color:#800080; '>{</span>DBSERVER<span style='color:#800080; '>}</span> <span style='color:#808030; '>and</span> <span style='color:#0000e6; '>"host=</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{DBSERVER};"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>
 310:             <span style='color:#808030; '>(</span>$CFG<span style='color:#800080; '>{</span>DBOPTIONS<span style='color:#800080; '>}</span> <span style='color:#808030; '>and</span> <span style='color:#0000e6; '>"options=</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{DBOPTIONS};"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>
 311:             <span style='color:#808030; '>(</span>$CFG<span style='color:#800080; '>{</span>DBPORT<span style='color:#800080; '>}</span> <span style='color:#808030; '>and</span> <span style='color:#0000e6; '>"port=</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{DBPORT};"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 312:     <span style='color:#800080; '>}</span>        
 313:     
 314:     <span style='color:#800000; font-weight:bold; '>my</span> $rv <span style='color:#808030; '>=</span> $DBH <span style='color:#808030; '>=</span>  <span style='color:#bb7977; font-weight:bold; '>DBI</span><span style='color:#808030; '>-></span><span style='color:#800000; font-weight:bold; '>connect</span><span style='color:#808030; '>(</span>$dsn<span style='color:#808030; '>,</span>
 315:                $CFG<span style='color:#800080; '>{</span>DBUSER<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$CFG<span style='color:#800080; '>{</span>DBPASS<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
 316:                <span style='color:#800080; '>{</span>
 317:                    PrintError <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>
 318:                    RaiseError <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
 319:                <span style='color:#800080; '>}</span> <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 320:     <span style='color:#800000; font-weight:bold; '>return</span> $rv<span style='color:#800080; '>;</span>                
 321: <span style='color:#800080; '>}</span>
 322: 
 323: 
 324: 
 325: 
 326: 
 327: <span style='color:#696969; '># Establish some defaults and provide a template to call CGI::Err with.</span>
 328: <span style='color:#800000; font-weight:bold; '>sub </span>err <span style='color:#800080; '>{</span>
 329: 
 330:     <span style='color:#800000; font-weight:bold; '>my</span> %args <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>
 331:         debug    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $DEBUG<span style='color:#808030; '>,</span>
 332:         @_
 333:     <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 334:     
 335:     <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>HTML::Template</span><span style='color:#800080; '>;</span>
 336: 
 337:     <span style='color:#696969; '># We treat the header and footer differently since they rely on other values in the incoming hash. </span>
 338:     <span style='color:#800000; font-weight:bold; '>my</span> $tmpl <span style='color:#808030; '>=</span> new <span style='color:#bb7977; font-weight:bold; '>HTML::Template</span><span style='color:#808030; '>(</span>
 339:         die_on_bad_params<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span>
 340:         path<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$CFG<span style='color:#800080; '>{</span>HTML_TEMPLATE_ROOT<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
 341:         filename<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'error.tmpl'</span>
 342:     <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 343:     
 344:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$args<span style='color:#800080; '>{</span>debug<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 345:         <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$package<span style='color:#808030; '>,</span> $file<span style='color:#808030; '>,</span> $line<span style='color:#808030; '>,</span> $sub<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>caller</span><span style='color:#808030; '>(</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>2</span><span style='color:#808030; '>,</span><span style='color:#008c00; '>3</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
 346:         <span style='color:#800000; font-weight:bold; '>my</span> $q <span style='color:#808030; '>=</span> new CGI<span style='color:#800080; '>;</span>
 347:         $args<span style='color:#800080; '>{</span>debugging_text<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"Package: </span><span style='color:#0000e6; '>$package</span><span style='color:#0000e6; '>&lt;BR> File: </span><span style='color:#0000e6; '>$file</span><span style='color:#0000e6; '> &lt;BR>Line: </span><span style='color:#0000e6; '>$line</span><span style='color:#0000e6; '> &lt;BR> Subroutine: </span><span style='color:#0000e6; '>$sub</span><span style='color:#0000e6; '>&lt;P>"</span> <span style='color:#808030; '>.</span>$q<span style='color:#808030; '>-></span>Dump<span style='color:#800080; '>;</span>
 348:     <span style='color:#800080; '>}</span>
 349: 
 350:     $args<span style='color:#800080; '>{</span>page_title<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> $args<span style='color:#800080; '>{</span>title<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 351:     $tmpl<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>%args<span style='color:#808030; '>,</span>contact_email<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$CFG<span style='color:#800080; '>{</span>CONTACT_EMAIL<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 352: 
 353:     <span style='color:#800000; font-weight:bold; '>return</span> $tmpl<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
 354:   
 355: <span style='color:#800080; '>}</span>
 356: 
 357: 
 358: <span style='color:#696969; '># Currently not used</span>
 359: <span style='color:#696969; '># sub get_user_item_rating {</span>
 360: <span style='color:#696969; '>#   </span>
 361: <span style='color:#696969; '>#   my ($user_id, $item_id, $category_id) = @_;</span>
 362: <span style='color:#696969; '>#   </span>
 363: <span style='color:#696969; '>#   my $rating = $DBH->selectrow_array("select rating from rating </span>
 364: <span style='color:#696969; '>#       where (user_id = $user_id</span>
 365: <span style='color:#696969; '>#       and item_id = $item_id</span>
 366: <span style='color:#696969; '>#       and category_id = $category_id)");</span>
 367: <span style='color:#696969; '>#   </span>
 368: <span style='color:#696969; '>#   return $rating;</span>
 369: <span style='color:#696969; '># </span>
 370: <span style='color:#696969; '># }</span>
 371: 
 372: 
 373: 
 374: 
 375: <span style='color:#696969; '># Used to to check to see whether the Input URL is a valid category, returns the category_id if true,</span>
 376: <span style='color:#696969; '># or undef if false</span>
 377: <span style='color:#800000; font-weight:bold; '>sub </span>check_cat_url <span style='color:#800080; '>{</span>
 378:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 379:    <span style='color:#800000; font-weight:bold; '>my</span> $url <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 380:    <span style='color:#800000; font-weight:bold; '>my</span> @cat_ids<span style='color:#800080; '>;</span>
 381:     
 382:    <span style='color:#696969; '># Be forgiving about leading and trailing whitespace (delete it)</span>
 383:    $url <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>s</span><span style='color:#800000; '>/</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>\s</span><span style='color:#808030; '>+</span><span style='color:#800080; '>|</span><span style='color:#0000e6; '>\s</span><span style='color:#808030; '>+</span><span style='color:#808030; '>$</span><span style='color:#800000; '>/</span><span style='color:#800000; '>/</span><span style='color:#800000; font-weight:bold; '>g</span><span style='color:#800080; '>;</span>
 384: 
 385:    <span style='color:#696969; '># If it's a static page, we want to get rid of HTML_ROOT_URL first</span>
 386:    $url <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>s</span><span style='color:#800000; '>/</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{HTML_ROOT_URL}</span><span style='color:#800000; '>/</span><span style='color:#800000; '>/</span><span style='color:#800080; '>;</span>
 387:    
 388:    <span style='color:#696969; '># Undo encoding</span>
 389: 
 390:    <span style='color:#696969; '># underscores back to spaces</span>
 391:    $url <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>s</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>_</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '> </span><span style='color:#800000; '>/</span><span style='color:#800000; font-weight:bold; '>g</span><span style='color:#800080; '>;</span>
 392: 
 393:    <span style='color:#696969; '># x's, which represent characters that don't make good urls, get turned into %</span>
 394:    <span style='color:#696969; '># for SQL LIKE pattern matching. -mls</span>
 395:    $url <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>s</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>x</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>%</span><span style='color:#800000; '>/</span><span style='color:#800000; font-weight:bold; '>g</span><span style='color:#800080; '>;</span>
 396:     
 397:    <span style='color:#696969; '># Split into directory names</span>
 398:    <span style='color:#800000; font-weight:bold; '>my</span> @cats <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>split</span> <span style='color:#0000e6; '>"/"</span><span style='color:#808030; '>,</span> $url<span style='color:#800080; '>;</span>
 399: 
 400:    <span style='color:#696969; '># The first element of the array is probably a null troublemaker. -mls</span>
 401:    <span style='color:#800000; font-weight:bold; '>my</span> $discard <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span> @cats <span style='color:#800000; font-weight:bold; '>unless</span> $cats<span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
 402:     
 403:    @cats <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>reverse</span> @cats<span style='color:#800080; '>;</span>
 404:     
 405:    <span style='color:#696969; '># Create a SQL statement to see if this directory really exists. </span>
 406:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>@from_bits<span style='color:#808030; '>,</span> @where_bits<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 407:    <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> $i <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> $i <span style='color:#808030; '>&lt;</span><span style='color:#808030; '>=</span> $#cats<span style='color:#800080; '>;</span> $i<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 408:       <span style='color:#800000; font-weight:bold; '>my</span> $i1 <span style='color:#808030; '>=</span> $i<span style='color:#808030; '>+</span><span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
 409:       <span style='color:#800000; font-weight:bold; '>push</span> @from_bits<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"cas_category c</span><span style='color:#0000e6; '>$i</span><span style='color:#0000e6; '>"</span><span style='color:#800080; '>;</span>
 410:       <span style='color:#800000; font-weight:bold; '>push</span> @where_bits<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"c</span><span style='color:#0000e6; '>$i1</span><span style='color:#0000e6; '>.category_id = c</span><span style='color:#0000e6; '>$i</span><span style='color:#0000e6; '>.parent_id"</span> <span style='color:#800000; font-weight:bold; '>unless</span> $i <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> $#cats<span style='color:#800080; '>;</span>
 411:       <span style='color:#800000; font-weight:bold; '>push</span> @where_bits<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"c</span><span style='color:#0000e6; '>$i</span><span style='color:#0000e6; '>.name LIKE "</span><span style='color:#808030; '>.</span>$DBH<span style='color:#808030; '>-></span>quote<span style='color:#808030; '>(</span>$cats<span style='color:#808030; '>[</span>$i<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> 
 412:    <span style='color:#800080; '>}</span>
 413:     
 414:    <span style='color:#800000; font-weight:bold; '>my</span> $sql <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"SELECT c0.category_id FROM "</span><span style='color:#808030; '>.</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>join</span> <span style='color:#0000e6; '>', '</span><span style='color:#808030; '>,</span> @from_bits<span style='color:#808030; '>)</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>" WHERE "</span><span style='color:#808030; '>.</span><span style='color:#800000; font-weight:bold; '>join</span> <span style='color:#0000e6; '>"</span><span style='color:#0f69ff; '>\n</span><span style='color:#0000e6; '>and "</span><span style='color:#808030; '>,</span> @where_bits<span style='color:#800080; '>;</span>
 415:    $sql <span style='color:#808030; '>.</span><span style='color:#808030; '>=</span> <span style='color:#0000e6; '>" AND c</span><span style='color:#0000e6; '>$#cats</span><span style='color:#0000e6; '>.parent_id = </span><span style='color:#008c00; '>0</span><span style='color:#0000e6; '>"</span><span style='color:#800080; '>;</span>
 416:     
 417:    <span style='color:#800000; font-weight:bold; '>my</span> $cat_id <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span>$sql<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 418: 
 419:    <span style='color:#696969; '>#If we made it this far, all's good. Return the $target_id</span>
 420:    <span style='color:#800000; font-weight:bold; '>return</span> $cat_id<span style='color:#800080; '>;</span>
 421: <span style='color:#800080; '>}</span>
 422: 
 423: <span style='color:#696969; '># Before we compare a submitted URL to one in the database, let's reduce the chance that 2 equivalent URLS will appear different.</span>
 424: <span style='color:#696969; '># We can lowercase the URL, and chop off standard directory prefixes. </span>
 425: <span style='color:#800000; font-weight:bold; '>sub </span>base_url <span style='color:#800080; '>{</span>
 426:     <span style='color:#800000; font-weight:bold; '>my</span> $url <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 427:     $url <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>s</span><span style='color:#800000; '>%</span><span style='color:#808030; '>(</span><span style='color:#808030; '>.</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>(</span><span style='color:#0000e6; '>default</span><span style='color:#800080; '>|</span><span style='color:#0000e6; '>welcome</span><span style='color:#800080; '>|</span><span style='color:#0000e6; '>index</span><span style='color:#808030; '>)</span><span style='color:#0f69ff; '>\.</span><span style='color:#808030; '>(</span><span style='color:#0000e6; '>cgi</span><span style='color:#800080; '>|</span><span style='color:#0000e6; '>s</span><span style='color:#808030; '>?</span><span style='color:#0000e6; '>html</span><span style='color:#808030; '>?</span><span style='color:#800080; '>|</span><span style='color:#0000e6; '>tcl</span><span style='color:#800080; '>|</span><span style='color:#0000e6; '>adp</span><span style='color:#800080; '>|</span><span style='color:#0000e6; '>asp</span><span style='color:#800080; '>|</span><span style='color:#0000e6; '>pl</span><span style='color:#808030; '>)</span><span style='color:#808030; '>$</span><span style='color:#800000; '>%</span><span style='color:#0000e6; '>$1</span><span style='color:#800000; '>%</span><span style='color:#800000; font-weight:bold; '>i</span><span style='color:#800080; '>;</span>
 428:     <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>lc</span> $url<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 429: <span style='color:#800080; '>}</span>
 430: 
 431: <span style='color:#696969; '># returns the html page for "what's new" page</span>
 432: <span style='color:#696969; '># deprecated. May go away in favor of historical_* run modes</span>
 433: <span style='color:#800000; font-weight:bold; '>sub </span>html_item_new <span style='color:#800080; '>{</span>
 434:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 435:    <span style='color:#800000; font-weight:bold; '>my</span> $tbl <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span>most_recent<span style='color:#808030; '>(</span>$CFG<span style='color:#800080; '>{</span>BUILD_NEW_CUTOFF<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> 
 436:    <span style='color:#800000; font-weight:bold; '>my</span> %cats<span style='color:#800080; '>;</span>
 437:    <span style='color:#800000; font-weight:bold; '>while</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> $row <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span> @$tbl<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 438:       <span style='color:#800000; font-weight:bold; '>push</span> @{ $cats<span style='color:#800080; '>{</span> $row<span style='color:#808030; '>-></span><span style='color:#808030; '>[</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>]</span> <span style='color:#800080; '>}</span> }<span style='color:#808030; '>,</span> $row<span style='color:#808030; '>-></span><span style='color:#808030; '>[</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>]</span>
 439:    <span style='color:#800080; '>}</span>
 440: 
 441:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>@tmpl_cats<span style='color:#808030; '>,</span>$cut_off<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 442:    <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $cat_id <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>keys</span> %cats<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 443:       <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$cat_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 444:       <span style='color:#800000; font-weight:bold; '>my</span> %cat <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>multi_link<span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $cat<span style='color:#808030; '>-></span>name<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'multi_link'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 445:       <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $item_id <span style='color:#808030; '>(</span>@{ $cats<span style='color:#800080; '>{</span>$cat_id<span style='color:#800080; '>}</span> }<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 446:      $cut_off<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#800080; '>;</span>
 447:      <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$item_id<span style='color:#808030; '>,</span>category_id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$cat_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 448:      $cat<span style='color:#800080; '>{</span>items<span style='color:#800080; '>}</span> <span style='color:#808030; '>.</span><span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"&lt;LI>"</span><span style='color:#808030; '>.</span>$item<span style='color:#808030; '>-></span>output_html<span style='color:#808030; '>(</span>date_added<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>    
 449:       <span style='color:#800080; '>}</span>    
 450:       <span style='color:#800000; font-weight:bold; '>push</span> @tmpl_cats<span style='color:#808030; '>,</span> <span style='color:#808030; '>\</span>%cat<span style='color:#800080; '>;</span>
 451:    <span style='color:#800080; '>}</span>
 452:     
 453:    <span style='color:#800000; font-weight:bold; '>my</span> $tmpl <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'whats-new.tmpl'</span> <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 454:   
 455:    $tmpl<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 456:         whats_new            <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#808030; '>\</span>@tmpl_cats<span style='color:#808030; '>,</span>
 457:         cutoff                <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $cut_off<span style='color:#808030; '>,</span>
 458:         page_title            <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'What</span><span style='color:#0f69ff; '>\'</span><span style='color:#0000e6; '>s New'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 459:         <span style='color:#808030; '>&amp;</span>footer_html_tmpl
 460:            <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 461:   
 462:    <span style='color:#800000; font-weight:bold; '>return</span> $tmpl<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
 463: <span style='color:#800080; '>}</span>
 464: 
 465: <span style='color:#800000; font-weight:bold; '>sub </span>historical_month_index <span style='color:#800080; '>{</span>
 466:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 467:    <span style='color:#696969; '># default to the current month </span>
 468:    <span style='color:#800000; font-weight:bold; '>my</span> $month <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> $FORM<span style='color:#800080; '>{</span>historical_month<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span> 
 469:    <span style='color:#696969; '># If nothing was passed in directly or in the form, this is the default view. </span>
 470:    <span style='color:#800000; font-weight:bold; '>my</span> $default<span style='color:#800080; '>;</span>
 471:    <span style='color:#800000; font-weight:bold; '>unless</span> <span style='color:#808030; '>(</span>$month<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 472:       $default <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
 473:       $month <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"SELECT date_trunc('month',CURRENT_DATE)"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 474:    <span style='color:#800080; '>}</span>
 475:    $month <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>quote<span style='color:#808030; '>(</span>$month<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 476: 
 477:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'historical-month-index.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 478: 
 479:    <span style='color:#696969; '># get all the item_ids for a month</span>
 480:    <span style='color:#800000; font-weight:bold; '>my</span> $items <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectcol_arrayref<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"select </span>
 481: <span style='color:#0000e6; '>    item_id </span>
 482: <span style='color:#0000e6; '>    from cas_item_approved</span>
 483: <span style='color:#0000e6; '>        WHERE date_trunc('month',COALESCE(historical_date,approved_date,insert_date)) =</span>
 484: <span style='color:#0000e6; '>            date_trunc('month',CAST(</span><span style='color:#0000e6; '>$month</span><span style='color:#0000e6; '> AS DATE))</span>
 485: <span style='color:#0000e6; '>        ORDER BY COALESCE(historical_date,approved_date,insert_date) DESC "</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 486: 
 487:    <span style='color:#800000; font-weight:bold; '>my</span> $prev_month <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 488: <span style='color:#0000e6; '>        SELECT  date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date</span>
 489: <span style='color:#0000e6; '>    as previous_month</span>
 490: <span style='color:#0000e6; '>    FROM cas_item_approved</span>
 491: <span style='color:#0000e6; '>    WHERE date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date </span>
 492: <span style='color:#0000e6; '>        &lt; date_trunc('month',CAST(</span><span style='color:#0000e6; '>$month</span><span style='color:#0000e6; '> AS DATE))</span>
 493: <span style='color:#0000e6; '>    ORDER BY date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date DESC</span>
 494: <span style='color:#0000e6; '>    LIMIT </span><span style='color:#008c00; '>1</span><span style='color:#0000e6; '>"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 495: 
 496:    <span style='color:#696969; '># If there are no items in the default month,</span>
 497:    <span style='color:#696969; '># and there are in the previous month, return that instead. </span>
 498:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>not</span> <span style='color:#800000; font-weight:bold; '>scalar</span> @$items<span style='color:#808030; '>)</span> <span style='color:#808030; '>and</span> $prev_month <span style='color:#808030; '>and</span> $default<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 499:       <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>historical_month_index<span style='color:#808030; '>(</span>$prev_month<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 500:    <span style='color:#800080; '>}</span>
 501: 
 502:    <span style='color:#800000; font-weight:bold; '>my</span> @entries<span style='color:#800080; '>;</span>
 503:    <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span>@$items<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 504:       <span style='color:#696969; '># We use static mode here because currently the edit link won't work because</span>
 505:       <span style='color:#696969; '># we are requiring a category_id at the moment. -mls</span>
 506:        <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$_<span style='color:#808030; '>,</span>mode<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'static'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 507:     <span style='color:#800000; font-weight:bold; '>push</span> @entries<span style='color:#808030; '>,</span> <span style='color:#800080; '>{</span> <span style='color:#0000e6; '>'item_html'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $item<span style='color:#808030; '>-></span>output_html<span style='color:#808030; '>(</span>date_added<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 508:    <span style='color:#800080; '>}</span>
 509:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span> prev_month   <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $prev_month<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 510:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 511:       next_month   <span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 512: <span style='color:#0000e6; '>        SELECT  date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date</span>
 513: <span style='color:#0000e6; '>    as next_month</span>
 514: <span style='color:#0000e6; '>    FROM cas_item_approved</span>
 515: <span style='color:#0000e6; '>    WHERE date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date </span>
 516: <span style='color:#0000e6; '>        > date_trunc('month',CAST(</span><span style='color:#0000e6; '>$month</span><span style='color:#0000e6; '> AS DATE))</span>
 517: <span style='color:#0000e6; '>    ORDER BY date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date ASC</span>
 518: <span style='color:#0000e6; '>    LIMIT </span><span style='color:#008c00; '>1</span><span style='color:#0000e6; '> "</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 519:      
 520:       <span style='color:#800000; font-weight:bold; '>my</span> $mode <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'static'</span> <span style='color:#800000; font-weight:bold; '>unless</span> $CFG<span style='color:#800080; '>{</span>DYNAMIC_ONLY_P<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 521:      $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 522:       month_as_text<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 523: <span style='color:#0000e6; '>        SELECT to_char(CAST(</span><span style='color:#0000e6; '>$month</span><span style='color:#0000e6; '> AS DATE), 'FMMonth, YYYY') "</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 524:        entries<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#808030; '>\</span>@entries<span style='color:#808030; '>,</span>
 525:       footer_html_tmpl<span style='color:#808030; '>(</span>$mode<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 526:      <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>    
 527:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
 528: <span style='color:#800080; '>}</span>
 529: 
 530: <span style='color:#696969; '># display historical index of all data. Pass in a year</span>
 531: <span style='color:#696969; '># directly or through the FORM to view just one year. -mls </span>
 532: <span style='color:#800000; font-weight:bold; '>sub </span>historical_all_index <span style='color:#800080; '>{</span>
 533:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 534:    <span style='color:#800000; font-weight:bold; '>my</span> %in <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>
 535:       year <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $FORM<span style='color:#800080; '>{</span>year<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
 536:       @_<span style='color:#808030; '>,</span>
 537:      <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 538:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'historical-all-index.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 539: 
 540:    <span style='color:#800000; font-weight:bold; '>my</span> $LoH <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectall_arrayref<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"select </span>
 541: <span style='color:#0000e6; '>    extract(year from COALESCE(historical_date,approved_date,insert_date)::date) as year,</span>
 542: <span style='color:#0000e6; '>    to_char( COALESCE(historical_date,approved_date,insert_date)::date, 'FMMonth, YYYY') as month_as_text,</span>
 543: <span style='color:#0000e6; '>     date_trunc('month',COALESCE(historical_date,approved_date,insert_date))::date as month_as_date,</span>
 544: <span style='color:#0000e6; '>    count(item_id) as items_in_month</span>
 545: <span style='color:#0000e6; '>    from cas_item_approved "</span><span style='color:#808030; '>.</span>
 546:         <span style='color:#808030; '>(</span>$in<span style='color:#800080; '>{</span>year<span style='color:#800080; '>}</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> 
 547:        <span style='color:#0000e6; '>"WHERE extract(year from COALESCE(historical_date,approved_date,insert_date)::date) = "</span><span style='color:#808030; '>.</span>$DBH<span style='color:#808030; '>-></span>quote<span style='color:#808030; '>(</span>$in<span style='color:#800080; '>{</span>year<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>"</span>
 548: <span style='color:#0000e6; '>      GROUP BY year,month_as_text, month_as_date</span>
 549: <span style='color:#0000e6; '>      ORDER BY  month_as_date ASC"</span><span style='color:#808030; '>,</span> <span style='color:#800080; '>{</span> Slice <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#800080; '>{</span><span style='color:#800080; '>}</span> <span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 550: 
 551:    <span style='color:#800000; font-weight:bold; '>my</span> %years<span style='color:#800080; '>;</span>
 552:    <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span>@$LoH<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 553:       <span style='color:#800000; font-weight:bold; '>my</span> $y <span style='color:#808030; '>=</span> $_<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>year<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 554:       $years<span style='color:#800080; '>{</span>$y<span style='color:#800080; '>}</span><span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>year<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> $y<span style='color:#800080; '>;</span>
 555:       $_<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>one_entry<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$_<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>items_in_month<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 556:       <span style='color:#696969; '># add the global we need inside this loop</span>
 557:       $_<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>cfg_cascade_cgi<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> $CFG<span style='color:#800080; '>{</span>CASCADE_CGI<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 558:       <span style='color:#800000; font-weight:bold; '>push</span> @{ $years<span style='color:#800080; '>{</span>$y<span style='color:#800080; '>}</span><span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>months<span style='color:#800080; '>}</span> }<span style='color:#808030; '>,</span> $_<span style='color:#800080; '>;</span>
 559:    <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 560: 
 561:    <span style='color:#696969; '># If we are not in "dynamic only" mode, we want to show static links in the footer here.</span>
 562:    <span style='color:#800000; font-weight:bold; '>my</span> $mode <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'static'</span> <span style='color:#800000; font-weight:bold; '>unless</span> $CFG<span style='color:#800080; '>{</span>DYNAMIC_ONLY_P<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 563:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 564:       page_title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>"Historical View of </span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{SYSTEM_NAME}"</span><span style='color:#808030; '>,</span>
 565:       footer_html_tmpl<span style='color:#808030; '>(</span>$mode<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 566:     <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 567:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>years<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#808030; '>[</span><span style='color:#800000; font-weight:bold; '>sort</span> <span style='color:#800080; '>{</span> $b<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>year<span style='color:#800080; '>}</span> <span style='color:#40015a; '>&lt;=></span> $a<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>year<span style='color:#800080; '>}</span> <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>values</span> %years <span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 568:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
 569: <span style='color:#800080; '>}</span>
 570: 
 571: <span style='color:#800000; font-weight:bold; '>sub </span>search_zip <span style='color:#800080; '>{</span>
 572:   <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 573: 
 574:   <span style='color:#696969; '># default to 50 miles. -mls</span>
 575:   <span style='color:#696969; '># XXX another candidate for moving to the config file</span>
 576:   <span style='color:#800000; font-weight:bold; '>my</span> $radius <span style='color:#808030; '>=</span> $FORM<span style='color:#800080; '>{</span><span style='color:#0000e6; '>'distance'</span><span style='color:#800080; '>}</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> <span style='color:#008c00; '>50</span><span style='color:#800080; '>;</span> 
 577: 
 578:   <span style='color:#696969; '># Convert kilometers to miles if needed</span>
 579:   <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>units<span style='color:#800080; '>}</span> <span style='color:#808030; '>eq</span> <span style='color:#0000e6; '>'kilometers'</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 580:     $radius *= <span style='color:#008c00; '>.62140</span><span style='color:#800080; '>;</span>
 581:   <span style='color:#800080; '>}</span>
 582: 
 583:   <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span><span style='color:#0000e6; '>'zipcode'</span><span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>m</span><span style='color:#800000; '>/</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>\d</span><span style='color:#0000e6; '>\d</span><span style='color:#0000e6; '>\d</span><span style='color:#0000e6; '>\d</span><span style='color:#0000e6; '>\d</span><span style='color:#808030; '>$</span><span style='color:#800000; '>/</span> <span style='color:#808030; '>)</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span>
 584:     <span style='color:#808030; '>(</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span><span style='color:#0000e6; '>'city'</span><span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span><span style='color:#0000e6; '> </span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>\w</span><span style='color:#800000; '>/</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span><span style='color:#0000e6; '>'st'</span><span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span><span style='color:#0000e6; '> </span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>\w</span><span style='color:#800000; '>/</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>)</span> <span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 585:      <span style='color:#696969; '># We trim off the first 28 characters of the city because</span>
 586:      <span style='color:#696969; '># that's all that's in my zipcode database -mls</span>
 587:      <span style='color:#696969; '># Find all the zipcodes that have a close enough latitude or</span>
 588:      <span style='color:#696969; '># longitude</span>
 589:      <span style='color:#696969; '># it's important to join on the item table-- this speeds thing up</span>
 590:      <span style='color:#696969; '># A LOT In a less sophicated database (like MySQL), you could</span>
 591:      <span style='color:#696969; '># accomplish the same thing with 3 seperate selects</span>
 592:      <span style='color:#696969; '># If you are here to think about making this work for another</span>
 593:      <span style='color:#696969; '># database, note that I'm doing a number of functions in the</span>
 594:      <span style='color:#696969; '># database (substr,trim,upper), which are probably better done in</span>
 595:      <span style='color:#696969; '># Perl to be more portable.</span>
 596:     $DBH<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>RaiseError<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
 597:    <span style='color:#800000; font-weight:bold; '>my</span> $items<span style='color:#800080; '>;</span>
 598:     <span style='color:#800000; font-weight:bold; '>eval</span> <span style='color:#800080; '>{</span>
 599:        <span style='color:#800000; font-weight:bold; '>my</span> $matching_point <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 600: <span style='color:#0000e6; '>        SELECT lon_lat </span>
 601: <span style='color:#0000e6; '>      FROM cas_zipcodes zipcodes</span>
 602: <span style='color:#0000e6; '>          WHERE zipcode = trim("</span><span style='color:#808030; '>.</span>$DBH<span style='color:#808030; '>-></span>quote<span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>zipcode<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>")</span>
 603: <span style='color:#0000e6; '>        OR (city = substring(upper(trim("</span><span style='color:#808030; '>.</span>$DBH<span style='color:#808030; '>-></span>quote<span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>city<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>")) from </span><span style='color:#008c00; '>1</span><span style='color:#0000e6; '> for </span><span style='color:#008c00; '>28</span><span style='color:#0000e6; '>) </span>
 604: <span style='color:#0000e6; '>            AND state_code = upper("</span><span style='color:#808030; '>.</span>$DBH<span style='color:#808030; '>-></span>quote<span style='color:#808030; '>(</span> $FORM<span style='color:#800080; '>{</span>st<span style='color:#800080; '>}</span> <span style='color:#808030; '>)</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>"))"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 605:        $matching_point <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#800000; font-weight:bold; '>undef</span><span style='color:#800080; '>;</span>
 606:     $items <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectall_arrayref<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 607: <span style='color:#0000e6; '>SELECT item.*,category_id </span>
 608: <span style='color:#0000e6; '> FROM cas_item item, cas_category_item_map category_item_map</span>
 609: <span style='color:#0000e6; '> WHERE item.item_id = category_item_map.item_id </span>
 610: <span style='color:#0000e6; '>   AND postal_code IN (</span>
 611: <span style='color:#0000e6; '> SELECT distinct zipcode FROM cas_zipcodes zipcodes</span>
 612: <span style='color:#0000e6; '>   WHERE item.postal_code = zipcodes.zipcode</span>
 613: <span style='color:#0000e6; '>     AND (?::point &lt;@> lon_lat ) &lt; ? ) "</span><span style='color:#808030; '>,</span>
 614:     <span style='color:#800080; '>{</span>  Slice<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span> <span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
 615:         $matching_point<span style='color:#808030; '>,</span> $radius
 616:        <span style='color:#808030; '>)</span>
 617:       <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'No Results'</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Your search returned no results'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 618:     <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 619:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$@<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 620:        err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Database Error'</span><span style='color:#808030; '>,</span>
 621:        msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'There was a database error when searching. This error has been logged.'</span><span style='color:#808030; '>)</span>
 622:     <span style='color:#800080; '>}</span>
 623:     <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
 624:        <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>search_results<span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>undef</span><span style='color:#808030; '>,</span>$items<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 625:     <span style='color:#800080; '>}</span>
 626:   <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
 627:     <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>TITLE <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'Missing Fields'</span><span style='color:#808030; '>,</span> MSG <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#800000; font-weight:bold; '>q</span><span style='color:#800000; '>{</span><span style='color:#0000e6; '>You Must specify a city and state or a zipcode to search. That's the breaks. </span><span style='color:#800000; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 628:   <span style='color:#800080; '>}</span>
 629: <span style='color:#800080; '>}</span>
 630: 
 631: 
 632: <span style='color:#800000; font-weight:bold; '>sub </span>search_results  <span style='color:#800080; '>{</span>
 633:   <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 634:   <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$cat_ref<span style='color:#808030; '>,</span> $item_ref<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @_<span style='color:#800080; '>;</span>
 635: 
 636:  <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'No matches found'</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'No results were found matching your query'</span><span style='color:#808030; '>)</span> 
 637:    <span style='color:#800000; font-weight:bold; '>unless</span> <span style='color:#808030; '>(</span>$item_ref <span style='color:#808030; '>or</span> $cat_ref<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 638:     
 639:   <span style='color:#800000; font-weight:bold; '>my</span> @cats<span style='color:#800080; '>;</span>
 640:   <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $row <span style='color:#808030; '>(</span>@$cat_ref<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 641:     <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$id<span style='color:#808030; '>,</span> $name<span style='color:#808030; '>,</span> $desc<span style='color:#808030; '>,</span> $items_below<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @$row<span style='color:#800080; '>;</span>
 642:     <span style='color:#800000; font-weight:bold; '>my</span>  $cat <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$id<span style='color:#808030; '>,</span>populate<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 643:     <span style='color:#800000; font-weight:bold; '>push</span> @cats<span style='color:#808030; '>,</span> <span style='color:#800080; '>{</span> 
 644:       name         <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $cat<span style='color:#808030; '>-></span>relative<span style='color:#808030; '>(</span>$name<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 645:       items_below <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $items_below<span style='color:#808030; '>,</span>
 646:       description    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $desc
 647:      <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>    
 648:   <span style='color:#800080; '>}</span>                 
 649:                       
 650:   <span style='color:#800000; font-weight:bold; '>my</span> @items<span style='color:#800080; '>;</span>
 651:   <span style='color:#696969; '># Note: I changed how this worked around 1.3.8</span>
 652:   <span style='color:#696969; '># instead of passing in an array of item ids, we are now passing in</span>
 653:   <span style='color:#696969; '># an array of hash references with item data</span>
 654:   <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $item_ref <span style='color:#808030; '>(</span>@$item_ref<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 655:     <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$item_ref<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>id<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>data<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$item_ref<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 656:     <span style='color:#800000; font-weight:bold; '>push</span> @items<span style='color:#808030; '>,</span> $item<span style='color:#808030; '>-></span>output_html<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 657:   <span style='color:#800080; '>}</span>
 658:     
 659:     <span style='color:#800000; font-weight:bold; '>my</span> $tmpl <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'search-results.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 660:           
 661:     $tmpl<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 662:       cats                <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#808030; '>\</span>@cats<span style='color:#808030; '>,</span>
 663:       items                <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#bb7977; font-weight:bold; '>CGI</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>li</span><span style='color:#808030; '>(</span><span style='color:#808030; '>[</span>@items<span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 664:       <span style='color:#808030; '>&amp;</span>footer_html_tmpl
 665:      <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 666: 
 667:     <span style='color:#800000; font-weight:bold; '>return</span> $tmpl<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
 668: <span style='color:#800080; '>}</span>    
 669: 
 670: <span style='color:#800000; font-weight:bold; '>sub </span>illegal_chars <span style='color:#800080; '>{</span>
 671:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span><span style='color:#0000e6; '>'name'</span><span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>m</span><span style='color:#800000; '>/</span><span style='color:#808030; '>(</span><span style='color:#808030; '>[</span><span style='color:#0000e6; '>_</span><span style='color:#808030; '>]</span><span style='color:#808030; '>)</span><span style='color:#800000; '>/</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 672:     <span style='color:#800000; font-weight:bold; '>my</span> $msg <span style='color:#808030; '>=</span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Your Name contained the illegal character"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>
 673:         <span style='color:#0000e6; '>" &lt;B></span><span style='color:#0000e6; '>$1</span><span style='color:#0000e6; '>&lt;/B>. "</span><span style='color:#808030; '>.</span>gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Go back and try again."</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 674:     <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Illegal Character"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> msg <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $msg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 675:      <span style='color:#800080; '>}</span>
 676: 
 677: <span style='color:#800080; '>}</span>
 678: 
 679: <span style='color:#696969; '># check to  see if a category already exists</span>
 680: <span style='color:#800000; font-weight:bold; '>sub </span>cat_already_exists <span style='color:#800080; '>{</span>
 681:     <span style='color:#696969; '># If they pass in a $cat_id, we assume this check is for an edit,</span>
 682:     <span style='color:#696969; '># otherwise we assume it's for an addition. If we have it's</span>
 683:     <span style='color:#696969; '># $cat_id, we can make sure it doesn't show up falsely as a</span>
 684:     <span style='color:#696969; '># duplicate of itself. -mls</span>
 685:     <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$name<span style='color:#808030; '>,</span>$parent_id<span style='color:#808030; '>,</span>$cat_id<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @_<span style='color:#800080; '>;</span>
 686:     <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>length</span> $name <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#800000; font-weight:bold; '>length</span> $parent_id<span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>die</span> <span style='color:#0000e6; '>"no category name and parent_id found"</span><span style='color:#800080; '>;</span> 
 687: 
 688:     <span style='color:#800000; font-weight:bold; '>my</span> @bind <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>lc</span> $name<span style='color:#808030; '>,</span> $parent_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 689:     <span style='color:#800000; font-weight:bold; '>my</span> $sql <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"select category_id from cas_category</span>
 690: <span style='color:#0000e6; '>      where lower(name) =  ?</span>
 691: <span style='color:#0000e6; '>      and   parent_id = ? "</span><span style='color:#800080; '>;</span>
 692:       <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>length</span> $cat_id<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 693:         <span style='color:#800000; font-weight:bold; '>push</span> @bind<span style='color:#808030; '>,</span> $cat_id<span style='color:#800080; '>;</span>
 694:         $sql <span style='color:#808030; '>.</span><span style='color:#808030; '>=</span> <span style='color:#0000e6; '>" category_id &lt;> ? "</span><span style='color:#800080; '>;</span>
 695:     <span style='color:#800080; '>}</span>
 696: 
 697:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>defined</span> $cat_id<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 698:          <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$cat_id<span style='color:#808030; '>,</span> mode<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'dynamic'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 699:          <span style='color:#800000; font-weight:bold; '>my</span> $msg <span style='color:#808030; '>=</span>  gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"The Category you have submitted "</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>
 700:              gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"is already in our database"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span> <span style='color:#0000e6; '>':&lt;P>'</span><span style='color:#808030; '>.</span>$cat<span style='color:#808030; '>-></span>name<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'plain'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>'&lt;P>'</span><span style='color:#808030; '>.</span>
 701:                  gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Try another!"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>    
 702:          <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Category Exists"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> msg <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $msg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 703:     <span style='color:#800080; '>}</span>                              
 704: <span style='color:#800080; '>}</span>
 705: 
 706: <span style='color:#696969; '># This tests for the case in which the category maps to directory name which is the same as an existing category</span>
 707: <span style='color:#800000; font-weight:bold; '>sub </span>conflicts_with_existing_cat <span style='color:#800080; '>{</span>
 708:     <span style='color:#800000; font-weight:bold; '>my</span> $name <span style='color:#808030; '>=</span> $FORM<span style='color:#800080; '>{</span>name<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 709: 
 710:     <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#800080; '>;</span>
 711:     <span style='color:#800000; font-weight:bold; '>my</span> $enc_name <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span>encode_name<span style='color:#808030; '>(</span>$name<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 712: 
 713:     <span style='color:#800000; font-weight:bold; '>length</span> $FORM<span style='color:#800080; '>{</span>category_id<span style='color:#800080; '>}</span> <span style='color:#808030; '>and</span> <span style='color:#800000; font-weight:bold; '>length</span> $FORM<span style='color:#800080; '>{</span>parent_id<span style='color:#800080; '>}</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#800000; font-weight:bold; '>undef</span><span style='color:#800080; '>;</span>
 714:     <span style='color:#800000; font-weight:bold; '>my</span> $tbl <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectall_arrayref<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 715: <span style='color:#0000e6; '>        SELECT category_id, name</span>
 716: <span style='color:#0000e6; '>            FROM cas_category</span>
 717: <span style='color:#0000e6; '>            WHERE parent_id = ?</span>
 718: <span style='color:#0000e6; '>                AND category_id != ?</span>
 719: <span style='color:#0000e6; '>    "</span><span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$FORM<span style='color:#800080; '>{</span>parent_id<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$FORM<span style='color:#800080; '>{</span>category_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 720:     
 721:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$tbl<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 722:         <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $row <span style='color:#808030; '>(</span>@$tbl<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 723:             <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$cat_id<span style='color:#808030; '>,</span> $name<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @$row<span style='color:#800080; '>;</span>
 724:             $name <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span>encode_name<span style='color:#808030; '>(</span>$name<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 725:             <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>lc</span> $name<span style='color:#808030; '>)</span> <span style='color:#808030; '>eq</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>lc</span> $enc_name<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 726:                 <span style='color:#800000; font-weight:bold; '>my</span> $msg <span style='color:#808030; '>=</span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"The Category you have submitted "</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>
 727:                     gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"conflicts with a pre-existing one named &lt;B></span><span style='color:#0000e6; '>$name</span><span style='color:#0000e6; '>&lt;/B>"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>
 728:                     <span style='color:#0000e6; '>'&lt;P>'</span><span style='color:#808030; '>.</span>gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Try another!"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 729:                 <span style='color:#800000; font-weight:bold; '>return</span>     err<span style='color:#808030; '>(</span>title <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Category Conflict"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> msg <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $msg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>    
 730:             <span style='color:#800080; '>}</span> 
 731:         <span style='color:#800080; '>}</span>
 732:     <span style='color:#800080; '>}</span>
 733: <span style='color:#800080; '>}</span>
 734: 
 735: <span style='color:#696969; '># is the user logged in as one of the passed in roles?</span>
 736: <span style='color:#696969; '># takes array of roles as input</span>
 737: <span style='color:#800000; font-weight:bold; '>sub </span>is_role <span style='color:#800080; '>{</span>
 738:    <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> @roles <span style='color:#808030; '>=</span> @_<span style='color:#808030; '>)</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#800000; font-weight:bold; '>undef</span><span style='color:#800080; '>;</span>
 739:     
 740:    <span style='color:#800000; font-weight:bold; '>my</span> $user_id <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 741: <span style='color:#0000e6; '>        SELECT user_id </span>
 742: <span style='color:#0000e6; '>        FROM cas_users</span>
 743: <span style='color:#0000e6; '>        WHERE role in  ("</span><span style='color:#808030; '>.</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>join</span> <span style='color:#0000e6; '>','</span><span style='color:#808030; '>,</span><span style='color:#800000; font-weight:bold; '>map</span> <span style='color:#800080; '>{</span> $DBH<span style='color:#808030; '>-></span>quote<span style='color:#808030; '>(</span>$_<span style='color:#808030; '>)</span> <span style='color:#800080; '>}</span> @roles<span style='color:#808030; '>)</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>")</span>
 744: <span style='color:#0000e6; '>            AND user_id = ?</span>
 745: <span style='color:#0000e6; '>    "</span><span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$SES<span style='color:#800080; '>{</span>user_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>    
 746:    <span style='color:#800000; font-weight:bold; '>return</span> $user_id<span style='color:#800080; '>;</span>
 747: <span style='color:#800080; '>}</span>
 748: 
 749: <span style='color:#800000; font-weight:bold; '>sub </span>item_id_from_title <span style='color:#800080; '>{</span>
 750:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$title<span style='color:#808030; '>,</span>$cat_id<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @_<span style='color:#800080; '>;</span>
 751:    $title <span style='color:#808030; '>and</span> $cat_id <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#800000; font-weight:bold; '>undef</span><span style='color:#800080; '>;</span>
 752:    <span style='color:#696969; '># strip leading and trailing new lines and spaces to make the form more copy/paste friendly</span>
 753:    $title <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>s</span><span style='color:#800000; '>/</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>\s</span><span style='color:#808030; '>+</span><span style='color:#800080; '>|</span><span style='color:#808030; '>[</span><span style='color:#0f69ff; '>\n</span><span style='color:#0f69ff; '>\r</span><span style='color:#0000e6; '>\s</span><span style='color:#808030; '>]</span><span style='color:#808030; '>+</span><span style='color:#808030; '>$</span><span style='color:#800000; '>/</span><span style='color:#800000; '>/</span><span style='color:#800080; '>;</span>
 754: 
 755:    <span style='color:#800000; font-weight:bold; '>return</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 756: <span style='color:#0000e6; '>        SELECT item.item_id </span>
 757: <span style='color:#0000e6; '>            FROM cas_item item, cas_category_item_map category_item_map</span>
 758: <span style='color:#0000e6; '>            WHERE lower(title) = ?</span>
 759: <span style='color:#0000e6; '>                AND item.item_id = category_item_map.item_id</span>
 760: <span style='color:#0000e6; '>                AND category_item_map.category_id = ? "</span><span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
 761:             <span style='color:#800000; font-weight:bold; '>lc</span> $title<span style='color:#808030; '>,</span> $cat_id
 762:         <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>     
 763: <span style='color:#800080; '>}</span>
 764: 
 765: 
 766: 
 767: <span style='color:#696969; '># prepare the content used in the html footer</span>
 768: <span style='color:#800000; font-weight:bold; '>sub </span>footer_html_tmpl <span style='color:#800080; '>{</span>
 769:    <span style='color:#800000; font-weight:bold; '>my</span> $mode <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 770:      <span style='color:#800000; font-weight:bold; '>my</span> %footer <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>
 771:          footer_cats                 <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>-></span>footer_cats<span style='color:#808030; '>(</span>$mode<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 772:         version                <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $CFG<span style='color:#800080; '>{</span>VERSION<span style='color:#800080; '>}</span>
 773:      <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 774:      <span style='color:#800000; font-weight:bold; '>return</span> %footer<span style='color:#800080; '>;</span>
 775: <span style='color:#800080; '>}</span>
 776: 
 777: <span style='color:#800000; font-weight:bold; '>sub </span>front_page <span style='color:#800080; '>{</span>
 778:   <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 779:   <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 780: 
 781:   <span style='color:#696969; '># If we are in static mode, we just redirect and we're done</span>
 782:   <span style='color:#800000; font-weight:bold; '>my</span> $user_id<span style='color:#800080; '>;</span>
 783:   <span style='color:#696969; '># I don't remember why I set max_includes to be 5. -mls </span>
 784:   <span style='color:#800000; font-weight:bold; '>my</span> $tmpl <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'front-page.tmpl'</span><span style='color:#808030; '>,</span> max_includes<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#008c00; '>5</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 785: 
 786: 
 787:   <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$total_states<span style='color:#808030; '>,</span> $total_countries<span style='color:#808030; '>,</span> $total_resources<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 788:     <span style='color:#808030; '>(</span>$total_states<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 789: <span style='color:#0000e6; '>        SELECT count(distinct state) FROM cas_item WHERE state is not null and approval_state = 'approved' "</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 790: 
 791:     <span style='color:#808030; '>(</span>$total_countries<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 792: <span style='color:#0000e6; '>        SELECT count(distinct country) FROM cas_item WHERE country is not null and approval_state = 'approved' "</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 793: 
 794:     <span style='color:#808030; '>(</span>$total_resources<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 795: <span style='color:#0000e6; '>        SELECT count(*) FROM cas_item where approval_state = 'approved' "</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 796: 
 797:  <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$suggested_inserts<span style='color:#808030; '>,</span>$suggested_updates<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 798:   <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$SES<span style='color:#800080; '>{</span>role_admin<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 799:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$CFG<span style='color:#800080; '>{</span>DISPLAY_SUGGESTION_LINKS_P<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 800:       <span style='color:#808030; '>(</span>$suggested_inserts<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 801: <span style='color:#0000e6; '>         SELECT count(item.item_id)</span>
 802: <span style='color:#0000e6; '>            FROM cas_item item, cas_category_item_map category_item_map</span>
 803: <span style='color:#0000e6; '>            WHERE item.item_id = category_item_map.item_id AND item.approval_state = 'needs_approval'"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 804:       <span style='color:#808030; '>(</span>$suggested_updates<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 805: <span style='color:#0000e6; '>         SELECT count(item_update_id) FROM cas_item_suggested_updates"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 806:     <span style='color:#800080; '>}</span>
 807:     $tmpl<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span> any_links_verified <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> 
 808:         $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 809: <span style='color:#0000e6; '>                SELECT item_id FROM cas_item WHERE url_verified_date is not null LIMIT </span><span style='color:#008c00; '>1</span><span style='color:#0000e6; '>"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 810:     $tmpl<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span> num_links_appear_stale <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> 
 811:         $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
 812: <span style='color:#0000e6; '>        SELECT count(item_id) FROM cas_item</span>
 813: <span style='color:#0000e6; '>            WHERE url like 'http%' </span>
 814: <span style='color:#0000e6; '>            AND</span>
 815: <span style='color:#0000e6; '>             ( url_verified_date is null )</span>
 816: <span style='color:#0000e6; '>               OR</span>
 817: <span style='color:#0000e6; '>             ( url_verified_date &lt; (CURRENT_DATE - '</span><span style='color:#008c00; '>30</span><span style='color:#0000e6; '> days'::interval)::date</span>
 818: <span style='color:#0000e6; '>                   AND url_verified_date is not null )"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 819:    <span style='color:#800080; '>}</span>
 820:     <span style='color:#696969; '># XXX editors will need their own select statement here</span>
 821:   
 822:   <span style='color:#800000; font-weight:bold; '>my</span> $subcats <span style='color:#808030; '>=</span> $cat<span style='color:#808030; '>-></span>sub_cats<span style='color:#800080; '>;</span> 
 823:   <span style='color:#800000; font-weight:bold; '>for</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> $i <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span> $i <span style='color:#808030; '>&lt;</span> @$subcats<span style='color:#800080; '>;</span> $i<span style='color:#808030; '>+</span><span style='color:#808030; '>+</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 824:      <span style='color:#696969; '># create a new category object</span>
 825:      <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> new <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span> <span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $subcats<span style='color:#808030; '>-></span><span style='color:#808030; '>[</span>$i<span style='color:#808030; '>]</span><span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>cat_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>        
 826:      <span style='color:#696969; '># get the subsubcats for this subcat, if any</span>
 827:      $subcats<span style='color:#808030; '>-></span><span style='color:#808030; '>[</span>$i<span style='color:#808030; '>]</span><span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>subcats<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> $cat<span style='color:#808030; '>-></span>sub_cats<span style='color:#808030; '>(</span>include_items_below<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 828:   <span style='color:#800080; '>}</span>
 829:  
 830:   <span style='color:#696969; '># handle the "new items"</span>
 831:   <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$new_cutoff<span style='color:#808030; '>,</span>@new_items<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 832:   <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> $tbl <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span>most_recent<span style='color:#808030; '>(</span>$CFG<span style='color:#800080; '>{</span>FRONT_PAGE_NEW_CUTOFF<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 833:   <span style='color:#696969; '># You may wonder why we bother computing the cutoff here when we have it already in a config variable</span>
 834:   <span style='color:#696969; '># If the config variable says 10, and there are are only 9 items, this will correctly display "9"</span>
 835:   <span style='color:#696969; '># Instead of announcing there are 10 items when there aren't. -mls</span>
 836:      $new_cutoff <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>@$tbl <span style='color:#808030; '>&lt;</span> $CFG<span style='color:#800080; '>{</span>FRONT_PAGE_NEW_CUTOFF<span style='color:#800080; '>}</span> <span style='color:#808030; '>)</span> 
 837:        <span style='color:#808030; '>?</span> <span style='color:#800000; font-weight:bold; '>scalar</span> @$tbl
 838:      <span style='color:#808030; '>:</span> $CFG<span style='color:#800080; '>{</span>FRONT_PAGE_NEW_CUTOFF<span style='color:#800080; '>}</span> <span style='color:#800080; '>;</span>
 839:      <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $row <span style='color:#808030; '>(</span>@$tbl<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 840:     <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$item_id<span style='color:#808030; '>,</span>$cat_id<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @$row<span style='color:#800080; '>;</span>
 841:     <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$item_id<span style='color:#808030; '>,</span>category_id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$cat_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 842:     <span style='color:#800000; font-weight:bold; '>push</span> @new_items<span style='color:#808030; '>,</span> <span style='color:#800080; '>{</span> item_html <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $item<span style='color:#808030; '>-></span>output_html<span style='color:#808030; '>(</span>style<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'short'</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 843:      <span style='color:#800080; '>}</span>    
 844:   <span style='color:#800080; '>}</span>
 845:      $tmpl<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 846:        new_items        <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#808030; '>\</span>@new_items<span style='color:#808030; '>,</span>
 847:        new_cutoff        <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $new_cutoff<span style='color:#808030; '>,</span>
 848:        suggested_inserts    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $suggested_inserts<span style='color:#808030; '>,</span>
 849:        suggested_updates    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $suggested_updates<span style='color:#808030; '>,</span>
 850:        any_suggestions        <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $suggested_updates<span style='color:#808030; '>+</span>$suggested_inserts<span style='color:#808030; '>,</span>
 851:        sub_cats            <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $subcats<span style='color:#808030; '>,</span>
 852:        role_admin         <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $SES<span style='color:#800080; '>{</span>role_admin<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
 853:          total_resources        <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $total_resources<span style='color:#808030; '>,</span>
 854:          total_states        <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $total_states<span style='color:#808030; '>,</span>
 855:          total_countries        <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $total_countries<span style='color:#808030; '>,</span>
 856:          page_title                <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $CFG<span style='color:#800080; '>{</span>SYSTEM_NAME<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
 857:          states_plural        <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'state'</span><span style='color:#808030; '>.</span><span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>$total_states <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> <span style='color:#0000e6; '>'s'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 858:          countries_plural    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'countr'</span><span style='color:#808030; '>.</span><span style='color:#808030; '>(</span>$total_countries <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span> <span style='color:#808030; '>?</span> <span style='color:#0000e6; '>'y'</span> <span style='color:#808030; '>:</span> <span style='color:#0000e6; '>'ies'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 859:          items                <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $cat<span style='color:#808030; '>-></span>get_item_html<span style='color:#808030; '>,</span>
 860:         whats_new_link        <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{CASCADE_CGI}/historical_month_index"</span><span style='color:#808030; '>,</span>
 861:     <span style='color:#696969; '>#  ($FORM{mode} eq 'static') ? $CFG{WHATS_NEW_URL} : "$CFG{CASCADE_CGI}/historical_month_index",</span>
 862:         <span style='color:#808030; '>&amp;</span>footer_html_tmpl    
 863:      <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 864:   $tmpl<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'display_admin_links'</span><span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>mode<span style='color:#800080; '>}</span> <span style='color:#808030; '>eq</span> <span style='color:#0000e6; '>'dynamic'</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>and</span> $SES<span style='color:#800080; '>{</span>role_admin<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>        
 865:   $self<span style='color:#808030; '>-></span>header_props<span style='color:#808030; '>(</span><span style='color:#808030; '>-</span>expires<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'-3m'</span><span style='color:#808030; '>,</span><span style='color:#808030; '>-</span>type<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'text/html'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 866:   <span style='color:#800000; font-weight:bold; '>return</span> $tmpl<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
 867: <span style='color:#800080; '>}</span>
 868: 
 869: <span style='color:#800000; font-weight:bold; '>sub </span>category_page <span style='color:#800080; '>{</span>
 870:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 871:    <span style='color:#800000; font-weight:bold; '>my</span> $cat_id <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 872:    $cat_id <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>length</span> $cat_id<span style='color:#808030; '>)</span> 
 873:      <span style='color:#808030; '>?</span> $cat_id  
 874:        <span style='color:#808030; '>:</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>length</span> $FORM<span style='color:#800080; '>{</span>category_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> 
 875:      <span style='color:#808030; '>?</span> $FORM<span style='color:#800080; '>{</span>category_id<span style='color:#800080; '>}</span> 
 876:        <span style='color:#808030; '>:</span> $self<span style='color:#808030; '>-></span>check_cat_url<span style='color:#808030; '>(</span>$ENV<span style='color:#800080; '>{</span>PATH_INFO<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 877: 
 878:    <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$cat_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 879: 
 880:    <span style='color:#696969; '># If the category didn't work out, it could be because it was for category that</span>
 881:    <span style='color:#696969; '># has a static page, but doesn't have an entry in the database. </span>
 882:    <span style='color:#696969; '># For that rare case, we return people to the front page by using category_id zero instead. -mls</span>
 883:    <span style='color:#800000; font-weight:bold; '>unless</span> <span style='color:#808030; '>(</span>$cat<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 884:       <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>mode<span style='color:#800080; '>}</span> <span style='color:#808030; '>eq</span> <span style='color:#0000e6; '>'static'</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 885:      $self<span style='color:#808030; '>-></span>header_type<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'redirect'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 886:      $self<span style='color:#808030; '>-></span>header_props<span style='color:#808030; '>(</span><span style='color:#808030; '>-</span>url<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$CFG<span style='color:#800080; '>{</span>HTML_ROOT_URL<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> 
 887:      <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#800080; '>;</span>
 888:       <span style='color:#800080; '>}</span>
 889:       <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
 890:      <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>front_page<span style='color:#800080; '>;</span> 
 891:        <span style='color:#800080; '>}</span>
 892:    <span style='color:#800080; '>}</span>
 893: 
 894:    <span style='color:#696969; '>#if they want a static category, we redirect them</span>
 895:    <span style='color:#696969; '># redirecting the dynamic page would create a loop. -mls</span>
 896:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>mode<span style='color:#800080; '>}</span> <span style='color:#808030; '>eq</span> <span style='color:#0000e6; '>'static'</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 897:        $self<span style='color:#808030; '>-></span>header_type<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'redirect'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 898:        $self<span style='color:#808030; '>-></span>header_props<span style='color:#808030; '>(</span><span style='color:#808030; '>-</span>url<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$cat<span style='color:#808030; '>-></span>name<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'full_url'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> 
 899:    <span style='color:#800080; '>}</span>
 900:    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
 901:        <span style='color:#696969; '># make an exception for the top category</span>
 902:        <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>front_page <span style='color:#800000; font-weight:bold; '>if</span> $cat_id <span style='color:#808030; '>=</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
 903: 
 904:        <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'category.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 905:        $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>$cat<span style='color:#808030; '>-></span>html_page<span style='color:#808030; '>(</span>user_id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$SES<span style='color:#800080; '>{</span>user_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 906:        <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
 907:    <span style='color:#800080; '>}</span>
 908: <span style='color:#800080; '>}</span>
 909: 
 910: <span style='color:#800000; font-weight:bold; '>sub </span>item_add_form <span style='color:#800080; '>{</span>
 911:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 912:    <span style='color:#800000; font-weight:bold; '>my</span> $errs <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 913: 
 914:    <span style='color:#696969; '># If we aren't passed a type_id, we use the default for this category. </span>
 915:    <span style='color:#800000; font-weight:bold; '>my</span> $type_id <span style='color:#808030; '>=</span> $FORM<span style='color:#800080; '>{</span>type_id<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 916:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#808030; '>not</span> <span style='color:#800000; font-weight:bold; '>length</span> $type_id<span style='color:#808030; '>)</span> <span style='color:#808030; '>and</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>length</span> $FORM<span style='color:#800080; '>{</span>category_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 917:       <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$FORM<span style='color:#800080; '>{</span>category_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 918:       $type_id <span style='color:#808030; '>=</span> $cat<span style='color:#808030; '>-></span>default_type_id<span style='color:#800080; '>;</span>  
 919:    <span style='color:#800080; '>}</span>
 920:    <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>category_id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$FORM<span style='color:#800080; '>{</span>category_id<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>type_id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$type_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 921:    $self<span style='color:#808030; '>-></span>header_props<span style='color:#808030; '>(</span><span style='color:#808030; '>-</span>expires<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'-3m'</span><span style='color:#808030; '>,</span><span style='color:#808030; '>-</span>type<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'text/html'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 922: 
 923:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'items/'</span><span style='color:#808030; '>.</span>$item<span style='color:#808030; '>-></span>type_tech_name<span style='color:#808030; '>.</span><span style='color:#0000e6; '>'-form.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 924:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 925:       $item<span style='color:#808030; '>-></span>html_form<span style='color:#808030; '>,</span>
 926:       <span style='color:#808030; '>%</span>$errs
 927:      <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 928: 
 929:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span> 
 930: <span style='color:#800080; '>}</span>
 931: 
 932: <span style='color:#800000; font-weight:bold; '>sub </span>item_edit_form <span style='color:#800080; '>{</span>
 933:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 934:    <span style='color:#800000; font-weight:bold; '>my</span> $errs <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
 935:    <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>defined</span> $FORM<span style='color:#800080; '>{</span><span style='color:#0000e6; '>'item_id'</span><span style='color:#800080; '>}</span> <span style='color:#808030; '>or</span> $FORM<span style='color:#800080; '>{</span>title<span style='color:#800080; '>}</span> <span style='color:#808030; '>or</span> $FORM<span style='color:#800080; '>{</span>item_update_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span> 
 936:     <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Insufficient Information"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> 
 937:            msg <span style='color:#808030; '>=</span><span style='color:#808030; '>></span>
 938:              gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"There must be an item_id or title or item_update_id "</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>
 939:                gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"present to edit the item"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 940:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$ItemId<span style='color:#808030; '>,</span>$Table<span style='color:#808030; '>,</span>$orig_item_html<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 941:    <span style='color:#800000; font-weight:bold; '>my</span> $change_cat <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
 942:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>item_update_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 943:      $ItemId <span style='color:#808030; '>=</span> $FORM<span style='color:#800080; '>{</span>item_update_id<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 944:      $Table <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'cas_item_suggested_updates'</span><span style='color:#800080; '>;</span>
 945:      
 946:    <span style='color:#800080; '>}</span>
 947: 
 948:    <span style='color:#696969; '># XXX For now we assume that if people are using a title to update the item</span>
 949:    <span style='color:#696969; '># They are a user</span>
 950:    <span style='color:#800000; font-weight:bold; '>elsif</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>not</span> $FORM<span style='color:#800080; '>{</span>item_id<span style='color:#800080; '>}</span> <span style='color:#808030; '>and</span> $FORM<span style='color:#800080; '>{</span>title<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 951:      $ItemId <span style='color:#808030; '>=</span> item_id_from_title<span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>title<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$FORM<span style='color:#800080; '>{</span>category_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span>
 952:        <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'No Matches Found'</span><span style='color:#808030; '>,</span>
 953:        msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'There were no items found with that title in this category.                 Try returning to the category and copying and pasting the item title precisely.</span>
 954: <span style='color:#0000e6; '>                It</span><span style='color:#0f69ff; '>\'</span><span style='color:#0000e6; '>s also possible that the item no longer exists in the database, although </span>
 955: <span style='color:#0000e6; '>                it still appears on the website.         </span>
 956: <span style='color:#0000e6; '>                '</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 957:      $Table <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'cas_item'</span><span style='color:#800080; '>;</span>
 958:      $change_cat <span style='color:#808030; '>=</span> <span style='color:#008c00; '>0</span><span style='color:#800080; '>;</span>
 959:    <span style='color:#800080; '>}</span>
 960:    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>     
 961:      $ItemId <span style='color:#808030; '>=</span> $FORM<span style='color:#800080; '>{</span>item_id<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
 962:      $Table <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'cas_item'</span><span style='color:#800080; '>;</span>
 963:    <span style='color:#800080; '>}</span>    
 964:    <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>
 965:      category_id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$FORM<span style='color:#800080; '>{</span>category_id<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
 966:     id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$ItemId<span style='color:#808030; '>,</span>
 967:     table<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$Table<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>  
 968:    $item <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'No Item Found'</span><span style='color:#808030; '>,</span> msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'No Item found with that item_id'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 969:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'items/'</span><span style='color:#808030; '>.</span>$item<span style='color:#808030; '>-></span>type_tech_name<span style='color:#808030; '>.</span><span style='color:#0000e6; '>'-form.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 970: 
 971:     <span style='color:#696969; '># Get the HTML for the original item to display as a comparison (if that applies)</span>
 972:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$Table <span style='color:#808030; '>eq</span> <span style='color:#0000e6; '>'cas_item_suggested_updates'</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 973:       <span style='color:#800000; font-weight:bold; '>my</span> $orig_item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$item<span style='color:#808030; '>-></span>field<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'item_id'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 974:       $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>orig_item_html<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$orig_item<span style='color:#808030; '>-></span>output_html<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 975:    <span style='color:#800080; '>}</span>
 976:       
 977:    $self<span style='color:#808030; '>-></span>header_props<span style='color:#808030; '>(</span><span style='color:#808030; '>-</span>expires<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'-3m'</span><span style='color:#808030; '>,</span><span style='color:#808030; '>-</span>type<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'text/html'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 978:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
 979:       $item<span style='color:#808030; '>-></span>html_form<span style='color:#808030; '>(</span>change_category<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$change_cat<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
 980:       <span style='color:#808030; '>%</span>$errs<span style='color:#808030; '>,</span>
 981:  <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 982:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span> 
 983: <span style='color:#800080; '>}</span>
 984: 
 985: <span style='color:#800000; font-weight:bold; '>sub </span>item_suggest_add <span style='color:#800080; '>{</span>
 986:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span> 
 987:    
 988:    <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>category_id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$FORM<span style='color:#800080; '>{</span>category_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
 989:    
 990:    $item<span style='color:#808030; '>-></span>validate_form<span style='color:#800080; '>;</span>
 991: 
 992:    <span style='color:#696969; '># if there are errors, return the errors</span>
 993:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$item<span style='color:#808030; '>-></span>missing <span style='color:#808030; '>or</span> $item<span style='color:#808030; '>-></span>invalid<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
 994:       <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>HTML::FillInForm</span><span style='color:#800080; '>;</span>
 995:       <span style='color:#800000; font-weight:bold; '>my</span> $fif <span style='color:#808030; '>=</span> new <span style='color:#bb7977; font-weight:bold; '>HTML::FillInForm</span><span style='color:#800080; '>;</span>
 996:       <span style='color:#800000; font-weight:bold; '>return</span> $fif<span style='color:#808030; '>-></span>fill<span style='color:#808030; '>(</span>
 997:      scalarref <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#808030; '>\</span>$self<span style='color:#808030; '>-></span>item_add_form<span style='color:#808030; '>(</span>
 998:         error_marks<span style='color:#808030; '>(</span> <span style='color:#808030; '>[</span> $item<span style='color:#808030; '>-></span>missing <span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span> $item<span style='color:#808030; '>-></span>invalid <span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> $item<span style='color:#808030; '>-></span>validation_msgs <span style='color:#808030; '>)</span>    
 999:        <span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
1000:      fobject <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
1001:    <span style='color:#800080; '>}</span>
1002: 
1003:    <span style='color:#800000; font-weight:bold; '>my</span> %params <span style='color:#808030; '>=</span> $item<span style='color:#808030; '>-></span>already_exists<span style='color:#800080; '>;</span>
1004:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$params<span style='color:#800080; '>{</span>self_html<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1005:       <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'item-duplicate.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1006:       $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>%params<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1007:       <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1008:    <span style='color:#800080; '>}</span>
1009: 
1010:    <span style='color:#696969; '># are we suggesting an update are actually making one? </span>
1011:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$send_alerts_p<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1012:    <span style='color:#800000; font-weight:bold; '>unless</span> <span style='color:#808030; '>(</span>$SES<span style='color:#800080; '>{</span>role_admin<span style='color:#800080; '>}</span> <span style='color:#808030; '>or</span> $SES<span style='color:#800080; '>{</span>role_editor<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1013:       $send_alerts_p <span style='color:#808030; '>=</span> <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
1014:    <span style='color:#800080; '>}</span>
1015:    
1016:    <span style='color:#696969; '># add the item to the database</span>
1017:    <span style='color:#800000; font-weight:bold; '>my</span> $item_id<span style='color:#800080; '>;</span>
1018:    <span style='color:#800000; font-weight:bold; '>eval</span> <span style='color:#800080; '>{</span> $item_id <span style='color:#808030; '>=</span> $item<span style='color:#808030; '>-></span>insert <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1019:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$@<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1020:       <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Insert Failed'</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>"The item could not be inserted due to the following error:&lt;BR>$@"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1021:    <span style='color:#800080; '>}</span>    
1022: 
1023:    <span style='color:#696969; '># send email alerts </span>
1024:    $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$item_id<span style='color:#808030; '>,</span>category_id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$FORM<span style='color:#800080; '>{</span>category_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1025:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> $msg <span style='color:#808030; '>=</span> $item<span style='color:#808030; '>-></span>send_alerts<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1026:      <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'emails/item-alert-new.txt'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1027:      $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span> $msg <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1028:      <span style='color:#800000; font-weight:bold; '>open</span><span style='color:#808030; '>(</span>MAIL<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"|</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{MAILPROG}    -t"</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> 
1029:        err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Error Opening Mail Program'</span><span style='color:#808030; '>,</span> msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'There was an error opening the mail program'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1030:      <span style='color:#800000; font-weight:bold; '>print</span> MAIL $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1031:      <span style='color:#800000; font-weight:bold; '>close</span><span style='color:#808030; '>(</span>MAIL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1032:    <span style='color:#800080; '>}</span>
1033: 
1034: 
1035:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$SES<span style='color:#800080; '>{</span>role_editor<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1036:       <span style='color:#696969; '># Return to the category_id we came from. </span>
1037:       <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>category_page<span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>orig_category_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1038:    <span style='color:#800080; '>}</span>
1039:    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1040:       <span style='color:#696969; '># XXX We should probably eventually great a page to thank people specifically for suggesting</span>
1041:       <span style='color:#696969; '># an addition, but the current message is generic enough for now. -mls </span>
1042:       <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>item_suggest_update_thanks<span style='color:#800080; '>;</span>
1043:    <span style='color:#800080; '>}</span>
1044: <span style='color:#800080; '>}</span>
1045: 
1046: <span style='color:#800000; font-weight:bold; '>sub </span>item_suggest_update_form <span style='color:#800080; '>{</span>
1047:   <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1048:   <span style='color:#800000; font-weight:bold; '>defined</span> $FORM<span style='color:#800080; '>{</span>category_id<span style='color:#800080; '>}</span> <span style='color:#808030; '>or</span> 
1049:     <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"No Category ID specified"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> 
1050:      msg <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"There must be a category_id "</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"present for this script to work"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1051:      
1052:   <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$FORM<span style='color:#800080; '>{</span>category_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1053: 
1054:   <span style='color:#800000; font-weight:bold; '>my</span> $tmpl <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'item-suggest-update.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1055:   $tmpl<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
1056:     plain      <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $cat<span style='color:#808030; '>-></span>name<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'plain'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
1057:     category_id <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $FORM<span style='color:#800080; '>{</span>category_id<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
1058:     mode    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $FORM<span style='color:#800080; '>{</span>mode<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
1059:     <span style='color:#808030; '>&amp;</span>footer_html_tmpl
1060:    <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1061:   <span style='color:#800000; font-weight:bold; '>return</span> $tmpl<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1062: <span style='color:#800080; '>}</span>
1063: 
1064: <span style='color:#800000; font-weight:bold; '>sub </span>item_edit <span style='color:#800080; '>{</span>
1065:   <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1066: 
1067:    <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>length</span> $FORM<span style='color:#800080; '>{</span><span style='color:#0000e6; '>'item_id'</span><span style='color:#800080; '>}</span> <span style='color:#808030; '>or</span> $FORM<span style='color:#800080; '>{</span>item_update_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span> 
1068:     <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"Insufficient Information"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> 
1069:            msg <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"There must be an item_id or item_update_id "</span><span style='color:#808030; '>)</span><span style='color:#808030; '>.</span>
1070:                gettext<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"present to edit the item"</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1071:   <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$ItemId<span style='color:#808030; '>,</span>$Table<span style='color:#808030; '>,</span>$return_mode<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1072:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>item_update_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1073:      $ItemId <span style='color:#808030; '>=</span> $FORM<span style='color:#800080; '>{</span>item_update_id<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1074:      $Table <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'cas_item_suggested_updates'</span><span style='color:#800080; '>;</span>
1075:      $return_mode <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'needs_approval_summary'</span>
1076:    <span style='color:#800080; '>}</span>
1077:    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>     
1078:      $ItemId <span style='color:#808030; '>=</span> $FORM<span style='color:#800080; '>{</span>item_id<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1079:      $Table <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'cas_item'</span><span style='color:#800080; '>;</span>
1080:    <span style='color:#800080; '>}</span>
1081: 
1082:   <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>
1083:     <span style='color:#696969; '>#category_id=>$FORM{category_id},</span>
1084:     id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$ItemId<span style='color:#808030; '>,</span>
1085:     table<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$Table <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1086:   $return_mode <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span><span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>$item<span style='color:#808030; '>-></span>field<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'approval_state'</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>eq</span> <span style='color:#0000e6; '>'needs_approval'</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>?</span> <span style='color:#0000e6; '>'needs_approval_summary'</span> <span style='color:#808030; '>:</span> <span style='color:#0000e6; '>'category_page'</span><span style='color:#800080; '>;</span>
1087:   
1088: 
1089:   $item<span style='color:#808030; '>-></span>validate_form<span style='color:#800080; '>;</span>
1090: 
1091:    <span style='color:#696969; '># if there are errors, return the errors</span>
1092:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$item<span style='color:#808030; '>-></span>missing <span style='color:#808030; '>or</span> $item<span style='color:#808030; '>-></span>invalid<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1093:       <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>HTML::FillInForm</span><span style='color:#800080; '>;</span>
1094:       <span style='color:#800000; font-weight:bold; '>my</span> $fif <span style='color:#808030; '>=</span> new <span style='color:#bb7977; font-weight:bold; '>HTML::FillInForm</span><span style='color:#800080; '>;</span>
1095:       <span style='color:#800000; font-weight:bold; '>return</span> $fif<span style='color:#808030; '>-></span>fill<span style='color:#808030; '>(</span>
1096:      scalarref <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#808030; '>\</span>$self<span style='color:#808030; '>-></span>item_edit_form<span style='color:#808030; '>(</span> 
1097:         error_marks<span style='color:#808030; '>(</span> <span style='color:#808030; '>[</span> $item<span style='color:#808030; '>-></span>missing <span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>[</span> $item<span style='color:#808030; '>-></span>invalid <span style='color:#808030; '>]</span><span style='color:#808030; '>,</span> $item<span style='color:#808030; '>-></span>validation_msgs<span style='color:#808030; '>)</span>
1098:        <span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
1099:      fobject <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $self<span style='color:#808030; '>-></span>query
1100:     <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1101:    <span style='color:#800080; '>}</span>
1102: 
1103:    <span style='color:#800000; font-weight:bold; '>my</span> %params <span style='color:#808030; '>=</span> $item<span style='color:#808030; '>-></span>already_exists<span style='color:#800080; '>;</span>
1104:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$params<span style='color:#800080; '>{</span>self_html<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1105:       <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'item-duplicate.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1106:       $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>%params<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1107:       <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1108:    <span style='color:#800080; '>}</span>
1109: 
1110:     <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $field <span style='color:#808030; '>(</span><span style='color:#0000e6; '>'state'</span><span style='color:#808030; '>,</span><span style='color:#0000e6; '>'country'</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1111:         $self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>-></span>Delete<span style='color:#808030; '>(</span>$field<span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>length</span>  $self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>$field<span style='color:#808030; '>)</span> <span style='color:#808030; '>)</span> <span style='color:#808030; '>!</span><span style='color:#808030; '>=</span> <span style='color:#008c00; '>2</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1112:     <span style='color:#800080; '>}</span>
1113: 
1114:   <span style='color:#696969; '># Users just suggest edits, editors and admins actually make them</span>
1115:   <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$SES<span style='color:#800080; '>{</span>role_admin<span style='color:#800080; '>}</span> <span style='color:#808030; '>or</span> $SES<span style='color:#800080; '>{</span>role_editor<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1116:     <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Admin</span><span style='color:#800080; '>;</span>
1117:     <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$item<span style='color:#808030; '>-></span>update<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1118:        <span style='color:#696969; '># update this form variable to return the category we came from. </span>
1119:        $FORM<span style='color:#800080; '>{</span>category_id<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> $FORM<span style='color:#800080; '>{</span>orig_category_id<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1120:        <span style='color:#696969; '># XXX It's only safe for admins to use this internal redirection</span>
1121:        <span style='color:#696969; '># because it by-passes the auth checking for run modes in setup(). -mls</span>
1122:        <span style='color:#696969; '># If $FORM{return_rm} is present, it supercedes the default return_mode. </span>
1123:        $return_mode <span style='color:#808030; '>=</span> $FORM<span style='color:#800080; '>{</span>return_rm<span style='color:#800080; '>}</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> $return_mode<span style='color:#800080; '>;</span>
1124:        <span style='color:#800000; font-weight:bold; '>my</span> $out <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>eval</span><span style='color:#808030; '>(</span><span style='color:#0000e6; '>'$self->'</span><span style='color:#808030; '>.</span>$return_mode<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> 
1125:        $@ <span style='color:#808030; '>?</span> <span style='color:#800000; font-weight:bold; '>die</span> <span style='color:#0000e6; '>"error run mode </span><span style='color:#0000e6; '>$return_mode</span><span style='color:#0000e6; '> was $@"</span><span style='color:#808030; '>:</span> <span style='color:#800000; font-weight:bold; '>return</span> $out<span style='color:#800080; '>;</span>
1126:     <span style='color:#800080; '>}</span>
1127:     <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1128:        err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Item Not Updated'</span><span style='color:#808030; '>,</span>
1129:         msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'The item was not updated. The database returned the error: '</span><span style='color:#808030; '>.</span>$DBI<span style='color:#808030; '>::</span>errstr<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1130:     <span style='color:#800080; '>}</span>
1131:   <span style='color:#800080; '>}</span>
1132:   <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1133:      <span style='color:#800000; font-weight:bold; '>my</span> $update_id<span style='color:#800080; '>;</span>
1134:       <span style='color:#800000; font-weight:bold; '>eval</span> <span style='color:#800080; '>{</span>$update_id <span style='color:#808030; '>=</span> $item<span style='color:#808030; '>-></span>suggest_update<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1135:       $@ <span style='color:#808030; '>and</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Insert Failed'</span><span style='color:#808030; '>,</span>
1136:     msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>"Inserting that suggested update failed with an unexpected error.</span>
1137: <span style='color:#0000e6; '>                   The error was: $@"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1138:       <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> $msg <span style='color:#808030; '>=</span> $item<span style='color:#808030; '>-></span>send_alerts<span style='color:#808030; '>(</span>$update_id<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1139:      <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'emails/item-alert-update.txt'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1140:      $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>$msg<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1141:      <span style='color:#800000; font-weight:bold; '>open</span><span style='color:#808030; '>(</span>MAIL<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"|</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{MAILPROG} -t"</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> 
1142:        err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Error Opening Mail Program'</span><span style='color:#808030; '>,</span> msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'There was an error opening the mail program'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1143:      <span style='color:#800000; font-weight:bold; '>print</span> MAIL $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1144:      <span style='color:#800000; font-weight:bold; '>close</span><span style='color:#808030; '>(</span>MAIL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1145:        <span style='color:#800080; '>}</span>
1146:      <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>item_suggest_update_thanks
1147:   <span style='color:#800080; '>}</span>
1148: <span style='color:#800080; '>}</span>
1149: 
1150: <span style='color:#800000; font-weight:bold; '>sub </span>item_suggest_update_thanks <span style='color:#800080; '>{</span>
1151:   <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1152:   <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'item_suggest_update_thanks.html'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1153:   $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>footer_html_tmpl<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1154:   <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1155: <span style='color:#800080; '>}</span>
1156: 
1157: <span style='color:#800000; font-weight:bold; '>sub </span>login_form <span style='color:#800080; '>{</span>
1158:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1159: 
1160:    <span style='color:#800000; font-weight:bold; '>my</span> $return_rm<span style='color:#800080; '>;</span>
1161:    <span style='color:#696969; '># If we have been passed an explicit return_rm, we use that first. </span>
1162:    <span style='color:#800080; '>{</span>
1163:       <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>length</span> $FORM<span style='color:#800080; '>{</span>return_rm<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span> $return_rm <span style='color:#808030; '>=</span> $FORM<span style='color:#800080; '>{</span>return_rm<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span> <span style='color:#800000; font-weight:bold; '>last</span> <span style='color:#800080; '>}</span>
1164:       
1165:       <span style='color:#696969; '># If we are being call from another run mode, we return there.</span>
1166:       <span style='color:#696969; '># Otherwise, we return to their homepage </span>
1167:       $return_rm <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>rm<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>m</span><span style='color:#800000; '>/</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>login</span><span style='color:#800000; '>/</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>?</span> <span style='color:#0000e6; '>'pvt_home'</span> <span style='color:#808030; '>:</span> $FORM<span style='color:#800080; '>{</span>rm<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1168:    <span style='color:#800080; '>}</span>
1169: 
1170:    <span style='color:#696969; '># If we are not in "dynamic only" mode, we want to show static links in the footer here.</span>
1171:    $FORM<span style='color:#800080; '>{</span>mode<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'static'</span> <span style='color:#800000; font-weight:bold; '>unless</span> $CFG<span style='color:#800080; '>{</span>DYNAMIC_ONLY_P<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1172: 
1173:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'register-index.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1174: 
1175:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span> 
1176:       referred    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>rm<span style='color:#800080; '>}</span> <span style='color:#808030; '>ne</span> <span style='color:#0000e6; '>'login'</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>and</span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
1177:       return_rm   <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $return_rm<span style='color:#808030; '>,</span>
1178:       query_string <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>-></span>escapeHTML<span style='color:#808030; '>(</span>$self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>-></span>query_string<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
1179:      footer_html_tmpl<span style='color:#808030; '>(</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1180: 
1181:    <span style='color:#696969; '># Expire the existing cookie, just for good measure. </span>
1182:    $self<span style='color:#808030; '>-></span>header_props<span style='color:#808030; '>(</span><span style='color:#808030; '>-</span>cookie<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>create_cookie<span style='color:#808030; '>(</span>$SES<span style='color:#800080; '>{</span>session_id<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span><span style='color:#0000e6; '>'-3M'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1183:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1184: <span style='color:#800080; '>}</span>
1185: 
1186: <span style='color:#800000; font-weight:bold; '>sub </span>login_process <span style='color:#800080; '>{</span>
1187:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1188:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$user_id<span style='color:#808030; '>,</span> $user_state<span style='color:#808030; '>,</span>$role<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
1189: <span style='color:#0000e6; '>     SELECT user_id,user_state,role</span>
1190: <span style='color:#0000e6; '>      FROM cas_users</span>
1191: <span style='color:#0000e6; '>      WHERE lower(email) = ?"</span><span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span><span style='color:#800000; font-weight:bold; '>lc</span> $FORM<span style='color:#800080; '>{</span>email<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1192:    <span style='color:#696969; '># If we recognize your email address</span>
1193:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$user_id<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1194:       <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$user_state <span style='color:#808030; '>eq</span> <span style='color:#0000e6; '>'authorized'</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1195:      <span style='color:#800000; font-weight:bold; '>my</span> $recognize_both <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
1196: <span style='color:#0000e6; '>            SELECT user_id </span>
1197: <span style='color:#0000e6; '>                FROM cas_users users</span>
1198: <span style='color:#0000e6; '>                WHERE users.user_id = </span><span style='color:#0000e6; '>$user_id</span><span style='color:#0000e6; '> </span>
1199: <span style='color:#0000e6; '>                    AND password = ?"</span><span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$FORM<span style='color:#800080; '>{</span>password<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1200: 
1201:      <span style='color:#696969; '># If we recognize your password, authorize and redirect you</span>
1202:      <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$recognize_both<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1203:         <span style='color:#696969; '>#my %session = validate_session();</span>
1204:         add_userid_to_session<span style='color:#808030; '>(</span><span style='color:#808030; '>\</span>%SES<span style='color:#808030; '>,</span>$user_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1205: 
1206:         <span style='color:#696969; '># if return_rm starts with 'http' we assume it's a </span>
1207:         <span style='color:#696969; '># full URL and use that. Otherwise, return_rm should be a run mode</span>
1208:         <span style='color:#800000; font-weight:bold; '>my</span> $url<span style='color:#800080; '>;</span>
1209:         <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>return_rm<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>m</span><span style='color:#800000; '>/</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>http</span><span style='color:#800000; '>/</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1210:             $url <span style='color:#808030; '>=</span> $FORM<span style='color:#800080; '>{</span>return_rm<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1211:         <span style='color:#800080; '>}</span>
1212:         <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1213:             $url <span style='color:#808030; '>=</span><span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{CASCADE_CGI}/</span><span style='color:#0000e6; '>$FORM</span><span style='color:#0000e6; '>{return_rm}?</span><span style='color:#0000e6; '>$FORM</span><span style='color:#0000e6; '>{query_string}"</span><span style='color:#800080; '>;</span> 
1214:         <span style='color:#800080; '>}</span>
1215: 
1216:         $self<span style='color:#808030; '>-></span>header_props<span style='color:#808030; '>(</span>
1217:            <span style='color:#808030; '>-</span>cookie<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>create_cookie<span style='color:#808030; '>(</span>$SES<span style='color:#800080; '>{</span>session_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
1218:            <span style='color:#808030; '>-</span>url<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$url<span style='color:#808030; '>,</span>
1219:          <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1220: 
1221:         $self<span style='color:#808030; '>-></span>header_type<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'redirect'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1222:         <span style='color:#800000; font-weight:bold; '>return</span><span style='color:#800080; '>;</span>
1223:      <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1224:         <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Bad Password'</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#800000; font-weight:bold; '>qq</span><span style='color:#800000; '>!</span><span style='color:#0000e6; '>The password is not correct.</span>
1225: <span style='color:#0000e6; '>                   If you've forgotten it, </span>
1226: <span style='color:#0000e6; '>              &lt;a href="</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{CASCADE_CGI}/password_mail_forgotten?user_id=</span><span style='color:#0000e6; '>$user_id</span><span style='color:#0000e6; '>">we can mail it to you.&lt;/A></span><span style='color:#800000; '>!</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1227:      <span style='color:#800080; '>}</span>
1228:       <span style='color:#800080; '>}</span> 
1229:       <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1230:      <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Inactive account'</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Your account is no longer active'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1231:       <span style='color:#800080; '>}</span>
1232:    <span style='color:#800080; '>}</span>
1233:    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1234:       <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'User not found'</span><span style='color:#808030; '>,</span>
1235:          msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'No user was not with that email address'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1236:    <span style='color:#800080; '>}</span>
1237: <span style='color:#800080; '>}</span>
1238: 
1239: <span style='color:#696969; '># XXX maybe this run mode should really be Auth.pm. -mls</span>
1240: <span style='color:#800000; font-weight:bold; '>sub </span>logout <span style='color:#800080; '>{</span>
1241:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1242:    <span style='color:#696969; '># We don't want to validate the session, since that would redirect them to register</span>
1243:    <span style='color:#696969; '># if they are already logged out. Instead, we just grab the cookie directly. </span>
1244:    <span style='color:#800000; font-weight:bold; '>my</span> %session <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span> session_id <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>-></span>cookie<span style='color:#808030; '>(</span>$CFG<span style='color:#800080; '>{</span>SESSION_COOKIE_NAME<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1245:    <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Auth</span><span style='color:#800080; '>;</span>
1246:    remove_userid_from_session<span style='color:#808030; '>(</span><span style='color:#808030; '>\</span>%session<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1247:    $self<span style='color:#808030; '>-></span>header_props<span style='color:#808030; '>(</span> <span style='color:#808030; '>-</span>cookie<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>create_cookie<span style='color:#808030; '>(</span>$session<span style='color:#800080; '>{</span>session_id<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span><span style='color:#0000e6; '>'-3M'</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1248:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'register-logout.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1249:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
1250:       top_url    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#808030; '>!</span>$CFG<span style='color:#800080; '>{</span>DYNAMIC_ONLY_P<span style='color:#800080; '>}</span> <span style='color:#808030; '>?</span> $CFG<span style='color:#800080; '>{</span>HTML_ROOT_URL<span style='color:#800080; '>}</span> <span style='color:#808030; '>:</span> $CFG<span style='color:#800080; '>{</span>CASCADE_CGI<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
1251:       return_rm <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>return_rm<span style='color:#800080; '>}</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> $ENV<span style='color:#800080; '>{</span>HTTP_REFERER<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1252:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1253: <span style='color:#800080; '>}</span>
1254:      
1255: <span style='color:#800000; font-weight:bold; '>sub </span>register_form <span style='color:#800080; '>{</span>
1256:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1257:    <span style='color:#800000; font-weight:bold; '>my</span> $errs <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1258: 
1259:    <span style='color:#696969; '># We don't want to pass through the run mode and confuse the</span>
1260:    <span style='color:#696969; '># system. -mls</span>
1261:    <span style='color:#800000; font-weight:bold; '>delete</span> $FORM<span style='color:#800080; '>{</span>rm<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1262:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'register-form.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1263:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>  
1264:       return_rm<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$FORM<span style='color:#800080; '>{</span>return_rm<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
1265:       query_string <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>-></span>escapeHTML<span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>query_string<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> 
1266:       <span style='color:#808030; '>%</span>$errs<span style='color:#808030; '>,</span>
1267:      <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1268:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1269: <span style='color:#800080; '>}</span>
1270: 
1271: <span style='color:#800000; font-weight:bold; '>sub </span>register_process <span style='color:#800080; '>{</span>
1272:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1273:    <span style='color:#696969; '># validate form</span>
1274:    <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Data</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>FormValidator</span><span style='color:#800080; '>;</span>
1275:    <span style='color:#800000; font-weight:bold; '>my</span> %email_validation <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>email <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'email'</span><span style='color:#808030; '>)</span> <span style='color:#800000; font-weight:bold; '>if</span> $CFG<span style='color:#800080; '>{</span>VERIFY_EMAILS_P<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1276:    <span style='color:#800000; font-weight:bold; '>my</span> $validator <span style='color:#808030; '>=</span> new <span style='color:#bb7977; font-weight:bold; '>Data</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>FormValidator</span><span style='color:#808030; '>(</span><span style='color:#800080; '>{</span>
1277:       form <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#800080; '>{</span>
1278:     required <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#808030; '>[</span><span style='color:#800000; font-weight:bold; '>qw</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>first_names last_name email password password_confirmation</span><span style='color:#800000; '>/</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>
1279:     filters <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'trim'</span><span style='color:#808030; '>,</span>
1280:     constraints <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#800080; '>{</span>
1281:        %email_validation<span style='color:#808030; '>,</span>
1282:        <span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
1283:     <span style='color:#800080; '>}</span>
1284:      <span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1285:      <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span> $valid<span style='color:#808030; '>,</span> $missing<span style='color:#808030; '>,</span> $invalid <span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $validator<span style='color:#808030; '>-></span>validate<span style='color:#808030; '>(</span>  <span style='color:#808030; '>\</span>%FORM<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"form"</span> <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1286: 
1287:    <span style='color:#800000; font-weight:bold; '>my</span> $msgs<span style='color:#800080; '>;</span>
1288:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>password<span style='color:#800080; '>}</span> <span style='color:#808030; '>ne</span> $FORM<span style='color:#800080; '>{</span>password_confirmation<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1289:       $msgs<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>password<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'Password and Confirmation do not match.'</span><span style='color:#800080; '>;</span>
1290:       <span style='color:#800000; font-weight:bold; '>push</span> @$invalid<span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#0000e6; '>'password'</span><span style='color:#808030; '>,</span> <span style='color:#0000e6; '>'password_confirmation'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1291:    <span style='color:#800080; '>}</span>
1292: 
1293:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>grep</span><span style='color:#0000e6; '> </span><span style='color:#800000; '>/</span><span style='color:#808030; '>^</span><span style='color:#0000e6; '>email</span><span style='color:#808030; '>$</span><span style='color:#800000; '>/</span><span style='color:#808030; '>,</span> @$invalid<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1294:       $msgs<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>email<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'Invalid Email format'</span><span style='color:#800080; '>;</span>
1295:    <span style='color:#800080; '>}</span>
1296: 
1297:    <span style='color:#696969; '># Are they already registered with this email address?</span>
1298:    <span style='color:#696969; '># If the user_id return is greater than zero, they are. </span>
1299:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span> <span style='color:#800000; font-weight:bold; '>my</span> $uid <span style='color:#808030; '>=</span> 
1300:            $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"SELECT user_id FROM cas_users WHERE lower(email) = ?"</span><span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span><span style='color:#800000; font-weight:bold; '>lc</span> $FORM<span style='color:#800080; '>{</span>email<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>></span> <span style='color:#008c00; '>0</span> <span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1301:       <span style='color:#800000; font-weight:bold; '>push</span> @$invalid<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>'email'</span><span style='color:#800080; '>;</span>
1302:       $msgs<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>email<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>qq</span><span style='color:#800000; '>!</span><span style='color:#0000e6; '>Already in system. </span>
1303: <span style='color:#0000e6; '>       ( &lt;a href="</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{CASCADE_CGI}/password_mail_forgotten?user_id=</span><span style='color:#0000e6; '>$uid</span><span style='color:#0000e6; '>">Send password to this address&lt;/a>&amp;nbsp;)</span><span style='color:#800000; '>!</span><span style='color:#800080; '>;</span>
1304:    <span style='color:#800080; '>}</span>
1305: 
1306:    <span style='color:#696969; '># if there are errors, return the errors</span>
1307:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>@$missing <span style='color:#808030; '>or</span> @$invalid<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1308:       <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>HTML::FillInForm</span><span style='color:#800080; '>;</span>
1309:       <span style='color:#800000; font-weight:bold; '>my</span> $fif <span style='color:#808030; '>=</span> new <span style='color:#bb7977; font-weight:bold; '>HTML::FillInForm</span><span style='color:#800080; '>;</span>
1310:       <span style='color:#800000; font-weight:bold; '>return</span> $fif<span style='color:#808030; '>-></span>fill<span style='color:#808030; '>(</span>
1311:      scalarref <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#808030; '>\</span>$self<span style='color:#808030; '>-></span>register_form<span style='color:#808030; '>(</span>
1312:         error_marks<span style='color:#808030; '>(</span> $missing<span style='color:#808030; '>,</span> $invalid<span style='color:#808030; '>,</span>$msgs<span style='color:#808030; '>)</span>
1313:        <span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
1314:      fobject <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span>
1315:    <span style='color:#800080; '>}</span>
1316:    <span style='color:#696969; '># otherwise, return login_process with the info we've got</span>
1317:    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1318:       <span style='color:#696969; '># check for duplicate email address</span>
1319:       <span style='color:#696969; '># insert into the database</span>
1320:       <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>DBIx::Abstract</span><span style='color:#800080; '>;</span>
1321:       <span style='color:#800000; font-weight:bold; '>my</span> $db <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>DBIx::Abstract</span><span style='color:#808030; '>-></span><span style='color:#800000; font-weight:bold; '>connect</span><span style='color:#808030; '>(</span>$DBH<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1322:       <span style='color:#800000; font-weight:bold; '>delete</span> $valid<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>password_confirmation<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1323:       <span style='color:#696969; '># XXX There's a good chance we should be verifying email addresses when people sign up. -mls</span>
1324:       $valid<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>user_state<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'authorized'</span><span style='color:#800080; '>;</span>
1325:       $valid<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>registration_ip<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> $ENV<span style='color:#800080; '>{</span>REMOTE_ADDR<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1326:       $db<span style='color:#808030; '>-></span>insert<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'cas_users'</span><span style='color:#808030; '>,</span>$valid<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1327:       <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>login_process<span style='color:#800080; '>;</span>
1328:    <span style='color:#800080; '>}</span>
1329:    
1330: <span style='color:#800080; '>}</span>
1331: <span style='color:#696969; '># create a hash from Data::FormValidator data for HTML::Template Input</span>
1332: <span style='color:#696969; '># is a reference to a list of fields with errors and a hash of field</span>
1333: <span style='color:#696969; '># names and custom error message messages</span>
1334: <span style='color:#696969; '># output is hash reference for HTML::Template;</span>
1335: <span style='color:#800000; font-weight:bold; '>sub </span>error_marks <span style='color:#800080; '>{</span>
1336:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$missing<span style='color:#808030; '>,</span> $invalid<span style='color:#808030; '>,</span> $msgs<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @_<span style='color:#800080; '>;</span>
1337:    
1338:    <span style='color:#696969; '># set one field just to say "we have some errors"</span>
1339:    <span style='color:#800000; font-weight:bold; '>my</span> $err_h <span style='color:#808030; '>=</span> <span style='color:#800080; '>{</span> <span style='color:#0000e6; '>'err__'</span> <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#008c00; '>1</span> <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1340: 
1341:    <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $err <span style='color:#808030; '>(</span>@$missing<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1342:       $msgs<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>$err<span style='color:#800080; '>}</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span><span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'Missing'</span><span style='color:#800080; '>;</span>
1343:       $err_h<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span><span style='color:#0000e6; '>'err_'</span><span style='color:#808030; '>.</span>$err<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span>
1344:     $CFG<span style='color:#800080; '>{</span>ERROR_MARK<span style='color:#800080; '>}</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>'&lt;B>&lt;font size="-1">'</span><span style='color:#808030; '>.</span>$msgs<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>$err<span style='color:#800080; '>}</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>'&lt;/font>&lt;/B>'</span><span style='color:#800080; '>;</span>
1345:    <span style='color:#800080; '>}</span>
1346:    <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $err <span style='color:#808030; '>(</span>@$invalid<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1347:       $msgs<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>$err<span style='color:#800080; '>}</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span><span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'Invalid'</span><span style='color:#800080; '>;</span>
1348:       $err_h<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span><span style='color:#0000e6; '>'err_'</span><span style='color:#808030; '>.</span>$err<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span>
1349:     $CFG<span style='color:#800080; '>{</span>ERROR_MARK<span style='color:#800080; '>}</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>'&lt;B>&lt;font size="-1">'</span><span style='color:#808030; '>.</span>$msgs<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>$err<span style='color:#800080; '>}</span><span style='color:#808030; '>.</span><span style='color:#0000e6; '>'&lt;/font>&lt;/B>'</span><span style='color:#800080; '>;</span>
1350:    <span style='color:#800080; '>}</span>
1351:    <span style='color:#800000; font-weight:bold; '>return</span> $err_h<span style='color:#800080; '>;</span>
1352: <span style='color:#800080; '>}</span>
1353: 
1354: <span style='color:#696969; '># a general purpose image validation routine</span>
1355: <span style='color:#696969; '># input</span>
1356: <span style='color:#696969; '>#    1. form field name</span>
1357: <span style='color:#696969; '>#    2. hashref of maxes (width, height, bytes)         </span>
1358: <span style='color:#696969; '># output: </span>
1359: <span style='color:#696969; '>#   1. attribute hash (width, height, mime_type, extension)</span>
1360: <span style='color:#696969; '>#   2. error msg (if any)</span>
1361: <span style='color:#800000; font-weight:bold; '>sub </span>validate_image <span style='color:#800080; '>{</span>
1362:    <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Image::Size</span><span style='color:#800080; '>;</span>
1363:    import <span style='color:#bb7977; font-weight:bold; '>Image::Size</span> <span style='color:#800000; font-weight:bold; '>qw</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>imgsize</span><span style='color:#800000; '>/</span><span style='color:#800080; '>;</span>
1364:    <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>HTTP::Headers</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span>UserAgent<span style='color:#800080; '>;</span>
1365:    import <span style='color:#bb7977; font-weight:bold; '>HTTP::Headers</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span>UserAgent<span style='color:#800080; '>;</span>
1366:    <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>File::Basename</span><span style='color:#800080; '>;</span>
1367:    import <span style='color:#bb7977; font-weight:bold; '>File::Basename</span><span style='color:#800080; '>;</span>  
1368: 
1369:    <span style='color:#800000; font-weight:bold; '>my</span> %os_convert <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>
1370:       Win9<span style='color:#008c00; '>5</span>           <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'MSWin32'</span><span style='color:#808030; '>,</span>
1371:       Win9<span style='color:#008c00; '>8</span>           <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'MSWin32'</span><span style='color:#808030; '>,</span>
1372:       WinNT           <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'MSWin32'</span><span style='color:#808030; '>,</span>
1373:       Mac             <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'MacOS'</span><span style='color:#808030; '>,</span>
1374:       Linux           <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>''</span><span style='color:#808030; '>,</span> <span style='color:#696969; '># the default for File::Basename</span>
1375:       UNIX            <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>''</span>
1376:    <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1377: 
1378:    <span style='color:#800000; font-weight:bold; '>my</span> %valid_mime_types <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>
1379:       <span style='color:#0000e6; '>'image/jpeg'</span>    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>
1380:       <span style='color:#0000e6; '>'image/gif'</span>     <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>
1381:       <span style='color:#0000e6; '>'image/png'</span>     <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#008c00; '>1</span><span style='color:#808030; '>,</span>
1382:      <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1383: 
1384:    <span style='color:#800000; font-weight:bold; '>my</span> $field <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1385:    <span style='color:#800000; font-weight:bold; '>my</span> $maxs <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1386:    <span style='color:#800000; font-weight:bold; '>my</span> $img <span style='color:#808030; '>=</span> $q<span style='color:#808030; '>-></span>upload<span style='color:#808030; '>(</span>$field<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1387:    carp $q<span style='color:#808030; '>-></span>cgi_error <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span>$img <span style='color:#808030; '>&amp;</span><span style='color:#808030; '>&amp;</span> $q<span style='color:#808030; '>-></span>cgi_error<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1388: 
1389:    <span style='color:#800000; font-weight:bold; '>my</span> $tmp_file <span style='color:#808030; '>=</span> $q<span style='color:#808030; '>-></span>tmpFileName<span style='color:#808030; '>(</span>$q<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>$field<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1390:    <span style='color:#800000; font-weight:bold; '>my</span> $file_size <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>stat</span> <span style='color:#808030; '>(</span>$img<span style='color:#808030; '>)</span><span style='color:#808030; '>)</span><span style='color:#808030; '>[</span><span style='color:#008c00; '>7</span><span style='color:#808030; '>]</span><span style='color:#800080; '>;</span>
1391:    <span style='color:#800000; font-weight:bold; '>my</span> $mime_type <span style='color:#808030; '>=</span> $q<span style='color:#808030; '>-></span>uploadInfo<span style='color:#808030; '>(</span>$img<span style='color:#808030; '>)</span><span style='color:#808030; '>-></span><span style='color:#800080; '>{</span><span style='color:#0000e6; '>'Content-Type'</span><span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>if</span> $img<span style='color:#800080; '>;</span>
1392: 
1393:    <span style='color:#800000; font-weight:bold; '>if</span><span style='color:#808030; '>(</span>$file_size <span style='color:#808030; '>></span> $maxs<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>bytes<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1394:       <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>undef</span><span style='color:#808030; '>,</span><span style='color:#0000e6; '>"File size exceeds maximum allowed"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1395:    <span style='color:#800080; '>}</span>
1396:    
1397:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>!</span> $valid_mime_types<span style='color:#800080; '>{</span>$mime_type<span style='color:#800080; '>}</span> <span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1398:       <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>undef</span><span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"Does not appear to be an allowed image format. (GIF, JPG, or PNG)"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1399:    <span style='color:#800080; '>}</span> 
1400: 
1401:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$width<span style='color:#808030; '>,</span>$height<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> imgsize<span style='color:#808030; '>(</span>$tmp_file<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1402:    <span style='color:#800000; font-weight:bold; '>my</span> $err<span style='color:#800080; '>;</span>
1403:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>(</span>$width <span style='color:#808030; '>></span> $maxs<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>width<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span>
1404:     <span style='color:#808030; '>(</span>$height <span style='color:#808030; '>></span> $maxs<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>height<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1405:      $err <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"Image dimensions (</span><span style='color:#0000e6; '>$width</span><span style='color:#0000e6; '> x </span><span style='color:#0000e6; '>$height</span><span style='color:#0000e6; '>) exceeds maximum allowed</span>
1406: <span style='color:#0000e6; '>           (</span><span style='color:#0000e6; '>$maxs</span><span style='color:#0000e6; '>->{width}</span><span style='color:#0000e6; '> x </span><span style='color:#0000e6; '>$maxs</span><span style='color:#0000e6; '>->{height}</span><span style='color:#0000e6; '>)"</span><span style='color:#800080; '>;</span>
1407:    <span style='color:#800080; '>}</span>
1408: 
1409:    <span style='color:#800000; font-weight:bold; '>my</span> $Platform <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>HTTP::Headers</span><span style='color:#808030; '>:</span><span style='color:#808030; '>:</span><span style='color:#bb7977; font-weight:bold; '>UserAgent</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>GetPlatform</span> <span style='color:#808030; '>(</span>$ENV<span style='color:#800080; '>{</span>HTTP_USER_AGENT<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1410:    fileparse_set_fstype<span style='color:#808030; '>(</span>$os_convert<span style='color:#800080; '>{</span>$Platform<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1411:    <span style='color:#800000; font-weight:bold; '>my</span> $orig_file_name <span style='color:#808030; '>=</span> basename<span style='color:#808030; '>(</span>$img<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1412:    <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> $ext<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $orig_file_name <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>m</span><span style='color:#800000; '>/</span><span style='color:#808030; '>(</span><span style='color:#0f69ff; '>\.</span><span style='color:#0000e6; '>\w</span><span style='color:#808030; '>*</span><span style='color:#808030; '>)</span><span style='color:#808030; '>?</span><span style='color:#808030; '>$</span><span style='color:#800000; '>/</span><span style='color:#800080; '>;</span>
1413: 
1414:    <span style='color:#800000; font-weight:bold; '>my</span> %attr <span style='color:#808030; '>=</span> <span style='color:#808030; '>(</span>
1415:      width  <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $width<span style='color:#808030; '>,</span>
1416:      height <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $height<span style='color:#808030; '>,</span>
1417:      extension <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $ext<span style='color:#808030; '>,</span> 
1418:      mime_type <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $mime_type<span style='color:#808030; '>,</span>
1419:     <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1420:    <span style='color:#800000; font-weight:bold; '>return</span> <span style='color:#808030; '>(</span><span style='color:#808030; '>\</span>%attr<span style='color:#808030; '>,</span>$err<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1421: <span style='color:#800080; '>}</span>
1422: 
1423: 
1424: <span style='color:#696969; '># XXX maybe I should rename this item_comments_view to be more consistent. -mls</span>
1425: <span style='color:#800000; font-weight:bold; '>sub </span>item_view_comments <span style='color:#800080; '>{</span>
1426:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1427:    <span style='color:#800000; font-weight:bold; '>length</span> $FORM<span style='color:#800080; '>{</span>item_id<span style='color:#800080; '>}</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>"No item_id"</span><span style='color:#808030; '>,</span>
1428:                        msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Insufficient information was found to build this page'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1429: 
1430:    <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$FORM<span style='color:#800080; '>{</span>item_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> 
1431:     <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>"No item"</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Failed to create an Item'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span><span style='color:#800080; '>;</span>
1432:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'item-view-comments.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1433:    $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>$item<span style='color:#808030; '>-></span>comments_html<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1434:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1435: <span style='color:#800080; '>}</span>
1436: 
1437: <span style='color:#800000; font-weight:bold; '>sub </span>item_include_comments <span style='color:#800080; '>{</span>
1438:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span> 
1439:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$item_id<span style='color:#808030; '>,</span> $where<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span> 
1440:    
1441:    <span style='color:#800000; font-weight:bold; '>my</span> @bind<span style='color:#800080; '>;</span>
1442:    <span style='color:#696969; '># first we try an explicit item_id</span>
1443:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>item_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1444:       $where <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>' item_id = ? '</span><span style='color:#800080; '>;</span>
1445:       <span style='color:#800000; font-weight:bold; '>push</span> @bind<span style='color:#808030; '>,</span> $FORM<span style='color:#800080; '>{</span>item_id<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1446:    <span style='color:#800080; '>}</span>
1447:    <span style='color:#696969; '># next we try matching the documents URI</span>
1448:    <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1449:       $where <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>'url = ?'</span><span style='color:#800080; '>;</span>
1450:       <span style='color:#800000; font-weight:bold; '>push</span> @bind<span style='color:#808030; '>,</span> $ENV<span style='color:#800080; '>{</span>DOCUMENT_URI<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1451:    <span style='color:#800080; '>}</span>
1452: 
1453:    $item_id <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span>
1454:        <span style='color:#0000e6; '>"SELECT item_id FROM cas_item_approved WHERE </span><span style='color:#0000e6; '>$where</span><span style='color:#0000e6; '>"</span><span style='color:#808030; '>,</span>
1455:            <span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
1456:         @bind<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1457:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$item_id <span style='color:#808030; '>></span> <span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1458:       <span style='color:#800000; font-weight:bold; '>my</span> $item <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Item</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$item_id<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1459:       <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'includes/item-include-comments.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1460:       $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>$item<span style='color:#808030; '>-></span>comments_html<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1461:       <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1462:    <span style='color:#800080; '>}</span>
1463: 
1464: <span style='color:#800080; '>}</span>
1465: 
1466: 
1467: <span style='color:#800000; font-weight:bold; '>sub </span>item_comment_post <span style='color:#800080; '>{</span>
1468:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1469:    <span style='color:#696969; '># validate the form;</span>
1470:    <span style='color:#800000; font-weight:bold; '>length</span> $FORM<span style='color:#800080; '>{</span>item_id<span style='color:#800080; '>}</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Technical Failure'</span><span style='color:#808030; '>,</span>
1471:                        msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'No item_id was found. This is probably not your fault'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1472: 
1473:    <span style='color:#800000; font-weight:bold; '>length</span> $SES<span style='color:#800080; '>{</span>user_id<span style='color:#800080; '>}</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Not logged in'</span><span style='color:#808030; '>,</span>
1474:                       msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'You need to logged in for this function to work. </span>
1475: <span style='color:#0000e6; '>         Try going back and reloading the page'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1476: 
1477:    <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>Data</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>FormValidator</span><span style='color:#800080; '>;</span>
1478:    <span style='color:#800000; font-weight:bold; '>my</span> $validator <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>Data</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>FormValidator</span><span style='color:#808030; '>-></span>new<span style='color:#808030; '>(</span><span style='color:#800080; '>{</span>
1479:       form <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#800080; '>{</span>
1480:        optional <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#808030; '>[</span><span style='color:#800000; font-weight:bold; '>qw</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>rating comment</span><span style='color:#800000; '>/</span><span style='color:#808030; '>]</span><span style='color:#808030; '>,</span>
1481:        filters <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>'trim'</span><span style='color:#808030; '>,</span>
1482:     <span style='color:#800080; '>}</span>
1483:      <span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1484:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$valid<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $validator<span style='color:#808030; '>-></span>validate<span style='color:#808030; '>(</span><span style='color:#808030; '>\</span>%FORM<span style='color:#808030; '>,</span><span style='color:#0000e6; '>'form'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1485: 
1486:    <span style='color:#696969; '># throw an error if they don't give a rating or a comment</span>
1487:    <span style='color:#808030; '>(</span>$valid<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>rating<span style='color:#800080; '>}</span> <span style='color:#808030; '>or</span> $valid<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>comment<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span>
1488:      <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Insufficient Information'</span><span style='color:#808030; '>,</span>
1489:         msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'You must supply a rating and/or a comment.'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1490: 
1491:    $valid<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>item_id<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> $FORM<span style='color:#800080; '>{</span>item_id<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1492:    $valid<span style='color:#808030; '>-></span><span style='color:#800080; '>{</span>user_id<span style='color:#800080; '>}</span> <span style='color:#808030; '>=</span> $SES<span style='color:#800080; '>{</span>user_id<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1493: 
1494:    <span style='color:#800000; font-weight:bold; '>require</span> <span style='color:#bb7977; font-weight:bold; '>DBIx::Abstract</span><span style='color:#800080; '>;</span>
1495:    <span style='color:#800000; font-weight:bold; '>my</span> $db <span style='color:#808030; '>=</span> <span style='color:#bb7977; font-weight:bold; '>DBIx::Abstract</span><span style='color:#808030; '>-></span><span style='color:#800000; font-weight:bold; '>connect</span><span style='color:#808030; '>(</span>$DBH<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1496:    <span style='color:#696969; '># If they've already posted</span>
1497:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
1498: <span style='color:#0000e6; '>          SELECT </span><span style='color:#008c00; '>1</span><span style='color:#0000e6; '> FROM cas_user_item_map</span>
1499: <span style='color:#0000e6; '>              WHERE user_id = ? AND item_id = ?"</span>
1500:               <span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$SES<span style='color:#800080; '>{</span>user_id<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$FORM<span style='color:#800080; '>{</span>item_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1501: 
1502:       $db<span style='color:#808030; '>-></span>update<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'cas_user_item_map'</span><span style='color:#808030; '>,</span>$valid<span style='color:#808030; '>,</span>
1503:           <span style='color:#800080; '>{</span> user_id <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $SES<span style='color:#800080; '>{</span>user_id<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span> item_id <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $FORM<span style='color:#800080; '>{</span>item_id<span style='color:#800080; '>}</span> <span style='color:#800080; '>}</span><span style='color:#808030; '>)</span>
1504:    <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1505:       $db<span style='color:#808030; '>-></span>insert<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'cas_user_item_map'</span><span style='color:#808030; '>,</span>$valid<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1506:    <span style='color:#800080; '>}</span>
1507:   
1508:    <span style='color:#bb7977; font-weight:bold; '>DBI</span><span style='color:#808030; '>-></span>trace<span style='color:#808030; '>(</span><span style='color:#008c00; '>1</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1509:    <span style='color:#696969; '># write affected static pages if we need to. </span>
1510:    <span style='color:#800000; font-weight:bold; '>unless</span> <span style='color:#808030; '>(</span>$CFG<span style='color:#800080; '>{</span>DYNAMIC_ONLY_P<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1511:        <span style='color:#696969; '># write static pages for all affected categories</span>
1512:        <span style='color:#800000; font-weight:bold; '>my</span> $cat_ids <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectcol_arrayref<span style='color:#808030; '>(</span><span style='color:#0000e6; '>"</span>
1513: <span style='color:#0000e6; '>       SELECT category_id </span>
1514: <span style='color:#0000e6; '>       FROM cas_category cat</span>
1515: <span style='color:#0000e6; '>       LEFT JOIN cas_category_item_map map USING (category_id)</span>
1516: <span style='color:#0000e6; '>       WHERE map.item_id = ?"</span><span style='color:#808030; '>,</span>
1517:        <span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$FORM<span style='color:#800080; '>{</span>item_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1518: 
1519:        <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $id <span style='color:#808030; '>(</span>@$cat_ids<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1520:            <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> new <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$id<span style='color:#808030; '>,</span>mode<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'static'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1521:            <span style='color:#800000; font-weight:bold; '>my</span> $rv <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>write_static_cat<span style='color:#808030; '>(</span>$cat<span style='color:#808030; '>,</span>verbose<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1522:        <span style='color:#800080; '>}</span>
1523:    <span style='color:#800080; '>}</span>
1524:    <span style='color:#bb7977; font-weight:bold; '>DBI</span><span style='color:#808030; '>-></span>trace<span style='color:#808030; '>(</span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1525: 
1526:    <span style='color:#696969; '># Send comments to those who care </span>
1527:    <span style='color:#696969; '># XXX For now, just admins. Later, maybe editors, too </span>
1528:    <span style='color:#800000; font-weight:bold; '>my</span> $cat <span style='color:#808030; '>=</span> new <span style='color:#bb7977; font-weight:bold; '>Cascade</span><span style='color:#808030; '>::</span><span style='color:#bb7977; font-weight:bold; '>Category</span><span style='color:#808030; '>(</span>id<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#008c00; '>0</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1529:       <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span><span style='color:#800000; font-weight:bold; '>my</span> $to_emails <span style='color:#808030; '>=</span> $cat<span style='color:#808030; '>-></span>get_admin_and_cat_emails<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1530:      <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'emails/item-alert-comment.txt'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1531:      $t<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span>
1532:         to_emails   <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $to_emails<span style='color:#808030; '>,</span>
1533:         from_email     <span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$SES<span style='color:#800080; '>{</span>email<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
1534:         title     <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $FORM<span style='color:#800080; '>{</span>title<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
1535:         rating    <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $FORM<span style='color:#800080; '>{</span>rating<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
1536:         comment     <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> $FORM<span style='color:#800080; '>{</span>comment<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>
1537:         comment_url <span style='color:#808030; '>=</span><span style='color:#808030; '>></span> <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{CASCADE_CGI}/item_view_comments?item_id=</span><span style='color:#0000e6; '>$FORM</span><span style='color:#0000e6; '>{item_id}"</span><span style='color:#808030; '>,</span>
1538:         delete_url  <span style='color:#808030; '>=</span><span style='color:#808030; '>></span>
1539:           <span style='color:#0000e6; '>"</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{CASCADE_CGI}/item_comments_delete?item_id=</span><span style='color:#0000e6; '>$FORM</span><span style='color:#0000e6; '>{item_id}&amp;comment_delete=</span><span style='color:#0000e6; '>$SES</span><span style='color:#0000e6; '>{user_id}"</span><span style='color:#808030; '>,</span>
1540:           
1541:        <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1542:      <span style='color:#800000; font-weight:bold; '>open</span><span style='color:#808030; '>(</span>MAIL<span style='color:#808030; '>,</span> <span style='color:#0000e6; '>"|</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{MAILPROG} -t"</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>or</span> <span style='color:#800000; font-weight:bold; '>return</span> 
1543:        err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Error Opening Mail Program'</span><span style='color:#808030; '>,</span> msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'There was an error opening the mail program'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1544:      <span style='color:#800000; font-weight:bold; '>eval</span> <span style='color:#800080; '>{</span><span style='color:#800000; font-weight:bold; '>print</span> MAIL $t<span style='color:#808030; '>-></span>output <span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1545:      $@ <span style='color:#808030; '>and</span> carp $@<span style='color:#800080; '>;</span> 
1546:      <span style='color:#800000; font-weight:bold; '>close</span><span style='color:#808030; '>(</span>MAIL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1547:        <span style='color:#800080; '>}</span>
1548: 
1549:    <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>item_view_comments<span style='color:#800080; '>;</span>
1550: 
1551: <span style='color:#800080; '>}</span>
1552: 
1553: <span style='color:#800000; font-weight:bold; '>sub </span>item_comments_delete <span style='color:#800080; '>{</span>
1554:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1555:    <span style='color:#800000; font-weight:bold; '>length</span> $FORM<span style='color:#800080; '>{</span>item_id<span style='color:#800080; '>}</span> <span style='color:#808030; '>or</span> error<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>"Insufficient Information"</span><span style='color:#808030; '>,</span>
1556:                   msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>"No item_id was found"</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1557: 
1558:    <span style='color:#696969; '># delete the marked comments</span>
1559:    <span style='color:#800000; font-weight:bold; '>foreach</span> <span style='color:#800000; font-weight:bold; '>my</span> $c <span style='color:#808030; '>(</span>$self<span style='color:#808030; '>-></span>query<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'comment_delete'</span><span style='color:#808030; '>)</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1560:       $DBH<span style='color:#808030; '>-></span><span style='color:#800000; font-weight:bold; '>do</span><span style='color:#808030; '>(</span><span style='color:#0000e6; '>"DELETE FROM cas_user_item_map</span>
1561: <span style='color:#0000e6; '>         WHERE item_id = ?</span>
1562: <span style='color:#0000e6; '>           AND user_id = ? "</span><span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$FORM<span style='color:#800080; '>{</span>item_id<span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>$c<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1563:    <span style='color:#800080; '>}</span>
1564: 
1565:    <span style='color:#696969; '># return to the page</span>
1566:    <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>item_view_comments<span style='color:#800080; '>;</span>
1567: <span style='color:#800080; '>}</span>
1568: 
1569: <span style='color:#800000; font-weight:bold; '>sub </span>password_forgot_form <span style='color:#800080; '>{</span>
1570:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1571:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'register-forgot-password.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1572:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1573: <span style='color:#800080; '>}</span>
1574: 
1575: <span style='color:#800000; font-weight:bold; '>sub </span>password_mail_success <span style='color:#800080; '>{</span>
1576:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1577:    <span style='color:#800000; font-weight:bold; '>my</span> $t <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'register-password-emailed.tmpl'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1578:    <span style='color:#800000; font-weight:bold; '>return</span> $t<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1579: <span style='color:#800080; '>}</span>
1580: 
1581: <span style='color:#800000; font-weight:bold; '>sub </span>password_mail_forgotten <span style='color:#800080; '>{</span>
1582:    <span style='color:#800000; font-weight:bold; '>my</span> $self <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1583: 
1584:    <span style='color:#800000; font-weight:bold; '>unless</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>user_id<span style='color:#800080; '>}</span> <span style='color:#808030; '>or</span> $FORM<span style='color:#800080; '>{</span>email<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1585:     <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Insufficient Information'</span><span style='color:#808030; '>,</span>
1586:         msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'There was an error processing your request-- Insufficient Information was received'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1587:      <span style='color:#800080; '>}</span>
1588: 
1589:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>@bind<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1590:    <span style='color:#800000; font-weight:bold; '>my</span> $sql <span style='color:#808030; '>=</span> <span style='color:#0000e6; '>"SELECT password,email FROM cas_users WHERE "</span><span style='color:#800080; '>;</span>
1591:    <span style='color:#800000; font-weight:bold; '>if</span> <span style='color:#808030; '>(</span>$FORM<span style='color:#800080; '>{</span>user_id<span style='color:#800080; '>}</span><span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1592:         $sql <span style='color:#808030; '>.</span><span style='color:#808030; '>=</span> <span style='color:#0000e6; '>" user_id = ? "</span><span style='color:#800080; '>;</span>
1593:         <span style='color:#800000; font-weight:bold; '>push</span> @bind<span style='color:#808030; '>,</span> $FORM<span style='color:#800080; '>{</span>user_id<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1594:    <span style='color:#800080; '>}</span> <span style='color:#800000; font-weight:bold; '>else</span> <span style='color:#800080; '>{</span>
1595:        $sql <span style='color:#808030; '>.</span><span style='color:#808030; '>=</span> <span style='color:#0000e6; '>" lower(email) = ? "</span><span style='color:#800080; '>;</span>
1596:        <span style='color:#800000; font-weight:bold; '>push</span> @bind<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>lc</span> $FORM<span style='color:#800080; '>{</span>email<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1597:    <span style='color:#800080; '>}</span>
1598:    <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$password<span style='color:#808030; '>,</span>$email<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>selectrow_array<span style='color:#808030; '>(</span>$sql<span style='color:#808030; '>,</span><span style='color:#800080; '>{</span><span style='color:#800080; '>}</span><span style='color:#808030; '>,</span>@bind<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1599: 
1600:    <span style='color:#800000; font-weight:bold; '>unless</span> <span style='color:#808030; '>(</span>$password <span style='color:#808030; '>and</span> $email<span style='color:#808030; '>)</span> <span style='color:#800080; '>{</span>
1601:           <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Information not found'</span><span style='color:#808030; '>,</span>
1602:         msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#800000; font-weight:bold; '>qq</span><span style='color:#800000; '>!</span><span style='color:#0000e6; '>We could not find sufficient information on your account.</span>
1603: <span style='color:#0000e6; '>            &lt;P></span>
1604: <span style='color:#0000e6; '>            Return to our &lt;A HREF="</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{CASCADE_CGI}/login">login page&lt;/A> to try logging in again</span><span style='color:#800000; '>!</span> <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1605:    <span style='color:#800080; '>}</span>
1606: 
1607:    <span style='color:#800000; font-weight:bold; '>open</span><span style='color:#808030; '>(</span>MAIL<span style='color:#808030; '>,</span><span style='color:#0000e6; '>"|</span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{MAILPROG} -t "</span><span style='color:#808030; '>)</span> <span style='color:#808030; '>|</span><span style='color:#808030; '>|</span> <span style='color:#800000; font-weight:bold; '>return</span> err<span style='color:#808030; '>(</span>title<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>'Error sending email'</span><span style='color:#808030; '>,</span>msg<span style='color:#808030; '>=</span><span style='color:#808030; '>></span><span style='color:#0000e6; '>"There was an error sending the message,</span>
1608: <span style='color:#0000e6; '>            please contact </span><span style='color:#0000e6; '>$CFG</span><span style='color:#0000e6; '>{CONTACT_EMAIL} for assistance."</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1609:    <span style='color:#800000; font-weight:bold; '>my</span> $msg <span style='color:#808030; '>=</span> $self<span style='color:#808030; '>-></span>load_tmpl<span style='color:#808030; '>(</span><span style='color:#0000e6; '>'emails/password-forgot.txt'</span><span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1610:    $msg<span style='color:#808030; '>-></span>param<span style='color:#808030; '>(</span> email<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$email<span style='color:#808030; '>,</span> password<span style='color:#808030; '>=</span><span style='color:#808030; '>></span>$password <span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1611:    <span style='color:#800000; font-weight:bold; '>print</span> MAIL $msg<span style='color:#808030; '>-></span>output<span style='color:#800080; '>;</span>
1612:    <span style='color:#800000; font-weight:bold; '>close</span><span style='color:#808030; '>(</span>MAIL<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1613: 
1614:    <span style='color:#800000; font-weight:bold; '>return</span> $self<span style='color:#808030; '>-></span>password_mail_success<span style='color:#800080; '>;</span>
1615: <span style='color:#800080; '>}</span>
1616: 
1617: <span style='color:#696969; '># make text a little more readable as HTML</span>
1618: <span style='color:#800000; font-weight:bold; '>sub </span>htmlicize <span style='color:#800080; '>{</span>
1619:    <span style='color:#800000; font-weight:bold; '>my</span> $txt <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>shift</span><span style='color:#800080; '>;</span>
1620:    <span style='color:#696969; '># convert 2 or more blank lines to a paragraph break</span>
1621:    $txt <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>s</span><span style='color:#800000; '>/</span><span style='color:#808030; '>(</span><span style='color:#0000e6; '>\s</span><span style='color:#808030; '>*</span><span style='color:#0f69ff; '>\n</span><span style='color:#808030; '>)</span><span style='color:#0000e6; '>{2}</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>&lt;P></span><span style='color:#800000; '>/</span><span style='color:#800000; font-weight:bold; '>gsi</span><span style='color:#800080; '>;</span>
1622: 
1623:    <span style='color:#696969; '># convert remaining newlines to html line breaks</span>
1624:    $txt <span style='color:#808030; '>=</span><span style='color:#808030; '>~</span> <span style='color:#800000; font-weight:bold; '>s</span><span style='color:#800000; '>/</span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>/</span><span style='color:#0000e6; '>&lt;BR></span><span style='color:#0f69ff; '>\n</span><span style='color:#800000; '>/</span><span style='color:#800000; font-weight:bold; '>gsi</span><span style='color:#800080; '>;</span>
1625: 
1626:    <span style='color:#800000; font-weight:bold; '>return</span> $txt<span style='color:#800080; '>;</span>
1627: <span style='color:#800080; '>}</span>
1628: 
1629: <span style='color:#696969; '># We use this sometimes to avoid the overhead of DBIx::Abstract</span>
1630: <span style='color:#696969; '># and take advantage of prepare_cached for mass inserting</span>
1631: <span style='color:#696969; '># (which only happened for a bookmark import script when I added this. -mls )</span>
1632: <span style='color:#696969; '># credit: This is basically straight from the DBI documentation. </span>
1633: <span style='color:#800000; font-weight:bold; '>sub </span>insert_hash <span style='color:#800080; '>{</span>
1634:     <span style='color:#800000; font-weight:bold; '>my</span> <span style='color:#808030; '>(</span>$table<span style='color:#808030; '>,</span> $field_values<span style='color:#808030; '>)</span> <span style='color:#808030; '>=</span> @_<span style='color:#800080; '>;</span>
1635:     <span style='color:#800000; font-weight:bold; '>my</span> @fields <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>sort</span> <span style='color:#800000; font-weight:bold; '>keys</span> <span style='color:#808030; '>%</span>$field_values<span style='color:#800080; '>;</span> <span style='color:#696969; '># sort required</span>
1636:     <span style='color:#800000; font-weight:bold; '>my</span> @values <span style='color:#808030; '>=</span> @{$field_values}<span style='color:#800080; '>{</span>@fields<span style='color:#800080; '>}</span><span style='color:#800080; '>;</span>
1637:     <span style='color:#800000; font-weight:bold; '>my</span> $sql <span style='color:#808030; '>=</span> <span style='color:#800000; font-weight:bold; '>sprintf</span> <span style='color:#0000e6; '>"insert into </span><span style='color:#007997; '>%s</span><span style='color:#0000e6; '> (</span><span style='color:#007997; '>%s</span><span style='color:#0000e6; '>) values (</span><span style='color:#007997; '>%s</span><span style='color:#0000e6; '>)"</span><span style='color:#808030; '>,</span>
1638:         $table<span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>join</span><span style='color:#808030; '>(</span><span style='color:#0000e6; '>","</span><span style='color:#808030; '>,</span> @fields<span style='color:#808030; '>)</span><span style='color:#808030; '>,</span> <span style='color:#800000; font-weight:bold; '>join</span><span style='color:#808030; '>(</span><span style='color:#0000e6; '>","</span><span style='color:#808030; '>,</span> <span style='color:#808030; '>(</span><span style='color:#0000e6; '>"?"</span><span style='color:#808030; '>)</span><span style='color:#800000; font-weight:bold; '>x</span>@fields<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1639:     <span style='color:#800000; font-weight:bold; '>my</span> $sth <span style='color:#808030; '>=</span> $DBH<span style='color:#808030; '>-></span>prepare_cached<span style='color:#808030; '>(</span>$sql<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1640:     <span style='color:#800000; font-weight:bold; '>return</span> $sth<span style='color:#808030; '>-></span>execute<span style='color:#808030; '>(</span>@values<span style='color:#808030; '>)</span><span style='color:#800080; '>;</span>
1641: <span style='color:#800080; '>}</span>
1642: 
1643: <span style='color:#008c00; '>1</span><span style='color:#800080; '>;</span>
1644: 
1645: 
1646: 
</pre></body></html>
